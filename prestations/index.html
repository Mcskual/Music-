<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Prestations ‚Äî Clips & Musique (v1.4)</title>
  <style>
    :root {
      --bg:#0f172a;
      --card:#111827;
      --muted:#6b7280;
      --accent:#2563eb;
      --accent2:#16a34a;
      --border:#1e293b;
      --text:#e5e7eb;
      --text2:#cbd5e1;
      --shadow:0 10px 30px rgba(0,0,0,.25);
      --nav-bg:linear-gradient(125deg,rgba(59,130,246,.18),rgba(34,197,94,.10)),linear-gradient(180deg,rgba(15,23,42,.9),rgba(15,23,42,.78));
      --nav-sheen:linear-gradient(90deg,rgba(255,255,255,.04),transparent 45%,rgba(255,255,255,.06));
      --bg-gradient:
        radial-gradient(circle at 0% 0%, rgba(59,130,246,.22), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(34,197,94,.16), transparent 55%),
        linear-gradient(120deg,#020617,#020617 40%,#020617 60%,#020617);
    }

    /* Th√®me clair premium */
    [data-theme="light"] {
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#0f172a;
      --text2:#4b5563;
      --border:#e5e7eb;
      --muted:#6b7280;
      --shadow:0 16px 40px rgba(15,23,42,.12);
      --nav-bg:linear-gradient(125deg,rgba(59,130,246,.12),rgba(34,197,94,.08)),linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.9));
      --nav-sheen:linear-gradient(90deg,rgba(15,23,42,.06),transparent 45%,rgba(15,23,42,.08));
      --bg-gradient:
        radial-gradient(circle at 0% 0%, rgba(59,130,246,.12), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(120deg,#f9fafb,#f3f4f6 40%,#e5e7eb 60%,#f9fafb);
    }

    *, *::before, *::after { box-sizing:border-box; }
    * { scroll-behavior:auto; }

    body {
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: var(--bg-gradient);
      color:var(--text);
      margin:0;
    }

    .container { max-width:1200px; margin:36px auto 0 auto; padding:0 16px; }

    .top-nav{
      position:relative;
      display:grid;
      grid-template-columns:auto 1fr auto;
      align-items:center;
      gap:14px;
      padding:0 18px;
      height:68px;
      background:var(--nav-bg);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 18px 44px rgba(15,23,42,.35);
      margin-bottom:16px;
      flex-wrap:nowrap;
      overflow:hidden;
      backdrop-filter:blur(10px);
    }
    .top-nav::after{
      content:"";
      position:absolute;
      inset:0;
      background:var(--nav-sheen);
      pointer-events:none;
    }
    .nav-left,
    .nav-links,
    .theme-toggle{
      height:68px;
      display:flex;
      align-items:center;
    }
    .nav-left{
      gap:12px;
      min-width:0;
      flex-shrink:0;
      position:relative;
      z-index:1;
    }
    .nav-brand{
      display:flex;
      flex-direction:column;
      gap:2px;
      font-weight:800;
      letter-spacing:.03em;
    }
    .nav-brand .brand-title{ font-size:12px; text-transform:uppercase; letter-spacing:.14em; }
    .nav-brand .brand-sub{ font-size:11px; color:var(--muted); letter-spacing:.05em; }
    .brand-stack{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .nav-links{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      flex:1;
      justify-content:center;
      align-items:center;
      min-width:0;
      padding:6px 8px;
      background:rgba(255,255,255,.02);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.04);
      position:relative;
      z-index:1;
    }
    [data-theme="light"] .nav-links{ background:rgba(15,23,42,.02); }
    .nav-link{
      position:relative;
      color:var(--text2);
      text-decoration:none;
      min-width:140px;
      height:38px;
      display:inline-flex;
      justify-content:center;
      align-items:center;
      line-height:1;
      padding:0;
      box-sizing:border-box;
      border-radius:12px;
      border:1px solid transparent;
      background:rgba(15,23,42,.35);
      font-size:13px;
      font-weight:600;
      letter-spacing:.01em;
      transition:.18s background,.18s border-color,.18s color,.18s transform;
    }
    [data-theme="light"] .nav-link{ background:#f8fafc; }
    .nav-link:hover{
      border-color:var(--accent);
      color:#fff;
      background:linear-gradient(135deg,rgba(37,99,235,.18),rgba(16,185,129,.18));
      transform:translateY(-1px);
    }
    [data-theme="light"] .nav-link:hover{ color:var(--accent); }
    .nav-link::after{
      content:"";
      position:absolute;
      left:12px;
      right:12px;
      bottom:6px;
      height:3px;
      border-radius:999px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      opacity:0;
      transform:translateY(6px);
      transition:.2s ease;
    }
    .nav-link:hover::after{ opacity:1; transform:translateY(0); }
    .nav-link.active{
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#fff;
      border-color:transparent;
      box-shadow:0 12px 26px rgba(37,99,235,.45);
      transform:translateY(-1px);
    }
    .nav-link.active::after{ opacity:1; transform:translateY(0); background:linear-gradient(135deg,rgba(255,255,255,.9),rgba(255,255,255,.6)); }

    header.app {
      display:flex;
      gap:16px;
      align-items:center;
      margin-bottom:8px;
      flex-wrap:wrap;
    }

    .logo-wrap{
      background:var(--card);
      border-radius:18px;
      padding:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      text-decoration:none;
      color:inherit;
    }
    .logo-wrap img{
      width:220px;
      height:auto;
      display:block;
      border-radius:14px;
      transition:transform .2s ease, opacity .2s ease;
    }
    .logo-compact{
      padding:6px 10px;
      border-radius:14px;
    }
    .logo-compact img{ width:160px; }

    h1 {
      font-size:clamp(26px,4vw,40px);
      margin:0;
      padding:0;
      line-height:1.15;
    }
    h2 { margin:0 0 12px; font-size:18px; }
    .sub{ color:var(--text2); margin-bottom:16px; font-size:14px;}

    header.app, header.hero { margin-bottom:16px; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:16px;
      margin-top:16px !important;
    }

    .page-content{
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .whatsapp-card{
      position:relative;
      overflow:hidden;
      border:1px solid rgba(34,197,94,.35);
      background:linear-gradient(135deg,rgba(16,185,129,.12),rgba(16,185,129,.04)),var(--card);
    }
    .whatsapp-card::after{
      content:"";
      position:absolute;
      inset:-40% auto auto 40%;
      width:360px;
      height:360px;
      background:radial-gradient(circle at center, rgba(16,185,129,.18), transparent 55%);
      opacity:.8;
      pointer-events:none;
      filter:blur(8px);
    }
    .whatsapp-card h2{ display:flex; align-items:center; gap:8px; margin-bottom:6px; }
    .wa-icon{ width:22px; height:22px; display:inline-flex; align-items:center; justify-content:center; }
    .wa-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(34,197,94,.18);
      color:#bbf7d0;
      border:1px solid rgba(34,197,94,.45);
      font-size:12px;
      font-weight:700;
      letter-spacing:.01em;
    }
    [data-theme="light"] .wa-chip{ color:#0f5132; background:rgba(16,185,129,.16); }
    .wa-legend{ gap:8px; }

    .followup-grid{ position:relative; z-index:1; }
    .followup-card{
      position:relative;
      border:1px solid rgba(34,197,94,.32);
      background:linear-gradient(120deg,rgba(16,185,129,.09),rgba(16,185,129,.02));
      box-shadow:0 12px 30px rgba(16,185,129,.12);
      isolation:isolate;
    }
    .followup-card::before{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(135deg,rgba(16,185,129,.18),transparent 55%);
      opacity:.4;
      pointer-events:none;
      border-radius:inherit;
      z-index:0;
    }
    .followup-card > *{ position:relative; z-index:1; }
    .followup-head{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .followup-meta{ display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:8px; margin-top:10px; }
    .followup-stat{
      display:flex;
      flex-direction:column;
      gap:4px;
      padding:8px 10px;
      border-radius:10px;
      background:rgba(15,23,42,.4);
      border:1px solid rgba(34,197,94,.25);
    }
    [data-theme="light"] .followup-stat{ background:rgba(240,253,244,.9); }
    .followup-stat .label{ font-size:12px; color:var(--muted); display:inline-flex; gap:6px; align-items:center; }
    .followup-stat .value{ font-weight:700; font-size:14px; }
    .followup-pill{ box-shadow:0 4px 16px rgba(16,185,129,.16); }
    .followup-actions{ display:flex; flex-direction:column; gap:6px; margin-top:12px; }
    .followup-btn-row{ display:flex; flex-wrap:wrap; gap:8px; }
    .relance-btn{ color:#fff; border-color:transparent; }
    .relance-soft{ background:linear-gradient(135deg,#22c55e,#15803d); box-shadow:0 10px 20px rgba(16,185,129,.28); }
    .relance-soft:hover{ background:linear-gradient(135deg,#34d399,#16a34a); }
    .relance-firm{ background:linear-gradient(135deg,#f59e0b,#d97706); box-shadow:0 10px 20px rgba(245,158,11,.28); }
    .relance-firm:hover{ background:linear-gradient(135deg,#fbbf24,#f59e0b); }
    .relance-critical{ background:linear-gradient(135deg,#ef4444,#b91c1c); box-shadow:0 12px 22px rgba(239,68,68,.3); }
    .relance-critical:hover{ background:linear-gradient(135deg,#f87171,#ef4444); }

    @media(max-width:640px){
      .followup-head{ flex-direction:column; }
      .followup-pill{ align-self:flex-start; }
    }

    .grid{ display:grid; gap:16px; }
    .grid-2{ grid-template-columns:1.15fr .85fr; }
    @media(max-width:960px){
      .grid-2{ grid-template-columns:1fr; }
      header.app{ justify-content:flex-start; }
    }

    label{
      display:block;
      font-size:13px;
      margin-bottom:6px;
      color:var(--text2);
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    input[type="time"],
    select,
    textarea{
      width:100%;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      font-size:14px;
      outline:none;
      transition:.16s border-color,.16s box-shadow,.16s background,.16s transform;
    }
    input::placeholder,
    textarea::placeholder{ color:#6b7280; font-size:13px;}
    input:focus,
    select:focus,
    textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(37,99,235,.35);
      background:var(--card);
      transform:translateY(-1px);
    }

    .btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 14px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
      letter-spacing:.01em;
      background:#111827;
      color:#e5e7eb;
      border:1px solid #1f2937;
      transition:.15s background,.15s transform,.15s box-shadow,.15s border-color,.15s opacity;
    }
    .btn-primary{
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      border-color:transparent;
      color:#fff;
      box-shadow:0 10px 18px rgba(37,99,235,.45);
    }
    .btn-primary:hover{
      transform:translateY(-1px);
      box-shadow:0 14px 26px rgba(37,99,235,.6);
      opacity:0.97;
    }
    .btn-outline{
      background:transparent;
      color:var(--text2);
      border-color:#1f2937;
    }
    [data-theme="light"] .btn-outline{
      border-color:#d1d5db;
      background:#f9fafb;
    }
    .btn-outline:hover{
      background:rgba(15,23,42,.08);
      border-color:#374151;
    }
    [data-theme="light"] .btn-outline:hover{
      background:#edf2ff;
      border-color:#3b82f6;
    }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
      align-items:center;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      font-size:13px;
      border-radius:12px;
      overflow:hidden;
    }
    th,td{
      padding:7px 8px;
      border-bottom:1px solid #111827;
      text-align:left;
      vertical-align:top;
    }
    [data-theme="light"] th,
    [data-theme="light"] td{
      border-bottom:1px solid #e5e7eb;
    }
    th{
      font-weight:500;
      font-size:12px;
      color:#9ca3af;
      white-space:nowrap;
      background:rgba(15,23,42,.85);
    }
    [data-theme="light"] th{
      background:#f3f4f6;
      color:#6b7280;
    }
    tr:nth-child(even) td{
      background:rgba(15,23,42,.35);
    }
    [data-theme="light"] tr:nth-child(even) td{
      background:#f9fafb;
    }
    tr:hover td{
      background:rgba(59,130,246,.18);
    }
    [data-theme="light"] tr:hover td{
      background:rgba(59,130,246,.09);
    }

    .small{ font-size:12px; color:#8aa0b5;}
    .muted{ color:#94a3b8; font-size:12px; }

    .totals{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:8px;
      margin-top:10px;
    }
    @media(max-width:780px){ .totals{ grid-template-columns:1fr; } }

    .kpi{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .kpi .label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .kpi .value{
      font-size:20px;
      font-weight:800;
      margin-top:6px;
    }
    .kpi .sub{
      font-size:11px;
      color:#64748b;
      margin-top:2px;
    }

    .progress{
      height:6px;
      border-radius:999px;
      background:rgba(15,23,42,.8);
      overflow:hidden;
      border:1px solid #111827;
    }
    [data-theme="light"] .progress{
      background:#e5e7eb;
      border-color:#d1d5db;
    }
    .progress-inner{
      height:100%;
      width:0;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      transition:width .2s ease-out;
    }

    .searchbar{
      display:grid;
      grid-template-columns:1fr 160px 150px;
      gap:10px;
      margin:10px 0 0;
    }
    @media(max-width:780px){
      .searchbar{ grid-template-columns:1fr; }
    }

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:5px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:var(--card);
      font-size:11px;
      color:var(--text);
    }
    [data-theme="light"] .status-pill{
      border-color:#e5e7eb;
    }
    .status-pill span.dot{
      width:8px;
      height:8px;
      border-radius:999px;
      display:inline-block;
    }

    /* √âtats de pastilles (nuit) */
    .status-pill.paid{
      background:rgba(22,163,74,.14);
      border-color:#16a34a;
      color:#bbf7d0;
    }
    .status-pill.paid .dot{
      background:#22c55e;
    }

    .status-pill.partial{
      background:rgba(234,179,8,.16);
      border-color:#facc15;
      color:#fef9c3;
    }
    .status-pill.partial .dot{
      background:#eab308;
    }

    .status-pill.muted{
      background:rgba(239,68,68,.16);
      border-color:#ef4444;
      color:#fecaca;
    }
    .status-pill.muted .dot{
      background:#ef4444;
    }
    .status-pill.critical{
      background:rgba(248,113,113,.22);
      border-color:#ef4444;
      color:#ffe4e6;
    }
    .status-pill.critical .dot{
      background:#f87171;
    }

    /* √âtats de pastilles (jour) */
    [data-theme="light"] .status-pill.paid{
      background:rgba(22,163,74,.14);
      border-color:#16a34a;
      color:#166534;
    }
    [data-theme="light"] .status-pill.partial{
      background:rgba(250,204,21,.16);
      border-color:#eab308;
      color:#854d0e;
    }
    [data-theme="light"] .status-pill.muted{
      background:rgba(248,113,113,.18);
      border-color:#ef4444;
      color:#991b1b;
    }
    [data-theme="light"] .status-pill.critical{
      background:rgba(254,226,226,.9);
      border-color:#ef4444;
      color:#991b1b;
    }

    .checkbox-toggle{ display:flex; align-items:center; gap:8px; }

    .alert{
      padding:10px 12px;
      border-radius:12px;
      margin:10px 0;
    }
    .alert-ok{
      background:rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.5);
      color:#bbf7d0;
    }
    .alert-err{
      background:rgba(239,68,68,.08);
      border:1px solid rgba(239,68,68,.5);
      color:#fecaca;
    }

    footer{
      margin:20px 0;
      color:#94a3b8;
      font-size:12px;
      text-align:center;
    }
    footer code{
      background:var(--card);
      border-radius:8px;
      padding:2px 6px;
      border:1px solid #1f2937;
    }
    [data-theme="light"] footer code{
      border-color:#e5e7eb;
    }

    .hint{ font-size:12px; color:#9fb1c2; }
    .tab-section{ display:none; }
    .tab-section.active{ display:block; }
    .row{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px;
    }
    .pill{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:var(--card);
      color:#9ca3af;
    }
    [data-theme="light"] .pill{
      border-color:#e5e7eb;
      color:#6b7280;
    }

    /* Switch th√®me */
    .switch{
      position:relative;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      color:#9ca3af;
      cursor:pointer;
      user-select:none;
    }
    .switch input{ display:none; }
    .switch span.slider{
      width:34px;
      height:18px;
      border-radius:999px;
      background:#020617;
      border:1px solid #1f2937;
      position:relative;
      transition:.16s background,.16s border-color;
    }
    [data-theme="light"] .switch span.slider{
      background:#e5e7eb;
      border-color:#d1d5db;
    }
    .switch span.slider::before{
      content:"";
      position:absolute;
      top:1px;
      left:1px;
      width:14px;
      height:14px;
      border-radius:999px;
      background:#e5e7eb;
      transition:.16s transform,.16s background;
      box-shadow:0 1px 3px rgba(15,23,42,.5);
    }
    [data-theme="light"] .switch span.slider::before{
      background:#ffffff;
    }
    .switch input:checked + .slider{
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      border-color:transparent;
    }
    .switch input:checked + .slider::before{
      transform:translateX(14px);
    }
    .theme-toggle{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      background:rgba(15,23,42,.6);
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow:var(--shadow);
      flex-shrink:0;
    }
    [data-theme="light"] .theme-toggle{ background:#f8fafc; }
    .theme-icon{
      font-size:14px;
      line-height:1;
      filter:drop-shadow(0 2px 6px rgba(0,0,0,.25));
    }

    .debug-zone{
      margin-top:10px;
      font-size:11px;
      background:var(--card);
      border-radius:12px;
      padding:8px 10px;
      border:1px dashed #1f2937;
      color:#9ca3af;
    }
    .debug-zone pre{
      margin:4px 0 0;
      white-space:pre-wrap;
      word-break:break-word;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }

    .actions button{ margin-right:6px; }

    .small { font-size:12px; color:#8aa0b5;}
    .checkbox-toggle { display:flex; align-items:center; gap:8px;}
    .alert-ok { background: rgba(34,197,94,.1); border:1px solid rgba(34,197,94,.4); color:#86efac; }
    .alert-err{ background: rgba(239,68,68,.1); border:1px solid rgba(239,68,68,.4); color:#fecaca; }
    .hint { font-size:12px; color:#9fb1c2; }
    .debug { font-size:12px; color:#9ca3af; margin-top:6px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .totals { display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px; margin-top:10px; }
    .kpi{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; }
    .kpi .label{ font-size:12px; color:var(--muted); }
    .kpi .value{ font-size:20px; font-weight:800; margin-top:6px;}
    .actions button{ margin-right:6px;}
    .searchbar{ display:grid; grid-template-columns: 1fr 150px 160px; gap:10px; }
    @media(max-width:780px){ .searchbar{ grid-template-columns:1fr;} .totals{ grid-template-columns:1fr; } }

    /* calendar centered narrow */
    #bloc-calendar{max-width:900px;margin:24px auto;}

    /* ====== CAPTURE MOBILE R√âCAP ====== */
    #capture-mobile{
      display:none;
      width:380px;
      max-width:100%;
      margin:0 auto;
      padding:16px;
      background:var(--bg);
      color:var(--text);
      border-radius:16px;
    }
    .cap-header{
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      margin-bottom:12px;
      gap:6px;
    }
    .cap-header img{
      width:180px;
      height:auto;
      border-radius:12px;
      margin-top: -6px;
    }
    .cap-header .recap-logo{
      filter:brightness(10);
    }
    .cap-logo-clone{
      display:block;
      margin:0 auto 6px;
      opacity:1 !important;
      visibility:visible !important;
    }
    .cap-logo-clone img{
      width:180px;
      height:auto;
      display:block;
      opacity:1 !important;
      visibility:visible !important;
    }
    .cap-title{
      font-size:16px;
      font-weight:700;
    }
    .cap-sub{
      font-size:11px;
      color:var(--text2);
    }
    .cap-summary{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:8px;
      width:100%;
      margin:4px 0 14px;
    }
    .cap-kpi{
      position:relative;
      overflow:hidden;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      text-align:center;
      isolation:isolate;
    }
    .cap-kpi::after{
      content:"";
      position:absolute;
      inset:-30% -20% auto auto;
      width:180%;
      height:180%;
      background:radial-gradient(circle at 25% 25%, rgba(255,255,255,.25), transparent 45%);
      opacity:.75;
      transform:rotate(6deg);
      pointer-events:none;
      z-index:0;
    }
    .cap-kpi .label,
    .cap-kpi .value{
      text-align:center;
    }
    .cap-kpi.due{
      background:linear-gradient(135deg,#f59e0b,#f97316);
      border-color:rgba(249,115,22,.45);
      color:#fff;
    }
    .cap-kpi.received{
      background:linear-gradient(135deg,#22c55e,#15803d);
      border-color:rgba(21,128,61,.5);
      color:#ecfdf3;
    }
    .cap-kpi.total{
      background:linear-gradient(135deg,#312e81,#2563eb);
      border-color:rgba(37,99,235,.45);
      color:#e0e7ff;
      grid-column:1 / -1;
    }
    .cap-kpi .label{
      font-size:10px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:rgba(255,255,255,.85);
      z-index:1;
    }
    .cap-kpi .value{
      font-size:16px;
      font-weight:800;
      margin-top:4px;
      z-index:1;
    }
    .cap-item{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      margin-bottom:10px;
    }
    .cap-client{
      font-weight:700;
      font-size:14px;
      margin-bottom:2px;
    }
    .cap-subtitle{
      font-size:12px;
      color:var(--text2);
      margin-bottom:6px;
    }
    .cap-row{
      display:flex;
      justify-content:space-between;
      font-size:12px;
      margin-bottom:2px;
      gap:6px;
    }
    .cap-row span:first-child{
      color:var(--text2);
    }
    .cap-row .status-pill{
      font-size:10px;
      padding:2px 6px;
    }

    /* NOUVEAU: Styles pour la barre de progression dans la capture mobile */
    .cap-progress-wrap {
      padding: 8px 0;
    }
    .cap-row-progress-label {
      display: flex;
      justify-content: space-between; /* Correction d'alignement */
      align-items: center;
      margin-bottom: 4px;
      font-size: 0.875rem; 
      color: var(--muted);
    }
    .cap-row-progress-label span:last-child {
      font-weight: 600;
      color: var(--text);
    }

    /* Bloc recherche plus premium */
    .filter-panel{
      background:linear-gradient(145deg, rgba(37,99,235,.12), rgba(34,197,94,.08)), var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    [data-theme="light"] .filter-panel{
      background:linear-gradient(145deg, rgba(37,99,235,.08), rgba(34,197,94,.05)), var(--card);
    }
    .filter-row{
      display:grid;
      grid-template-columns:1.2fr 1fr 1fr;
      gap:12px;
      align-items:end;
    }
    .filter-actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      padding-top:8px;
      border-top:1px dashed var(--border);
    }
    .filter-actions .row{ gap:12px; }
    @media(max-width:780px){
      .filter-row{ grid-template-columns:1fr; }
      .filter-actions{ flex-direction:column; align-items:flex-start; }
    }

    /* BeatsEngine Premium */
    .beats-shell{
      position:relative;
      background: radial-gradient(circle at 20% 20%, rgba(106,0,255,0.18), transparent 40%),
                  radial-gradient(circle at 80% 0%, rgba(0,229,255,0.18), transparent 34%),
                  #0b0b0f;
      border:1px solid rgba(255,255,255,0.06);
      border-radius:18px;
      padding:18px;
      box-shadow:0 16px 48px rgba(0,0,0,0.45);
      overflow:hidden;
      isolation:isolate;
    }
    .beats-shell::after{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(135deg, rgba(106,0,255,0.08), rgba(0,229,255,0.06));
      pointer-events:none;
      z-index:-1;
    }
    .beats-hero{
      display:flex;
      gap:16px;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      background:linear-gradient(135deg, rgba(106,0,255,0.16), rgba(0,229,255,0.12));
      border:1px solid rgba(255,255,255,0.08);
      border-radius:16px;
      padding:18px;
      box-shadow:0 18px 38px rgba(0,0,0,0.55);
    }
    .beats-hero h2{
      margin:0;
      font-size:1.6rem;
      letter-spacing:0.01em;
    }
    .beats-hero p{
      color:#c9d1ff;
      max-width:780px;
      margin:6px 0 0;
    }
    .beats-tagline{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .beats-chip{
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(0,229,255,0.35);
      background:rgba(0,229,255,0.08);
      color:#e8f0ff;
      font-size:12px;
      letter-spacing:0.02em;
    }
    .beats-accent{
      color:#00ff9c;
      font-weight:700;
    }
    .beats-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .beats-pill-btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(255,255,255,0.04);
      color:#e8f0ff;
      font-weight:700;
      box-shadow:0 10px 28px rgba(0,0,0,0.35);
    }
    .beats-pill-btn:hover{
      border-color:rgba(0,229,255,0.4);
      background:linear-gradient(135deg, rgba(106,0,255,0.2), rgba(0,229,255,0.14));
      transform:translateY(-1px);
      transition:150ms ease;
    }
    .beats-columns{
      display:grid;
      grid-template-columns:1.08fr 0.92fr;
      gap:14px;
      margin-top:14px;
    }
    @media(max-width:1024px){
      .beats-columns{ grid-template-columns:1fr; }
    }
    .beats-stack{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .beats-card{
      background:rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:14px;
      padding:16px;
      box-shadow:0 16px 42px rgba(0,0,0,0.45);
      backdrop-filter:blur(6px);
    }
    .beats-card h3{
      margin-top:0;
      margin-bottom:6px;
      letter-spacing:0.02em;
    }
    .beats-card h4{
      margin:10px 0 8px;
      letter-spacing:0.02em;
      font-size:14px;
    }
    .beats-description{
      color:#8fa0c9;
      font-size:13px;
      margin:0 0 12px;
    }
    .beats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:12px;
    }
    .beats-label{
      font-size:12px;
      color:#c3c9ff;
      letter-spacing:0.02em;
      margin-bottom:6px;
      display:block;
    }
    .beats-input,
    .beats-select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.03);
      color:#f4f6ff;
      font-weight:600;
      letter-spacing:0.01em;
    }
    .beats-select{ appearance:none; }
    .beats-meta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .beats-meta-pill{
      padding:8px 12px;
      border-radius:12px;
      border:1px dashed rgba(0,229,255,0.35);
      color:#cfe9ff;
      background:rgba(0,229,255,0.06);
      font-size:12px;
    }
    .usage-meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .usage-pill{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(0,229,255,0.25);
      background:rgba(0,229,255,0.05);
      color:#d5e7ff;
      font-size:12px;
      letter-spacing:0.01em;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .usage-pill strong{ color:#fff; }
    .energy-toggle{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .energy-chip{
      position:relative;
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.02);
      cursor:pointer;
      min-width:160px;
      transition:180ms ease;
    }
    .energy-chip input{ display:none; }
    .energy-chip span{
      font-weight:700;
      color:#f4f6ff;
      letter-spacing:0.01em;
    }
    .energy-chip small{
      color:#9db2ff;
      display:block;
      font-weight:500;
    }
    .energy-chip.active{
      border-color:rgba(0,229,255,0.5);
      box-shadow:0 10px 30px rgba(0,229,255,0.18);
      background:linear-gradient(135deg, rgba(106,0,255,0.2), rgba(0,229,255,0.1));
    }
    .progression-chip,
    .vocal-chip,
    .dance-chip{
      border:1px solid rgba(255,255,255,0.1);
      border-radius:12px;
      padding:10px 12px;
      background:rgba(255,255,255,0.02);
      color:#e8f0ff;
      display:flex;
      gap:8px;
      align-items:flex-start;
      cursor:pointer;
      transition:140ms ease;
      box-shadow:0 10px 28px rgba(0,0,0,0.35);
    }
    .progression-chip.active,
    .vocal-chip.active,
    .dance-chip.active{
      border-color:rgba(0,229,255,0.45);
      background:linear-gradient(135deg, rgba(106,0,255,0.18), rgba(0,229,255,0.12));
      box-shadow:0 14px 34px rgba(0,0,0,0.45);
    }
    .progression-chip small,
    .vocal-chip small,
    .dance-chip small{
      display:block;
      color:#9db2ff;
      line-height:1.4;
    }
    .progression-row,
    .vocal-row,
    .dance-row{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:10px;
    }
    .beats-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:10px;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.08);
      color:#cfe9ff;
      font-size:12px;
    }
    .progression-meta{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:10px;
      padding:10px;
      border:1px dashed rgba(0,229,255,0.25);
      border-radius:12px;
      background:rgba(0,229,255,0.04);
      color:#e8f0ff;
      font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    .beats-warning{
      margin-top:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,99,132,0.55);
      background:rgba(255,99,132,0.08);
      color:#ffc9d6;
      font-weight:700;
      display:none;
    }
    .beats-warning.visible{ display:block; }
    .dual-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:12px;
    }
    .beats-slider{
      width:100%;
    }
    .duration-row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .duration-row input[type="text"]{
      max-width:120px;
      text-align:center;
    }
    .instrument-accordion{
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.02);
    }
    .instrument-accordion summary{
      list-style:none;
      padding:12px 14px;
      cursor:pointer;
      font-weight:700;
      color:#e8f0ff;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .instrument-accordion summary::-webkit-details-marker{ display:none; }
    .instrument-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:10px;
      padding:10px 14px 14px;
      background:rgba(0,0,0,0.25);
    }
    .instrument-checkbox{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px;
      border:1px solid rgba(255,255,255,0.07);
      border-radius:12px;
      background:rgba(255,255,255,0.03);
      font-size:13px;
      color:#f4f6ff;
    }
    .instrument-checkbox input{ accent-color:#00e5ff; }
    .instrument-checkbox.over-limit{
      border-color:rgba(255,99,132,0.7);
      box-shadow:0 0 0 1px rgba(255,99,132,0.4);
    }
    .instrument-group-title{
      color:#9db2ff;
      font-weight:800;
      margin:6px 0 2px;
      letter-spacing:0.01em;
    }
    .structure-list{
      list-style:none;
      margin:0;
      padding:0;
      display:grid;
      gap:10px;
    }
    .structure-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.03);
      cursor:grab;
    }
    .structure-item.dragging{
      opacity:0.7;
      border-style:dashed;
    }
    .structure-label{
      font-weight:700;
      color:#f4f6ff;
      letter-spacing:0.01em;
    }
    .drag-handle{
      color:#00e5ff;
      font-size:18px;
      margin-right:6px;
    }
    .structure-controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .structure-controls input{
      flex:1;
      min-width:160px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.02);
      color:#f4f6ff;
      padding:10px 12px;
    }
    .structure-btn{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(0,229,255,0.35);
      background:linear-gradient(135deg, rgba(106,0,255,0.16), rgba(0,229,255,0.14));
      color:#f4f6ff;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(0,0,0,0.35);
    }
    .structure-btn.secondary{
      background:rgba(255,255,255,0.04);
      border-color:rgba(255,255,255,0.08);
    }
    .beats-output{
      width:100%;
      min-height:240px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
      line-height:1.5;
      background:linear-gradient(160deg, rgba(106,0,255,0.12), rgba(0,229,255,0.08));
      border:1px solid rgba(0,229,255,0.35);
      border-radius:14px;
      color:#f8fbff;
      padding:14px;
      box-shadow:0 18px 42px rgba(0,0,0,0.45);
    }
    .beats-toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .beats-btn{
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.04);
      color:#f4f6ff;
      font-weight:800;
      letter-spacing:0.01em;
      cursor:pointer;
      min-width:140px;
      transition:160ms ease;
      box-shadow:0 12px 30px rgba(0,0,0,0.35);
    }
    .beats-btn.primary{
      background:linear-gradient(135deg, #6a00ff, #00e5ff);
      border-color:rgba(0,229,255,0.35);
      color:#0b0b0f;
    }
    .beats-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 16px 36px rgba(0,0,0,0.5);
    }
    .beats-status{
      font-size:12px;
      color:#9db2ff;
      margin-top:6px;
    }

  </style>
  <link rel="stylesheet" href="assets/szd-cards.css">
</head>
<body>
  <div class="container">
    <nav class="top-nav" aria-label="Navigation principale">
      <div class="nav-left">
        <a class="logo-wrap logo-compact" href="index.html" aria-label="Revenir aux prestations">
          <img
            src="szd_logo_white.png"
            data-dark-src="szd_logo_white.png"
            data-light-src="szd_logo_black.png"
            alt="Logo">
        </a>
      </div>
      <div class="nav-links">
        <a class="nav-link active" href="#prestations" data-tab-target="prestations">Prestations</a>
        <a class="nav-link" href="#beatsengine" data-tab-target="beatsengine">üéõÔ∏è BeatsEngine</a>
        <a class="nav-link" href="facturation.html">Facturation</a>
        <a class="nav-link" href="rdv.html">Ajouter un RDV</a>
        <a class="nav-link" href="licence.html">Contrat instrumentale</a>
        <a class="nav-link" href="famille.html">Famille</a>
      </div>
      <div class="theme-toggle">
        <span class="theme-icon" aria-hidden="true">üåô</span>
        <label class="switch" aria-label="Basculer le th√®me nuit/jour">
          <input type="checkbox" id="themeToggle">
          <span class="slider"></span>
        </label>
      </div>
    </nav>
    <header class="app">
      <div>
        <h1>Prestations ‚Äî Clips & Musique</h1>
        <div class="row" style="margin:4px 0 2px;">
          <span class="pill">Version 1.4</span>
          <span class="pill">LocalStorage</span>
        </div>
        <p class="sub">
          Ajoute tes prestations, saisis les montants et enregistre les paiements partiels.
          Donn√©es stock√©es en localStorage. Si le stockage est bloqu√©, l'application bascule en mode secours (sauvegarde JSON).
        </p>
      </div>
    </header>

    <main class="page-content">
    <section class="tab-section active" id="prestations">
      <div id="status" class="alert" style="display:none;"></div>

      <div class="grid grid-2">
        <div class="card">
          <h2>Nouvelle prestation</h2>
          <form id="prestations-form" novalidate>
            <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px;">
              <div>
                <label for="client">Client</label>
                <input type="text" id="client" placeholder="Nom de l'artiste / client">
              </div>
              <div>
                <label for="type">Type</label>
                <select id="type">
                  <option value="Clip">Clip</option>
                  <option value="Musique">Musique</option>
                  <option value="Tournage">Tournage</option>
                  <option value="Montage">Montage</option>
                  <option value="Autre">Autre</option>
                </select>
              </div>
              <div style="grid-column:1 / -1;">
                <label for="description">Description (optionnel)</label>
                <input type="text" id="description" placeholder="D√©tails de la prestation (ex : Clip Mayanna)">
              </div>
              <div>
                <label for="date">Date</label>
                <input type="date" id="date">
              </div>
              <div>
                <label for="montant">Montant (‚Ç¨)</label>
                <input type="text" inputmode="decimal" id="montant" placeholder="ex : 800 ou 800,00">
              </div>
              <div class="checkbox-toggle" style="align-self:end;">
                <input type="checkbox" id="paye">
                <label for="paye" style="margin:0;">D√©j√† pay√© (total)</label>
              </div>
            </div>
            <div class="toolbar" style="margin-top:12px;">
              <button class="btn btn-primary" id="save" type="submit">Ajouter</button>
              <button type="button" class="btn btn-outline" id="reset">R√©initialiser</button>
              <button type="button" class="btn btn-outline" id="addDemo">+ D√©mo</button>
              <button type="button" class="btn btn-outline" id="exportJson">Export JSON</button>
              <button type="button" class="btn btn-outline" id="exportCsv">Export CSV</button>
              <label class="btn btn-outline">
                Import JSON
                <input type="file" id="importJson" accept="application/json" style="display:none;">
              </label>
            </div>
          </form>
        </div>

        <div class="card">
          <h2>Recherche & filtre</h2>
          <div class="filter-panel">
            <div class="filter-row">
              <div>
                <label for="search">Filtre texte</label>
                <input type="text" id="search" placeholder="Client, type, description‚Ä¶">
              </div>
              <div>
                <label for="filterStatus">Statut</label>
                <select id="filterStatus">
                  <option value="all">Tous</option>
                  <option value="unpayed">Non pay√©</option>
                  <option value="partial">Partiel</option>
                  <option value="paid">Pay√© / sold√©</option>
                </select>
              </div>
              <div>
                <label for="filterType">Type</label>
                <select id="filterType">
                  <option value="all">Tous</option>
                  <option value="Clip">Clip</option>
                  <option value="Musique">Musique</option>
                  <option value="Tournage">Tournage</option>
                  <option value="Montage">Montage</option>
                  <option value="Autre">Autre</option>
                </select>
              </div>
            </div>

            <div class="filter-actions">
              <div class="row">
                <div class="checkbox-toggle">
                  <input type="checkbox" id="debug">
                  <label for="debug" style="margin:0;">Debug mode</label>
                </div>
                <div class="checkbox-toggle">
                  <input type="checkbox" id="autoFile">
                  <label for="autoFile" style="margin:0;">Fichier auto (exp√©rimental)</label>
                </div>
              </div>
              <div class="row" style="gap:8px; color:var(--muted); font-size:12px;">
                <span>Affinez vos r√©sultats :</span>
                <span class="pill">Texte</span>
                <span class="pill">Statut</span>
                <span class="pill">Type</span>
              </div>
            </div>
          </div>

          <div class="totals" style="margin-top:14px;">
            <div class="kpi">
              <div class="label">Total factur√©</div>
              <div class="value" id="totalMontant">0 ‚Ç¨</div>
              <div class="sub">Somme des prestations</div>
            </div>
            <div class="kpi">
              <div class="label">Total re√ßu</div>
              <div class="value" id="totalRecu">0 ‚Ç¨</div>
              <div class="sub">Somme des paiements</div>
            </div>
            <div class="kpi">
              <div class="label">Total restant</div>
              <div class="value" id="totalRestant">0 ‚Ç¨</div>
              <div class="sub">√Ä encaisser</div>
            </div>
          </div>

          <div class="small" id="lsStatus" style="margin-top:6px;"></div>

        <div class="debug-zone" id="debug-zone" style="display:none;">
          <div>Console locale :</div>
          <pre id="debugOut"></pre>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:20px;">
      <h2>Prestations enregistr√©es</h2>
      <div class="small">Clique sur "Encaisser" pour enregistrer un paiement partiel ou total.</div>
      <div class="toolbar" style="margin-top:10px;">
        <button type="button" class="btn btn-outline" id="captureRecap">üì∏ Capture </button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Client / Type</th>
              <th>Montant</th>
              <th>Re√ßu</th>
              <th>Restant</th>
              <th>Avancement</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
        <tbody id="tbody">
          <tr><td colspan="10" class="small">Aucune prestation ne correspond.</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card whatsapp-card" style="margin-top:20px;">
      <h2><span class="wa-icon">üíö</span>Relances automatiques</h2>
      <div class="row" style="justify-content:space-between; align-items:center; gap:10px;">
        <p class="small" style="margin:0; max-width:620px;">Clients √† relancer apr√®s 15 jours sans paiement ; √† 30 jours la relance devient prioritaire, et √† 45 jours elle passe en mode critique. Pr√©pare tout pour WhatsApp en un coup d'≈ìil.</p>
        <span class="wa-chip">üí¨ Mode WhatsApp pr√™t</span>
      </div>
      <div class="row wa-legend" style="align-items:center; margin:10px 0 6px; flex-wrap:wrap;">
        <span class="pill">15 jours : relance douce</span>
        <span class="pill">30 jours : relance urgente</span>
        <span class="pill">45 jours : relance critique</span>
        <span class="pill" id="followupCounts">0 relance en attente</span>
      </div>
      <div id="followupList" class="grid followup-grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:10px;"></div>
    </div>
    </section>

    <section class="tab-section" id="beatsengine" hidden>
      <div class="beats-shell">
        <div class="beats-hero">
          <div>
            <h2>üéõÔ∏è BeatsEngine Pro ‚Äî Module Studio</h2>
            <p>
              G√©n√®re des prompts IA studio-grade : tonalit√©, accords gagnants transpos√©s, √©nergie et danceability dissoci√©es, vocal control, instruments intelligents, structure drag & drop et dur√©e cible. Identit√© visuelle d√©di√©e sans nuire aux autres onglets.
            </p>
            <div class="beats-tagline">
              <span class="beats-chip">D√©grad√© signature #6A00FF ‚Üí #00E5FF</span>
              <span class="beats-chip">Accords & BPM coh√©rents</span>
              <span class="beats-chip">Structure drag & drop</span>
            </div>
          </div>
          <div class="beats-actions">
            <span class="beats-pill-btn">‚ö° Studio-grade prompt</span>
            <button type="button" class="beats-pill-btn" id="beats-shuffle">Shuffle üé≤</button>
          </div>
        </div>

        <div class="beats-columns">
          <div class="beats-stack">
            <div class="beats-card">
              <h3>üéº Core Settings</h3>
              <p class="beats-description">Style, cl√© et BPM verrouill√©s sur des plages coh√©rentes pour un rendu pro.</p>
              <div class="beats-grid">
                <div>
                  <label class="beats-label" for="beats-style">Style musical</label>
                  <select id="beats-style" class="beats-select">
                    <option>Afro-Trap</option>
                    <option>Afro-Trap Club</option>
                    <option>Drill</option>
                    <option>R&B</option>
                    <option>Dancehall</option>
                    <option>Afrobeat</option>
                    <option>Afropop</option>
                    <option>Bongo Flava</option>
                    <option>Amapiano</option>
                    <option>Zouk</option>
                    <option>Reggae</option>
                    <option>Reggaeton</option>
                    <option>Moombahton</option>
                    <option>Shatta</option>
                  </select>
                </div>
                <div>
                  <label class="beats-label" for="beats-key">Cl√© musicale</label>
                  <select id="beats-key" class="beats-select">
                    <option>C minor</option>
                    <option>C# minor</option>
                    <option>D minor</option>
                    <option>D# minor</option>
                    <option>E minor</option>
                    <option>F minor</option>
                    <option>F# minor</option>
                    <option>G minor</option>
                    <option>G# minor</option>
                    <option>A minor</option>
                    <option>A# minor</option>
                    <option>B minor</option>
                    <option>D major</option>
                    <option>E major</option>
                    <option>F major</option>
                    <option>G major</option>
                    <option>A major</option>
                    <option>B major</option>
                  </select>
                </div>
                <div>
                  <label class="beats-label" for="beats-bpm">BPM</label>
                  <input type="number" id="beats-bpm" class="beats-input" min="70" max="180" step="1" value="110" inputmode="numeric">
                </div>
              </div>
              <div class="beats-meta">
                <span class="beats-meta-pill">Accords cl√©s : <strong id="beats-chords">-</strong></span>
                <span class="beats-meta-pill">Plage BPM : <strong id="beats-bpm-range">-</strong></span>
                <span class="beats-meta-pill">Groove : <strong id="beats-energy-desc">-</strong></span>
              </div>
            </div>

            <div class="beats-card">
              <h3>üéº Winning Chords</h3>
              <p class="beats-description">Progressions gagnantes auto-s√©lectionn√©es par style et transpos√©es dans la cl√© choisie.</p>
              <div class="progression-row" id="progression-options"></div>
              <div class="progression-meta">
                <div><strong>Degr√©s :</strong> <span id="beats-progression">i ‚Äì VI ‚Äì III ‚Äì VII</span></div>
                <div><strong>Accords r√©els :</strong> <span id="beats-progression-chords">Am ‚Äì F ‚Äì C ‚Äì G</span></div>
                <div class="beats-badge">Auto-transpos√© selon la cl√© et le style.</div>
              </div>
            </div>

            <div class="beats-card">
              <h3>üé§ Vocal Control & Groove</h3>
              <p class="beats-description">Mode vocal-first par d√©faut, avec √©nergie et danceability dissoci√©es.</p>
              <div class="vocal-row" id="vocal-modes">
                <label class="vocal-chip active">
                  <input type="radio" name="vocal-mode" value="vocal-first" checked>
                  <div>
                    <span style="font-weight:800;">Vocal-First</span>
                    <small>vocal-first arrangement, no competing lead melody, instrumental supportive, clear space for human vocals.</small>
                  </div>
                </label>
                <label class="vocal-chip">
                  <input type="radio" name="vocal-mode" value="balanced">
                  <div>
                    <span style="font-weight:800;">Balanced</span>
                    <small>vocal-instrument balance, gentle counter-melodies, controlled layers.</small>
                  </div>
                </label>
                <label class="vocal-chip">
                  <input type="radio" name="vocal-mode" value="instrumental-lead">
                  <div>
                    <span style="font-weight:800;">Instrumental-Lead</span>
                    <small>instrumental hooks in front, vocals woven around the lead.</small>
                  </div>
                </label>
              </div>

              <div class="dual-grid" style="margin-top:12px;">
                <div>
                  <h4>‚ö° Energy</h4>
                  <div class="energy-toggle" id="beats-energy">
                    <label class="energy-chip">
                      <input type="radio" name="beats-energy" value="low">
                      <div>
                        <span>Low</span>
                        <small>Minimal, smooth, spacious</small>
                      </div>
                    </label>
                    <label class="energy-chip active">
                      <input type="radio" name="beats-energy" value="medium" checked>
                      <div>
                        <span>Medium</span>
                        <small>Balanced, groove-focused</small>
                      </div>
                    </label>
                    <label class="energy-chip">
                      <input type="radio" name="beats-energy" value="high">
                      <div>
                        <span>High</span>
                        <small>Aggressive, club-ready</small>
                      </div>
                    </label>
                  </div>
                  <div class="beats-status" id="beats-energy-note">Low ‚Üí minimal, smooth, spacious.</div>
                </div>

                <div>
                  <h4>üï∫ Danceability</h4>
                  <div class="dance-row" id="beats-danceability">
                    <label class="dance-chip">
                      <input type="radio" name="beats-dance" value="low">
                      <div>
                        <span>Low</span>
                        <small>Laid-back groove</small>
                      </div>
                    </label>
                    <label class="dance-chip active">
                      <input type="radio" name="beats-dance" value="medium" checked>
                      <div>
                        <span>Medium</span>
                        <small>Smooth bounce</small>
                      </div>
                    </label>
                    <label class="dance-chip">
                      <input type="radio" name="beats-dance" value="high">
                      <div>
                        <span>High</span>
                        <small>Club-focused rhythmic drive</small>
                      </div>
                    </label>
                  </div>
                  <div class="beats-status" id="beats-dance-note">Danceable sans agressivit√© obligatoire.</div>
                </div>
              </div>
            </div>

            <div class="beats-card">
              <h3>üéπ Instruments & Structure</h3>
              <p class="beats-description">Coche ce qui doit √™tre entendu, ce qui doit dispara√Ætre, et sculpte la structure drag & drop.</p>
              <details class="instrument-accordion" open>
                <summary>Instruments premium</summary>
                <div class="instrument-grid" id="beats-instruments">
                  <div>
                    <div class="instrument-group-title">Rythme</div>
                    <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="kick" data-role="rhythm" checked> Kick</label>
                    <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="snare / clap" data-role="rhythm" checked> Snare / Clap</label>
                    <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="hi-hats" data-role="rhythm" checked> Hi-hats</label>
                    <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="percussions africaines" data-role="rhythm" checked> Percussions africaines</label>
                  </div>
                  <div>
                    <div class="instrument-group-title">Basse</div>
                    <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="808 / bass" data-role="bass" checked> 808 / Bass</label>
                    <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="log drum" data-role="bass"> Log drum</label>
                  </div>
                  <div>
                    <div class="instrument-group-title">M√©lodie</div>
                    <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="guitar" data-role="melody"> Guitar</label>
                    <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="piano / keys" data-role="melody"> Piano / Keys</label>
                    <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="synth lead" data-role="melody"> Synth lead</label>
                    <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="synth pads" data-role="melody" checked> Synth pads</label>
                    <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="strings" data-role="melody"> Strings</label>
                  </div>
                  <div>
                    <div class="instrument-group-title">Ambiance</div>
                    <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="fx" data-role="ambience"> FX</label>
                    <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="atmospheres" data-role="ambience"> Atmospheres</label>
                  </div>
                </div>
              </details>
              <div class="beats-warning" id="melody-warning">Mode Vocal-First : limite de 1 instrument m√©lodique d√©pass√©e.</div>

              <div style="margin-top:14px;">
                <label class="beats-label" for="beats-usage">üéØ Usage du morceau</label>
                <select id="beats-usage" class="beats-select">
                  <option value="radio">üìª Radio</option>
                  <option value="streaming" selected>üéß Streaming</option>
                  <option value="club">üîä Club</option>
                  <option value="dj">üéõÔ∏è DJ / Extended</option>
                  <option value="emotion">‚ù§Ô∏è Chant / √âmotion (Zouk, R&B, Reggae)</option>
                </select>
                <div class="usage-meta" id="beats-usage-meta" aria-live="polite" style="margin-top:8px;"></div>
              </div>

              <div style="margin-top:14px;">
                <label class="beats-label" for="beats-duration">‚è±Ô∏è Track Duration</label>
                <div class="duration-row">
                  <input type="range" id="beats-duration-range" class="beats-slider" min="110" max="360" step="5" value="150">
                  <input type="text" id="beats-duration" class="beats-input" placeholder="2:30 ou 180s" value="2:30">
                  <span class="beats-badge">dur√©e intelligente</span>
                </div>
              </div>

              <div style="margin-top:12px;">
                <div class="structure-controls">
                  <input type="text" id="structure-input" placeholder="Ajouter un segment (ex : Refrain 2)">
                  <button type="button" class="structure-btn" id="structure-add">Ajouter</button>
                  <button type="button" class="structure-btn secondary" id="structure-reset">R√©initialiser</button>
                </div>
                <div class="structure-controls" style="margin-top:8px;">
                  <button type="button" class="structure-btn secondary" data-structure-preset="singer">Preset Singer</button>
                  <button type="button" class="structure-btn secondary" data-structure-preset="rapper">Preset Rapper</button>
                  <button type="button" class="structure-btn secondary" data-structure-preset="club">Preset Club</button>
                </div>
                <ul class="structure-list" id="structure-list" aria-label="Structure du morceau"></ul>
              </div>
            </div>
          </div>

          <div class="beats-card">
            <h3>üß† Prompt Engine</h3>
            <p class="beats-description">Prompt premium ligne par ligne, lisible, pr√™t √† √™tre coll√© dans ton IA audio.</p>
            <textarea id="beats-output" class="beats-output" rows="14" readonly aria-live="polite"></textarea>
            <div class="beats-toolbar">
              <button type="button" class="beats-btn primary" id="beats-generate">Generate</button>
              <button type="button" class="beats-btn" id="beats-copy">Copy Prompt</button>
            </div>
            <div class="beats-status" id="beats-status">Pr√™t √† g√©n√©rer un prompt studio.</div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Zone de capture mobile cach√©e -->
  <div id="capture-mobile"></div>

  </div>

  <footer>Local ‚Äî cl√©: <code>prestations_v1</code>. Si √ßa casse, tu peux exporter en JSON et garder une sauvegarde manuelle.</footer>

  <!-- html2canvas pour la capture -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="assets/szd-card-glow.js" defer></script>

  <script>
    function updateThemeLogos(theme){
      const mode = theme === "light" ? "light" : "dark";

      document.querySelectorAll('[data-light-src][data-dark-src]').forEach((img) => {
        const target = mode === "light" ? img.dataset.lightSrc : img.dataset.darkSrc;
        if (target) {
          img.setAttribute("src", target);
        }
      });
    }

    function currentLogoForTheme(theme){
      const mode = theme === "light" ? "light" : "dark";
      const img = document.querySelector('[data-light-src][data-dark-src]');
      if (!img) return "";

      return mode === "light"
        ? (img.dataset.lightSrc || img.getAttribute("src") || "")
        : (img.dataset.darkSrc || img.getAttribute("src") || "");
    }

    function captureLogoForTheme(theme){
      const preferredCaptureLogo = "szd_logo_blanc.png";
      const mode = theme === "light" ? "light" : "dark";
      const candidates = [
        preferredCaptureLogo,
        "szd_logo_white.png",
        currentLogoForTheme(mode),
        mode === "light" ? "szd_logo_black.png" : "szd_logo_white.png",
        "szd_logo.png"
      ].filter(Boolean);

      const candidate = candidates[0] || "";

      try {
        return new URL(candidate, window.location.href).href;
      } catch (e) {
        return candidate;
      }
    }
  </script>

  <!-- SCRIPT TABS -->
  <script>
    (function(){
      const tabLinks = document.querySelectorAll("[data-tab-target]");
      const tabSections = document.querySelectorAll(".tab-section");
      if(!tabLinks.length || !tabSections.length) return;

      function activateTab(targetId, skipHash){
        tabSections.forEach(section => {
          const active = section.id === targetId;
          section.classList.toggle("active", active);
          section.hidden = !active;
        });

        tabLinks.forEach(link => {
          const active = link.dataset.tabTarget === targetId;
          link.classList.toggle("active", active);
          if(active) link.blur();
        });

        if(!skipHash){
          const hash = targetId === "prestations" ? "" : `#${targetId}`;
          const newUrl = hash ? `${location.pathname}${hash}` : location.pathname;
          history.replaceState(null, "", newUrl);
        }
      }

      function initFromHash(){
        const hash = (location.hash || "").replace("#","");
        const target = document.getElementById(hash) ? hash : "prestations";
        activateTab(target, true);
      }

      tabLinks.forEach(link => {
        link.addEventListener("click", (e) => {
          const target = link.dataset.tabTarget;
          if(!target) return;
          e.preventDefault();
          activateTab(target);
        });
      });

      initFromHash();
      window.addEventListener("hashchange", initFromHash);
    })();
  </script>

  <!-- SCRIPT PRESTATIONS -->
  <script>
    (() => {
      const $ = (id) => document.getElementById(id);
      const formEl = $("prestations-form");
      const eur = (n) => new Intl.NumberFormat("fr-FR", {style:"currency", currency:"EUR"}).format(n || 0);
      const storageKey = "prestations_v1";
      const VERSION = "1.4";

      const status = $("status");
      const debugChk = $("debug");
      const autoFile = $("autoFile");
      const debugOut = $("debugOut");
      const lsStatus = $("lsStatus");

      const tbody = $("tbody");
      const totalMontantEl = $("totalMontant");
      const totalRecuEl = $("totalRecu");
      const totalRestantEl = $("totalRestant");
      const search = $("search");
      const filterStatus = $("filterStatus");
      const filterType = $("filterType");

      const client = $("client");
      const type = $("type");
      const description = $("description");
      const date = $("date");
      const montant = $("montant");
      const paye = $("paye");

      const exportJsonBtn = $("exportJson");
      const exportCsvBtn = $("exportCsv");
      const importJsonInput = $("importJson");
      const clearAllBtn = $("clearAll"); // (pas pr√©sent dans le HTML, ok si null)
      const resetBtn = $("reset");
      const addDemoBtn = $("addDemo");
      const captureBtn = $("captureRecap");
      const followupList = $("followupList");
      const followupCounts = $("followupCounts");

      const WHATSAPP_LEVELS = [
        {
          threshold: 15,
          label: "Relance 15j",
          template: `Salut [Pr√©nom],\nPetit rappel concernant ta prestation : il te reste encore 15 jours pour finaliser le r√®glement du solde.\nN‚Äôh√©site pas √† me contacter si tu as la moindre question.\n√Ä bient√¥t.`,
          tone: "soft"
        },
        {
          threshold: 30,
          label: "Relance 30j",
          template: `Bonjour [Pr√©nom],\nLa date limite des 30 jours pour le r√®glement du solde est atteinte.\nMerci de r√©gulariser la situation rapidement afin de conserver la r√©servation de la prestation.\nJe reste disponible si besoin.`,
          tone: "firm"
        },
        {
          threshold: 45,
          label: "Relance 45j (critique)",
          template: `Bonjour [Pr√©nom],\nCela fait d√©sormais 45 jours que le solde est en attente malgr√© mes pr√©c√©dentes relances.\nMerci de r√©gulariser la situation imm√©diatement afin d'√©viter toute interruption de la prestation.\nJe reste disponible en cas de besoin.`,
          tone: "critical"
        }
      ];

      let data = [];
      let editingId = null;

      const log = (...args) => {
        if (debugChk && debugChk.checked) {
          console.log("[DEBUG]", ...args);
          if (debugOut) {
            debugOut.textContent = String(args.join(" "));
          }
        }
      };

      function ts(){
        const d=new Date();
        const p=n=>String(n).padStart(2,"0");
        return d.getFullYear()+"-"+p(d.getMonth()+1)+p(d.getDate())+"_"+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds());
      }

      const supportsLocalStorage = (() => {
        try {
          const k = "__test_ls__";
          localStorage.setItem(k,"1");
          localStorage.removeItem(k);
          return true;
        } catch(e) {
          return false;
        }
      })();

      function showStatus(msg, ok=true){
        if(!status) return;
        status.className = "alert " + (ok ? "alert-ok" : "alert-err");
        status.textContent = msg;
        status.style.display = "block";
        clearTimeout(showStatus._t);
        showStatus._t = setTimeout(() => { status.style.display = "none"; }, 4000);
      }

      function persist(){
        if(!supportsLocalStorage) return;
        try {
          localStorage.setItem(storageKey, JSON.stringify(data));
          log("persist ok", data.length);
        } catch(e) {
          console.error(e);
          showStatus("Erreur de sauvegarde locale : " + e.message, false);
        }
      }

      function load(){
        if(!supportsLocalStorage){
          if(lsStatus){
            lsStatus.textContent = "LocalStorage indisponible (mode secours).";
          }
          return;
        }
        if(lsStatus){
          lsStatus.textContent = "LocalStorage actif.";
        }
        try {
          const raw = localStorage.getItem(storageKey);
          if(!raw) return;
          data = JSON.parse(raw) || [];
        } catch(e) {
          console.error(e);
          showStatus("Impossible de lire les donn√©es locales.", false);
        }
      }

      function sanitizeAmount(v) {
        if (typeof v === "number") return v;
        let s = (v||"").toString().trim();
        s = s.replace(/\s/g,"").replace(",", "."); // french decimal
        const num = parseFloat(s);
        return isFinite(num) ? num : NaN;
      }

      function getPaid(r){ return Number(r.paidAmount || 0); }
      function getRemaining(r){ return Math.max(0, Number((r.montant||0) - getPaid(r))); }
      function isSettled(r){ return getRemaining(r) <= 0.00001; }

      function daysSince(datestr){
        if(!datestr) return null;
        const d = new Date(datestr);
        if(Number.isNaN(d.getTime())) return null;
        const now = new Date();
        const diff = now - d;
        if(diff < 0) return 0;
        return Math.floor(diff / (1000*60*60*24));
      }

      function extractFirstName(full){
        if(!full) return "client";
        const parts = full.trim().split(/\s+/);
        return parts[0] || "client";
      }

      function buildWhatsAppUrl(name, level){
        const targetName = name || "client";
        const message = (level?.template || "").replace("[Pr√©nom]", targetName);
        return "https://wa.me/?text=" + encodeURIComponent(message);
      }

      function filterRecords(list){
        const q = (search?.value || "").toLowerCase();
        const fStatus = filterStatus?.value || "all";
        const fType = filterType?.value || "all";

        return list.filter(r => {
          if(q){
            const blob = [r.client,r.type,r.description].join(" ").toLowerCase();
            if(!blob.includes(q)) return false;
          }
          if(fType !== "all" && r.type !== fType) return false;
          if(fStatus !== "all"){
            const settled = isSettled(r);
            const paid = getPaid(r) > 0;
            if(fStatus === "paid" && !settled) return false;
            if(fStatus === "unpayed" && (paid || settled)) return false;
            if(fStatus === "partial" && (!paid || settled)) return false;
          }
          return true;
        });
      }

      function updateTotals(records){
        const list = Array.isArray(records) ? records : [];
        const totals = list.reduce((acc, r = {}) => {
          const m = Number(r.montant || 0);
          const p = getPaid(r);
          acc.totalMontant += m;
          acc.totalRecu += p;
          acc.totalRestant += Math.max(0, m - p);
          return acc;
        }, {totalMontant:0, totalRecu:0, totalRestant:0});

        if(totalMontantEl) totalMontantEl.textContent = eur(totals.totalMontant);
        if(totalRecuEl) totalRecuEl.textContent = eur(totals.totalRecu);
        if(totalRestantEl) totalRestantEl.textContent = eur(totals.totalRestant);

        return totals;
      }

      function buildMobileRecap(records, totals){
        const zone = document.getElementById("capture-mobile");
        if(!zone){
          throw new Error("Zone de capture introuvable pour le r√©capitulatif mobile.");
        }

        if(!Array.isArray(records)){
          throw new Error("getFilteredRecords() n'a pas renvoy√© un tableau.");
        }
        if(typeof records.length !== "number" || records.length < 0){
          throw new Error("records.length est invalide pour la capture mobile.");
        }

        const list = Array.isArray(records) ? records : [];
        const totalRestant = list.reduce((acc, r = {}) => acc + Math.max(0, getRemaining(r)), 0);
        const summary = { totalRestant };

        const now = new Date();
        const dateStr = now.toLocaleString("fr-FR", {
          day:"2-digit", month:"2-digit", year:"numeric",
          hour:"2-digit", minute:"2-digit"
        });

        zone.innerHTML = "";

        const header = document.createElement("div");
        header.className = "cap-header";

        const headerLogo = document.querySelector(".nav-left .logo-wrap");
        if(!headerLogo){
          throw new Error("Logo source introuvable pour la capture mobile.");
        }
        const clonedLogo = headerLogo.cloneNode(true);
        clonedLogo.classList.add("cap-logo-clone");
        clonedLogo.removeAttribute("href");
        const clonedImg = clonedLogo.querySelector("img");
        if(!clonedImg){
          throw new Error("Image du logo introuvable pour la capture mobile.");
        }
        clonedImg.style.opacity = "1";
        clonedImg.style.visibility = "visible";
        clonedImg.style.display = "block";
        header.appendChild(clonedLogo);

        const title = document.createElement("div");
        title.className = "cap-title";
        title.textContent = "R√©capitulatif des prestations";
        const sub = document.createElement("div");
        sub.className = "cap-sub";
        sub.textContent = "G√©n√©r√© le " + dateStr;
        header.appendChild(title);
        header.appendChild(sub);
        zone.appendChild(header);

        const summaryWrap = document.createElement("div");
        summaryWrap.className = "cap-summary";
        const kpi = document.createElement("div");
        kpi.className = "cap-kpi due";
        const l = document.createElement("div");
        l.className = "label";
        l.textContent = "Restant d√ª total";
        const v = document.createElement("div");
        v.className = "value";
        v.textContent = eur(summary.totalRestant || 0);
        kpi.appendChild(l);
        kpi.appendChild(v);
        summaryWrap.appendChild(kpi);
        zone.appendChild(summaryWrap);

        if(!list.length){
          const empty = document.createElement("div");
          empty.className = "cap-item";
          empty.textContent = "Aucune prestation ne correspond aux filtres.";
          zone.appendChild(empty);
          return summary;
        }

        const frag = document.createDocumentFragment();
        list.forEach(r => {
          const remaining = getRemaining(r);
          const paid = getPaid(r);
          const percent = (r.montant && r.montant > 0) ? Math.min(100, Math.round(paid/r.montant*100)) : 0;

          let cls, label;
          if(isSettled(r)){
            cls = "paid"; label = "Pay√©";
          }else if(paid > 0){
            cls = "partial"; label = "Partiel";
          }else{
            cls = "muted"; label = "Non pay√©";
          }

          const item = document.createElement("div");
          item.className = "cap-item";
          item.innerHTML = `
            <div class="cap-client">${r.client || ""}</div>
            <div class="cap-subtitle">${(r.type || "")}${r.description ? " ‚Äî " + r.description : ""}</div>
            <div class="cap-row"><span>Date</span><span>${r.date || ""}</span></div>
            <div class="cap-row"><span>Factur√©</span><span>${eur(r.montant || 0)}</span></div>
            <div class="cap-row"><span>Re√ßu</span><span>${eur(paid)}</span></div>
            <div class="cap-row"><span>Restant</span><span>${eur(remaining)}</span></div>
            <div class="cap-progress-wrap">
              <div class="cap-row-progress-label">
                <span>Avancement</span>
                <span>${percent} %</span>
              </div>
              <div class="progress">
                <div class="progress-inner" style="width:${percent}%;"></div>
              </div>
            </div>
            <div class="cap-row">
              <span>Statut</span>
              <span class="status-pill ${cls}">
                <span class="dot"></span>
                <span>${label}</span>
              </span>
            </div>
          `;
          frag.appendChild(item);
        });
        zone.appendChild(frag);

        return summary;
      }

      function updateFollowUps(){
        if(!followupList) return;

        followupList.innerHTML = "";
        let soft = 0, firm = 0, critical = 0;

        const items = data
          .map(r => ({...r, days: daysSince(r.date), remaining: getRemaining(r)}))
          .filter(r => r.remaining > 0 && r.days !== null && r.days >= 15)
          .sort((a,b) => (b.days||0) - (a.days||0));

        if(!items.length){
          const empty = document.createElement("div");
          empty.className = "small";
          empty.textContent = "Aucune relance n√©cessaire pour le moment.";
          followupList.appendChild(empty);
          if(followupCounts) followupCounts.textContent = "0 relance en attente";
          return;
        }

        items.forEach(r => {
          const urgency = (r.days || 0) >= 45 ? "critical" : (r.days || 0) >= 30 ? "firm" : "soft";
          if(urgency === "critical") critical++; else if(urgency === "firm") firm++; else soft++;

          const item = document.createElement("div");
          item.className = "cap-item followup-card";

          const actionLabel = urgency === "critical" ? "Relance critique" : urgency === "firm" ? "Relance urgente" : "Relance √† pr√©voir";
          const pillClass = urgency === "critical" ? "critical" : (urgency === "firm" ? "muted" : "partial");
          const actionIcon = urgency === "critical" ? "üö®" : urgency === "firm" ? "üöÄ" : "üå±";
          const paceLabel = urgency === "critical" ? "Critique" : urgency === "firm" ? "Prioritaire" : "Douce";
          const availableLevels = WHATSAPP_LEVELS.filter(level => (r.days || 0) >= level.threshold);

          item.innerHTML = `
            <div class="followup-head">
              <div>
                <div class="cap-client">${r.client || "Client"}</div>
                <div class="cap-subtitle">${r.type || ""}${r.description ? " ‚Äî " + r.description : ""}</div>
              </div>
              <span class="status-pill ${pillClass} followup-pill">
                <span class="dot"></span>
                <span>${actionIcon} ${actionLabel}</span>
              </span>
            </div>
            <div class="followup-meta">
              <div class="followup-stat">
                <span class="label">üí∂ Restant d√ª</span>
                <span class="value">${eur(r.remaining)}</span>
              </div>
              <div class="followup-stat">
                <span class="label">‚è≥ Anciennet√©</span>
                <span class="value">${r.days} jours</span>
              </div>
              <div class="followup-stat">
                <span class="label">üí¨ Niveau WhatsApp</span>
                <span class="value">${paceLabel}</span>
              </div>
            </div>
          `;

          const actions = document.createElement("div");
          actions.className = "followup-actions";

          const hint = document.createElement("div");
          hint.className = "small";
          hint.textContent = "Messages pr√™ts :";
          actions.appendChild(hint);

          const btnRow = document.createElement("div");
          btnRow.className = "followup-btn-row";

          availableLevels.forEach(level => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = `btn relance-btn relance-${level.tone}`;
            btn.textContent = level.label;
            btn.addEventListener("click", () => {
              const url = buildWhatsAppUrl(extractFirstName(r.client), level);
              window.open(url, "_blank", "noopener");
            });
            btnRow.appendChild(btn);
          });

          actions.appendChild(btnRow);
          item.appendChild(actions);

          followupList.appendChild(item);
        });

        if(followupCounts){
          const parts = [];
          if(soft) parts.push(`${soft} √† relancer`);
          if(firm) parts.push(`${firm} urgentes`);
          if(critical) parts.push(`${critical} critiques`);
          followupCounts.textContent = parts.join(" ‚Ä¢ ");
        }
      }

      function render(){
        if(!tbody) return;
        tbody.innerHTML = "";

        const records = filterRecords(data);
        if(!records.length){
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 10;
          td.className = "small";
          td.textContent = "Aucune prestation ne correspond.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          const totals = updateTotals(records);
          buildMobileRecap(records, totals);
          updateFollowUps();
          return;
        }

        records.sort((a,b) => {
          const da = a.date || "";
          const db = b.date || "";
          return da.localeCompare(db);
        });

        records.forEach(r => {
          const tr = document.createElement("tr");

          const tdDate = document.createElement("td");
          tdDate.textContent = r.date || "";
          tr.appendChild(tdDate);

          const tdClient = document.createElement("td");
          const c1 = document.createElement("div");
          c1.textContent = r.client || "";
          c1.style.fontWeight = "600";
          const c2 = document.createElement("div");
          c2.className = "small";
          c2.textContent = (r.type || "") + (r.description ? " ‚Äî " + r.description : "");
          tdClient.appendChild(c1);
          tdClient.appendChild(c2);
          tr.appendChild(tdClient);

          const tdMontant = document.createElement("td");
          tdMontant.textContent = eur(r.montant || 0);
          tr.appendChild(tdMontant);

          const tdRecu = document.createElement("td");
          tdRecu.textContent = eur(getPaid(r));
          tr.appendChild(tdRecu);

          const remaining = getRemaining(r);
          const tdRestant = document.createElement("td");
          tdRestant.textContent = eur(remaining);
          tr.appendChild(tdRestant);

          const tdProgress = document.createElement("td");
          const wrapper = document.createElement("div");
          wrapper.className = "small";
          const percent = (r.montant && r.montant > 0) ? Math.min(100, Math.round(getPaid(r)/r.montant*100)) : 0;
          wrapper.textContent = percent + " %";
          const bar = document.createElement("div");
          bar.className = "progress";
          const inner = document.createElement("div");
          inner.className = "progress-inner";
          inner.style.width = percent + "%";
          bar.appendChild(inner);
          tdProgress.appendChild(wrapper);
          tdProgress.appendChild(bar);
          tr.appendChild(tdProgress);

          const tdStatus = document.createElement("td");
          const pill = document.createElement("span");
          pill.className = "status-pill";
          const dot = document.createElement("span");
          dot.className = "dot";
          pill.appendChild(dot);
          const label = document.createElement("span");
          let cls = "";
          if(isSettled(r)){
            cls = "paid";
            label.textContent = "Pay√©";
          }else if(getPaid(r) > 0){
            cls = "partial";
            label.textContent = "Partiel";
          }else{
            cls = "muted";
            label.textContent = "Non pay√©";
          }
          pill.classList.add(cls);
          pill.appendChild(label);
          tdStatus.appendChild(pill);
          tr.appendChild(tdStatus);

          const tdActions = document.createElement("td");
          const encBtn = document.createElement("button");
          encBtn.type = "button";
          encBtn.className = "btn btn-primary";
          encBtn.textContent = "Encaisser";
          encBtn.addEventListener("click", () => {
            let max = getRemaining(r);
            if(max <= 0){
              showStatus("Tout est d√©j√† pay√© pour cette prestation.", false);
              return;
            }
            const s = prompt("Montant √† encaisser (max " + eur(max) + "):", "");
            if(s===null) return;
            const val = sanitizeAmount(s);
            if(!isFinite(val) || val<=0){
              showStatus("Montant invalide.", false);
              return;
            }
            if(val > max + 0.00001){
              showStatus("Montant sup√©rieur au restant d√ª.", false);
              return;
            }
            r.paidAmount = (r.paidAmount || 0) + val;
            persist();
            updateTotals(filterRecords(data));
            render();
            showStatus("Paiement enregistr√©.");
          });

          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.className = "btn btn-outline";
          editBtn.textContent = "Modifier";
          editBtn.addEventListener("click", () => {
            editingId = r.id;
            client.value = r.client || "";
            type.value = r.type || "Clip";
            description.value = r.description || "";
            date.value = r.date || "";
            montant.value = r.montant != null ? String(r.montant) : "";
            paye.checked = isSettled(r);
            window.scrollTo({top:0, behavior:"smooth"});
          });

          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "btn btn-outline";
          delBtn.textContent = "Supprimer";
          delBtn.addEventListener("click", () => {
            if (confirm("Supprimer cette prestation ?")) {
              data = data.filter(x => x.id !== r.id);
              persist();
              updateTotals(filterRecords(data));
              render();
              if (editingId === r.id) editingId = null;
              showStatus("Prestation supprim√©e.");
            }
          });

          tdActions.appendChild(encBtn);
          tdActions.appendChild(editBtn);
          tdActions.appendChild(delBtn);
          tr.appendChild(tdActions);

          tbody.appendChild(tr);
        });

        const totals = updateTotals(records);
        buildMobileRecap(records, totals);
        updateFollowUps();
      }

      function captureRecap(records){
        console.log("CAPTURE 0: d√©marrage captureRecap");
        try{
          console.log("CAPTURE 1: r√©cup√©ration records");
          const base = Array.isArray(records) ? records : (data || []);
          if(!Array.isArray(base)){
            throw new Error("getFilteredRecords() n'a pas renvoy√© un tableau.");
          }
          console.log("CAPTURE 2: application des filtres");
          const list = filterRecords(base);
          if(!Array.isArray(list)){
            throw new Error("getFilteredRecords() n'a pas renvoy√© un tableau.");
          }
          if(typeof list.length !== "number" || list.length < 0){
            throw new Error("records.length est invalide pour la capture.");
          }
          if(!list.length){
            showStatus("Aucune prestation √† capturer (v√©rifie les filtres).", false);
            return;
          }

          console.log("CAPTURE 3: r√©cup√©ration du conteneur de capture");
          const zone = document.getElementById("capture-mobile");
          if(!zone){
            throw new Error("Conteneur #capture-mobile introuvable.");
          }
          if(!(zone instanceof HTMLElement)){
            throw new Error("√âl√©ment de capture invalide.");
          }

          console.log("CAPTURE 4: buildMobileRecap en cours");
          const totals = buildMobileRecap(list);
          if(!totals){
            throw new Error("buildMobileRecap n'a pas renvoy√© de totaux.");
          }
          console.log("CAPTURE 5: buildMobileRecap OK, pr√©paration html2canvas");

          if(typeof html2canvas !== "function"){
            throw new Error("html2canvas indisponible pour la capture.");
          }

          const bg = document.documentElement.getAttribute("data-theme") === "light"
            ? "#f3f4f6"
            : "#020617";

          const prevDisplay = zone.style.display;
          const prevVisibility = zone.style.visibility;
          zone.style.display = "block";
          zone.style.visibility = "visible";

          const launchCapture = () => {
            console.log("CAPTURE 6: html2canvas lanc√©");
            html2canvas(zone, {
              backgroundColor: bg,
              scale: 2,
              useCORS: true,
              allowTaint: true
            }).then(canvas => {
              console.log("CAPTURE 7: html2canvas OK, cr√©ation du lien de t√©l√©chargement");
              const link = document.createElement("a");
              link.download = "recap_prestations_mobile_"+ts()+".png";
              link.href = canvas.toDataURL("image/png");
              link.click();
              showStatus("R√©capitulatif captur√© (format mobile) !");
            }).catch(err => {
              console.error("CAPTURE ERREUR html2canvas", err);
              if(err && err.stack) console.error(err.stack);
              alert(err?.message || "Erreur lors de l'ex√©cution de html2canvas.");
            }).finally(() => {
              zone.style.display = prevDisplay;
              zone.style.visibility = prevVisibility;
            });
          };

          if(typeof requestAnimationFrame === "function"){
            requestAnimationFrame(() => requestAnimationFrame(launchCapture));
          }else{
            setTimeout(launchCapture, 0);
          }
        }catch(err){
          console.error("CAPTURE ERREUR inattendue", err);
          if(err && err.stack) console.error(err.stack);
          alert(err && err.message ? err.message : "Erreur lors de la capture du r√©capitulatif.");
        }
      }

      function resetForm(){
        if(!formEl) return;
        client.value = "";
        type.value = "Clip";
        description.value = "";
        date.value = "";
        montant.value = "";
        paye.checked = false;
        editingId = null;
      }

      function validateForm(){
        const c = client.value.trim();
        if(!c){
          showStatus("Le nom du client est obligatoire.", false);
          client.focus();
          return null;
        }
        const m = sanitizeAmount(montant.value);
        if(!isFinite(m) || m<=0){
          showStatus("Montant invalide.", false);
          montant.focus();
          return null;
        }
        const d = date.value || new Date().toISOString().slice(0,10);
        return {client:c, type:type.value, description:description.value.trim(), date:d, montant:m};
      }

      function addRecord(rec){
        rec.id = rec.id || Date.now() + Math.random();
        rec.paidAmount = rec.paidAmount || 0;
        data.push(rec);
      }

      if(formEl){
        formEl.addEventListener("submit", (e) => {
          e.preventDefault();
          const rec = validateForm();
          if(!rec) return;

          if(editingId){
            const idx = data.findIndex(r => r.id === editingId);
            if(idx !== -1){
              data[idx] = {
                ...data[idx],
                ...rec
              };
              showStatus("Prestation modifi√©e.");
            }
            editingId = null;
          } else {
            if(paye.checked){
              rec.paidAmount = rec.montant;
            }
            addRecord(rec);
            showStatus("Prestation ajout√©e.");
          }

          persist();
          render();
          resetForm();
        });
      }

      if(resetBtn){
        resetBtn.addEventListener("click", () => {
          resetForm();
        });
      }

      if(addDemoBtn){
        addDemoBtn.addEventListener("click", () => {
          const demo = {
            client:"Artiste d√©mo",
            type:"Clip",
            description:"Clip test d√©mo",
            date:new Date().toISOString().slice(0,10),
            montant:800,
            paidAmount:200
          };
          addRecord(demo);
          persist();
          render();
          showStatus("D√©mo ajout√©e.");
        });
      }

      if(exportJsonBtn){
        exportJsonBtn.addEventListener("click", () => {
          try{
            const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "prestations_"+ts()+".json";
            a.click();
            URL.revokeObjectURL(a.href);
            showStatus("Export JSON t√©l√©charg√©.");
          }catch(e){
            console.error(e);
            showStatus("Erreur export JSON : " + e.message, false);
          }
        });
      }

      if(exportCsvBtn){
        exportCsvBtn.addEventListener("click", () => {
          try{
            let csv = "date;client;type;description;montant;recu;restant\n";
            data.forEach(r => {
              csv += [
                r.date || "",
                r.client || "",
                r.type || "",
                (r.description||"").replace(/\n/g," "),
                r.montant || 0,
                getPaid(r),
                getRemaining(r)
              ].map(v => String(v).replace(/;/g,",")).join(";") + "\n";
            });
            const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "prestations_"+ts()+".csv";
            a.click();
            URL.revokeObjectURL(a.href);
            showStatus("Export CSV t√©l√©charg√©.");
          }catch(e){
            console.error(e);
            showStatus("Erreur export CSV : " + e.message, false);
          }
        });
      }

      if(importJsonInput){
        importJsonInput.addEventListener("change", async (e) => {
          const file = e.target.files && e.target.files[0];
          if(!file) return;
          try{
            const txt = await file.text();
            const arr = JSON.parse(txt);
            if(!Array.isArray(arr)) throw new Error("Format JSON invalide");
            data = arr.map(r => ({
              id: r.id || Date.now()+Math.random(),
              client: r.client || "",
              type: r.type || "Clip",
              description: r.description || "",
              date: r.date || "",
              montant: Number(r.montant||0),
              paidAmount: Number(r.paidAmount||0)
            }));
            persist();
            render();
            showStatus("Import JSON r√©ussi.");
          }catch(err){
            console.error(err);
            showStatus("Erreur import JSON : " + err.message, false);
          }finally{
            importJsonInput.value = "";
          }
        });
      }

      if(clearAllBtn){
        clearAllBtn.addEventListener("click", () => {
          if(confirm("Effacer TOUTES les prestations ?")){
            data = [];
            persist();
            render();
            showStatus("Tous les enregistrements ont √©t√© supprim√©s.");
          }
        });
      }

      if(debugChk){
        debugChk.addEventListener("change", () => {
          const zone = document.getElementById("debug-zone");
          if(zone) zone.style.display = debugChk.checked ? "block" : "none";
        });
      }

      if (search) {
        search.addEventListener("input", () => {
          render();
        });
      }
      if (filterStatus) {
        filterStatus.addEventListener("change", render);
      }
      if (filterType) {
        filterType.addEventListener("change", render);
      }

      /* ==== Capture pour "Prestations enregistr√©es" ==== */
if (captureBtn && typeof html2canvas !== "undefined") {
  captureBtn.addEventListener("click", () => {
    captureRecap(filterRecords(data));
  });
}

      load();
      render();
      showStatus(
        supportsLocalStorage ? "Sauvegarde locale active." : "Mode secours actif (stockage bloqu√©).",
        supportsLocalStorage
      );
      log("init ok, version", VERSION);

    })();
  </script>

  <!-- SCRIPT BEATSENGINE -->
  <script>
    (function(){
      const styleSel = document.getElementById("beats-style");
      const keySel = document.getElementById("beats-key");
      const bpmInput = document.getElementById("beats-bpm");
      const durationInput = document.getElementById("beats-duration");
      const usageSel = document.getElementById("beats-usage");
      const usageMetaEl = document.getElementById("beats-usage-meta");
      const outputEl = document.getElementById("beats-output");
      const statusEl = document.getElementById("beats-status");
      const copyBtn = document.getElementById("beats-copy");
      const shuffleBtn = document.getElementById("beats-shuffle");
      const generateBtn = document.getElementById("beats-generate");
      const instrumentInputs = Array.from(document.querySelectorAll(".beats-instrument"));
      const chordsEl = document.getElementById("beats-chords");
      const bpmRangeEl = document.getElementById("beats-bpm-range");
      const energyDescEl = document.getElementById("beats-energy-desc");
      const energyNoteEl = document.getElementById("beats-energy-note");
      const energyChips = Array.from(document.querySelectorAll("#beats-energy .energy-chip"));
      const energyRadios = Array.from(document.querySelectorAll('input[name="beats-energy"]'));
      const structureListEl = document.getElementById("structure-list");
      const structureInput = document.getElementById("structure-input");
      const structureAddBtn = document.getElementById("structure-add");
      const structureResetBtn = document.getElementById("structure-reset");
      const progressionOptionsEl = document.getElementById("progression-options");
      const beatsProgressionEl = document.getElementById("beats-progression");
      const beatsProgressionChordsEl = document.getElementById("beats-progression-chords");
      const danceChips = Array.from(document.querySelectorAll("#beats-danceability .dance-chip"));
      const danceRadios = Array.from(document.querySelectorAll('input[name="beats-dance"]'));
      const danceNoteEl = document.getElementById("beats-dance-note");
      const vocalChips = Array.from(document.querySelectorAll("#vocal-modes .vocal-chip"));
      const vocalRadios = Array.from(document.querySelectorAll('input[name="vocal-mode"]'));
      const durationRange = document.getElementById("beats-duration-range");
      const melodyWarning = document.getElementById("melody-warning");

      if(!styleSel || !keySel || !bpmInput || !outputEl || !structureListEl) return;

      const chordsMap = {};

      const progressionMap = {
        "Afro-Trap":["i ‚Äì VI ‚Äì III ‚Äì VII","i ‚Äì v ‚Äì i ‚Äì VII","i ‚Äì III ‚Äì VI ‚Äì VII"],
        "Afro-Trap Club":["i ‚Äì VI ‚Äì III ‚Äì VII","i ‚Äì v ‚Äì i ‚Äì VII","i ‚Äì III ‚Äì VI ‚Äì VII"],
        "Afrobeat":["I ‚Äì V ‚Äì vi ‚Äì IV","i ‚Äì VI ‚Äì III ‚Äì VII","i ‚Äì VII ‚Äì VI ‚Äì VII"],
        "Afropop":["I ‚Äì V ‚Äì vi ‚Äì IV","i ‚Äì VI ‚Äì III ‚Äì VII","i ‚Äì VII ‚Äì VI ‚Äì VII"],
        "Bongo Flava":["I ‚Äì V ‚Äì vi ‚Äì IV","i ‚Äì VI ‚Äì III ‚Äì VII","i ‚Äì VII ‚Äì VI ‚Äì VII"],
        "Reggae":["I ‚Äì IV ‚Äì V","I ‚Äì V ‚Äì IV","vi ‚Äì IV ‚Äì I ‚Äì V"],
        "Zouk":["I ‚Äì IV ‚Äì V","I ‚Äì V ‚Äì IV","vi ‚Äì IV ‚Äì I ‚Äì V"],
        "Reggaeton":["i ‚Äì VI ‚Äì VII","vi ‚Äì IV ‚Äì I ‚Äì V","i ‚Äì VII ‚Äì VI"],
        "Moombahton":["i ‚Äì VI ‚Äì VII","vi ‚Äì IV ‚Äì I ‚Äì V","i ‚Äì VII ‚Äì VI"],
        "Dancehall":["i ‚Äì VII ‚Äì VI ‚Äì VII","i ‚Äì VI ‚Äì VII","i ‚Äì III ‚Äì VI ‚Äì VII"],
        "Shatta":["i ‚Äì VII ‚Äì VI ‚Äì VII","i ‚Äì VI ‚Äì VII","i ‚Äì III ‚Äì VI ‚Äì VII"],
        "Amapiano":["i ‚Äì v ‚Äì i ‚Äì VII","i ‚Äì VI ‚Äì III ‚Äì VII","i ‚Äì VII ‚Äì VI ‚Äì VII"],
        "R&B":["i ‚Äì VI ‚Äì III ‚Äì VII","vi ‚Äì IV ‚Äì I ‚Äì V","i ‚Äì VII ‚Äì VI ‚Äì VII"],
        "Drill":["i ‚Äì VI ‚Äì III ‚Äì VII","i ‚Äì VII ‚Äì VI ‚Äì VII","i ‚Äì III ‚Äì VI ‚Äì VII"]
      };

      const bpmMap = {
        "Afro-Trap":[95,115],
        "Afro-Trap Club":[100,118],
        "R&B":[72,92],
        "Drill":[135,150],
        "Dancehall":[90,105],
        "Afrobeat":[100,120],
        "Afropop":[102,118],
        "Bongo Flava":[95,112],
        "Amapiano":[103,115],
        "Zouk":[85,100],
        "Reggae":[78,92],
        "Reggaeton":[86,98],
        "Moombahton":[100,110],
        "Shatta":[96,112]
      };

      const vibeMap = {
        "Afro-Trap":"afro swing bounce, syncopated percussions, trap gloss and modern club sheen.",
        "Afro-Trap Club":"dancefloor afro-trap, neon synths, tight drums and crowd-ready drops.",
        "R&B":"silky R&B textures, lush chords, intimate drums and smooth ambience.",
        "Drill":"cinematic drill tension, sliding 808s, moody pads and syncopated hats.",
        "Dancehall":"island groove with skanking guitars, playful percs, warm low-end and hooks.",
        "Afrobeat":"polyrhythmic afrobeat pulse, brass stabs, guitar licks and steady groove.",
        "Afropop":"sunny afro-pop sheen, catchy toplines, bouncy drums and bright textures.",
        "Bongo Flava":"east-afro fusion, polished percussions, airy keys and melodic hooks.",
        "Amapiano":"log drum rolls, shaker-driven groove, dreamy keys and late-night atmosphere.",
        "Zouk":"smooth zouk sway, silky guitars, romantic pads and mid-tempo bounce.",
        "Reggae":"roots groove, off-beat skank, warm bass and relaxed pocket.",
        "Reggaeton":"latin club swing, perreo drums, crisp claps and sensual bounce.",
        "Moombahton":"electro-latin push, mid-tempo drive, heavy drums and festival energy.",
        "Shatta":"dancehall-inspired shatta grit, percussive chops and assertive groove."
      };

      const energyMap = {
        low: {
          label: "low",
          note: "Low ‚Üí minimal, smooth, spacious",
          texture: "minimal dynamics, airy ambience, plenty of space between elements"
        },
        medium: {
          label: "medium",
          note: "Medium ‚Üí balanced, groove-focused",
          texture: "balanced groove, clean transients, pocketed swing and tasteful layers"
        },
        high: {
          label: "high",
          note: "High ‚Üí aggressive, powerful, club-ready",
          texture: "aggressive drums, forward low-end, club-ready punch and bold synth leads"
        }
      };

      const danceabilityMap = {
        low: {
          label:"low",
          note:"Low ‚Üí laid-back groove",
          texture:"laid-back groove, relaxed syncopation, room for storytelling"
        },
        medium: {
          label:"medium",
          note:"Medium ‚Üí smooth bounce",
          texture:"smooth bounce, pocketed swing, body-friendly groove"
        },
        high: {
          label:"high",
          note:"High ‚Üí strong rhythmic drive, club-focused",
          texture:"strong rhythmic drive, club-focused cadence, infectious movement"
        }
      };

      const vocalModeMap = {
        "vocal-first":{
          label:"vocal-first",
          arrangement:"vocal-first arrangement, no competing lead melody, instrumental supportive, not dominant, clear space for human vocals",
          mix:"strong rhythmic groove with clean vocal pocket, instrumental supportive not dominant"
        },
        "balanced":{
          label:"balanced",
          arrangement:"balanced vocal/instrument layout, controlled counter-melodies, supportive pads",
          mix:"vocals and instruments share space with controlled dynamics"
        },
        "instrumental-lead":{
          label:"instrumental-lead",
          arrangement:"instrumental hooks upfront, vocals weaving around the lead motif",
          mix:"lead melody forward, vocals ride the groove without clashing"
        }
      };

      const styles = Array.from(styleSel.options).map(o => o.value);
      const keys = Array.from(keySel.options).map(o => o.value);
      const defaultStructure = ["Intro","Couplet","Refrain","Pont","Drop","Outro"];
      const structurePresets = {
        singer:["Intro","Couplet","Refrain","Refrain","Pont","Refrain","Outro"],
        rapper:["Intro","Couplet","Couplet","Refrain","Pont","Refrain","Outro"],
        club:["Intro","Refrain","Drop","Refrain","Drop","Outro"]
      };
      const usageMap = {
        radio:   { label:"Radio", icon:"üìª",   min:"2:00", ideal:"2:40 ‚Äì 2:55",   default:"2:50",  structure:"format radio compact, intro courte, refrain rapide" },
        streaming:{label:"Streaming", icon:"üéß", min:"1:50", ideal:"2:10 ‚Äì 2:50", default:"2:30",  structure:"optimis√© streaming, hook rapide, transitions fluides" },
        club:    { label:"Club", icon:"üîä",   min:"2:45", ideal:"3:00 ‚Äì 3:30",   default:"3:15",  structure:"sections r√©p√©tables pour DJ, drops marqu√©s" },
        dj:      { label:"DJ / Extended", icon:"üéõÔ∏è", min:"3:30", ideal:"4:00 ‚Äì 4:30", default:"4:15", structure:"intro/outro longues, mix-friendly, progression progressive" },
        emotion: { label:"Chant / √âmotion", icon:"‚ù§Ô∏è", min:"2:40", ideal:"3:00 ‚Äì 3:30", default:"3:10", structure:"ballad/slow sway, refrain ample, espace pour la voix" }
      };
      let structure = [...defaultStructure];
      let draggingIndex = null;
      let selectedProgression = progressionMap[styleSel.value]?.[0] || "i ‚Äì VI ‚Äì III ‚Äì VII";

      const chromatic = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      const flatToSharp = {"Db":"C#","Eb":"D#","Gb":"F#","Ab":"G#","Bb":"A#"};

      function normalizeRoot(note){
        if(!note) return "A";
        return flatToSharp[note] || note;
      }

      function parseKey(keyStr){
        const parts = (keyStr || "A minor").split(" ");
        const root = normalizeRoot(parts[0]);
        const scale = (parts[1] || "minor").toLowerCase().includes("major") ? "major" : "minor";
        return {root, scale};
      }

      function generateScaleChords(keyStr){
        const {root, scale} = parseKey(keyStr);
        const intervals = scale === "major" ? [0,2,4,5,7,9,11] : [0,2,3,5,7,8,10];
        const qualities = scale === "major"
          ? ["maj","min","min","maj","maj","min","dim"]
          : ["min","dim","maj","min","min","maj","maj"];
        const mapping = {};
        const rootIndex = chromatic.indexOf(root);
        if(rootIndex === -1) return mapping;

        ["I","II","III","IV","V","VI","VII"].forEach((deg, idx) => {
          const note = chromatic[(rootIndex + intervals[idx]) % chromatic.length];
          const qual = qualities[idx];
          const chord = qual === "maj" ? note : qual === "min" ? `${note}m` : `${note}¬∞`;
          mapping[deg] = chord;
          mapping[deg.toLowerCase()] = chord;
        });
        return mapping;
      }

      function buildChordLibrary(){
        keys.forEach(k => {
          chordsMap[k] = generateScaleChords(k);
        });
      }

      function romanToDegree(r){
        const base = r.toUpperCase();
        const map = { "I":1,"II":2,"III":3,"IV":4,"V":5,"VI":6,"VII":7 };
        return map[base] || 1;
      }

      function chordFromRoman(roman, keyStr){
        const degree = romanToDegree(roman);
        const dict = chordsMap[keyStr] || {};
        const entry = dict[roman] || dict[roman.toUpperCase()] || dict[roman.toLowerCase()];
        if(entry){
          const root = entry.replace(/m|¬∞/g,"");
          const isMinor = roman === roman.toLowerCase();
          const isDim = roman.includes("¬∞");
          if(isDim) return `${root}¬∞`;
          if(isMinor) return `${root}m`;
          return entry.includes("m") && roman === roman.toUpperCase() ? entry.replace("m","") : entry;
        }
        const {root, scale} = parseKey(keyStr);
        const intervals = scale === "major" ? [0,2,4,5,7,9,11] : [0,2,3,5,7,8,10];
        const rootIndex = chromatic.indexOf(root);
        const note = chromatic[(rootIndex + intervals[degree-1]) % chromatic.length];
        const minor = roman === roman.toLowerCase();
        return minor ? `${note}m` : note;
      }

      function splitProgression(progress){
        return (progress || "").split("‚Äì").map(p => p.trim()).filter(Boolean);
      }

      function transposeProgression(progress, keyStr){
        const degrees = splitProgression(progress);
        const chords = degrees.map(r => chordFromRoman(r, keyStr));
        return {
          romanLine: progress,
          chordLine: chords.join(" ‚Äì ")
        };
      }

      function sanitizeBpm(value, range){
        const [min,max] = range || [80,160];
        const n = parseInt(value, 10);
        if(Number.isFinite(n)){
          return Math.max(min, Math.min(max, n));
        }
        return Math.round((min + max) / 2);
      }

      function describeStyle(style){
        return vibeMap[style] || "clean modern mix, energetic groove and tight arrangement.";
      }

      function currentEnergy(){
        const selected = energyRadios.find(r => r.checked);
        return selected ? selected.value : "medium";
      }

      function updateEnergyUI(){
        const value = currentEnergy();
        energyChips.forEach(chip => {
          const radio = chip.querySelector('input[name="beats-energy"]');
          chip.classList.toggle("active", radio && radio.value === value);
        });
        const meta = energyMap[value] || energyMap.medium;
        if(energyDescEl) energyDescEl.textContent = meta.note;
        if(energyNoteEl) energyNoteEl.textContent = meta.note;
      }

      function currentDanceability(){
        const selected = danceRadios.find(r => r.checked);
        return selected ? selected.value : "medium";
      }

      function updateDanceUI(){
        const value = currentDanceability();
        danceChips.forEach(chip => {
          const radio = chip.querySelector('input[name="beats-dance"]');
          chip.classList.toggle("active", radio && radio.value === value);
        });
        const meta = danceabilityMap[value] || danceabilityMap.medium;
        if(danceNoteEl) danceNoteEl.textContent = meta.note;
      }

      function currentVocalMode(){
        const selected = vocalRadios.find(r => r.checked);
        return selected ? selected.value : "vocal-first";
      }

      function updateVocalUI(){
        const value = currentVocalMode();
        vocalChips.forEach(chip => {
          const radio = chip.querySelector('input[name="vocal-mode"]');
          chip.classList.toggle("active", radio && radio.value === value);
        });
        enforceMelodyLimit();
      }

      /* Hard exclusion map : structural instruments requiring strict ban when unchecked (melodic/harmonic roles) */
      const HARD_EXCLUSION_ALIASES = {
        "guitar":"guitar",
        "electric guitar":"guitar",
        "acoustic guitar":"guitar",
        "piano / keys":"piano / keys",
        "piano":"piano / keys",
        "keys":"piano / keys",
        "strings":"strings",
        "string":"strings",
        "brass":"brass",
        "synth lead":"lead synth",
        "lead synth":"lead synth",
        "lead":"lead synth",
        "vox-like synths":"vox-like synths",
        "vox like synths":"vox-like synths",
        "vocal synth":"vox-like synths",
        "choirs":"choirs",
        "choir":"choirs"
      };

      function normalizeInstrumentName(name){
        return (name || "").toLowerCase().trim();
      }

      function isMelodicRole(role){
        const r = (role || "").toLowerCase();
        return r === "melody" || r === "harmonic" || r === "harmony";
      }

      function getInstrumentSelection(){
        const included = [];
        const excluded = [];
        const strictExclusions = new Set();

        instrumentInputs.forEach(input => {
          const name = (input.value || "").trim();
          if(!name) return;
          const role = input.dataset.role || "";
          const canonical = HARD_EXCLUSION_ALIASES[normalizeInstrumentName(name)];

          if(input.checked){
            included.push(name);
          } else {
            excluded.push(name);
            if(isMelodicRole(role) && canonical){
              strictExclusions.add(canonical);
            }
          }
        });

        if(!included.length){
          included.push("minimal percussions");
        }

        return {included, excluded, strictExclusions};
      }

      function buildStrictExclusionBlock(strictExclusions){
        if(!strictExclusions || !strictExclusions.size) return "";

        const lines = [];
        strictExclusions.forEach(name => {
          const label = normalizeInstrumentName(name);
          lines.push(
            `no ${label} in any form,`,
            `no rhythmic ${label},`,
            `no strumming patterns,`,
            `no ${label} textures,`,
            `no ${label}-like timbres`
          );
        });

        if(lines.length){
          const lastIdx = lines.length - 1;
          lines[lastIdx] = lines[lastIdx].replace(/,+$/, "");
        }

        return `strict exclusion:\n${lines.join("\n")}`;
      }

      function buildInstrumentLines(){
        const {included, excluded, strictExclusions} = getInstrumentSelection();
        const humanize = (list) => list.map(v => {
          if(v === "fx") return "FX";
          if(v === "atmospheres") return "atmospheres";
          return v;
        });
        const includedLine = `included instruments: ${humanize(included).join(", ")}`;
        const excludedLine = `excluded instruments: ${excluded.length ? humanize(excluded).join(", ") : "none"}`;
        const strictBlock = buildStrictExclusionBlock(strictExclusions);
        return {includedLine, excludedLine, strictBlock};
      }

      function enforceMelodyLimit(){
        const isVocalFirst = currentVocalMode() === "vocal-first";
        const melodic = instrumentInputs.filter(i => i.dataset.role === "melody" && i.checked);
        const overLimit = isVocalFirst && melodic.length > 1;
        instrumentInputs.forEach(input => {
          const wrapper = input.closest(".instrument-checkbox");
          if(wrapper){
            wrapper.classList.toggle("over-limit", overLimit && input.dataset.role === "melody" && input.checked);
          }
        });
        if(melodyWarning){
          melodyWarning.classList.toggle("visible", overLimit);
        }
      }

      function ensureStructure(){
        if(!Array.isArray(structure) || !structure.length){
          structure = [...defaultStructure];
        }
      }

      function renderStructure(){
        ensureStructure();
        structureListEl.innerHTML = "";

        structure.forEach((part, index) => {
          const li = document.createElement("li");
          li.className = "structure-item";
          li.draggable = true;
          li.dataset.index = index;

          const left = document.createElement("div");
          left.style.display = "flex";
          left.style.alignItems = "center";
          left.style.gap = "8px";

          const handle = document.createElement("span");
          handle.className = "drag-handle";
          handle.textContent = "‚†ø";
          left.appendChild(handle);

          const label = document.createElement("span");
          label.className = "structure-label";
          label.textContent = part;
          left.appendChild(label);

          const remove = document.createElement("button");
          remove.type = "button";
          remove.className = "structure-btn secondary";
          remove.textContent = "‚úï";
          remove.style.minWidth = "42px";
          remove.addEventListener("click", () => {
            structure.splice(index,1);
            renderStructure();
            generatePrompt();
          });

          li.appendChild(left);
          li.appendChild(remove);

          li.addEventListener("dragstart", () => {
            draggingIndex = index;
            li.classList.add("dragging");
          });
          li.addEventListener("dragend", () => {
            draggingIndex = null;
            li.classList.remove("dragging");
          });
          li.addEventListener("dragover", (e) => {
            e.preventDefault();
          });
          li.addEventListener("drop", (e) => {
            e.preventDefault();
            const targetIndex = Number(li.dataset.index);
            if(draggingIndex === null || Number.isNaN(targetIndex)) return;
            const [moved] = structure.splice(draggingIndex,1);
            structure.splice(targetIndex,0,moved);
            draggingIndex = null;
            renderStructure();
            generatePrompt();
          });

          structureListEl.appendChild(li);
        });
      }

      function addStructurePart(){
        const value = (structureInput.value || "").trim();
        if(!value) return;
        structure.push(value);
        structureInput.value = "";
        renderStructure();
        generatePrompt();
      }

      function resetStructure(){
        structure = [...defaultStructure];
        renderStructure();
        generatePrompt();
      }

      function applyPreset(name){
        const preset = structurePresets[name];
        if(Array.isArray(preset)){
          structure = [...preset];
          renderStructure();
          generatePrompt();
        }
      }

      function formatDuration(raw){
        const value = (raw || "").trim();
        if(!value) return "3:00";
        if(/^[0-9]+:[0-9]{1,2}$/.test(value)){
          return value;
        }
        if(/^[0-9]+$/.test(value)){
          return `${value}s`;
        }
        return value;
      }

      function parseDurationToSeconds(val){
        const value = (val || "").trim();
        if(/^[0-9]+:[0-9]{1,2}$/.test(value)){
          const [m,s] = value.split(":").map(Number);
          return (m*60) + s;
        }
        if(/^[0-9]+$/.test(value)){
          return Number(value);
        }
        return null;
      }

      function formatMinutesValue(seconds){
        if(!Number.isFinite(seconds) || seconds <= 0) return "3.0";
        return (seconds / 60).toFixed(1);
      }

      function secondsToClock(sec){
        if(!Number.isFinite(sec)) return "3:00";
        const m = Math.floor(sec/60);
        const s = Math.max(0, Math.round(sec % 60));
        return `${m}:${String(s).padStart(2,"0")}`;
      }

      function syncDurationInputs(source){
        if(source === "slider" && durationRange && durationInput){
          const sec = Number(durationRange.value);
          durationInput.value = secondsToClock(sec);
        } else if(durationInput && durationRange){
          const parsed = parseDurationToSeconds(durationInput.value);
          if(Number.isFinite(parsed)){
            durationRange.value = Math.max(durationRange.min, Math.min(durationRange.max, parsed));
            durationInput.value = secondsToClock(parsed);
          }
        }
      }

      function updateMeta(){
        const style = styleSel.value;
        const key = keySel.value;
        const transposed = transposeProgression(selectedProgression, key);
        const range = bpmMap[style] || [90,120];
        if(chordsEl) chordsEl.textContent = transposed.chordLine;
        if(bpmRangeEl) bpmRangeEl.textContent = `${range[0]}-${range[1]} BPM`;
        updateEnergyUI();
        updateDanceUI();
        updateVocalUI();
      }

      function renderUsageMeta(entry){
        if(!usageMetaEl) return;
        usageMetaEl.innerHTML = "";
        if(!entry) return;
        const tags = [
          {label:"D√©faut", value: entry.default},
          {label:"Id√©al", value: entry.ideal},
          {label:"Minimum", value: entry.min},
          {label:"Structure", value: entry.structure}
        ];
        tags.forEach(tag => {
          const pill = document.createElement("div");
          pill.className = "usage-pill";
          pill.innerHTML = `<strong>${tag.label} :</strong> ${tag.value}`;
          usageMetaEl.appendChild(pill);
        });
      }

      function maybeApplyStructurePresetForUsage(usageKey){
        const presetLink = {
          radio:"singer",
          streaming:"singer",
          club:"club",
          dj:"club",
          emotion:"singer"
        };
        const presetName = presetLink[usageKey];
        if(!presetName) return;
        const preset = structurePresets[presetName];
        if(!Array.isArray(preset)) return;

        const currentSignature = Array.isArray(structure) ? structure.join("|") : "";
        const knownPresets = [
          defaultStructure.join("|"),
          ...Object.values(structurePresets).map(p => Array.isArray(p) ? p.join("|") : "")
        ];
        if(knownPresets.includes(currentSignature)){
          structure = [...preset];
          renderStructure();
        }
      }

      function applyUsage(usageKey, triggerSource="auto"){
        const entry = usageMap[usageKey] || usageMap.streaming;
        const sec = parseDurationToSeconds(entry.default) || 150;
        if(durationRange){
          durationRange.value = Math.min(Math.max(sec, Number(durationRange.min)), Number(durationRange.max));
        }
        if(durationInput){
          durationInput.value = secondsToClock(sec);
        }
        renderUsageMeta(entry);
        maybeApplyStructurePresetForUsage(usageKey);
        if(triggerSource !== "init"){
          generatePrompt();
        }
      }

      function pickProgression(){
        const options = progressionMap[styleSel.value] || ["i ‚Äì VI ‚Äì III ‚Äì VII"];
        if(!selectedProgression || !options.includes(selectedProgression)){
          selectedProgression = options[0];
        }
        return selectedProgression;
      }

      function renderProgressions(){
        const list = progressionMap[styleSel.value] || [];
        progressionOptionsEl.innerHTML = "";
        list.forEach(prog => {
          const label = document.createElement("label");
          label.className = "progression-chip" + (prog === selectedProgression ? " active" : "");
          label.innerHTML = `<div><strong>${prog}</strong><small>Progression gagnante ${styleSel.value}</small></div>`;
          label.addEventListener("click", () => {
            selectedProgression = prog;
            renderProgressions();
            generatePrompt();
          });
          progressionOptionsEl.appendChild(label);
        });
        if(!selectedProgression && list.length){
          selectedProgression = list[0];
        }
        const transposed = transposeProgression(selectedProgression, keySel.value);
        beatsProgressionEl.textContent = transposed.romanLine;
        beatsProgressionChordsEl.textContent = transposed.chordLine;
      }

      function syncBpmWithStyle(){
        const range = bpmMap[styleSel.value] || [90,120];
        const mid = Math.round((range[0]+range[1])/2);
        bpmInput.min = range[0];
        bpmInput.max = range[1];
        bpmInput.value = sanitizeBpm(bpmInput.value, range) || mid;
        if(!bpmInput.value) bpmInput.value = mid;
      }

      function generatePrompt(source="manual"){
        const style = styleSel.value || "Afro-Trap";
        const key = keySel.value || "A minor";
        const range = bpmMap[style] || [90,120];
        const bpm = sanitizeBpm(bpmInput.value, range);
        bpmInput.value = bpm;
        const usageKey = usageSel?.value || "streaming";
        const usageEntry = usageMap[usageKey] || usageMap.streaming;
        const progression = pickProgression();
        const transposed = transposeProgression(progression, key);
        beatsProgressionEl.textContent = transposed.romanLine;
        beatsProgressionChordsEl.textContent = transposed.chordLine;
        if(chordsEl) chordsEl.textContent = transposed.chordLine;
        const {includedLine, excludedLine, strictBlock} = buildInstrumentLines();
        const energy = energyMap[currentEnergy()] || energyMap.medium;
        const dance = danceabilityMap[currentDanceability()] || danceabilityMap.medium;
        const vocal = vocalModeMap[currentVocalMode()] || vocalModeMap["vocal-first"];
        const structureLine = (structure && structure.length) ? structure.join(" ‚Üí ") : "Intro ‚Üí Drop ‚Üí Outro";
        const usageMinSeconds = parseDurationToSeconds(usageEntry.min) || Number(durationRange?.min) || 120;
        const rawDurationSeconds = parseDurationToSeconds(durationInput?.value) || Number(durationRange?.value) || 180;
        const currentDurationSeconds = Math.max(rawDurationSeconds, usageMinSeconds);
        if(durationInput){
          durationInput.value = secondsToClock(currentDurationSeconds);
        }
        if(durationRange){
          durationRange.value = Math.min(Math.max(currentDurationSeconds, Number(durationRange.min)), Number(durationRange.max));
        }
        const durationMinutes = formatMinutesValue(currentDurationSeconds);
        const styleDescriptor = describeStyle(style) + " " + dance.texture;
        const durationBlock = [
          "full-length instrumental track,",
          `approximately ${durationMinutes} minutes,`,
          "continuous arrangement from intro to outro,",
          "intended as a complete song,",
          "not a loop, not a short preview"
        ].join("\n");

        const promptLines = [
`${style} instrumental in ${key},`,
`winning chord progression ${transposed.romanLine} (${transposed.chordLine}),`,
`${bpm} BPM,`,
`energy: ${energy.label}, ${energy.texture},`,
`danceability: ${dance.label}, ${dance.texture},`,
`vocal mode: ${vocal.label},`,
`arrangement: ${vocal.arrangement},`,
`usage: ${usageEntry.icon} ${usageEntry.label}, ${usageEntry.structure},`,
`${includedLine},`,
strictBlock,
`${excludedLine},`,
`structure: ${structureLine},`,
durationBlock,
`${styleDescriptor},`,
`${vocal.mix},`,
`clean modern balanced mix, no vocals`,
`do not introduce any instrument not explicitly listed as included`
        ].filter(Boolean);

        outputEl.value = promptLines.join("\n");
        if(statusEl){
          statusEl.textContent = source === "shuffle"
            ? "Shuffle premium g√©n√©r√© automatiquement."
            : "Prompt g√©n√©r√© et pr√™t √† √™tre copi√©.";
        }
        updateMeta();
        enforceMelodyLimit();
      }

      function copyPrompt(){
        const txt = outputEl.value || "";
        if(!txt.trim()){
          statusEl && (statusEl.textContent = "Rien √† copier : g√©n√®re un prompt d'abord.");
          return;
        }
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(txt).then(() => {
            statusEl && (statusEl.textContent = "Prompt copi√© dans le presse-papiers.");
          }).catch(() => {
            fallbackCopy(txt);
          });
        } else {
          fallbackCopy(txt);
        }
      }

      function fallbackCopy(text){
        const area = document.createElement("textarea");
        area.value = text;
        area.style.position = "fixed";
        area.style.opacity = "0";
        document.body.appendChild(area);
        area.select();
        try { document.execCommand("copy"); } catch(e){}
        document.body.removeChild(area);
        statusEl && (statusEl.textContent = "Prompt copi√© (mode r√©tro).");
      }

      function randomizeInstruments(){
        let checkedCount = 0;
        instrumentInputs.forEach(input => {
          const mustKeep = ["kick","hi-hats","snare / clap","808 / bass"].includes(input.value);
          const decision = mustKeep ? true : Math.random() > 0.35;
          input.checked = decision;
          if(decision) checkedCount++;
        });
        if(checkedCount === 0 && instrumentInputs[0]){
          instrumentInputs[0].checked = true;
        }
        enforceMelodyLimit();
      }

      function shuffleStructure(){
        structure = [...defaultStructure]
          .sort(() => Math.random() - 0.5)
          .slice(0, Math.max(4, Math.floor(Math.random()*defaultStructure.length)+2));
        renderStructure();
      }

      function shufflePrompt(){
        const style = styles[Math.floor(Math.random()*styles.length)] || "Afro-Trap";
        const key = keys[Math.floor(Math.random()*keys.length)] || "A minor";
        styleSel.value = style;
        keySel.value = key;

        syncBpmWithStyle();
        const range = bpmMap[style] || [90,120];
        const bpm = Math.floor(Math.random() * (range[1] - range[0] + 1)) + range[0];
        bpmInput.value = bpm;

        const energyKeys = Object.keys(energyMap);
        const pickedEnergy = energyKeys[Math.floor(Math.random()*energyKeys.length)] || "medium";
        energyRadios.forEach(r => { r.checked = r.value === pickedEnergy; });
        updateEnergyUI();

        const danceKeys = Object.keys(danceabilityMap);
        const pickedDance = danceKeys[Math.floor(Math.random()*danceKeys.length)] || "medium";
        danceRadios.forEach(r => { r.checked = r.value === pickedDance; });
        updateDanceUI();

        const vocalKeys = Object.keys(vocalModeMap);
        const pickedVocal = vocalKeys[Math.floor(Math.random()*vocalKeys.length)] || "vocal-first";
        vocalRadios.forEach(r => { r.checked = r.value === pickedVocal; });
        updateVocalUI();

        const usageKeys = Object.keys(usageMap);
        const pickedUsage = usageKeys[Math.floor(Math.random()*usageKeys.length)] || "streaming";
        if(usageSel){
          usageSel.value = pickedUsage;
          applyUsage(pickedUsage, "shuffle");
        }

        const progs = progressionMap[style] || [];
        selectedProgression = progs[Math.floor(Math.random()*progs.length)] || selectedProgression;

        randomizeInstruments();
        shuffleStructure();
        renderProgressions();
        generatePrompt("shuffle");
      }

      styleSel.addEventListener("change", () => {
        selectedProgression = (progressionMap[styleSel.value] || [])[0] || selectedProgression;
        syncBpmWithStyle();
        renderProgressions();
        updateMeta();
        generatePrompt();
      });
      keySel.addEventListener("change", () => {
        renderProgressions();
        updateMeta();
        generatePrompt();
      });
      bpmInput.addEventListener("input", () => generatePrompt());
      energyChips.forEach(chip => {
        const radio = chip.querySelector('input[name="beats-energy"]');
        chip.addEventListener("click", () => {
          if(radio){
            radio.checked = true;
            updateEnergyUI();
            generatePrompt();
          }
        });
      });
      danceChips.forEach(chip => {
        const radio = chip.querySelector('input[name="beats-dance"]');
        chip.addEventListener("click", () => {
          if(radio){
            radio.checked = true;
            updateDanceUI();
            generatePrompt();
          }
        });
      });
      vocalChips.forEach(chip => {
        const radio = chip.querySelector('input[name="vocal-mode"]');
        chip.addEventListener("click", () => {
          if(radio){
            radio.checked = true;
            updateVocalUI();
            generatePrompt();
          }
        });
      });
      if(usageSel){
        usageSel.addEventListener("change", () => {
          applyUsage(usageSel.value, "user");
        });
      }
      if(durationRange){
        durationRange.addEventListener("input", () => {
          syncDurationInputs("slider");
          generatePrompt();
        });
      }
      if(durationInput){
        durationInput.addEventListener("change", () => {
          syncDurationInputs("text");
          generatePrompt();
        });
      }
      instrumentInputs.forEach(input => {
        input.addEventListener("change", () => {
          enforceMelodyLimit();
          generatePrompt();
        });
      });
      structureAddBtn && structureAddBtn.addEventListener("click", addStructurePart);
      structureResetBtn && structureResetBtn.addEventListener("click", resetStructure);
      structureInput && structureInput.addEventListener("keydown", (e) => {
        if(e.key === "Enter"){
          e.preventDefault();
          addStructurePart();
        }
      });
      document.querySelectorAll("[data-structure-preset]").forEach(btn => {
        btn.addEventListener("click", () => {
          const name = btn.getAttribute("data-structure-preset");
          applyPreset(name);
        });
      });
      copyBtn && copyBtn.addEventListener("click", copyPrompt);
      generateBtn && generateBtn.addEventListener("click", () => generatePrompt());
      shuffleBtn && shuffleBtn.addEventListener("click", shufflePrompt);

      buildChordLibrary();
      syncBpmWithStyle();
      renderProgressions();
      renderStructure();
      updateMeta();
      applyUsage(usageSel?.value || "streaming", "init");
      syncDurationInputs("slider");
      generatePrompt("init");
    })();
  </script>

  <!-- SCRIPT THEME NUIT/JOUR -->
  <script>
    (function(){
      const THEME_KEY = "szd_theme";
      const root = document.documentElement;
      const themeIcon = document.querySelector(".theme-icon");

      function applyTheme(theme){
        if(theme === "light"){
          root.setAttribute("data-theme","light");
        }else{
          root.removeAttribute("data-theme"); // dark par d√©faut
        }

        if (themeIcon) {
          themeIcon.textContent = theme === "light" ? "‚òÄÔ∏è" : "üåô";
        }

        if (typeof updateThemeLogos === "function") {
          updateThemeLogos(theme);
        }
      }

      document.addEventListener("DOMContentLoaded", function(){
        var toggle = document.getElementById("themeToggle");
        if(!toggle) return;

        var saved = null;
        try {
          saved = localStorage.getItem(THEME_KEY);
        } catch(e) {}

        if(saved === "light"){
          applyTheme("light");
          toggle.checked = false;
        } else {
          applyTheme("dark");
          toggle.checked = true;
        }

        toggle.addEventListener("change", function(){
          if(toggle.checked){
            applyTheme("dark");
            try { localStorage.setItem(THEME_KEY,"dark"); } catch(e) {}
          } else {
            applyTheme("light");
            try { localStorage.setItem(THEME_KEY,"light"); } catch(e) {}
          }
        });
      });
    })();
  </script>

</body>
</html>
