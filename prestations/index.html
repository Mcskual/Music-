<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Prestations ‚Äî Clips & Musique (v1.4)</title>
  <style>
    :root {
      --bg:#0f172a;
      --card:#111827;
      --muted:#6b7280;
      --accent:#2563eb;
      --accent2:#16a34a;
      --border:#1e293b;
      --text:#e5e7eb;
      --text2:#cbd5e1;
      --shadow:0 10px 30px rgba(0,0,0,.25);
      --bg-gradient:
        radial-gradient(circle at 0% 0%, rgba(59,130,246,.22), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(34,197,94,.16), transparent 55%),
        linear-gradient(120deg,#020617,#020617 40%,#020617 60%,#020617);
    }

    /* Th√®me clair premium */
    [data-theme="light"] {
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#0f172a;
      --text2:#4b5563;
      --border:#e5e7eb;
      --muted:#6b7280;
      --shadow:0 16px 40px rgba(15,23,42,.12);
      --bg-gradient:
        radial-gradient(circle at 0% 0%, rgba(59,130,246,.12), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(120deg,#f9fafb,#f3f4f6 40%,#e5e7eb 60%,#f9fafb);
    }

    *{box-sizing:border-box}

    body {
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: var(--bg-gradient);
      color:var(--text);
      margin:0;
    }

    .container { max-width:1200px; margin:36px auto; padding:0 16px; }

    .top-nav{
      display:flex;
      align-items:center;
      gap:14px;
      background:linear-gradient(120deg,rgba(59,130,246,.14),rgba(34,197,94,.08)),var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 14px;
      box-shadow:var(--shadow);
      margin-bottom:14px;
    }
    .nav-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .nav-brand{
      font-weight:800;
      letter-spacing:.03em;
    }
    .brand-stack{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .nav-links{ display:flex; gap:8px; flex-wrap:wrap; flex:1; justify-content:center; }
    .nav-link{
      color:var(--text2);
      text-decoration:none;
      padding:8px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.6);
      font-size:13px;
      transition:.15s background,.15s border-color,.15s color;
    }
    [data-theme="light"] .nav-link{
      background:#f8fafc;
    }
    .nav-link:hover{ border-color:var(--accent); color:#fff; }
    [data-theme="light"] .nav-link:hover{ color:var(--accent); }
    .nav-link.active{
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#fff;
      border-color:transparent;
      box-shadow:0 10px 22px rgba(37,99,235,.45);
    }

    header.app {
      display:flex;
      gap:16px;
      align-items:center;
      margin-bottom:8px;
      flex-wrap:wrap;
    }

    .logo-wrap{
      background:var(--card);
      border-radius:18px;
      padding:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      text-decoration:none;
      color:inherit;
    }
    .logo-wrap img{
      width:220px;
      height:auto;
      display:block;
      border-radius:14px;
      transition:transform .2s ease, opacity .2s ease;
    }
    .logo-compact{
      padding:6px 10px;
      border-radius:14px;
    }
    .logo-compact img{ width:160px; }

    h1 { font-size:clamp(26px,4vw,40px); margin:0; }
    h2 { margin:0 0 12px; font-size:18px; }
    .sub{ color:var(--text2); margin-bottom:16px; font-size:14px;}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:16px;
      margin-top:16px;
    }

    .whatsapp-card{
      position:relative;
      overflow:hidden;
      border:1px solid rgba(34,197,94,.35);
      background:linear-gradient(135deg,rgba(16,185,129,.12),rgba(16,185,129,.04)),var(--card);
    }
    .whatsapp-card::after{
      content:"";
      position:absolute;
      inset:-40% auto auto 40%;
      width:360px;
      height:360px;
      background:radial-gradient(circle at center, rgba(16,185,129,.18), transparent 55%);
      opacity:.8;
      pointer-events:none;
      filter:blur(8px);
    }
    .whatsapp-card h2{ display:flex; align-items:center; gap:8px; margin-bottom:6px; }
    .wa-icon{ width:22px; height:22px; display:inline-flex; align-items:center; justify-content:center; }
    .wa-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(34,197,94,.18);
      color:#bbf7d0;
      border:1px solid rgba(34,197,94,.45);
      font-size:12px;
      font-weight:700;
      letter-spacing:.01em;
    }
    [data-theme="light"] .wa-chip{ color:#0f5132; background:rgba(16,185,129,.16); }
    .wa-legend{ gap:8px; }

    .followup-grid{ position:relative; z-index:1; }
    .followup-card{
      position:relative;
      border:1px solid rgba(34,197,94,.32);
      background:linear-gradient(120deg,rgba(16,185,129,.09),rgba(16,185,129,.02));
      box-shadow:0 12px 30px rgba(16,185,129,.12);
      isolation:isolate;
    }
    .followup-card::before{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(135deg,rgba(16,185,129,.18),transparent 55%);
      opacity:.4;
      pointer-events:none;
      border-radius:inherit;
      z-index:0;
    }
    .followup-card > *{ position:relative; z-index:1; }
    .followup-head{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .followup-meta{ display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:8px; margin-top:10px; }
    .followup-stat{
      display:flex;
      flex-direction:column;
      gap:4px;
      padding:8px 10px;
      border-radius:10px;
      background:rgba(15,23,42,.4);
      border:1px solid rgba(34,197,94,.25);
    }
    [data-theme="light"] .followup-stat{ background:rgba(240,253,244,.9); }
    .followup-stat .label{ font-size:12px; color:var(--muted); display:inline-flex; gap:6px; align-items:center; }
    .followup-stat .value{ font-weight:700; font-size:14px; }
    .followup-pill{ box-shadow:0 4px 16px rgba(16,185,129,.16); }
    .followup-actions{ display:flex; flex-direction:column; gap:6px; margin-top:12px; }
    .followup-btn-row{ display:flex; flex-wrap:wrap; gap:8px; }
    .relance-btn{ color:#fff; border-color:transparent; }
    .relance-soft{ background:linear-gradient(135deg,#22c55e,#15803d); box-shadow:0 10px 20px rgba(16,185,129,.28); }
    .relance-soft:hover{ background:linear-gradient(135deg,#34d399,#16a34a); }
    .relance-firm{ background:linear-gradient(135deg,#f59e0b,#d97706); box-shadow:0 10px 20px rgba(245,158,11,.28); }
    .relance-firm:hover{ background:linear-gradient(135deg,#fbbf24,#f59e0b); }
    .relance-critical{ background:linear-gradient(135deg,#ef4444,#b91c1c); box-shadow:0 12px 22px rgba(239,68,68,.3); }
    .relance-critical:hover{ background:linear-gradient(135deg,#f87171,#ef4444); }

    @media(max-width:640px){
      .followup-head{ flex-direction:column; }
      .followup-pill{ align-self:flex-start; }
    }

    .grid{ display:grid; gap:16px; }
    .grid-2{ grid-template-columns:1.15fr .85fr; }
    @media(max-width:960px){
      .grid-2{ grid-template-columns:1fr; }
      header.app{ justify-content:flex-start; }
    }

    label{
      display:block;
      font-size:13px;
      margin-bottom:6px;
      color:var(--text2);
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    input[type="time"],
    select,
    textarea{
      width:100%;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      font-size:14px;
      outline:none;
      transition:.16s border-color,.16s box-shadow,.16s background,.16s transform;
    }
    input::placeholder,
    textarea::placeholder{ color:#6b7280; font-size:13px;}
    input:focus,
    select:focus,
    textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(37,99,235,.35);
      background:var(--card);
      transform:translateY(-1px);
    }

    .btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 14px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
      letter-spacing:.01em;
      background:#111827;
      color:#e5e7eb;
      border:1px solid #1f2937;
      transition:.15s background,.15s transform,.15s box-shadow,.15s border-color,.15s opacity;
    }
    .btn-primary{
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      border-color:transparent;
      color:#fff;
      box-shadow:0 10px 18px rgba(37,99,235,.45);
    }
    .btn-primary:hover{
      transform:translateY(-1px);
      box-shadow:0 14px 26px rgba(37,99,235,.6);
      opacity:0.97;
    }
    .btn-outline{
      background:transparent;
      color:var(--text2);
      border-color:#1f2937;
    }
    [data-theme="light"] .btn-outline{
      border-color:#d1d5db;
      background:#f9fafb;
    }
    .btn-outline:hover{
      background:rgba(15,23,42,.08);
      border-color:#374151;
    }
    [data-theme="light"] .btn-outline:hover{
      background:#edf2ff;
      border-color:#3b82f6;
    }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
      align-items:center;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      font-size:13px;
      border-radius:12px;
      overflow:hidden;
    }
    th,td{
      padding:7px 8px;
      border-bottom:1px solid #111827;
      text-align:left;
      vertical-align:top;
    }
    [data-theme="light"] th,
    [data-theme="light"] td{
      border-bottom:1px solid #e5e7eb;
    }
    th{
      font-weight:500;
      font-size:12px;
      color:#9ca3af;
      white-space:nowrap;
      background:rgba(15,23,42,.85);
    }
    [data-theme="light"] th{
      background:#f3f4f6;
      color:#6b7280;
    }
    tr:nth-child(even) td{
      background:rgba(15,23,42,.35);
    }
    [data-theme="light"] tr:nth-child(even) td{
      background:#f9fafb;
    }
    tr:hover td{
      background:rgba(59,130,246,.18);
    }
    [data-theme="light"] tr:hover td{
      background:rgba(59,130,246,.09);
    }

    .small{ font-size:12px; color:#8aa0b5;}
    .muted{ color:#94a3b8; font-size:12px; }

    .totals{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:8px;
      margin-top:10px;
    }
    @media(max-width:780px){ .totals{ grid-template-columns:1fr; } }

    .kpi{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .kpi .label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .kpi .value{
      font-size:20px;
      font-weight:800;
      margin-top:6px;
    }
    .kpi .sub{
      font-size:11px;
      color:#64748b;
      margin-top:2px;
    }

    .progress{
      height:6px;
      border-radius:999px;
      background:rgba(15,23,42,.8);
      overflow:hidden;
      border:1px solid #111827;
    }
    [data-theme="light"] .progress{
      background:#e5e7eb;
      border-color:#d1d5db;
    }
    .progress-inner{
      height:100%;
      width:0;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      transition:width .2s ease-out;
    }

    .searchbar{
      display:grid;
      grid-template-columns:1fr 160px 150px;
      gap:10px;
      margin:10px 0 0;
    }
    @media(max-width:780px){
      .searchbar{ grid-template-columns:1fr; }
    }

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:5px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:var(--card);
      font-size:11px;
      color:var(--text);
    }
    [data-theme="light"] .status-pill{
      border-color:#e5e7eb;
    }
    .status-pill span.dot{
      width:8px;
      height:8px;
      border-radius:999px;
      display:inline-block;
    }

    /* √âtats de pastilles (nuit) */
    .status-pill.paid{
      background:rgba(22,163,74,.14);
      border-color:#16a34a;
      color:#bbf7d0;
    }
    .status-pill.paid .dot{
      background:#22c55e;
    }

    .status-pill.partial{
      background:rgba(234,179,8,.16);
      border-color:#facc15;
      color:#fef9c3;
    }
    .status-pill.partial .dot{
      background:#eab308;
    }

    .status-pill.muted{
      background:rgba(239,68,68,.16);
      border-color:#ef4444;
      color:#fecaca;
    }
    .status-pill.muted .dot{
      background:#ef4444;
    }
    .status-pill.critical{
      background:rgba(248,113,113,.22);
      border-color:#ef4444;
      color:#ffe4e6;
    }
    .status-pill.critical .dot{
      background:#f87171;
    }

    /* √âtats de pastilles (jour) */
    [data-theme="light"] .status-pill.paid{
      background:rgba(22,163,74,.14);
      border-color:#16a34a;
      color:#166534;
    }
    [data-theme="light"] .status-pill.partial{
      background:rgba(250,204,21,.16);
      border-color:#eab308;
      color:#854d0e;
    }
    [data-theme="light"] .status-pill.muted{
      background:rgba(248,113,113,.18);
      border-color:#ef4444;
      color:#991b1b;
    }
    [data-theme="light"] .status-pill.critical{
      background:rgba(254,226,226,.9);
      border-color:#ef4444;
      color:#991b1b;
    }

    .checkbox-toggle{ display:flex; align-items:center; gap:8px; }

    .alert{
      padding:10px 12px;
      border-radius:12px;
      margin:10px 0;
    }
    .alert-ok{
      background:rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.5);
      color:#bbf7d0;
    }
    .alert-err{
      background:rgba(239,68,68,.08);
      border:1px solid rgba(239,68,68,.5);
      color:#fecaca;
    }

    footer{
      margin:20px 0;
      color:#94a3b8;
      font-size:12px;
      text-align:center;
    }
    footer code{
      background:var(--card);
      border-radius:8px;
      padding:2px 6px;
      border:1px solid #1f2937;
    }
    [data-theme="light"] footer code{
      border-color:#e5e7eb;
    }

    .hint{ font-size:12px; color:#9fb1c2; }
    .row{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px;
    }
    .pill{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:var(--card);
      color:#9ca3af;
    }
    [data-theme="light"] .pill{
      border-color:#e5e7eb;
      color:#6b7280;
    }

    /* Switch th√®me */
    .switch{
      position:relative;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      color:#9ca3af;
      cursor:pointer;
      user-select:none;
    }
    .switch input{ display:none; }
    .switch span.slider{
      width:34px;
      height:18px;
      border-radius:999px;
      background:#020617;
      border:1px solid #1f2937;
      position:relative;
      transition:.16s background,.16s border-color;
    }
    [data-theme="light"] .switch span.slider{
      background:#e5e7eb;
      border-color:#d1d5db;
    }
    .switch span.slider::before{
      content:"";
      position:absolute;
      top:1px;
      left:1px;
      width:14px;
      height:14px;
      border-radius:999px;
      background:#e5e7eb;
      transition:.16s transform,.16s background;
      box-shadow:0 1px 3px rgba(15,23,42,.5);
    }
    [data-theme="light"] .switch span.slider::before{
      background:#ffffff;
    }
    .switch input:checked + .slider{
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      border-color:transparent;
    }
    .switch input:checked + .slider::before{
      transform:translateX(14px);
    }
    .theme-toggle{
      display:flex;
      align-items:center;
      gap:8px;
      margin-left:auto;
      padding:6px 10px;
      background:rgba(15,23,42,.6);
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow:var(--shadow);
    }
    [data-theme="light"] .theme-toggle{ background:#f8fafc; }
    .theme-icon{
      font-size:14px;
      line-height:1;
      filter:drop-shadow(0 2px 6px rgba(0,0,0,.25));
    }

    .debug-zone{
      margin-top:10px;
      font-size:11px;
      background:var(--card);
      border-radius:12px;
      padding:8px 10px;
      border:1px dashed #1f2937;
      color:#9ca3af;
    }
    .debug-zone pre{
      margin:4px 0 0;
      white-space:pre-wrap;
      word-break:break-word;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }

    .actions button{ margin-right:6px; }

    .small { font-size:12px; color:#8aa0b5;}
    .checkbox-toggle { display:flex; align-items:center; gap:8px;}
    .alert-ok { background: rgba(34,197,94,.1); border:1px solid rgba(34,197,94,.4); color:#86efac; }
    .alert-err{ background: rgba(239,68,68,.1); border:1px solid rgba(239,68,68,.4); color:#fecaca; }
    .hint { font-size:12px; color:#9fb1c2; }
    .debug { font-size:12px; color:#9ca3af; margin-top:6px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .totals { display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px; margin-top:10px; }
    .kpi{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; }
    .kpi .label{ font-size:12px; color:var(--muted); }
    .kpi .value{ font-size:20px; font-weight:800; margin-top:6px;}
    .actions button{ margin-right:6px;}
    .searchbar{ display:grid; grid-template-columns: 1fr 150px 160px; gap:10px; }
    @media(max-width:780px){ .searchbar{ grid-template-columns:1fr;} .totals{ grid-template-columns:1fr; } }

    /* calendar centered narrow */
    #bloc-calendar{max-width:900px;margin:24px auto;}

    /* ====== CAPTURE MOBILE R√âCAP ====== */
    #capture-mobile{
      display:none;
      width:380px;
      max-width:100%;
      margin:0 auto;
      padding:16px;
      background:var(--bg);
      color:var(--text);
      border-radius:16px;
    }
    .cap-header{
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      margin-bottom:12px;
      gap:6px;
    }
    .cap-header img{
      width:180px;
      height:auto;
      border-radius:12px;
      margin-top: -6px;
    }
    .cap-title{
      font-size:16px;
      font-weight:700;
    }
    .cap-sub{
      font-size:11px;
      color:var(--text2);
    }
    .cap-summary{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:8px;
      width:100%;
      margin:4px 0 14px;
    }
    .cap-kpi{
      position:relative;
      overflow:hidden;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      text-align:center;
      isolation:isolate;
    }
    .cap-kpi::after{
      content:"";
      position:absolute;
      inset:-30% -20% auto auto;
      width:180%;
      height:180%;
      background:radial-gradient(circle at 25% 25%, rgba(255,255,255,.25), transparent 45%);
      opacity:.75;
      transform:rotate(6deg);
      pointer-events:none;
      z-index:0;
    }
    .cap-kpi .label,
    .cap-kpi .value{
      text-align:center;
    }
    .cap-kpi.due{
      background:linear-gradient(135deg,#f59e0b,#f97316);
      border-color:rgba(249,115,22,.45);
      color:#fff;
    }
    .cap-kpi.received{
      background:linear-gradient(135deg,#22c55e,#15803d);
      border-color:rgba(21,128,61,.5);
      color:#ecfdf3;
    }
    .cap-kpi.total{
      background:linear-gradient(135deg,#312e81,#2563eb);
      border-color:rgba(37,99,235,.45);
      color:#e0e7ff;
      grid-column:1 / -1;
    }
    .cap-kpi .label{
      font-size:10px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:rgba(255,255,255,.85);
      z-index:1;
    }
    .cap-kpi .value{
      font-size:16px;
      font-weight:800;
      margin-top:4px;
      z-index:1;
    }
    .cap-item{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      margin-bottom:10px;
    }
    .cap-client{
      font-weight:700;
      font-size:14px;
      margin-bottom:2px;
    }
    .cap-subtitle{
      font-size:12px;
      color:var(--text2);
      margin-bottom:6px;
    }
    .cap-row{
      display:flex;
      justify-content:space-between;
      font-size:12px;
      margin-bottom:2px;
      gap:6px;
    }
    .cap-row span:first-child{
      color:var(--text2);
    }
    .cap-row .status-pill{
      font-size:10px;
      padding:2px 6px;
    }

    /* NOUVEAU: Styles pour la barre de progression dans la capture mobile */
    .cap-progress-wrap {
      padding: 8px 0;
    }
    .cap-row-progress-label {
      display: flex;
      justify-content: space-between; /* Correction d'alignement */
      align-items: center;
      margin-bottom: 4px;
      font-size: 0.875rem; 
      color: var(--muted);
    }
    .cap-row-progress-label span:last-child {
      font-weight: 600;
      color: var(--text);
    }

    /* Bloc recherche plus premium */
    .filter-panel{
      background:linear-gradient(145deg, rgba(37,99,235,.12), rgba(34,197,94,.08)), var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    [data-theme="light"] .filter-panel{
      background:linear-gradient(145deg, rgba(37,99,235,.08), rgba(34,197,94,.05)), var(--card);
    }
    .filter-row{
      display:grid;
      grid-template-columns:1.2fr 1fr 1fr;
      gap:12px;
      align-items:end;
    }
    .filter-actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      padding-top:8px;
      border-top:1px dashed var(--border);
    }
    .filter-actions .row{ gap:12px; }
    @media(max-width:780px){
      .filter-row{ grid-template-columns:1fr; }
      .filter-actions{ flex-direction:column; align-items:flex-start; }
    }
    
  </style>
</head>
<body>
  <div class="container">
    <nav class="top-nav" aria-label="Navigation principale">
      <div class="nav-left">
        <a class="logo-wrap logo-compact" href="index.html" aria-label="Revenir aux prestations">
          <img
            src="szd_logo_white.png"
            data-dark-src="szd_logo_white.png"
            data-light-src="szd_logo_black.png"
            alt="Logo">
        </a>
      </div>
      <div class="nav-links">
        <a class="nav-link active" href="index.html">Prestations</a>
        <a class="nav-link" href="facturation.html">Facturation</a>
        <a class="nav-link" href="rdv.html">Ajouter un RDV</a>
        <a class="nav-link" href="licence.html">Contrat instrumentale</a>
        <a class="nav-link" href="famille.html">Famille</a>
        <a class="nav-link" href="reverb.html">Outils reverb vintage</a>
      </div>
      <div class="theme-toggle">
        <span class="theme-icon" aria-hidden="true">üåô</span>
        <label class="switch" aria-label="Basculer le th√®me nuit/jour">
          <input type="checkbox" id="themeToggle">
          <span class="slider"></span>
        </label>
      </div>
    </nav>
    <header class="app">
      <div>
        <h1>Prestations ‚Äî Clips & Musique</h1>
        <div class="row" style="margin:4px 0 2px;">
          <span class="pill">Version 1.4</span>
          <span class="pill">LocalStorage</span>
        </div>
        <p class="sub">
          Ajoute tes prestations, saisis les montants et enregistre les paiements partiels.
          Donn√©es stock√©es en localStorage. Si le stockage est bloqu√©, l'application bascule en mode secours (sauvegarde JSON).
        </p>
      </div>
    </header>

    <div id="status" class="alert" style="display:none;"></div>

    <div class="grid grid-2">
      <div class="card">
        <h2>Nouvelle prestation</h2>
        <form id="prestations-form" novalidate>
          <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px;">
            <div>
              <label for="client">Client</label>
              <input type="text" id="client" placeholder="Nom de l'artiste / client">
            </div>
            <div>
              <label for="type">Type</label>
              <select id="type">
                <option value="Clip">Clip</option>
                <option value="Musique">Musique</option>
                <option value="Tournage">Tournage</option>
                <option value="Montage">Montage</option>
                <option value="Autre">Autre</option>
              </select>
            </div>
            <div style="grid-column:1 / -1;">
              <label for="description">Description (optionnel)</label>
              <input type="text" id="description" placeholder="D√©tails de la prestation (ex : Clip Mayanna)">
            </div>
            <div>
              <label for="date">Date</label>
              <input type="date" id="date">
            </div>
            <div>
              <label for="montant">Montant (‚Ç¨)</label>
              <input type="text" inputmode="decimal" id="montant" placeholder="ex : 800 ou 800,00">
            </div>
            <div class="checkbox-toggle" style="align-self:end;">
              <input type="checkbox" id="paye">
              <label for="paye" style="margin:0;">D√©j√† pay√© (total)</label>
            </div>
          </div>
          <div class="toolbar" style="margin-top:12px;">
            <button class="btn btn-primary" id="save" type="submit">Ajouter</button>
            <button type="button" class="btn btn-outline" id="reset">R√©initialiser</button>
            <button type="button" class="btn btn-outline" id="addDemo">+ D√©mo</button>
            <button type="button" class="btn btn-outline" id="exportJson">Export JSON</button>
            <button type="button" class="btn btn-outline" id="exportCsv">Export CSV</button>
            <label class="btn btn-outline">
              Import JSON
              <input type="file" id="importJson" accept="application/json" style="display:none;">
            </label>
          </div>
        </form>
      </div>

      <div class="card">
        <h2>Recherche & filtre</h2>
        <div class="filter-panel">
          <div class="filter-row">
            <div>
              <label for="search">Filtre texte</label>
              <input type="text" id="search" placeholder="Client, type, description‚Ä¶">
            </div>
            <div>
              <label for="filterStatus">Statut</label>
              <select id="filterStatus">
                <option value="all">Tous</option>
                <option value="unpayed">Non pay√©</option>
                <option value="partial">Partiel</option>
                <option value="paid">Pay√© / sold√©</option>
              </select>
            </div>
            <div>
              <label for="filterType">Type</label>
              <select id="filterType">
                <option value="all">Tous</option>
                <option value="Clip">Clip</option>
                <option value="Musique">Musique</option>
                <option value="Tournage">Tournage</option>
                <option value="Montage">Montage</option>
                <option value="Autre">Autre</option>
              </select>
            </div>
          </div>

          <div class="filter-actions">
            <div class="row">
              <div class="checkbox-toggle">
                <input type="checkbox" id="debug">
                <label for="debug" style="margin:0;">Debug mode</label>
              </div>
              <div class="checkbox-toggle">
                <input type="checkbox" id="autoFile">
                <label for="autoFile" style="margin:0;">Fichier auto (exp√©rimental)</label>
              </div>
            </div>
            <div class="row" style="gap:8px; color:var(--muted); font-size:12px;">
              <span>Affinez vos r√©sultats :</span>
              <span class="pill">Texte</span>
              <span class="pill">Statut</span>
              <span class="pill">Type</span>
            </div>
          </div>
        </div>

        <div class="totals" style="margin-top:14px;">
          <div class="kpi">
            <div class="label">Total factur√©</div>
            <div class="value" id="totalMontant">0 ‚Ç¨</div>
            <div class="sub">Somme des prestations</div>
          </div>
          <div class="kpi">
            <div class="label">Total re√ßu</div>
            <div class="value" id="totalRecu">0 ‚Ç¨</div>
            <div class="sub">Somme des paiements</div>
          </div>
          <div class="kpi">
            <div class="label">Total restant</div>
            <div class="value" id="totalRestant">0 ‚Ç¨</div>
            <div class="sub">√Ä encaisser</div>
          </div>
        </div>

        <div class="small" id="lsStatus" style="margin-top:6px;"></div>

      <div class="debug-zone" id="debug-zone" style="display:none;">
        <div>Console locale :</div>
        <pre id="debugOut"></pre>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:20px;">
    <h2>Prestations enregistr√©es</h2>
    <div class="small">Clique sur "Encaisser" pour enregistrer un paiement partiel ou total.</div>
    <div class="toolbar" style="margin-top:10px;">
      <button type="button" class="btn btn-outline" id="captureRecap">üì∏ Capture </button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Client / Type</th>
            <th>Montant</th>
            <th>Re√ßu</th>
            <th>Restant</th>
            <th>Avancement</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
      <tbody id="tbody">
        <tr><td colspan="10" class="small">Aucune prestation ne correspond.</td></tr>
      </tbody>
    </table>
  </div>

  <div class="card whatsapp-card" style="margin-top:20px;">
    <h2><span class="wa-icon">üíö</span>Relances automatiques</h2>
    <div class="row" style="justify-content:space-between; align-items:center; gap:10px;">
      <p class="small" style="margin:0; max-width:620px;">Clients √† relancer apr√®s 15 jours sans paiement ; √† 30 jours la relance devient prioritaire, et √† 45 jours elle passe en mode critique. Pr√©pare tout pour WhatsApp en un coup d'≈ìil.</p>
      <span class="wa-chip">üí¨ Mode WhatsApp pr√™t</span>
    </div>
    <div class="row wa-legend" style="align-items:center; margin:10px 0 6px; flex-wrap:wrap;">
      <span class="pill">15 jours : relance douce</span>
      <span class="pill">30 jours : relance urgente</span>
      <span class="pill">45 jours : relance critique</span>
      <span class="pill" id="followupCounts">0 relance en attente</span>
    </div>
    <div id="followupList" class="grid followup-grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:10px;"></div>
  </div>

  <!-- Zone de capture mobile cach√©e -->
  <div id="capture-mobile"></div>

  </div>

  <footer>Local ‚Äî cl√©: <code>prestations_v1</code>. Si √ßa casse, tu peux exporter en JSON et garder une sauvegarde manuelle.</footer>

  <!-- html2canvas pour la capture -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    function updateThemeLogos(theme){
      const mode = theme === "light" ? "light" : "dark";

      document.querySelectorAll('[data-light-src][data-dark-src]').forEach((img) => {
        const target = mode === "light" ? img.dataset.lightSrc : img.dataset.darkSrc;
        if (target) {
          img.setAttribute("src", target);
        }
      });
    }

    function currentLogoForTheme(theme){
      const mode = theme === "light" ? "light" : "dark";
      const img = document.querySelector('[data-light-src][data-dark-src]');
      if (!img) return "";

      return mode === "light"
        ? (img.dataset.lightSrc || img.getAttribute("src") || "")
        : (img.dataset.darkSrc || img.getAttribute("src") || "");
    }
  </script>

  <!-- SCRIPT PRESTATIONS -->
  <script>
    (() => {
      const $ = (id) => document.getElementById(id);
      const formEl = $("prestations-form");
      const eur = (n) => new Intl.NumberFormat("fr-FR", {style:"currency", currency:"EUR"}).format(n || 0);
      const storageKey = "prestations_v1";
      const VERSION = "1.4";

      const status = $("status");
      const debugChk = $("debug");
      const autoFile = $("autoFile");
      const debugOut = $("debugOut");
      const lsStatus = $("lsStatus");

      const tbody = $("tbody");
      const totalMontantEl = $("totalMontant");
      const totalRecuEl = $("totalRecu");
      const totalRestantEl = $("totalRestant");
      const search = $("search");
      const filterStatus = $("filterStatus");
      const filterType = $("filterType");

      const client = $("client");
      const type = $("type");
      const description = $("description");
      const date = $("date");
      const montant = $("montant");
      const paye = $("paye");

      const exportJsonBtn = $("exportJson");
      const exportCsvBtn = $("exportCsv");
      const importJsonInput = $("importJson");
      const clearAllBtn = $("clearAll"); // (pas pr√©sent dans le HTML, ok si null)
      const resetBtn = $("reset");
      const addDemoBtn = $("addDemo");
      const captureBtn = $("captureRecap");
      const followupList = $("followupList");
      const followupCounts = $("followupCounts");

      const WHATSAPP_LEVELS = [
        {
          threshold: 15,
          label: "Relance 15j",
          template: `Salut [Pr√©nom],\nPetit rappel concernant ta prestation : il te reste encore 15 jours pour finaliser le r√®glement du solde.\nN‚Äôh√©site pas √† me contacter si tu as la moindre question.\n√Ä bient√¥t.`,
          tone: "soft"
        },
        {
          threshold: 30,
          label: "Relance 30j",
          template: `Bonjour [Pr√©nom],\nLa date limite des 30 jours pour le r√®glement du solde est atteinte.\nMerci de r√©gulariser la situation rapidement afin de conserver la r√©servation de la prestation.\nJe reste disponible si besoin.`,
          tone: "firm"
        },
        {
          threshold: 45,
          label: "Relance 45j (critique)",
          template: `Bonjour [Pr√©nom],\nCela fait d√©sormais 45 jours que le solde est en attente malgr√© mes pr√©c√©dentes relances.\nMerci de r√©gulariser la situation imm√©diatement afin d'√©viter toute interruption de la prestation.\nJe reste disponible en cas de besoin.`,
          tone: "critical"
        }
      ];

      let data = [];
      let editingId = null;

      const log = (...args) => {
        if (debugChk && debugChk.checked) {
          console.log("[DEBUG]", ...args);
          if (debugOut) {
            debugOut.textContent = String(args.join(" "));
          }
        }
      };

      function ts(){
        const d=new Date();
        const p=n=>String(n).padStart(2,"0");
        return d.getFullYear()+"-"+p(d.getMonth()+1)+p(d.getDate())+"_"+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds());
      }

      const supportsLocalStorage = (() => {
        try {
          const k = "__test_ls__";
          localStorage.setItem(k,"1");
          localStorage.removeItem(k);
          return true;
        } catch(e) {
          return false;
        }
      })();

      function showStatus(msg, ok=true){
        if(!status) return;
        status.className = "alert " + (ok ? "alert-ok" : "alert-err");
        status.textContent = msg;
        status.style.display = "block";
        clearTimeout(showStatus._t);
        showStatus._t = setTimeout(() => { status.style.display = "none"; }, 4000);
      }

      function persist(){
        if(!supportsLocalStorage) return;
        try {
          localStorage.setItem(storageKey, JSON.stringify(data));
          log("persist ok", data.length);
        } catch(e) {
          console.error(e);
          showStatus("Erreur de sauvegarde locale : " + e.message, false);
        }
      }

      function load(){
        if(!supportsLocalStorage){
          if(lsStatus){
            lsStatus.textContent = "LocalStorage indisponible (mode secours).";
          }
          return;
        }
        if(lsStatus){
          lsStatus.textContent = "LocalStorage actif.";
        }
        try {
          const raw = localStorage.getItem(storageKey);
          if(!raw) return;
          data = JSON.parse(raw) || [];
        } catch(e) {
          console.error(e);
          showStatus("Impossible de lire les donn√©es locales.", false);
        }
      }

      function sanitizeAmount(v) {
        if (typeof v === "number") return v;
        let s = (v||"").toString().trim();
        s = s.replace(/\s/g,"").replace(",", "."); // french decimal
        const num = parseFloat(s);
        return isFinite(num) ? num : NaN;
      }

      function getPaid(r){ return Number(r.paidAmount || 0); }
      function getRemaining(r){ return Math.max(0, Number((r.montant||0) - getPaid(r))); }
      function isSettled(r){ return getRemaining(r) <= 0.00001; }

      function daysSince(datestr){
        if(!datestr) return null;
        const d = new Date(datestr);
        if(Number.isNaN(d.getTime())) return null;
        const now = new Date();
        const diff = now - d;
        if(diff < 0) return 0;
        return Math.floor(diff / (1000*60*60*24));
      }

      function extractFirstName(full){
        if(!full) return "client";
        const parts = full.trim().split(/\s+/);
        return parts[0] || "client";
      }

      function buildWhatsAppUrl(name, level){
        const targetName = name || "client";
        const message = (level?.template || "").replace("[Pr√©nom]", targetName);
        return "https://wa.me/?text=" + encodeURIComponent(message);
      }

      function filterRecords(list){
        const q = (search?.value || "").toLowerCase();
        const fStatus = filterStatus?.value || "all";
        const fType = filterType?.value || "all";

        return list.filter(r => {
          if(q){
            const blob = [r.client,r.type,r.description].join(" ").toLowerCase();
            if(!blob.includes(q)) return false;
          }
          if(fType !== "all" && r.type !== fType) return false;
          if(fStatus !== "all"){
            const settled = isSettled(r);
            const paid = getPaid(r) > 0;
            if(fStatus === "paid" && !settled) return false;
            if(fStatus === "unpayed" && (paid || settled)) return false;
            if(fStatus === "partial" && (!paid || settled)) return false;
          }
          return true;
        });
      }

      function updateTotals(){
        let totalMontant = 0;
        let totalRecu    = 0;
        let totalRestant = 0;

        data.forEach(r => {
          const m = Number(r.montant||0);
          const p = getPaid(r);
          totalMontant += m;
          totalRecu    += p;
          totalRestant += Math.max(0,m-p);
        });

        if(totalMontantEl) totalMontantEl.textContent = eur(totalMontant);
        if(totalRecuEl) totalRecuEl.textContent = eur(totalRecu);
        if(totalRestantEl) totalRestantEl.textContent = eur(totalRestant);
      }

      function updateFollowUps(){
        if(!followupList) return;

        followupList.innerHTML = "";
        let soft = 0, firm = 0, critical = 0;

        const items = data
          .map(r => ({...r, days: daysSince(r.date), remaining: getRemaining(r)}))
          .filter(r => r.remaining > 0 && r.days !== null && r.days >= 15)
          .sort((a,b) => (b.days||0) - (a.days||0));

        if(!items.length){
          const empty = document.createElement("div");
          empty.className = "small";
          empty.textContent = "Aucune relance n√©cessaire pour le moment.";
          followupList.appendChild(empty);
          if(followupCounts) followupCounts.textContent = "0 relance en attente";
          return;
        }

        items.forEach(r => {
          const urgency = (r.days || 0) >= 45 ? "critical" : (r.days || 0) >= 30 ? "firm" : "soft";
          if(urgency === "critical") critical++; else if(urgency === "firm") firm++; else soft++;

          const item = document.createElement("div");
          item.className = "cap-item followup-card";

          const actionLabel = urgency === "critical" ? "Relance critique" : urgency === "firm" ? "Relance urgente" : "Relance √† pr√©voir";
          const pillClass = urgency === "critical" ? "critical" : (urgency === "firm" ? "muted" : "partial");
          const actionIcon = urgency === "critical" ? "üö®" : urgency === "firm" ? "üöÄ" : "üå±";
          const paceLabel = urgency === "critical" ? "Critique" : urgency === "firm" ? "Prioritaire" : "Douce";
          const availableLevels = WHATSAPP_LEVELS.filter(level => (r.days || 0) >= level.threshold);

          item.innerHTML = `
            <div class="followup-head">
              <div>
                <div class="cap-client">${r.client || "Client"}</div>
                <div class="cap-subtitle">${r.type || ""}${r.description ? " ‚Äî " + r.description : ""}</div>
              </div>
              <span class="status-pill ${pillClass} followup-pill">
                <span class="dot"></span>
                <span>${actionIcon} ${actionLabel}</span>
              </span>
            </div>
            <div class="followup-meta">
              <div class="followup-stat">
                <span class="label">üí∂ Restant d√ª</span>
                <span class="value">${eur(r.remaining)}</span>
              </div>
              <div class="followup-stat">
                <span class="label">‚è≥ Anciennet√©</span>
                <span class="value">${r.days} jours</span>
              </div>
              <div class="followup-stat">
                <span class="label">üí¨ Niveau WhatsApp</span>
                <span class="value">${paceLabel}</span>
              </div>
            </div>
          `;

          const actions = document.createElement("div");
          actions.className = "followup-actions";

          const hint = document.createElement("div");
          hint.className = "small";
          hint.textContent = "Messages pr√™ts :";
          actions.appendChild(hint);

          const btnRow = document.createElement("div");
          btnRow.className = "followup-btn-row";

          availableLevels.forEach(level => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = `btn relance-btn relance-${level.tone}`;
            btn.textContent = level.label;
            btn.addEventListener("click", () => {
              const url = buildWhatsAppUrl(extractFirstName(r.client), level);
              window.open(url, "_blank", "noopener");
            });
            btnRow.appendChild(btn);
          });

          actions.appendChild(btnRow);
          item.appendChild(actions);

          followupList.appendChild(item);
        });

        if(followupCounts){
          const parts = [];
          if(soft) parts.push(`${soft} √† relancer`);
          if(firm) parts.push(`${firm} urgentes`);
          if(critical) parts.push(`${critical} critiques`);
          followupCounts.textContent = parts.join(" ‚Ä¢ ");
        }
      }

      function render(){
        if(!tbody) return;
        tbody.innerHTML = "";

        const records = filterRecords(data);
        if(!records.length){
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 10;
          td.className = "small";
          td.textContent = "Aucune prestation ne correspond.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          updateTotals();
          updateFollowUps();
          return;
        }

        records.sort((a,b) => {
          const da = a.date || "";
          const db = b.date || "";
          return da.localeCompare(db);
        });

        records.forEach(r => {
          const tr = document.createElement("tr");

          const tdDate = document.createElement("td");
          tdDate.textContent = r.date || "";
          tr.appendChild(tdDate);

          const tdClient = document.createElement("td");
          const c1 = document.createElement("div");
          c1.textContent = r.client || "";
          c1.style.fontWeight = "600";
          const c2 = document.createElement("div");
          c2.className = "small";
          c2.textContent = (r.type || "") + (r.description ? " ‚Äî " + r.description : "");
          tdClient.appendChild(c1);
          tdClient.appendChild(c2);
          tr.appendChild(tdClient);

          const tdMontant = document.createElement("td");
          tdMontant.textContent = eur(r.montant || 0);
          tr.appendChild(tdMontant);

          const tdRecu = document.createElement("td");
          tdRecu.textContent = eur(getPaid(r));
          tr.appendChild(tdRecu);

          const remaining = getRemaining(r);
          const tdRestant = document.createElement("td");
          tdRestant.textContent = eur(remaining);
          tr.appendChild(tdRestant);

          const tdProgress = document.createElement("td");
          const wrapper = document.createElement("div");
          wrapper.className = "small";
          const percent = (r.montant && r.montant > 0) ? Math.min(100, Math.round(getPaid(r)/r.montant*100)) : 0;
          wrapper.textContent = percent + " %";
          const bar = document.createElement("div");
          bar.className = "progress";
          const inner = document.createElement("div");
          inner.className = "progress-inner";
          inner.style.width = percent + "%";
          bar.appendChild(inner);
          tdProgress.appendChild(wrapper);
          tdProgress.appendChild(bar);
          tr.appendChild(tdProgress);

          const tdStatus = document.createElement("td");
          const pill = document.createElement("span");
          pill.className = "status-pill";
          const dot = document.createElement("span");
          dot.className = "dot";
          pill.appendChild(dot);
          const label = document.createElement("span");
          let cls = "";
          if(isSettled(r)){
            cls = "paid";
            label.textContent = "Pay√©";
          }else if(getPaid(r) > 0){
            cls = "partial";
            label.textContent = "Partiel";
          }else{
            cls = "muted";
            label.textContent = "Non pay√©";
          }
          pill.classList.add(cls);
          pill.appendChild(label);
          tdStatus.appendChild(pill);
          tr.appendChild(tdStatus);

          const tdActions = document.createElement("td");
          const encBtn = document.createElement("button");
          encBtn.type = "button";
          encBtn.className = "btn btn-primary";
          encBtn.textContent = "Encaisser";
          encBtn.addEventListener("click", () => {
            let max = getRemaining(r);
            if(max <= 0){
              showStatus("Tout est d√©j√† pay√© pour cette prestation.", false);
              return;
            }
            const s = prompt("Montant √† encaisser (max " + eur(max) + "):", "");
            if(s===null) return;
            const val = sanitizeAmount(s);
            if(!isFinite(val) || val<=0){
              showStatus("Montant invalide.", false);
              return;
            }
            if(val > max + 0.00001){
              showStatus("Montant sup√©rieur au restant d√ª.", false);
              return;
            }
            r.paidAmount = (r.paidAmount || 0) + val;
            persist();
            updateTotals();
            render();
            showStatus("Paiement enregistr√©.");
          });

          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.className = "btn btn-outline";
          editBtn.textContent = "Modifier";
          editBtn.addEventListener("click", () => {
            editingId = r.id;
            client.value = r.client || "";
            type.value = r.type || "Clip";
            description.value = r.description || "";
            date.value = r.date || "";
            montant.value = r.montant != null ? String(r.montant) : "";
            paye.checked = isSettled(r);
            window.scrollTo({top:0, behavior:"smooth"});
          });

          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "btn btn-outline";
          delBtn.textContent = "Supprimer";
          delBtn.addEventListener("click", () => {
            if (confirm("Supprimer cette prestation ?")) {
              data = data.filter(x => x.id !== r.id);
              persist();
              updateTotals();
              render();
              if (editingId === r.id) editingId = null;
              showStatus("Prestation supprim√©e.");
            }
          });

          tdActions.appendChild(encBtn);
          tdActions.appendChild(editBtn);
          tdActions.appendChild(delBtn);
          tr.appendChild(tdActions);

          tbody.appendChild(tr);
        });

        updateTotals();
        updateFollowUps();
      }

      function resetForm(){
        if(!formEl) return;
        client.value = "";
        type.value = "Clip";
        description.value = "";
        date.value = "";
        montant.value = "";
        paye.checked = false;
        editingId = null;
      }

      function validateForm(){
        const c = client.value.trim();
        if(!c){
          showStatus("Le nom du client est obligatoire.", false);
          client.focus();
          return null;
        }
        const m = sanitizeAmount(montant.value);
        if(!isFinite(m) || m<=0){
          showStatus("Montant invalide.", false);
          montant.focus();
          return null;
        }
        const d = date.value || new Date().toISOString().slice(0,10);
        return {client:c, type:type.value, description:description.value.trim(), date:d, montant:m};
      }

      function addRecord(rec){
        rec.id = rec.id || Date.now() + Math.random();
        rec.paidAmount = rec.paidAmount || 0;
        data.push(rec);
      }

      if(formEl){
        formEl.addEventListener("submit", (e) => {
          e.preventDefault();
          const rec = validateForm();
          if(!rec) return;

          if(editingId){
            const idx = data.findIndex(r => r.id === editingId);
            if(idx !== -1){
              data[idx] = {
                ...data[idx],
                ...rec
              };
              showStatus("Prestation modifi√©e.");
            }
            editingId = null;
          } else {
            if(paye.checked){
              rec.paidAmount = rec.montant;
            }
            addRecord(rec);
            showStatus("Prestation ajout√©e.");
          }

          persist();
          render();
          resetForm();
        });
      }

      if(resetBtn){
        resetBtn.addEventListener("click", () => {
          resetForm();
        });
      }

      if(addDemoBtn){
        addDemoBtn.addEventListener("click", () => {
          const demo = {
            client:"Artiste d√©mo",
            type:"Clip",
            description:"Clip test d√©mo",
            date:new Date().toISOString().slice(0,10),
            montant:800,
            paidAmount:200
          };
          addRecord(demo);
          persist();
          render();
          showStatus("D√©mo ajout√©e.");
        });
      }

      if(exportJsonBtn){
        exportJsonBtn.addEventListener("click", () => {
          try{
            const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "prestations_"+ts()+".json";
            a.click();
            URL.revokeObjectURL(a.href);
            showStatus("Export JSON t√©l√©charg√©.");
          }catch(e){
            console.error(e);
            showStatus("Erreur export JSON : " + e.message, false);
          }
        });
      }

      if(exportCsvBtn){
        exportCsvBtn.addEventListener("click", () => {
          try{
            let csv = "date;client;type;description;montant;recu;restant\n";
            data.forEach(r => {
              csv += [
                r.date || "",
                r.client || "",
                r.type || "",
                (r.description||"").replace(/\n/g," "),
                r.montant || 0,
                getPaid(r),
                getRemaining(r)
              ].map(v => String(v).replace(/;/g,",")).join(";") + "\n";
            });
            const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "prestations_"+ts()+".csv";
            a.click();
            URL.revokeObjectURL(a.href);
            showStatus("Export CSV t√©l√©charg√©.");
          }catch(e){
            console.error(e);
            showStatus("Erreur export CSV : " + e.message, false);
          }
        });
      }

      if(importJsonInput){
        importJsonInput.addEventListener("change", async (e) => {
          const file = e.target.files && e.target.files[0];
          if(!file) return;
          try{
            const txt = await file.text();
            const arr = JSON.parse(txt);
            if(!Array.isArray(arr)) throw new Error("Format JSON invalide");
            data = arr.map(r => ({
              id: r.id || Date.now()+Math.random(),
              client: r.client || "",
              type: r.type || "Clip",
              description: r.description || "",
              date: r.date || "",
              montant: Number(r.montant||0),
              paidAmount: Number(r.paidAmount||0)
            }));
            persist();
            render();
            showStatus("Import JSON r√©ussi.");
          }catch(err){
            console.error(err);
            showStatus("Erreur import JSON : " + err.message, false);
          }finally{
            importJsonInput.value = "";
          }
        });
      }

      if(clearAllBtn){
        clearAllBtn.addEventListener("click", () => {
          if(confirm("Effacer TOUTES les prestations ?")){
            data = [];
            persist();
            render();
            showStatus("Tous les enregistrements ont √©t√© supprim√©s.");
          }
        });
      }

      if(debugChk){
        debugChk.addEventListener("change", () => {
          const zone = document.getElementById("debug-zone");
          if(zone) zone.style.display = debugChk.checked ? "block" : "none";
        });
      }

      if (search) {
        search.addEventListener("input", () => {
          render();
        });
      }
      if (filterStatus) {
        filterStatus.addEventListener("change", render);
      }
      if (filterType) {
        filterType.addEventListener("change", render);
      }

      /* ==== Capture pour "Prestations enregistr√©es" ==== */
if (captureBtn && typeof html2canvas !== "undefined") {
  captureBtn.addEventListener("click", () => {
    const records = filterRecords(data);
    if (!records.length) {
      showStatus("Aucune prestation √† capturer (v√©rifie les filtres).", false);
      return;
    }
    const zone = document.getElementById("capture-mobile");
    if (!zone) {
      alert("Zone de capture introuvable.");
      return;
    }

    const now = new Date();
    const dateStr = now.toLocaleString("fr-FR", {
      day:"2-digit", month:"2-digit", year:"numeric",
      hour:"2-digit", minute:"2-digit"
    });

    const totals = records.reduce((acc, r) => {
      const montant = Number(r.montant || 0);
      const paid = getPaid(r);
      acc.montant += montant;
      acc.recu += paid;
      acc.restant += Math.max(0, montant - paid);
      return acc;
    }, { montant:0, recu:0, restant:0 });

    // D√©tecte le th√®me pour choisir le bon logo
    const isDarkTheme = !document.documentElement.hasAttribute("data-theme") ||
                        document.documentElement.getAttribute("data-theme") !== "light";
    const currentTheme = isDarkTheme ? "dark" : "light";
    const logoSrc = currentLogoForTheme(currentTheme) || (isDarkTheme ? "szd_logo_white.png" : "szd_logo_black.png");

    let html = "";
    html += `
      <div class="cap-header">
        <img src="${logoSrc}" alt="Logo">
        <div class="cap-title">R√©capitulatif des prestations</div>
        <div class="cap-sub">G√©n√©r√© le ${dateStr}</div>
      </div>
      <div class="cap-summary">
        <div class="cap-kpi due">
          <div class="label">Montant d√ª</div>
          <div class="value">${eur(totals.restant)}</div>
        </div>
        <div class="cap-kpi received">
          <div class="label">Montant re√ßu / pay√©</div>
          <div class="value">${eur(totals.recu)}</div>
        </div>
        <div class="cap-kpi total">
          <div class="label">Montant total des prestations</div>
          <div class="value">${eur(totals.montant)}</div>
        </div>
      </div>
    `;

    records.forEach(r => {
      const remaining = getRemaining(r);
      const paid = getPaid(r);
      
      // NOUVEAU (inclus pour la barre de progression)
      const percent = (r.montant && r.montant > 0) ? Math.min(100, Math.round(paid/r.montant*100)) : 0;
      
      let cls, label;
      if (isSettled(r)) {
        // ... (reste de la logique de statut) ...
        cls = "paid";
        label = "Pay√©";
      } else if (paid > 0) {
        cls = "partial";
        label = "Partiel";
      } else {
        cls = "muted";
        label = "Non pay√©";
      }

      html += `
        <div class="cap-item">
          <div class="cap-client">${r.client || ""}</div>
          <div class="cap-subtitle">${(r.type || "")}${r.description ? " ‚Äî " + r.description : ""}</div>
          <div class="cap-row">
            <span>Date</span><span>${r.date || ""}</span>
          </div>
          <div class="cap-row">
            <span>Montant</span><span>${eur(r.montant || 0)}</span>
          </div>
          <div class="cap-row">
            <span>Re√ßu</span><span>${eur(paid)}</span>
          </div>
          <div class="cap-row">
            <span>Restant</span><span>${eur(remaining)}</span>
          </div>
          
          <div class="cap-progress-wrap">
            <div class="cap-row-progress-label">
              <span>Avancement</span>
              <span>${percent} %</span>
            </div>
            <div class="progress">
              <div class="progress-inner" style="width:${percent}%;"></div>
            </div>
          </div>
          
          <div class="cap-row">
            <span>Statut</span>
            <span class="status-pill ${cls}">
              <span class="dot"></span>
              <span>${label}</span>
            </span>
          </div>

        </div>
      `;
    });

    zone.innerHTML = html;
    zone.style.display = "block";

    const bg = document.documentElement.getAttribute("data-theme") === "light"
      ? "#f3f4f6"
      : "#020617";

    html2canvas(zone, {
      backgroundColor: bg,
      scale: 2
    }).then(canvas => {
      const link = document.createElement("a");
      link.download = "recap_prestations_mobile_"+ts()+".png";
      link.href = canvas.toDataURL("image/png");
      link.click();
      zone.style.display = "none";
      showStatus("R√©capitulatif captur√© (format mobile) !");
    }).catch(err => {
      console.error(err);
      zone.style.display = "none";
      showStatus("Erreur lors de la capture du r√©capitulatif.", false);
    });
  });
}

      load();
      render();
      showStatus(
        supportsLocalStorage ? "Sauvegarde locale active." : "Mode secours actif (stockage bloqu√©).",
        supportsLocalStorage
      );
      log("init ok, version", VERSION);

    })();
  </script>

  <!-- SCRIPT THEME NUIT/JOUR -->
  <script>
    (function(){
      const THEME_KEY = "szd_theme";
      const root = document.documentElement;
      const themeIcon = document.querySelector(".theme-icon");

      function applyTheme(theme){
        if(theme === "light"){
          root.setAttribute("data-theme","light");
        }else{
          root.removeAttribute("data-theme"); // dark par d√©faut
        }

        if (themeIcon) {
          themeIcon.textContent = theme === "light" ? "‚òÄÔ∏è" : "üåô";
        }

        if (typeof updateThemeLogos === "function") {
          updateThemeLogos(theme);
        }
      }

      document.addEventListener("DOMContentLoaded", function(){
        var toggle = document.getElementById("themeToggle");
        if(!toggle) return;

        var saved = null;
        try {
          saved = localStorage.getItem(THEME_KEY);
        } catch(e) {}

        if(saved === "light"){
          applyTheme("light");
          toggle.checked = false;
        } else {
          applyTheme("dark");
          toggle.checked = true;
        }

        toggle.addEventListener("change", function(){
          if(toggle.checked){
            applyTheme("dark");
            try { localStorage.setItem(THEME_KEY,"dark"); } catch(e) {}
          } else {
            applyTheme("light");
            try { localStorage.setItem(THEME_KEY,"light"); } catch(e) {}
          }
        });
      });
    })();
  </script>

</body>
</html>
