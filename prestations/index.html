<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Prestations ‚Äî Clips & Musique (v1.4)</title>
  <style>
    :root {
      --bg:#0f172a;
      --card:#111827;
      --muted:#6b7280;
      --accent:#2563eb;
      --accent2:#16a34a;
      --border:#1e293b;
      --text:#e5e7eb;
      --text2:#cbd5e1;
      --shadow:0 10px 30px rgba(0,0,0,.25);
      --bg-gradient:
        radial-gradient(circle at 0% 0%, rgba(59,130,246,.22), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(34,197,94,.16), transparent 55%),
        linear-gradient(120deg,#020617,#020617 40%,#020617 60%,#020617);
    }

    /* Th√®me clair premium */
    [data-theme="light"] {
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#0f172a;
      --text2:#4b5563;
      --border:#e5e7eb;
      --muted:#6b7280;
      --shadow:0 16px 40px rgba(15,23,42,.12);
      --bg-gradient:
        radial-gradient(circle at 0% 0%, rgba(59,130,246,.12), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(120deg,#f9fafb,#f3f4f6 40%,#e5e7eb 60%,#f9fafb);
    }

    *{box-sizing:border-box}

    body {
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: var(--bg-gradient);
      color:var(--text);
      margin:0;
    }

    .container { max-width:1200px; margin:36px auto; padding:0 16px; }

    .top-nav{
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:linear-gradient(120deg,rgba(59,130,246,.14),rgba(34,197,94,.08)),var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 14px;
      box-shadow:var(--shadow);
      margin-bottom:14px;
    }
    .nav-brand{
      font-weight:800;
      letter-spacing:.03em;
    }
    .nav-links{ display:flex; gap:8px; flex-wrap:wrap; }
    .nav-link{
      color:var(--text2);
      text-decoration:none;
      padding:8px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.6);
      font-size:13px;
      transition:.15s background,.15s border-color,.15s color;
    }
    [data-theme="light"] .nav-link{
      background:#f8fafc;
    }
    .nav-link:hover{ border-color:var(--accent); color:#fff; }
    [data-theme="light"] .nav-link:hover{ color:var(--accent); }
    .nav-link.active{
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#fff;
      border-color:transparent;
      box-shadow:0 10px 22px rgba(37,99,235,.45);
    }

    header.app {
      display:flex;
      gap:16px;
      align-items:center;
      margin-bottom:8px;
      flex-wrap:wrap;
    }

    .logo-wrap{
      background:var(--card);
      border-radius:18px;
      padding:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      width:200px;
      max-width:100%;
    }
    .logo-wrap img{
      max-width:100%;
      width:auto;
      height:auto;
      max-height:70px;
      display:block;
      border-radius:14px;
      transition:transform .2s ease, opacity .2s ease;
    }

    @media(max-width:720px){
      .logo-wrap{ width:160px; padding:8px; }
      .logo-wrap img{ max-height:60px; }
    }

    h1 { font-size:clamp(26px,4vw,40px); margin:0; }
    h2 { margin:0 0 12px; font-size:18px; }
    .sub{ color:var(--text2); margin-bottom:16px; font-size:14px;}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:16px;
      margin-top:16px;
    }

    .grid{ display:grid; gap:16px; }
    .grid-2{ grid-template-columns:1.15fr .85fr; }
    @media(max-width:960px){
      .grid-2{ grid-template-columns:1fr; }
      header.app{ justify-content:flex-start; }
    }

    label{
      display:block;
      font-size:13px;
      margin-bottom:6px;
      color:var(--text2);
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    input[type="time"],
    select,
    textarea{
      width:100%;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      font-size:14px;
      outline:none;
      transition:.16s border-color,.16s box-shadow,.16s background,.16s transform;
    }
    input::placeholder,
    textarea::placeholder{ color:#6b7280; font-size:13px;}
    input:focus,
    select:focus,
    textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(37,99,235,.35);
      background:var(--card);
      transform:translateY(-1px);
    }

    .btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 14px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
      letter-spacing:.01em;
      background:#111827;
      color:#e5e7eb;
      border:1px solid #1f2937;
      transition:.15s background,.15s transform,.15s box-shadow,.15s border-color,.15s opacity;
    }
    .btn-primary{
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      border-color:transparent;
      color:#fff;
      box-shadow:0 10px 18px rgba(37,99,235,.45);
    }
    .btn-primary:hover{
      transform:translateY(-1px);
      box-shadow:0 14px 26px rgba(37,99,235,.6);
      opacity:0.97;
    }
    .btn-outline{
      background:transparent;
      color:var(--text2);
      border-color:#1f2937;
    }
    [data-theme="light"] .btn-outline{
      border-color:#d1d5db;
      background:#f9fafb;
    }
    .btn-outline:hover{
      background:rgba(15,23,42,.08);
      border-color:#374151;
    }
    [data-theme="light"] .btn-outline:hover{
      background:#edf2ff;
      border-color:#3b82f6;
    }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
      align-items:center;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      font-size:13px;
      border-radius:12px;
      overflow:hidden;
    }
    th,td{
      padding:7px 8px;
      border-bottom:1px solid #111827;
      text-align:left;
      vertical-align:top;
    }
    [data-theme="light"] th,
    [data-theme="light"] td{
      border-bottom:1px solid #e5e7eb;
    }
    th{
      font-weight:500;
      font-size:12px;
      color:#9ca3af;
      white-space:nowrap;
      background:rgba(15,23,42,.85);
    }
    [data-theme="light"] th{
      background:#f3f4f6;
      color:#6b7280;
    }
    tr:nth-child(even) td{
      background:rgba(15,23,42,.35);
    }
    [data-theme="light"] tr:nth-child(even) td{
      background:#f9fafb;
    }
    tr:hover td{
      background:rgba(59,130,246,.18);
    }
    [data-theme="light"] tr:hover td{
      background:rgba(59,130,246,.09);
    }

    .small{ font-size:12px; color:#8aa0b5;}
    .muted{ color:#94a3b8; font-size:12px; }

    .totals{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:8px;
      margin-top:10px;
    }
    @media(max-width:780px){ .totals{ grid-template-columns:1fr; } }

    .kpi{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .kpi .label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .kpi .value{
      font-size:20px;
      font-weight:800;
      margin-top:6px;
    }
    .kpi .sub{
      font-size:11px;
      color:#64748b;
      margin-top:2px;
    }

    .progress{
      height:6px;
      border-radius:999px;
      background:rgba(15,23,42,.8);
      overflow:hidden;
      border:1px solid #111827;
    }
    [data-theme="light"] .progress{
      background:#e5e7eb;
      border-color:#d1d5db;
    }
    .progress-inner{
      height:100%;
      width:0;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      transition:width .2s ease-out;
    }

    .searchbar{
      display:grid;
      grid-template-columns:1fr 160px 150px;
      gap:10px;
      margin:10px 0 0;
    }
    @media(max-width:780px){
      .searchbar{ grid-template-columns:1fr; }
    }

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:5px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:var(--card);
      font-size:11px;
      color:var(--text);
    }
    [data-theme="light"] .status-pill{
      border-color:#e5e7eb;
    }
    .status-pill span.dot{
      width:8px;
      height:8px;
      border-radius:999px;
      display:inline-block;
    }

    /* √âtats de pastilles (nuit) */
    .status-pill.paid{
      background:rgba(22,163,74,.14);
      border-color:#16a34a;
      color:#bbf7d0;
    }
    .status-pill.paid .dot{
      background:#22c55e;
    }

    .status-pill.partial{
      background:rgba(234,179,8,.16);
      border-color:#facc15;
      color:#fef9c3;
    }
    .status-pill.partial .dot{
      background:#eab308;
    }

    .status-pill.muted{
      background:rgba(239,68,68,.16);
      border-color:#ef4444;
      color:#fecaca;
    }
    .status-pill.muted .dot{
      background:#ef4444;
    }

    /* √âtats de pastilles (jour) */
    [data-theme="light"] .status-pill.paid{
      background:rgba(22,163,74,.14);
      border-color:#16a34a;
      color:#166534;
    }
    [data-theme="light"] .status-pill.partial{
      background:rgba(250,204,21,.16);
      border-color:#eab308;
      color:#854d0e;
    }
    [data-theme="light"] .status-pill.muted{
      background:rgba(248,113,113,.18);
      border-color:#ef4444;
      color:#991b1b;
    }

    .checkbox-toggle{ display:flex; align-items:center; gap:8px; }

    .alert{
      padding:10px 12px;
      border-radius:12px;
      margin:10px 0;
    }
    .alert-ok{
      background:rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.5);
      color:#bbf7d0;
    }
    .alert-err{
      background:rgba(239,68,68,.08);
      border:1px solid rgba(239,68,68,.5);
      color:#fecaca;
    }

    footer{
      margin:20px 0;
      color:#94a3b8;
      font-size:12px;
      text-align:center;
    }
    footer code{
      background:var(--card);
      border-radius:8px;
      padding:2px 6px;
      border:1px solid #1f2937;
    }
    [data-theme="light"] footer code{
      border-color:#e5e7eb;
    }

    .hint{ font-size:12px; color:#9fb1c2; }
    .row{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px;
    }
    .pill{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:var(--card);
      color:#9ca3af;
    }
    [data-theme="light"] .pill{
      border-color:#e5e7eb;
      color:#6b7280;
    }

    /* Switch th√®me */
    .switch{
      position:relative;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      color:#9ca3af;
      cursor:pointer;
      user-select:none;
    }
    .switch input{ display:none; }
    .switch span.slider{
      width:34px;
      height:18px;
      border-radius:999px;
      background:#020617;
      border:1px solid #1f2937;
      position:relative;
      transition:.16s background,.16s border-color;
    }
    [data-theme="light"] .switch span.slider{
      background:#e5e7eb;
      border-color:#d1d5db;
    }
    .switch span.slider::before{
      content:"";
      position:absolute;
      top:1px;
      left:1px;
      width:14px;
      height:14px;
      border-radius:999px;
      background:#e5e7eb;
      transition:.16s transform,.16s background;
      box-shadow:0 1px 3px rgba(15,23,42,.5);
    }
    [data-theme="light"] .switch span.slider::before{
      background:#ffffff;
    }
    .switch input:checked + .slider{
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      border-color:transparent;
    }
    .switch input:checked + .slider::before{
      transform:translateX(14px);
    }

    .debug-zone{
      margin-top:10px;
      font-size:11px;
      background:var(--card);
      border-radius:12px;
      padding:8px 10px;
      border:1px dashed #1f2937;
      color:#9ca3af;
    }
    .debug-zone pre{
      margin:4px 0 0;
      white-space:pre-wrap;
      word-break:break-word;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }

    .actions button{ margin-right:6px; }

    .small { font-size:12px; color:#8aa0b5;}
    .checkbox-toggle { display:flex; align-items:center; gap:8px;}
    .alert-ok { background: rgba(34,197,94,.1); border:1px solid rgba(34,197,94,.4); color:#86efac; }
    .alert-err{ background: rgba(239,68,68,.1); border:1px solid rgba(239,68,68,.4); color:#fecaca; }
    .hint { font-size:12px; color:#9fb1c2; }
    .debug { font-size:12px; color:#9ca3af; margin-top:6px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .totals { display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px; margin-top:10px; }
    .kpi{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; }
    .kpi .label{ font-size:12px; color:var(--muted); }
    .kpi .value{ font-size:20px; font-weight:800; margin-top:6px;}
    .actions button{ margin-right:6px;}
    .searchbar{ display:grid; grid-template-columns: 1fr 150px 160px; gap:10px; }
    @media(max-width:780px){ .searchbar{ grid-template-columns:1fr;} .totals{ grid-template-columns:1fr; } }

    /* calendar centered narrow */
    #bloc-calendar{max-width:900px;margin:24px auto;}

    /* ====== CAPTURE MOBILE R√âCAP ====== */
    #capture-mobile{
      display:none;
      width:380px;
      max-width:100%;
      margin:0 auto;
      padding:16px;
      background:var(--bg);
      color:var(--text);
      border-radius:16px;
    }
    .cap-header{
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      margin-bottom:12px;
      gap:6px;
    }
    .cap-header img{
      width:180px;
      height:auto;
      border-radius:12px;
      margin-top: -6px;
    }
    .cap-title{
      font-size:16px;
      font-weight:700;
    }
    .cap-sub{
      font-size:11px;
      color:var(--text2);
    }
    .cap-summary{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:8px;
      width:100%;
      margin:4px 0 14px;
    }
    .cap-kpi{
      position:relative;
      overflow:hidden;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      text-align:center;
      isolation:isolate;
    }
    .cap-kpi::after{
      content:"";
      position:absolute;
      inset:-30% -20% auto auto;
      width:180%;
      height:180%;
      background:radial-gradient(circle at 25% 25%, rgba(255,255,255,.25), transparent 45%);
      opacity:.75;
      transform:rotate(6deg);
      pointer-events:none;
      z-index:0;
    }
    .cap-kpi .label,
    .cap-kpi .value{
      text-align:center;
    }
    .cap-kpi.due{
      background:linear-gradient(135deg,#f59e0b,#f97316);
      border-color:rgba(249,115,22,.45);
      color:#fff;
    }
    .cap-kpi.received{
      background:linear-gradient(135deg,#22c55e,#15803d);
      border-color:rgba(21,128,61,.5);
      color:#ecfdf3;
    }
    .cap-kpi.total{
      background:linear-gradient(135deg,#312e81,#2563eb);
      border-color:rgba(37,99,235,.45);
      color:#e0e7ff;
      grid-column:1 / -1;
    }
    .cap-kpi .label{
      font-size:10px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:rgba(255,255,255,.85);
      z-index:1;
    }
    .cap-kpi .value{
      font-size:16px;
      font-weight:800;
      margin-top:4px;
      z-index:1;
    }
    .cap-item{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      margin-bottom:10px;
    }
    .cap-client{
      font-weight:700;
      font-size:14px;
      margin-bottom:2px;
    }
    .cap-subtitle{
      font-size:12px;
      color:var(--text2);
      margin-bottom:6px;
    }
    .cap-row{
      display:flex;
      justify-content:space-between;
      font-size:12px;
      margin-bottom:2px;
      gap:6px;
    }
    .cap-row span:first-child{
      color:var(--text2);
    }
    .cap-row .status-pill{
      font-size:10px;
      padding:2px 6px;
    }

    /* NOUVEAU: Styles pour la barre de progression dans la capture mobile */
    .cap-progress-wrap {
      padding: 8px 0;
    }
    .cap-row-progress-label {
      display: flex;
      justify-content: space-between; /* Correction d'alignement */
      align-items: center;
      margin-bottom: 4px;
      font-size: 0.875rem; 
      color: var(--muted);
    }
    .cap-row-progress-label span:last-child {
      font-weight: 600;
      color: var(--text);
    }

    /* Bloc recherche plus premium */
    .filter-panel{
      background:linear-gradient(145deg, rgba(37,99,235,.12), rgba(34,197,94,.08)), var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    [data-theme="light"] .filter-panel{
      background:linear-gradient(145deg, rgba(37,99,235,.08), rgba(34,197,94,.05)), var(--card);
    }
    .filter-row{
      display:grid;
      grid-template-columns:1.2fr 1fr 1fr;
      gap:12px;
      align-items:end;
    }
    .filter-actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      padding-top:8px;
      border-top:1px dashed var(--border);
    }
    .filter-actions .row{ gap:12px; }
    @media(max-width:780px){
      .filter-row{ grid-template-columns:1fr; }
      .filter-actions{ flex-direction:column; align-items:flex-start; }
    }
    
  </style>
</head>
<body>
  <div class="container">
    <nav class="top-nav" aria-label="Navigation principale">
      <div class="row" style="gap:10px;">
        <span class="nav-brand">SZD Studio</span>
        <span class="pill">Suite cr√©ative</span>
      </div>
      <div class="nav-links">
        <a class="nav-link active" href="index.html">Prestations</a>
        <a class="nav-link" href="facturation.html">Facturation</a>
        <a class="nav-link" href="reverb.html">Outils reverb vintage</a>
      </div>
    </nav>
    <header class="app">
      <div class="logo-wrap">
        <img
          src="szd_logo_white.png"
          data-dark-src="szd_logo_white.png"
          data-light-src="szd_logo_black.png"
          alt="SZD Studio">
      </div>

      <div>
        <h1>Prestations ‚Äî Clips & Musique</h1>
        <div class="row" style="margin:4px 0 2px;">
          <span class="pill">Version 1.4</span>
          <span class="pill">LocalStorage</span>
        </div>
        <p class="sub">
          Ajoute tes prestations, saisis les montants et enregistre les paiements partiels.
          Donn√©es stock√©es en localStorage. Si le stockage est bloqu√©, l'application bascule en mode secours (sauvegarde JSON).
        </p>
      </div>

      <!-- Switch th√®me nuit / jour -->
      <label class="switch" style="margin-left:auto;">
        <input type="checkbox" id="themeToggle">
        <span class="slider"></span>
      </label>
    </header>

    <div class="sub">
      Ajoute tes prestations, saisis les montants et enregistre les paiements partiels.
      Donn√©es stock√©es en localStorage. Si le stockage est bloqu√©, l'application bascule en mode secours (sauvegarde JSON).
    </div>

    <div id="status" class="alert" style="display:none;"></div>

    <div class="grid grid-2">
      <div class="card">
        <h2>Nouvelle prestation</h2>
        <form id="prestations-form" novalidate>
          <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px;">
            <div>
              <label for="client">Client</label>
              <input type="text" id="client" placeholder="Nom de l'artiste / client">
            </div>
            <div>
              <label for="type">Type</label>
              <select id="type">
                <option value="Clip">Clip</option>
                <option value="Musique">Musique</option>
                <option value="Tournage">Tournage</option>
                <option value="Montage">Montage</option>
                <option value="Autre">Autre</option>
              </select>
            </div>
            <div style="grid-column:1 / -1;">
              <label for="description">Description (optionnel)</label>
              <input type="text" id="description" placeholder="D√©tails de la prestation (ex : Clip Mayanna)">
            </div>
            <div>
              <label for="date">Date</label>
              <input type="date" id="date">
            </div>
            <div>
              <label for="montant">Montant (‚Ç¨)</label>
              <input type="text" inputmode="decimal" id="montant" placeholder="ex : 800 ou 800,00">
            </div>
            <div class="checkbox-toggle" style="align-self:end;">
              <input type="checkbox" id="paye">
              <label for="paye" style="margin:0;">D√©j√† pay√© (total)</label>
            </div>
          </div>
          <div class="toolbar" style="margin-top:12px;">
            <button class="btn btn-primary" id="save" type="submit">Ajouter</button>
            <button type="button" class="btn btn-outline" id="reset">R√©initialiser</button>
            <button type="button" class="btn btn-outline" id="addDemo">+ D√©mo</button>
            <button type="button" class="btn btn-outline" id="exportJson">Export JSON</button>
            <button type="button" class="btn btn-outline" id="exportCsv">Export CSV</button>
            <label class="btn btn-outline">
              Import JSON
              <input type="file" id="importJson" accept="application/json" style="display:none;">
            </label>
          </div>
        </form>
      </div>

      <div class="card">
        <h2>Recherche & filtre</h2>
        <div class="filter-panel">
          <div class="filter-row">
            <div>
              <label for="search">Filtre texte</label>
              <input type="text" id="search" placeholder="Client, type, description‚Ä¶">
            </div>
            <div>
              <label for="filterStatus">Statut</label>
              <select id="filterStatus">
                <option value="all">Tous</option>
                <option value="unpayed">Non pay√©</option>
                <option value="partial">Partiel</option>
                <option value="paid">Pay√© / sold√©</option>
              </select>
            </div>
            <div>
              <label for="filterType">Type</label>
              <select id="filterType">
                <option value="all">Tous</option>
                <option value="Clip">Clip</option>
                <option value="Musique">Musique</option>
                <option value="Tournage">Tournage</option>
                <option value="Montage">Montage</option>
                <option value="Autre">Autre</option>
              </select>
            </div>
          </div>

          <div class="filter-actions">
            <div class="row">
              <div class="checkbox-toggle">
                <input type="checkbox" id="debug">
                <label for="debug" style="margin:0;">Debug mode</label>
              </div>
              <div class="checkbox-toggle">
                <input type="checkbox" id="autoFile">
                <label for="autoFile" style="margin:0;">Fichier auto (exp√©rimental)</label>
              </div>
            </div>
            <div class="row" style="gap:8px; color:var(--muted); font-size:12px;">
              <span>Affinez vos r√©sultats :</span>
              <span class="pill">Texte</span>
              <span class="pill">Statut</span>
              <span class="pill">Type</span>
            </div>
          </div>
        </div>

        <div class="totals" style="margin-top:14px;">
          <div class="kpi">
            <div class="label">Total factur√©</div>
            <div class="value" id="totalMontant">0 ‚Ç¨</div>
            <div class="sub">Somme des prestations</div>
          </div>
          <div class="kpi">
            <div class="label">Total re√ßu</div>
            <div class="value" id="totalRecu">0 ‚Ç¨</div>
            <div class="sub">Somme des paiements</div>
          </div>
          <div class="kpi">
            <div class="label">Total restant</div>
            <div class="value" id="totalRestant">0 ‚Ç¨</div>
            <div class="sub">√Ä encaisser</div>
          </div>
        </div>

        <div class="small" id="lsStatus" style="margin-top:6px;"></div>

        <div class="debug-zone" id="debug-zone" style="display:none;">
          <div>Console locale :</div>
          <pre id="debugOut"></pre>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:20px;">
      <h2>Prestations enregistr√©es</h2>
      <div class="small">Clique sur "Encaisser" pour enregistrer un paiement partiel ou total.</div>
      <div class="toolbar" style="margin-top:10px;">
        <button type="button" class="btn btn-outline" id="captureRecap">üì∏ Capture </button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Client / Type</th>
            <th>Montant</th>
            <th>Re√ßu</th>
            <th>Restant</th>
            <th>Avancement</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="10" class="small">Aucune prestation ne correspond.</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Zone de capture mobile cach√©e -->
    <div id="capture-mobile"></div>

    <!-- ====== FORMULAIRE CALENDRIER ====== -->
    <section class="card" id="bloc-calendar" style="max-width: 900px; margin: 24px auto;">
      <h2>Ajouter un RDV (Google Calendar)</h2>
      <p class="hint">Remplis les champs puis clique sur ‚ÄúCr√©er dans Google Calendar‚Äù.</p>

      <div class="grid grid-2">
        <div>
          <label for="gc-title">Titre</label>
          <input id="gc-title" type="text" placeholder="Titre de l‚Äô√©v√©nement" />
        </div>
        <div>
          <label for="gc-location">Lieu</label>
          <input id="gc-location" type="text" placeholder="Lieu" />
        </div>

        <div>
          <label for="gc-date">Date</label>
          <input id="gc-date" type="date" />
        </div>
        <div>
          <label for="gc-allday">Toute la journ√©e ?</label>
          <input id="gc-allday" type="checkbox" />
        </div>

        <div>
          <label for="gc-start">Heure de d√©but</label>
          <input id="gc-start" type="time" />
        </div>
        <div>
          <label for="gc-end">Heure de fin</label>
          <input id="gc-end" type="time" />
        </div>

        <div style="grid-column:1 / -1;">
          <label for="gc-desc">Description</label>
          <textarea id="gc-desc" placeholder="D√©tails (ex : Tournage clip, dur√©e, particularit√©s...)"></textarea>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn btn-primary" id="gc-create" type="button">Cr√©er dans Google Calendar</button>
        <a id="gc-url" href="#" target="_blank" class="btn btn-outline">Ouvrir le lien</a>
      </div>
      <p class="small">Le lien ouvre Google Calendar avec l'√©v√©nement pr√©-rempli (dans un nouvel onglet).</p>
    </section>
    <!-- ====== FIN FORMULAIRE CALENDRIER ====== -->

    <!-- ====== CONTRAT LICENCE D'INSTRUMENTALE ====== -->
    <section class="card" id="bloc-contrat-artiste" style="max-width:900px;margin:24px auto;">
      <h2>Contrat de licence d'instrumentale</h2>
      <p class="hint">
        Remplis les infos, choisis la fonction (Artiste / Manager / Autre), puis clique sur ¬´ G√©n√©rer le contrat instrumental (.doc) ¬ª.
      </p>

      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;">

        <div>
          <label for="ca-nom-artiste">Nom / pr√©nom de la personne (obligatoire)</label>
          <input type="text" id="ca-nom-artiste" placeholder="Nom complet de la personne">
        </div>

        <div>
          <label for="ca-fonction">Fonction (obligatoire)</label>
          <select id="ca-fonction">
            <option value="Artiste" selected>Artiste</option>
            <option value="Manager">Manager / Responsable d'artiste</option>
            <option value="Autre">Autre</option>
          </select>
        </div>

        <div id="ca-wrapper-nom-scene">
          <label for="ca-nom-scene">Nom de sc√®ne (si Artiste)</label>
          <input type="text" id="ca-nom-scene" placeholder="Ex : HAMADA">
        </div>

        <div id="ca-wrapper-artiste-represente" style="display:none;">
          <label for="ca-artiste-represente">Artiste repr√©sent√© (obligatoire si Manager)</label>
          <input type="text" id="ca-artiste-represente" placeholder="Nom de l'artiste repr√©sent√©">
        </div>

        <div id="ca-wrapper-fonction-detail" style="display:none;">
          <label for="ca-fonction-detaillee">Pr√©ciser la fonction (obligatoire si Autre)</label>
          <input type="text" id="ca-fonction-detaillee" placeholder="Ex : Producteur ex√©cutif">
        </div>

        <div>
          <label for="ca-adresse-artiste">Adresse</label>
          <input type="text" id="ca-adresse-artiste" placeholder="Adresse compl√®te">
        </div>

        <div>
          <label for="ca-cp-ville-artiste">Code postal / Ville</label>
          <input type="text" id="ca-cp-ville-artiste" placeholder="Ex : 71170 Chauffailles">
        </div>

        <div>
          <label for="ca-date-contrat">Date du contrat</label>
          <input type="date" id="ca-date-contrat">
        </div>

        <div>
          <label for="ca-lieu-signature">Lieu de signature</label>
          <input type="text" id="ca-lieu-signature" placeholder="Ex : Montlouis-sur-Loire">
        </div>

        <div>
          <label for="ca-titre-oeuvre">Titre de l'instrumentale</label>
          <input type="text" id="ca-titre-oeuvre" placeholder="Titre de la prod">
        </div>

        <div>
          <label for="ca-type-licence">Type de licence</label>
          <select id="ca-type-licence">
            <option value="non exclusive" selected>Non exclusive</option>
            <option value="exclusive">Exclusive</option>
          </select>
        </div>

        <div>
          <label for="ca-montant">Montant pay√© (‚Ç¨)</label>
          <input type="number" id="ca-montant" placeholder="Ex : 100" min="0">
        </div>
      </div>

      <div class="toolbar" style="margin-top:12px;">
        <button type="button" class="btn btn-primary" id="ca-generate">
          G√©n√©rer le contrat instrumental (.doc)
        </button>
      </div>

      <p class="small">
        Le fichier g√©n√©r√© sera un .doc modifiable (Word / LibreOffice), que tu pourras ensuite exporter en PDF pour signature.
      </p>
    </section>
    <!-- ====== FIN CONTRAT LICENCE D'INSTRUMENTALE ====== -->

  </div>

  <footer>Local ‚Äî cl√©: <code>prestations_v1</code>. Si √ßa casse, tu peux exporter en JSON et garder une sauvegarde manuelle.</footer>

  <!-- html2canvas pour la capture -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    function updateThemeLogos(theme){
      const mode = theme === "light" ? "light" : "dark";

      document.querySelectorAll('[data-light-src][data-dark-src]').forEach((img) => {
        const target = mode === "light" ? img.dataset.lightSrc : img.dataset.darkSrc;
        if (target) {
          img.setAttribute("src", target);
        }
      });
    }

    function currentLogoForTheme(theme){
      const mode = theme === "light" ? "light" : "dark";
      const img = document.querySelector('[data-light-src][data-dark-src]');
      if (!img) return "";

      return mode === "light"
        ? (img.dataset.lightSrc || img.getAttribute("src") || "")
        : (img.dataset.darkSrc || img.getAttribute("src") || "");
    }
  </script>

  <!-- SCRIPT GCAL -->
  <script>
  (function(){
    function pad(n){ return String(n).padStart(2,'0'); }
    function yyyymmdd(dateStr){
      if(!dateStr) return "";
      var parts = dateStr.split("-");
      if(parts.length !== 3) return "";
      var Y = parts[0], M = parts[1], D = parts[2];
      return Y + M + D;
    }
    function hhmmss(timeStr){
      if(!timeStr) return "000000";
      var parts = String(timeStr).split(":");
      var h = parts[0] || "00";
      var m = parts[1] || "00";
      return pad(h) + pad(m) + "00";
    }
    function buildUrl(){
      var title = document.getElementById("gc-title").value || "RDV";
      var desc  = document.getElementById("gc-desc").value  || "";
      var loc   = document.getElementById("gc-location").value || "";
      var date  = document.getElementById("gc-date").value;
      var start = document.getElementById("gc-start").value;
      var end   = document.getElementById("gc-end").value;
      var allDay= document.getElementById("gc-allday").checked;

      if(!date) return "";

      var d = yyyymmdd(date);
      var datesParam = "";
      if(allDay){
        datesParam = d + "/" + d;
      }else{
        var hs = hhmmss(start || "09:00");
        var he = hhmmss(end   || "10:00");
        datesParam = d + "T" + hs + "/" + d + "T" + he;
      }

      var params = new URLSearchParams();
      params.set("action","TEMPLATE");
      params.set("text", title);
      if(desc) params.set("details", desc);
      if(loc) params.set("location", loc);
      params.set("dates", datesParam);

      return "https://www.google.com/calendar/render?" + params.toString();
    }

    document.addEventListener("DOMContentLoaded", function(){
      var preview = document.getElementById("gc-url");
      var create  = document.getElementById("gc-create");
      if(!preview || !create) return;

      function refresh(){
        var url = buildUrl();
        if(url){
          preview.href = url;
          preview.textContent = "Ouvrir le lien Google Calendar";
        }else{
          preview.href = "#";
          preview.textContent = "Renseigne au moins la date";
        }
      }

      ["gc-title","gc-desc","gc-location","gc-date","gc-start","gc-end","gc-allday"].forEach(function(id){
        var el = document.getElementById(id);
        if(el){
          el.addEventListener("input", refresh);
          el.addEventListener("change", refresh);
        }
      });
      refresh();

      create.addEventListener("click", function(){
        var url = buildUrl();
        if(url){
          window.open(url, "_blank", "noopener");
        }else{
          alert("Renseigne au moins la date pour cr√©er l'√©v√©nement.");
        }
      });
    });
  })();
  </script>

  <!-- SCRIPT PRESTATIONS -->
  <script>
    (() => {
      const $ = (id) => document.getElementById(id);
      const formEl = $("prestations-form");
      const eur = (n) => new Intl.NumberFormat("fr-FR", {style:"currency", currency:"EUR"}).format(n || 0);
      const storageKey = "prestations_v1";
      const VERSION = "1.4";

      const status = $("status");
      const debugChk = $("debug");
      const autoFile = $("autoFile");
      const debugOut = $("debugOut");
      const lsStatus = $("lsStatus");

      const tbody = $("tbody");
      const totalMontantEl = $("totalMontant");
      const totalRecuEl = $("totalRecu");
      const totalRestantEl = $("totalRestant");
      const search = $("search");
      const filterStatus = $("filterStatus");
      const filterType = $("filterType");

      const client = $("client");
      const type = $("type");
      const description = $("description");
      const date = $("date");
      const montant = $("montant");
      const paye = $("paye");

      const exportJsonBtn = $("exportJson");
      const exportCsvBtn = $("exportCsv");
      const importJsonInput = $("importJson");
      const clearAllBtn = $("clearAll"); // (pas pr√©sent dans le HTML, ok si null)
      const resetBtn = $("reset");
      const addDemoBtn = $("addDemo");
      const captureBtn = $("captureRecap");

      let data = [];
      let editingId = null;

      const log = (...args) => {
        if (debugChk && debugChk.checked) {
          console.log("[DEBUG]", ...args);
          if (debugOut) {
            debugOut.textContent = String(args.join(" "));
          }
        }
      };

      function ts(){
        const d=new Date();
        const p=n=>String(n).padStart(2,"0");
        return d.getFullYear()+"-"+p(d.getMonth()+1)+p(d.getDate())+"_"+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds());
      }

      const supportsLocalStorage = (() => {
        try {
          const k = "__test_ls__";
          localStorage.setItem(k,"1");
          localStorage.removeItem(k);
          return true;
        } catch(e) {
          return false;
        }
      })();

      function showStatus(msg, ok=true){
        if(!status) return;
        status.className = "alert " + (ok ? "alert-ok" : "alert-err");
        status.textContent = msg;
        status.style.display = "block";
        clearTimeout(showStatus._t);
        showStatus._t = setTimeout(() => { status.style.display = "none"; }, 4000);
      }

      function persist(){
        if(!supportsLocalStorage) return;
        try {
          localStorage.setItem(storageKey, JSON.stringify(data));
          log("persist ok", data.length);
        } catch(e) {
          console.error(e);
          showStatus("Erreur de sauvegarde locale : " + e.message, false);
        }
      }

      function load(){
        if(!supportsLocalStorage){
          if(lsStatus){
            lsStatus.textContent = "LocalStorage indisponible (mode secours).";
          }
          return;
        }
        if(lsStatus){
          lsStatus.textContent = "LocalStorage actif.";
        }
        try {
          const raw = localStorage.getItem(storageKey);
          if(!raw) return;
          data = JSON.parse(raw) || [];
        } catch(e) {
          console.error(e);
          showStatus("Impossible de lire les donn√©es locales.", false);
        }
      }

      function sanitizeAmount(v) {
        if (typeof v === "number") return v;
        let s = (v||"").toString().trim();
        s = s.replace(/\s/g,"").replace(",", "."); // french decimal
        const num = parseFloat(s);
        return isFinite(num) ? num : NaN;
      }

      function getPaid(r){ return Number(r.paidAmount || 0); }
      function getRemaining(r){ return Math.max(0, Number((r.montant||0) - getPaid(r))); }
      function isSettled(r){ return getRemaining(r) <= 0.00001; }

      function filterRecords(list){
        const q = (search?.value || "").toLowerCase();
        const fStatus = filterStatus?.value || "all";
        const fType = filterType?.value || "all";

        return list.filter(r => {
          if(q){
            const blob = [r.client,r.type,r.description].join(" ").toLowerCase();
            if(!blob.includes(q)) return false;
          }
          if(fType !== "all" && r.type !== fType) return false;
          if(fStatus !== "all"){
            const settled = isSettled(r);
            const paid = getPaid(r) > 0;
            if(fStatus === "paid" && !settled) return false;
            if(fStatus === "unpayed" && (paid || settled)) return false;
            if(fStatus === "partial" && (!paid || settled)) return false;
          }
          return true;
        });
      }

      function updateTotals(){
        let totalMontant = 0;
        let totalRecu    = 0;
        let totalRestant = 0;

        data.forEach(r => {
          const m = Number(r.montant||0);
          const p = getPaid(r);
          totalMontant += m;
          totalRecu    += p;
          totalRestant += Math.max(0,m-p);
        });

        if(totalMontantEl) totalMontantEl.textContent = eur(totalMontant);
        if(totalRecuEl) totalRecuEl.textContent = eur(totalRecu);
        if(totalRestantEl) totalRestantEl.textContent = eur(totalRestant);
      }

      function render(){
        if(!tbody) return;
        tbody.innerHTML = "";

        const records = filterRecords(data);
        if(!records.length){
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 10;
          td.className = "small";
          td.textContent = "Aucune prestation ne correspond.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          updateTotals();
          return;
        }

        records.sort((a,b) => {
          const da = a.date || "";
          const db = b.date || "";
          return da.localeCompare(db);
        });

        records.forEach(r => {
          const tr = document.createElement("tr");

          const tdDate = document.createElement("td");
          tdDate.textContent = r.date || "";
          tr.appendChild(tdDate);

          const tdClient = document.createElement("td");
          const c1 = document.createElement("div");
          c1.textContent = r.client || "";
          c1.style.fontWeight = "600";
          const c2 = document.createElement("div");
          c2.className = "small";
          c2.textContent = (r.type || "") + (r.description ? " ‚Äî " + r.description : "");
          tdClient.appendChild(c1);
          tdClient.appendChild(c2);
          tr.appendChild(tdClient);

          const tdMontant = document.createElement("td");
          tdMontant.textContent = eur(r.montant || 0);
          tr.appendChild(tdMontant);

          const tdRecu = document.createElement("td");
          tdRecu.textContent = eur(getPaid(r));
          tr.appendChild(tdRecu);

          const remaining = getRemaining(r);
          const tdRestant = document.createElement("td");
          tdRestant.textContent = eur(remaining);
          tr.appendChild(tdRestant);

          const tdProgress = document.createElement("td");
          const wrapper = document.createElement("div");
          wrapper.className = "small";
          const percent = (r.montant && r.montant > 0) ? Math.min(100, Math.round(getPaid(r)/r.montant*100)) : 0;
          wrapper.textContent = percent + " %";
          const bar = document.createElement("div");
          bar.className = "progress";
          const inner = document.createElement("div");
          inner.className = "progress-inner";
          inner.style.width = percent + "%";
          bar.appendChild(inner);
          tdProgress.appendChild(wrapper);
          tdProgress.appendChild(bar);
          tr.appendChild(tdProgress);

          const tdStatus = document.createElement("td");
          const pill = document.createElement("span");
          pill.className = "status-pill";
          const dot = document.createElement("span");
          dot.className = "dot";
          pill.appendChild(dot);
          const label = document.createElement("span");
          let cls = "";
          if(isSettled(r)){
            cls = "paid";
            label.textContent = "Pay√©";
          }else if(getPaid(r) > 0){
            cls = "partial";
            label.textContent = "Partiel";
          }else{
            cls = "muted";
            label.textContent = "Non pay√©";
          }
          pill.classList.add(cls);
          pill.appendChild(label);
          tdStatus.appendChild(pill);
          tr.appendChild(tdStatus);

          const tdActions = document.createElement("td");
          const encBtn = document.createElement("button");
          encBtn.type = "button";
          encBtn.className = "btn btn-primary";
          encBtn.textContent = "Encaisser";
          encBtn.addEventListener("click", () => {
            let max = getRemaining(r);
            if(max <= 0){
              showStatus("Tout est d√©j√† pay√© pour cette prestation.", false);
              return;
            }
            const s = prompt("Montant √† encaisser (max " + eur(max) + "):", "");
            if(s===null) return;
            const val = sanitizeAmount(s);
            if(!isFinite(val) || val<=0){
              showStatus("Montant invalide.", false);
              return;
            }
            if(val > max + 0.00001){
              showStatus("Montant sup√©rieur au restant d√ª.", false);
              return;
            }
            r.paidAmount = (r.paidAmount || 0) + val;
            persist();
            updateTotals();
            render();
            showStatus("Paiement enregistr√©.");
          });

          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.className = "btn btn-outline";
          editBtn.textContent = "Modifier";
          editBtn.addEventListener("click", () => {
            editingId = r.id;
            client.value = r.client || "";
            type.value = r.type || "Clip";
            description.value = r.description || "";
            date.value = r.date || "";
            montant.value = r.montant != null ? String(r.montant) : "";
            paye.checked = isSettled(r);
            window.scrollTo({top:0, behavior:"smooth"});
          });

          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "btn btn-outline";
          delBtn.textContent = "Supprimer";
          delBtn.addEventListener("click", () => {
            if (confirm("Supprimer cette prestation ?")) {
              data = data.filter(x => x.id !== r.id);
              persist();
              updateTotals();
              render();
              if (editingId === r.id) editingId = null;
              showStatus("Prestation supprim√©e.");
            }
          });

          tdActions.appendChild(encBtn);
          tdActions.appendChild(editBtn);
          tdActions.appendChild(delBtn);
          tr.appendChild(tdActions);

          tbody.appendChild(tr);
        });

        updateTotals();
      }

      function resetForm(){
        if(!formEl) return;
        client.value = "";
        type.value = "Clip";
        description.value = "";
        date.value = "";
        montant.value = "";
        paye.checked = false;
        editingId = null;
      }

      function validateForm(){
        const c = client.value.trim();
        if(!c){
          showStatus("Le nom du client est obligatoire.", false);
          client.focus();
          return null;
        }
        const m = sanitizeAmount(montant.value);
        if(!isFinite(m) || m<=0){
          showStatus("Montant invalide.", false);
          montant.focus();
          return null;
        }
        const d = date.value || new Date().toISOString().slice(0,10);
        return {client:c, type:type.value, description:description.value.trim(), date:d, montant:m};
      }

      function addRecord(rec){
        rec.id = rec.id || Date.now() + Math.random();
        rec.paidAmount = rec.paidAmount || 0;
        data.push(rec);
      }

      if(formEl){
        formEl.addEventListener("submit", (e) => {
          e.preventDefault();
          const rec = validateForm();
          if(!rec) return;

          if(editingId){
            const idx = data.findIndex(r => r.id === editingId);
            if(idx !== -1){
              data[idx] = {
                ...data[idx],
                ...rec
              };
              showStatus("Prestation modifi√©e.");
            }
            editingId = null;
          } else {
            if(paye.checked){
              rec.paidAmount = rec.montant;
            }
            addRecord(rec);
            showStatus("Prestation ajout√©e.");
          }

          persist();
          render();
          resetForm();
        });
      }

      if(resetBtn){
        resetBtn.addEventListener("click", () => {
          resetForm();
        });
      }

      if(addDemoBtn){
        addDemoBtn.addEventListener("click", () => {
          const demo = {
            client:"Artiste d√©mo",
            type:"Clip",
            description:"Clip test d√©mo",
            date:new Date().toISOString().slice(0,10),
            montant:800,
            paidAmount:200
          };
          addRecord(demo);
          persist();
          render();
          showStatus("D√©mo ajout√©e.");
        });
      }

      if(exportJsonBtn){
        exportJsonBtn.addEventListener("click", () => {
          try{
            const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "prestations_"+ts()+".json";
            a.click();
            URL.revokeObjectURL(a.href);
            showStatus("Export JSON t√©l√©charg√©.");
          }catch(e){
            console.error(e);
            showStatus("Erreur export JSON : " + e.message, false);
          }
        });
      }

      if(exportCsvBtn){
        exportCsvBtn.addEventListener("click", () => {
          try{
            let csv = "date;client;type;description;montant;recu;restant\n";
            data.forEach(r => {
              csv += [
                r.date || "",
                r.client || "",
                r.type || "",
                (r.description||"").replace(/\n/g," "),
                r.montant || 0,
                getPaid(r),
                getRemaining(r)
              ].map(v => String(v).replace(/;/g,",")).join(";") + "\n";
            });
            const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "prestations_"+ts()+".csv";
            a.click();
            URL.revokeObjectURL(a.href);
            showStatus("Export CSV t√©l√©charg√©.");
          }catch(e){
            console.error(e);
            showStatus("Erreur export CSV : " + e.message, false);
          }
        });
      }

      if(importJsonInput){
        importJsonInput.addEventListener("change", async (e) => {
          const file = e.target.files && e.target.files[0];
          if(!file) return;
          try{
            const txt = await file.text();
            const arr = JSON.parse(txt);
            if(!Array.isArray(arr)) throw new Error("Format JSON invalide");
            data = arr.map(r => ({
              id: r.id || Date.now()+Math.random(),
              client: r.client || "",
              type: r.type || "Clip",
              description: r.description || "",
              date: r.date || "",
              montant: Number(r.montant||0),
              paidAmount: Number(r.paidAmount||0)
            }));
            persist();
            render();
            showStatus("Import JSON r√©ussi.");
          }catch(err){
            console.error(err);
            showStatus("Erreur import JSON : " + err.message, false);
          }finally{
            importJsonInput.value = "";
          }
        });
      }

      if(clearAllBtn){
        clearAllBtn.addEventListener("click", () => {
          if(confirm("Effacer TOUTES les prestations ?")){
            data = [];
            persist();
            render();
            showStatus("Tous les enregistrements ont √©t√© supprim√©s.");
          }
        });
      }

      if(debugChk){
        debugChk.addEventListener("change", () => {
          const zone = document.getElementById("debug-zone");
          if(zone) zone.style.display = debugChk.checked ? "block" : "none";
        });
      }

      if (search) {
        search.addEventListener("input", () => {
          render();
        });
      }
      if (filterStatus) {
        filterStatus.addEventListener("change", render);
      }
      if (filterType) {
        filterType.addEventListener("change", render);
      }

      /* ==== Capture pour "Prestations enregistr√©es" ==== */
if (captureBtn && typeof html2canvas !== "undefined") {
  captureBtn.addEventListener("click", () => {
    const records = filterRecords(data);
    if (!records.length) {
      showStatus("Aucune prestation √† capturer (v√©rifie les filtres).", false);
      return;
    }
    const zone = document.getElementById("capture-mobile");
    if (!zone) {
      alert("Zone de capture introuvable.");
      return;
    }

    const now = new Date();
    const dateStr = now.toLocaleString("fr-FR", {
      day:"2-digit", month:"2-digit", year:"numeric",
      hour:"2-digit", minute:"2-digit"
    });

    const totals = records.reduce((acc, r) => {
      const montant = Number(r.montant || 0);
      const paid = getPaid(r);
      acc.montant += montant;
      acc.recu += paid;
      acc.restant += Math.max(0, montant - paid);
      return acc;
    }, { montant:0, recu:0, restant:0 });

    // D√©tecte le th√®me pour choisir le bon logo
    const isDarkTheme = !document.documentElement.hasAttribute("data-theme") ||
                        document.documentElement.getAttribute("data-theme") !== "light";
    const currentTheme = isDarkTheme ? "dark" : "light";
    const logoSrc = currentLogoForTheme(currentTheme) || (isDarkTheme ? "szd_logo_white.png" : "szd_logo_black.png");

    let html = "";
    html += `
      <div class="cap-header">
        <img src="${logoSrc}" alt="SZD Studio">
        <div class="cap-title">R√©capitulatif des prestations</div>
        <div class="cap-sub">G√©n√©r√© le ${dateStr}</div>
      </div>
      <div class="cap-summary">
        <div class="cap-kpi due">
          <div class="label">Montant d√ª</div>
          <div class="value">${eur(totals.restant)}</div>
        </div>
        <div class="cap-kpi received">
          <div class="label">Montant re√ßu / pay√©</div>
          <div class="value">${eur(totals.recu)}</div>
        </div>
        <div class="cap-kpi total">
          <div class="label">Montant total des prestations</div>
          <div class="value">${eur(totals.montant)}</div>
        </div>
      </div>
    `;

    records.forEach(r => {
      const remaining = getRemaining(r);
      const paid = getPaid(r);
      
      // NOUVEAU (inclus pour la barre de progression)
      const percent = (r.montant && r.montant > 0) ? Math.min(100, Math.round(paid/r.montant*100)) : 0;
      
      let cls, label;
      if (isSettled(r)) {
        // ... (reste de la logique de statut) ...
        cls = "paid";
        label = "Pay√©";
      } else if (paid > 0) {
        cls = "partial";
        label = "Partiel";
      } else {
        cls = "muted";
        label = "Non pay√©";
      }

      html += `
        <div class="cap-item">
          <div class="cap-client">${r.client || ""}</div>
          <div class="cap-subtitle">${(r.type || "")}${r.description ? " ‚Äî " + r.description : ""}</div>
          <div class="cap-row">
            <span>Date</span><span>${r.date || ""}</span>
          </div>
          <div class="cap-row">
            <span>Montant</span><span>${eur(r.montant || 0)}</span>
          </div>
          <div class="cap-row">
            <span>Re√ßu</span><span>${eur(paid)}</span>
          </div>
          <div class="cap-row">
            <span>Restant</span><span>${eur(remaining)}</span>
          </div>
          
          <div class="cap-progress-wrap">
            <div class="cap-row-progress-label">
              <span>Avancement</span>
              <span>${percent} %</span>
            </div>
            <div class="progress">
              <div class="progress-inner" style="width:${percent}%;"></div>
            </div>
          </div>
          
          <div class="cap-row">
            <span>Statut</span>
            <span class="status-pill ${cls}">
              <span class="dot"></span>
              <span>${label}</span>
            </span>
          </div>

        </div>
      `;
    });

    zone.innerHTML = html;
    zone.style.display = "block";

    const bg = document.documentElement.getAttribute("data-theme") === "light"
      ? "#f3f4f6"
      : "#020617";

    html2canvas(zone, {
      backgroundColor: bg,
      scale: 2
    }).then(canvas => {
      const link = document.createElement("a");
      link.download = "recap_prestations_mobile_"+ts()+".png";
      link.href = canvas.toDataURL("image/png");
      link.click();
      zone.style.display = "none";
      showStatus("R√©capitulatif captur√© (format mobile) !");
    }).catch(err => {
      console.error(err);
      zone.style.display = "none";
      showStatus("Erreur lors de la capture du r√©capitulatif.", false);
    });
  });
}

      load();
      render();
      showStatus(
        supportsLocalStorage ? "Sauvegarde locale active." : "Mode secours actif (stockage bloqu√©).",
        supportsLocalStorage
      );
      log("init ok, version", VERSION);

    })();
  </script>

  <!-- ====== TEMPLATE CONTRAT INSTRUMENTALE (CACH√â) ====== -->
  <textarea id="template-contrat-artiste" style="display:none; white-space:pre-wrap;">

[[LIEU_SIGNATURE]], le [[DATE_CONTRAT]]

[[NOM_PERSONNE]]
[[ADRESSE_ARTISTE]]
[[CP_VILLE_ARTISTE]]

Objet : Contrat de licence d'instrumentale ([[TYPE_LICENCE_MAJ]])

Madame, Monsieur,
[[APPEL_CLIENT]]

Par le pr√©sent courrier, il est convenu ce qui suit entre :

[[NOM_PRODUCTEUR]] (ci-apr√®s ¬´ le Producteur ¬ª ou ¬´ le Beatmaker ¬ª),

et

[[BLOC_CLIENT]]

--------------------------------------------------
ARTICLE 1 ‚Äì OBJET
--------------------------------------------------
Le pr√©sent contrat a pour objet de d√©finir les conditions dans lesquelles le Producteur conc√®de √† l'Artiste une licence [[TYPE_LICENCE]] d'utilisation de l'instrumentale intitul√©e ¬´ [[TITRE_OEUVRE]] ¬ª (ci-apr√®s ¬´ l'Instrumentale ¬ª).

--------------------------------------------------
ARTICLE 2 ‚Äì PRIX, ACOMPTE, MODALIT√âS DE PAIEMENT ET RETOUCHES
--------------------------------------------------
En contrepartie de la Licence conc√©d√©e et du travail de production r√©alis√©, l‚ÄôArtiste s‚Äôengage √† verser au Producteur la somme de :

MONTANT TOTAL : [[MONTANT]] ‚Ç¨ TTC

ACOMPTE :
Un acompte obligatoire de trente pour cent (30%) du montant total doit √™tre r√©gl√© pour permettre au Producteur de d√©marrer la production.  
Aucun travail (composition, arrangement, mix, structure ou tout √©l√©ment de production) ne sera initi√© tant que cet acompte n‚Äôaura pas √©t√© re√ßu.

SOLDE :
Le solde restant (70%) doit √™tre r√©gl√© dans un d√©lai maximum de trente (30) jours √† compter de la livraison de la premi√®re version de l‚ÄôInstrumentale ou de l‚Äô√©mission de la demande de paiement correspondante.  
Le paiement complet est indispensable pour valider d√©finitivement la Licence.  
Aucun fichier final (export, stems, projet, ou √©l√©ment d√©finitif) ne sera livr√© tant que le r√®glement total n‚Äôaura pas √©t√© re√ßu.

MODES DE PAIEMENT ACCEPT√âS :
- Virement bancaire (coordonn√©es ci-dessous)
- PayPal ou Lydia (adresse communiqu√©e sur demande)
- Esp√®ces (uniquement en main propre)

Coordonn√©es bancaires du Producteur :
Nom : Armel Abdoulatif ALI
IBAN : FR80 2043 3026 26N2 6178 8757 833
BIC : NTSBFRM1XXX

RETOUCHES :
L‚ÄôArtiste b√©n√©ficie de deux (2) retouches gratuites, √† condition qu‚Äôelles soient demand√©es dans un d√©lai maximum de quinze (15) jours apr√®s la livraison initiale.  
Une retouche correspond √† une modification raisonnable n‚Äôalt√©rant pas la structure ou l‚Äôidentit√© de l‚Äô≈ìuvre.

RETOUCHES SUPPL√âMENTAIRES :
Toute retouche suppl√©mentaire au-del√† des deux incluses sera factur√©e dix euros (10 ‚Ç¨) par retouche.  
Les retouches suppl√©mentaires doivent obligatoirement √™tre r√©gl√©es avant le d√©but de leur r√©alisation.

PROTECTIONS :
Le Producteur se r√©serve le droit de refuser toute demande excessive ou abusive.  
En cas de non-paiement dans les d√©lais impartis (y compris l'acompte ou le solde), la prestation peut √™tre suspendue ou annul√©e sans pr√©avis.
--------------------------------------------------
ARTICLE 3 ‚Äì NATURE DE LA LICENCE
--------------------------------------------------
3.1 Licence non exclusive  
Lorsque la licence choisie est NON EXCLUSIVE, l‚ÄôArtiste peut exploiter librement l‚ÄôInstrumentale, mais le Producteur conserve le droit de vendre la m√™me Instrumentale √† d‚Äôautres artistes.

3.2 Licence exclusive  
Lorsque la licence choisie est EXCLUSIVE, l‚ÄôArtiste obtient un droit exclusif d‚Äôexploitation de l'Instrumentale √† compter de la date du contrat.  
Le Producteur ne pourra plus vendre cette Instrumentale √† un autre artiste apr√®s cette date.

Le type de licence choisi est : [[TYPE_LICENCE_MAJ]].

--------------------------------------------------
ARTICLE 4 ‚Äì TERRITOIRE ET DUR√âE
--------------------------------------------------
La licence est accord√©e pour le monde entier et pour toute la dur√©e l√©gale de protection de l'≈ìuvre au titre du droit d‚Äôauteur.

--------------------------------------------------
ARTICLE 5 ‚Äì DROITS ACCORD√âS
--------------------------------------------------
L‚ÄôArtiste est autoris√© √† :
- enregistrer un ou plusieurs morceaux avec l‚ÄôInstrumentale ;
- diffuser ces morceaux sur les plateformes de streaming (Spotify, Apple Music, Deezer, etc.) ;
- diffuser ces morceaux sur YouTube, TikTok, r√©seaux sociaux, radios, TV ;
- utiliser ces morceaux dans des clips, concerts, showcases, √©v√©nements promotionnels.

L‚ÄôArtiste n‚Äôest pas autoris√© √† :
- revendre l‚ÄôInstrumentale seule ;
- mettre l‚ÄôInstrumentale seule √† disposition en pack, banque de sons, kit de production ;
- revendiquer la qualit√© de producteur ou de beatmaker de l‚ÄôInstrumentale.

--------------------------------------------------
ARTICLE 6 ‚Äì MENTION OBLIGATOIRE DU PRODUCTEUR
--------------------------------------------------
L‚ÄôArtiste s'engage √† cr√©diter le Producteur de mani√®re claire et visible sur toutes les exploitations du morceau utilisant l‚ÄôInstrumentale, notamment, √† titre d‚Äôexemple :

¬´ Prod. par [[NOM_PRODUCTEUR]] ¬ª

Cette mention devra appara√Ætre, dans la mesure du possible :
- dans les m√©tadonn√©es des plateformes (Spotify, Apple Music, Deezer, etc.) ;
- dans les descriptions des vid√©os YouTube ;
- sur la pochette ou le visuel du single / projet ;
- sur les visuels promotionnels et publications r√©seaux sociaux.

--------------------------------------------------
ARTICLE 7 ‚Äì PROPRI√âT√â INTELLECTUELLE
--------------------------------------------------
Le Producteur reste, en toutes circonstances, seul titulaire des droits d‚Äôauteur sur l‚ÄôInstrumentale.

La licence conc√©d√©e √† l‚ÄôArtiste n‚Äôemporte aucun transfert de propri√©t√©, mais uniquement une autorisation d‚Äôutilisation dans le cadre d√©fini par le pr√©sent contrat.

--------------------------------------------------
ARTICLE 8 ‚Äì GARANTIE D‚ÄôUTILISATION
--------------------------------------------------
L‚ÄôArtiste s‚Äôengage √† ne pas utiliser l‚ÄôInstrumentale ni les morceaux qui en d√©coulent dans des contenus :
- diffamatoires,
- haineux,
- discriminatoires,
- contraires aux lois et r√®glements fran√ßais.

--------------------------------------------------
ARTICLE 9 ‚Äì R√âSILIATION
--------------------------------------------------
En cas de non-respect grave des obligations du pr√©sent contrat (par exemple : diffusion de l‚ÄôInstrumentale seule, absence syst√©matique de cr√©dit du Producteur, cession non autoris√©e de la licence), le Producteur pourra proc√©der √† la r√©siliation du contrat apr√®s mise en demeure √©crite rest√©e sans effet pendant un d√©lai de quinze (15) jours.

La r√©siliation ne remet pas en cause les sommes d√©j√† vers√©es au titre de la licence.

--------------------------------------------------
ARTICLE 10 ‚Äì DROIT APPLICABLE ET JURIDICTION
--------------------------------------------------
Le pr√©sent contrat est r√©gi par le droit fran√ßais.

En cas de litige relatif √† son interpr√©tation ou √† son ex√©cution, et √† d√©faut de r√©solution amiable, les Parties conviennent de soumettre le diff√©rend aux tribunaux comp√©tents du ressort du domicile du Producteur.

Fait √† [[LIEU_SIGNATURE]], le [[DATE_CONTRAT]].

Le Producteur  
[[NOM_PRODUCTEUR]]  
Signature :

L'Artiste  
[[NOM_ARTISTE]]  
Alias [[NOM_SCENE]]  
Signature :

</textarea>

  <!-- ====== FIN TEMPLATE CONTRAT INSTRUMENTALE ====== -->

  <!-- SCRIPT CONTRAT INSTRUMENTAL -->
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const btn = document.getElementById('ca-generate');
    const tplEl = document.getElementById('template-contrat-artiste');
    if (!btn || !tplEl) return;

    const fFonction = document.getElementById('ca-fonction');
    const wrapNomScene = document.getElementById('ca-wrapper-nom-scene');
    const wrapArtisteRep = document.getElementById('ca-wrapper-artiste-represente');
    const wrapFonctionDetail = document.getElementById('ca-wrapper-fonction-detail');

    function g(id) {
      const el = document.getElementById(id);
      return el ? el.value.trim() : "";
    }

    function updateFonctionUI(){
      const f = g('ca-fonction') || "Artiste";
      if (f === "Artiste") {
        if (wrapNomScene) wrapNomScene.style.display = "";
        if (wrapArtisteRep) wrapArtisteRep.style.display = "none";
        if (wrapFonctionDetail) wrapFonctionDetail.style.display = "none";
      } else if (f === "Manager") {
        if (wrapNomScene) wrapNomScene.style.display = "none";
        if (wrapArtisteRep) wrapArtisteRep.style.display = "";
        if (wrapFonctionDetail) wrapFonctionDetail.style.display = "none";
      } else { // Autre
        if (wrapNomScene) wrapNomScene.style.display = "none";
        if (wrapArtisteRep) wrapArtisteRep.style.display = "none";
        if (wrapFonctionDetail) wrapFonctionDetail.style.display = "";
      }
    }

    if (fFonction) {
      fFonction.addEventListener('change', updateFonctionUI);
      updateFonctionUI();
    }

    btn.addEventListener('click', function () {
      let tpl = tplEl.value;
      if (!tpl || !tpl.trim()) {
        alert('Le mod√®le de contrat est vide. V√©rifie le bloc <textarea id="template-contrat-artiste"> dans le code.');
        return;
      }

      const nomPersonne = g('ca-nom-artiste');
      const fonction = g('ca-fonction') || "Artiste";
      const artisteRep = g('ca-artiste-represente');
      const fonctionDetaillee = g('ca-fonction-detaillee');

      if (!nomPersonne) {
        alert("Le nom / pr√©nom de la personne est obligatoire.");
        return;
      }

      if (fonction === "Manager" && !artisteRep) {
        alert("Merci de pr√©ciser l'artiste repr√©sent√© (obligatoire pour un manager).");
        return;
      }

      if (fonction === "Autre" && !fonctionDetaillee) {
        alert("Merci de pr√©ciser la fonction (obligatoire si 'Autre').");
        return;
      }

      // Artiste principal utilis√© dans le contrat
      let nomArtisteContrat;
      if (fonction === "Artiste") {
        nomArtisteContrat = nomPersonne;
      } else if (fonction === "Manager") {
        nomArtisteContrat = artisteRep || nomPersonne;
      } else { // Autre
        nomArtisteContrat = nomPersonne;
      }

      let nomScene = "";
      if (fonction === "Artiste") {
        nomScene = g('ca-nom-scene') || nomArtisteContrat;
      } else if (fonction === "Manager") {
        nomScene = artisteRep || nomArtisteContrat;
      } else {
        nomScene = nomArtisteContrat;
      }

      // Bloc d'appel (Madame, Monsieur, ... )
      let appelClient;
      if (fonction === "Artiste") {
        appelClient = `Cher/Ch√®re ${nomArtisteContrat} (alias ${nomScene}),`;
      } else if (fonction === "Manager") {
        appelClient = `Cher/Ch√®re ${nomPersonne}, manager de ${nomArtisteContrat},`;
      } else {
        appelClient = `Cher/Ch√®re ${nomPersonne},`;
      }

      // Bloc client (partie "et ...")
      let blocClient;
      if (fonction === "Artiste") {
        blocClient = `${nomArtisteContrat}, √©galement connu sous le nom de sc√®ne ${nomScene}, demeurant ${g('ca-adresse-artiste')} ${g('ca-cp-ville-artiste')} (ci-apr√®s ¬´ l'Artiste ¬ª).`;
      } else if (fonction === "Manager") {
        blocClient = `${nomPersonne}, agissant en qualit√© de manager de ${nomArtisteContrat}, demeurant ${g('ca-adresse-artiste')} ${g('ca-cp-ville-artiste')} (le manager, repr√©sentant l'Artiste).`;
      } else {
        blocClient = `${nomPersonne}, agissant en qualit√© de ${fonctionDetaillee}, demeurant ${g('ca-adresse-artiste')} ${g('ca-cp-ville-artiste')} (ci-apr√®s ¬´ le Client ¬ª).`;
      }

      const nomProducteur = "Armel ALI"; // change ici si besoin

      tpl = tpl
        .replaceAll('[[NOM_PERSONNE]]', nomPersonne || nomArtisteContrat)
        .replaceAll('[[APPEL_CLIENT]]', appelClient)
        .replaceAll('[[BLOC_CLIENT]]', blocClient)
        .replaceAll('[[NOM_ARTISTE]]', nomArtisteContrat)
        .replaceAll('[[NOM_SCENE]]', nomScene || nomArtisteContrat)
        .replaceAll('[[ADRESSE_ARTISTE]]', g('ca-adresse-artiste'))
        .replaceAll('[[CP_VILLE_ARTISTE]]', g('ca-cp-ville-artiste'))
        .replaceAll('[[DATE_CONTRAT]]', g('ca-date-contrat'))
        .replaceAll('[[LIEU_SIGNATURE]]', g('ca-lieu-signature'))
        .replaceAll('[[TITRE_OEUVRE]]', g('ca-titre-oeuvre') || "Instrumentale")
        .replaceAll('[[TYPE_LICENCE]]', g('ca-type-licence') || "non exclusive")
        .replaceAll('[[TYPE_LICENCE_MAJ]]', (g('ca-type-licence') || "non exclusive").toUpperCase())
        .replaceAll('[[MONTANT]]', g('ca-montant') || "0")
        .replaceAll('[[NOM_PRODUCTEUR]]', nomProducteur);

      const blob = new Blob([tpl], { type: "application/msword" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const safeName = (nomScene || nomArtisteContrat || "Artiste").replace(/\s+/g, "_");

      a.href = url;
      a.download = "Contrat_Licence_Instrumentale_" + safeName + ".doc";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  });
  </script>

  <!-- SCRIPT THEME NUIT/JOUR -->
  <script>
    (function(){
      const THEME_KEY = "szd_theme";
      const root = document.documentElement;

      function applyTheme(theme){
        if(theme === "light"){
          root.setAttribute("data-theme","light");
        }else{
          root.removeAttribute("data-theme"); // dark par d√©faut
        }

        if (typeof updateThemeLogos === "function") {
          updateThemeLogos(theme);
        }
      }

      document.addEventListener("DOMContentLoaded", function(){
        var toggle = document.getElementById("themeToggle");
        if(!toggle) return;

        var saved = null;
        try {
          saved = localStorage.getItem(THEME_KEY);
        } catch(e) {}

        if(saved === "light"){
          applyTheme("light");
          toggle.checked = false;
        } else {
          applyTheme("dark");
          toggle.checked = true;
        }

        toggle.addEventListener("change", function(){
          if(toggle.checked){
            applyTheme("dark");
            try { localStorage.setItem(THEME_KEY,"dark"); } catch(e) {}
          } else {
            applyTheme("light");
            try { localStorage.setItem(THEME_KEY,"light"); } catch(e) {}
          }
        });
      });
    })();
  </script>

</body>
</html>
