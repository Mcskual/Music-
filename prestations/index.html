<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Prestations — Clips & Musique (v1.4)</title>
  <style>
    :root {
      --bg:#0b0e14;
      --card:#111827;
      --panel:#0f172a;
      --muted:#9ca3af;
      --accent:#3b82f6;
      --accent2:#22d3ee;
      --border:#1f2937;
      --text:#e5e7eb;
      --text2:#9ca3af;
      --shadow:0 8px 28px rgba(0,0,0,.32);
      --nav-bg:#0f172a;
      --nav-sheen:linear-gradient(90deg,rgba(255,255,255,.05),transparent 50%);
      --bg-gradient:var(--bg);
      --suno-orange:#FF7A18;
    }

    /* Thème clair premium */
    [data-theme="light"] {
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#0f172a;
      --text2:#4b5563;
      --border:#e5e7eb;
      --muted:#6b7280;
      --shadow:0 16px 40px rgba(15,23,42,.12);
      --nav-bg:linear-gradient(125deg,rgba(59,130,246,.12),rgba(34,197,94,.08)),linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.9));
      --nav-sheen:linear-gradient(90deg,rgba(15,23,42,.06),transparent 45%,rgba(15,23,42,.08));
      --bg-gradient:
        radial-gradient(circle at 0% 0%, rgba(59,130,246,.12), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(120deg,#f9fafb,#f3f4f6 40%,#e5e7eb 60%,#f9fafb);
    }

    *, *::before, *::after { box-sizing:border-box; }
    * { scroll-behavior:auto; }

    body {
      font-family: "Inter", system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: var(--bg);
      color:var(--text);
      margin:0;
      overflow-y:auto;
      overflow-x:hidden;
    }

    .container { max-width:1200px; margin:36px auto 0 auto; padding:0 16px; }
    .tab-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px 16px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .tab-header h2{ margin:0; font-size:clamp(22px,2.8vw,26px); }
    .tab-subtitle{
      color:var(--text2);
      margin:6px 0 0;
      font-size:14px;
      max-width:820px;
      line-height:1.5;
    }
    .tab-actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      align-self:center;
    }

    .top-nav{
      position:relative;
      display:flex;
      align-items:center;
      flex-wrap:nowrap;
      gap:12px;
      padding:10px 14px;
      min-height:70px;
      background:var(--nav-bg);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
      margin-bottom:16px;
      overflow:hidden;
      isolation:isolate;
      z-index:20;
    }
    .top-nav::after{
      content:"";
      position:absolute;
      inset:0;
      background:var(--nav-sheen);
      pointer-events:none;
      z-index:0;
    }
    .nav-left,
    .nav-center,
    .nav-actions{
      display:flex;
      align-items:center;
      min-width:0;
      z-index:1;
      height:100%;
      flex-shrink:0;
    }
    .nav-left{ flex:0 0 auto; }
    .nav-center{
      flex:1 1 auto;
      gap:8px;
      justify-content:flex-start;
      position:relative;
      min-width:0;
      overflow:visible;
    }
    .nav-actions{
      flex:0 0 auto;
      justify-content:flex-end;
      gap:8px;
      padding-left:4px;
    }
    .privacy-toggle{
      display:inline-flex;
      align-items:center;
      gap:8px;
      height:44px;
      padding:0 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:inherit;
      font-weight:600;
      cursor:pointer;
      transition:.18s background,.18s border-color,.18s transform,.18s box-shadow;
    }
    [data-theme="light"] .privacy-toggle{
      background:rgba(255,255,255,.9);
    }
    .privacy-toggle:hover{
      border-color:var(--accent);
      box-shadow:0 10px 22px rgba(0,0,0,.25);
      transform:translateY(-1px);
    }
    .privacy-toggle.is-active{
      background:linear-gradient(135deg,rgba(59,130,246,.14),rgba(34,211,238,.14));
      border-color:var(--accent);
      box-shadow:0 12px 26px rgba(34,211,238,.2);
    }
    .privacy-toggle.icon-only{
      width:44px;
      padding:0;
      justify-content:center;
      gap:0;
    }
    .privacy-toggle-icon{ font-size:16px; }
    .privacy-toggle-text{ font-size:13px; }
    .sr-only{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }
    .nav-toggle{
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:5px;
      width:44px;
      height:44px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:inherit;
      cursor:pointer;
      transition:.2s background,.2s border-color,.2s transform;
    }
    [data-theme="light"] .nav-toggle{
      background:rgba(255,255,255,.9);
    }
    .nav-toggle:hover{
      border-color:var(--accent);
      transform:translateY(-1px);
    }
    .nav-toggle .bar{
      width:20px;
      height:2px;
      border-radius:999px;
      background:currentColor;
      transition:.2s transform,.2s opacity,.2s background;
    }
    .top-nav.is-open .nav-toggle{
      border-color:var(--accent);
    }
    .top-nav.is-open .nav-toggle .bar:nth-child(1){
      transform:translateY(6px) rotate(45deg);
    }
    .top-nav.is-open .nav-toggle .bar:nth-child(2){
      opacity:0;
    }
    .top-nav.is-open .nav-toggle .bar:nth-child(3){
      transform:translateY(-6px) rotate(-45deg);
    }
    .nav-links{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-start;
      flex:1 1 auto;
      min-width:0;
      padding:6px 10px;
      background:#0d121d;
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:none;
      position:relative;
      z-index:1;
      flex-wrap:wrap;
      overflow:visible;
      white-space:normal;
    }
    [data-theme="light"] .nav-links{ background:rgba(15,23,42,.02); }
    .nav-link{
      position:relative;
      color:var(--text2);
      text-decoration:none;
      min-width:108px;
      height:40px;
      display:inline-flex;
      justify-content:center;
      align-items:center;
      line-height:1;
      padding:0 12px;
      box-sizing:border-box;
      border-radius:12px;
      border:1px solid transparent;
      background:#0f172a;
      font-size:13px;
      font-weight:700;
      letter-spacing:.01em;
      transition:.18s background,.18s border-color,.18s color;
      white-space:nowrap;
      flex:0 0 auto;
    }
    [data-theme="light"] .nav-link{ background:#f8fafc; }
    .nav-link:hover{
      border-color:var(--accent);
      color:#e2e8f0;
      background:#111827;
    }
    [data-theme="light"] .nav-link:hover{ color:var(--accent); }
    .nav-link::after{
      content:"";
      position:absolute;
      left:12px;
      right:12px;
      bottom:6px;
      height:3px;
      border-radius:999px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      opacity:0;
      transform:translateY(6px);
      transition:.2s ease;
    }
    .nav-link:hover::after{ opacity:1; transform:translateY(0); }
    .nav-link.active{
      background:#111827;
      color:#f8fafc;
      border-color:rgba(59,130,246,.45);
      box-shadow:none;
    }
    .nav-link[data-tab-target="beatsengine"].active{
      border-color:rgba(255,122,24,.35);
    }
    [data-theme="light"] .nav-link.active{
      background:linear-gradient(135deg,rgba(59,130,246,.14),rgba(16,185,129,.16));
      color:var(--accent);
      box-shadow:0 8px 18px rgba(59,130,246,.22);
    }
    .nav-link.active::after{ opacity:1; transform:translateY(0); background:linear-gradient(135deg,rgba(255,255,255,.8),rgba(255,255,255,.4)); }
    .nav-link[data-tab-target="beatsengine"].active::after{
      background:var(--suno-orange);
    }
    .theme-toggle{
      display:flex;
      align-items:center;
      gap:8px;
      height:100%;
    }
    @media(max-width:820px){
      .top-nav{ gap:10px; }
      .nav-link{ min-width:100px; padding:0 10px; font-size:12px; }
      .nav-links{ gap:8px; padding:6px 8px; }
      .theme-toggle{ padding:6px 8px; }
    }
    @media(max-width:768px){
      .top-nav{
        flex-wrap:wrap;
        overflow:visible;
        padding:10px 12px;
      }
      .top-nav .logo-wrap img{
        width:80%;
        max-width:160px;
        height:auto;
      }
      .nav-center{
        order:3;
        width:100%;
      }
      .nav-actions{
        margin-left:auto;
        gap:8px;
      }
      .nav-toggle{
        display:inline-flex;
      }
      .nav-links{
        position:absolute;
        top:100%;
        left:0;
        right:0;
        flex-direction:column;
        gap:10px;
        padding:12px;
        background:var(--nav-bg);
        border:1px solid var(--border);
        border-radius:14px;
        box-shadow:0 18px 36px rgba(0,0,0,.4);
        transform:translateY(-6px);
        opacity:0;
        visibility:hidden;
        pointer-events:none;
        max-height:0;
        overflow:hidden;
        transition:max-height .28s ease, opacity .18s ease, transform .18s ease, visibility 0s linear .18s;
        z-index:5;
      }
      .top-nav.is-open .nav-links{
        opacity:1;
        visibility:visible;
        transform:translateY(0);
        pointer-events:auto;
        max-height:600px;
        transition:max-height .32s ease, opacity .22s ease, transform .22s ease, visibility 0s;
      }
      .nav-link{
        width:100%;
        justify-content:flex-start;
      }
      .theme-toggle{
        padding:8px;
        border-radius:12px;
        gap:0;
      }
      .theme-toggle .switch{
        display:none;
      }
      .theme-toggle .theme-icon{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        width:36px;
        height:36px;
        border-radius:12px;
        border:1px solid var(--border);
        background:var(--nav-bg);
        cursor:pointer;
      }
    }
    @media(max-width:640px){
      .nav-link{ min-width:96px; padding:0 8px; }
      .top-nav{ padding:8px 10px; }
    }

    header.app {
      display:flex;
      gap:16px;
      align-items:center;
      margin-bottom:8px;
      flex-wrap:wrap;
    }

    .logo-wrap{
      background:var(--card);
      border-radius:18px;
      padding:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      text-decoration:none;
      color:inherit;
    }
    .logo-wrap img{
      width:220px;
      height:auto;
      display:block;
      border-radius:14px;
      transition:transform .2s ease, opacity .2s ease;
    }
    .logo-compact{
      padding:6px 10px;
      border-radius:14px;
    }
    .logo-compact img{ width:160px; }

    h1 {
      font-size:clamp(26px,4vw,40px);
      margin:0;
      padding:0;
      line-height:1.15;
    }
    h2 { margin:0 0 10px; font-size:clamp(18px,2.4vw,22px); }
    .sub{ color:var(--text2); margin-bottom:16px; font-size:14px;}

    header.app, header.hero { margin-bottom:16px; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:16px;
      margin-top:16px !important;
    }

    .page-content{
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .whatsapp-card{
      position:relative;
      overflow:hidden;
      border:1px solid rgba(34,197,94,.35);
      background:linear-gradient(135deg,rgba(16,185,129,.12),rgba(16,185,129,.04)),var(--card);
    }
    .whatsapp-card::after{
      content:"";
      position:absolute;
      inset:-40% auto auto 40%;
      width:360px;
      height:360px;
      background:radial-gradient(circle at center, rgba(16,185,129,.18), transparent 55%);
      opacity:.8;
      pointer-events:none;
      filter:blur(8px);
    }
    .whatsapp-card h2{ display:flex; align-items:center; gap:8px; margin-bottom:6px; }
    .wa-icon{ width:22px; height:22px; display:inline-flex; align-items:center; justify-content:center; }
    .wa-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(34,197,94,.18);
      color:#bbf7d0;
      border:1px solid rgba(34,197,94,.45);
      font-size:12px;
      font-weight:700;
      letter-spacing:.01em;
    }
    [data-theme="light"] .wa-chip{ color:#0f5132; background:rgba(16,185,129,.16); }
    .wa-legend{ gap:8px; }

    .followup-grid{ position:relative; z-index:1; }
    .followup-card{
      position:relative;
      border:1px solid rgba(34,197,94,.32);
      background:linear-gradient(120deg,rgba(16,185,129,.09),rgba(16,185,129,.02));
      box-shadow:0 12px 30px rgba(16,185,129,.12);
      isolation:isolate;
    }
    .followup-card::before{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(135deg,rgba(16,185,129,.18),transparent 55%);
      opacity:.4;
      pointer-events:none;
      border-radius:inherit;
      z-index:0;
    }
    .followup-card > *{ position:relative; z-index:1; }
    .followup-head{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .followup-meta{ display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:8px; margin-top:10px; }
    .followup-stat{
      display:flex;
      flex-direction:column;
      gap:4px;
      padding:8px 10px;
      border-radius:10px;
      background:rgba(15,23,42,.4);
      border:1px solid rgba(34,197,94,.25);
    }
    [data-theme="light"] .followup-stat{ background:rgba(240,253,244,.9); }
    .followup-stat .label{ font-size:12px; color:var(--muted); display:inline-flex; gap:6px; align-items:center; }
    .followup-stat .value{ font-weight:700; font-size:14px; }
    .followup-pill{ box-shadow:0 4px 16px rgba(16,185,129,.16); }
    .followup-actions{ display:flex; flex-direction:column; gap:6px; margin-top:12px; }
    .followup-btn-row{ display:flex; flex-wrap:wrap; gap:8px; }
    .relance-btn{ color:#fff; border-color:transparent; }
    .relance-soft{ background:linear-gradient(135deg,#22c55e,#15803d); box-shadow:0 10px 20px rgba(16,185,129,.28); }
    .relance-soft:hover{ background:linear-gradient(135deg,#34d399,#16a34a); }
    .relance-firm{ background:linear-gradient(135deg,#f59e0b,#d97706); box-shadow:0 10px 20px rgba(245,158,11,.28); }
    .relance-firm:hover{ background:linear-gradient(135deg,#fbbf24,#f59e0b); }
    .relance-critical{ background:linear-gradient(135deg,#ef4444,#b91c1c); box-shadow:0 12px 22px rgba(239,68,68,.3); }
    .relance-critical:hover{ background:linear-gradient(135deg,#f87171,#ef4444); }

    @media(max-width:640px){
      .followup-head{ flex-direction:column; }
      .followup-pill{ align-self:flex-start; }
    }

    .grid{ display:grid; gap:16px; }
    .grid-2{ grid-template-columns:1.15fr .85fr; }
    @media(max-width:960px){
      .grid-2{ grid-template-columns:1fr; }
      header.app{ justify-content:flex-start; }
    }

    label{
      display:block;
      font-size:13px;
      margin-bottom:6px;
      color:var(--text2);
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    input[type="time"],
    select,
    textarea{
      width:100%;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      font-size:14px;
      outline:none;
      transition:.16s border-color,.16s box-shadow,.16s background,.16s transform;
    }
    input::placeholder,
    textarea::placeholder{ color:#6b7280; font-size:13px;}
    input:focus,
    select:focus,
    textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(59,130,246,.35);
      background:var(--card);
    }

    .btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:9px 14px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
      letter-spacing:.01em;
      background:transparent;
      color:var(--text);
      border:1px solid var(--border);
      transition:.12s background,.12s border-color,.12s color;
    }
    .btn-primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
      border-radius:8px;
      box-shadow:none;
    }
    .btn-primary:hover{
      background:#4f8ff8;
      border-color:#4f8ff8;
    }
    .btn-outline{
      background:transparent;
      color:var(--text);
      border-color:var(--border);
    }
    [data-theme="light"] .btn-outline{
      border-color:#d1d5db;
      background:#f9fafb;
    }
    .btn-outline:hover{
      background:#111827;
      border-color:#1f2937;
    }
    [data-theme="light"] .btn-outline:hover{
      background:#edf2ff;
      border-color:#3b82f6;
    }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
      align-items:center;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      font-size:13px;
      border-radius:12px;
      overflow:hidden;
    }
    th,td{
      padding:7px 8px;
      border-bottom:1px solid #111827;
      text-align:left;
      vertical-align:top;
    }
    [data-theme="light"] th,
    [data-theme="light"] td{
      border-bottom:1px solid #e5e7eb;
    }
    th{
      font-weight:500;
      font-size:12px;
      color:#9ca3af;
      white-space:nowrap;
      background:rgba(15,23,42,.85);
    }
    [data-theme="light"] th{
      background:#f3f4f6;
      color:#6b7280;
    }
    tr:nth-child(even) td{
      background:rgba(15,23,42,.35);
    }
    [data-theme="light"] tr:nth-child(even) td{
      background:#f9fafb;
    }
    tr:hover td{
      background:rgba(59,130,246,.18);
    }
    [data-theme="light"] tr:hover td{
      background:rgba(59,130,246,.09);
    }

    .small{ font-size:12px; color:#8aa0b5;}
    .muted{ color:#94a3b8; font-size:12px; }

    .totals{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:8px;
      margin-top:10px;
    }
    @media(max-width:780px){ .totals{ grid-template-columns:1fr; } }

    .kpi{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .kpi .label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .kpi .value{
      font-size:20px;
      font-weight:800;
      margin-top:6px;
    }
    .kpi .sub{
      font-size:11px;
      color:#64748b;
      margin-top:2px;
    }

    .progress{
      height:6px;
      border-radius:999px;
      background:rgba(15,23,42,.8);
      overflow:hidden;
      border:1px solid #111827;
    }
    [data-theme="light"] .progress{
      background:#e5e7eb;
      border-color:#d1d5db;
    }
    .progress-inner{
      height:100%;
      width:0;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      transition:width .2s ease-out;
    }

    .searchbar{
      display:grid;
      grid-template-columns:1fr 160px 150px;
      gap:10px;
      margin:10px 0 0;
    }
    @media(max-width:780px){
      .searchbar{ grid-template-columns:1fr; }
    }

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:5px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:var(--card);
      font-size:11px;
      color:var(--text);
    }
    [data-theme="light"] .status-pill{
      border-color:#e5e7eb;
    }
    .status-pill span.dot{
      width:8px;
      height:8px;
      border-radius:999px;
      display:inline-block;
    }

    /* États de pastilles (nuit) */
    .status-pill.paid{
      background:rgba(22,163,74,.14);
      border-color:#16a34a;
      color:#bbf7d0;
    }
    .status-pill.paid .dot{
      background:#22c55e;
    }

    .status-pill.partial{
      background:rgba(234,179,8,.16);
      border-color:#facc15;
      color:#fef9c3;
    }
    .status-pill.partial .dot{
      background:#eab308;
    }

    .status-pill.muted{
      background:rgba(239,68,68,.16);
      border-color:#ef4444;
      color:#fecaca;
    }
    .status-pill.muted .dot{
      background:#ef4444;
    }
    .status-pill.critical{
      background:rgba(248,113,113,.22);
      border-color:#ef4444;
      color:#ffe4e6;
    }
    .status-pill.critical .dot{
      background:#f87171;
    }

    /* États de pastilles (jour) */
    [data-theme="light"] .status-pill.paid{
      background:rgba(22,163,74,.14);
      border-color:#16a34a;
      color:#166534;
    }
    [data-theme="light"] .status-pill.partial{
      background:rgba(250,204,21,.16);
      border-color:#eab308;
      color:#854d0e;
    }
    [data-theme="light"] .status-pill.muted{
      background:rgba(248,113,113,.18);
      border-color:#ef4444;
      color:#991b1b;
    }
    [data-theme="light"] .status-pill.critical{
      background:rgba(254,226,226,.9);
      border-color:#ef4444;
      color:#991b1b;
    }

    .checkbox-toggle{ display:flex; align-items:center; gap:8px; }

    .alert{
      padding:10px 12px;
      border-radius:12px;
      margin:10px 0;
    }
    .alert-ok{
      background:rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.5);
      color:#bbf7d0;
    }
    .alert-err{
      background:rgba(239,68,68,.08);
      border:1px solid rgba(239,68,68,.5);
      color:#fecaca;
    }

    footer{
      margin:20px 0;
      color:#94a3b8;
      font-size:12px;
      text-align:center;
    }
    footer code{
      background:var(--card);
      border-radius:8px;
      padding:2px 6px;
      border:1px solid #1f2937;
    }
    [data-theme="light"] footer code{
      border-color:#e5e7eb;
    }

    .hint{ font-size:12px; color:#9fb1c2; }
    .tab-section{ display:none; }
    .tab-section.active{ display:block; }
    .embed-shell{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:var(--shadow);
      padding:12px;
      margin-top:16px;
    }
    .embed-frame{
      width:100%;
      border:0;
      border-radius:10px;
      background:transparent;
      min-height:860px;
      display:block;
    }
    .embed-note{
      font-size:13px;
      color:var(--text2);
      margin:0 0 10px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .embed-note[data-loaded="true"]{ display:none; }
    .row{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px;
    }
    .pill{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:var(--card);
      color:#9ca3af;
    }
    [data-theme="light"] .pill{
      border-color:#e5e7eb;
      color:#6b7280;
    }

    /* Switch thème */
    .switch{
      position:relative;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      color:#9ca3af;
      cursor:pointer;
      user-select:none;
    }
    .switch input{ display:none; }
    .switch span.slider{
      width:34px;
      height:18px;
      border-radius:999px;
      background:#020617;
      border:1px solid #1f2937;
      position:relative;
      transition:.16s background,.16s border-color;
    }
    [data-theme="light"] .switch span.slider{
      background:#e5e7eb;
      border-color:#d1d5db;
    }
    .switch span.slider::before{
      content:"";
      position:absolute;
      top:1px;
      left:1px;
      width:14px;
      height:14px;
      border-radius:999px;
      background:#e5e7eb;
      transition:.16s transform,.16s background;
      box-shadow:0 1px 3px rgba(15,23,42,.5);
    }
    [data-theme="light"] .switch span.slider::before{
      background:#ffffff;
    }
    .switch input:checked + .slider{
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      border-color:transparent;
    }
    .switch input:checked + .slider::before{
      transform:translateX(14px);
    }
    .theme-toggle{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      background:rgba(15,23,42,.6);
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow:var(--shadow);
      flex-shrink:0;
    }
    [data-theme="light"] .theme-toggle{ background:#f8fafc; }
    .theme-icon{
      font-size:14px;
      line-height:1;
      filter:drop-shadow(0 2px 6px rgba(0,0,0,.25));
    }

    .debug-zone{
      margin-top:10px;
      font-size:11px;
      background:var(--card);
      border-radius:12px;
      padding:8px 10px;
      border:1px dashed #1f2937;
      color:#9ca3af;
    }
    .debug-zone pre{
      margin:4px 0 0;
      white-space:pre-wrap;
      word-break:break-word;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }

    .actions button{ margin-right:6px; }

    .small { font-size:12px; color:#8aa0b5;}
    .checkbox-toggle { display:flex; align-items:center; gap:8px;}
    .alert-ok { background: rgba(34,197,94,.1); border:1px solid rgba(34,197,94,.4); color:#86efac; }
    .alert-err{ background: rgba(239,68,68,.1); border:1px solid rgba(239,68,68,.4); color:#fecaca; }
    .hint { font-size:12px; color:#9fb1c2; }
    .debug { font-size:12px; color:#9ca3af; margin-top:6px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .totals { display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px; margin-top:10px; }
    .kpi{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; }
    .kpi .label{ font-size:12px; color:var(--muted); }
    .kpi .value{ font-size:20px; font-weight:800; margin-top:6px;}
    .actions button{ margin-right:6px;}
    .searchbar{ display:grid; grid-template-columns: 1fr 150px 160px; gap:10px; }
    @media(max-width:780px){ .searchbar{ grid-template-columns:1fr;} .totals{ grid-template-columns:1fr; } }

    /* calendar centered narrow */
    #bloc-calendar{max-width:900px;margin:24px auto;}

    /* ====== CAPTURE MOBILE RÉCAP ====== */
#capture-mobile{
  display:none;
  width:380px;
  max-width:100%;
  margin:0 auto;
  padding:16px;
  background:var(--bg);
  color:var(--text);
  border-radius:16px;
}
    #capture-mobile.smart-capture{
      width:420px;
      gap:8px;
      background:var(--card);
      border:1px solid var(--border);
    }
    /* Capture dédiée aux relances (mobile) */
    #followup-capture{
      display:none;
      width:400px;
      max-width:100%;
      margin:0 auto;
      padding:16px;
      background:var(--bg);
      color:var(--text);
      border-radius:16px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
    }
    #followup-capture .cap-header{
      margin-bottom:10px;
    }
    #followup-capture .relance-summary{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:8px;
      margin:8px 0 12px;
    }
    .relance-kpi{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      box-shadow:var(--shadow);
    }
    .relance-kpi .label{
      font-size:11px;
      color:var(--text2);
      letter-spacing:.05em;
      text-transform:uppercase;
    }
    .relance-kpi .value{
      font-size:16px;
      font-weight:800;
    }
    .relance-item{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      margin-bottom:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      box-shadow:var(--shadow);
    }
    .relance-top{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .relance-urgency{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      font-size:12px;
      font-weight:700;
      letter-spacing:.01em;
    }
    .relance-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:6px;
    }
    .relance-row{
      display:flex;
      justify-content:space-between;
      gap:6px;
      font-size:12px;
      color:var(--text2);
    }
    .relance-row strong{
      color:var(--text);
    }
    .relance-message{
      margin-top:6px;
      padding:10px 12px;
      border-radius:10px;
      background:rgba(255,255,255,.03);
      border:1px dashed var(--border);
      font-size:12px;
      line-height:1.5;
      white-space:pre-line;
    }
    .followup-mobile-actions{
      display:none;
      width:100%;
      margin:8px 0 0;
    }
    .followup-capture-btn,
    .followup-copy-btn{
      display:none;
      width:100%;
      justify-content:center;
      gap:8px;
      font-weight:700;
    }
    .cap-header{
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      margin-bottom:12px;
      gap:6px;
    }
    .cap-header img{
      width:180px;
      height:auto;
      border-radius:12px;
      margin-top: -6px;
    }
    .cap-header .recap-logo{
      filter:brightness(10);
    }
    .cap-logo-clone{
      display:block;
      margin:0 auto 6px;
      opacity:1 !important;
      visibility:visible !important;
    }
    .cap-logo-clone img{
      width:180px;
      height:auto;
      display:block;
      opacity:1 !important;
      visibility:visible !important;
    }
.cap-title{
  font-size:16px;
  font-weight:700;
}
.cap-sub{
  font-size:11px;
  color:var(--text2);
}
.cap-highlight{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  font-size:11px;
  background:rgba(255,255,255,.04);
  border:1px solid var(--border);
}
.cap-highlight .dot{
  width:8px;
  height:8px;
  border-radius:50%;
  background:var(--accent);
  display:inline-block;
}
    .cap-summary{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:8px;
      width:100%;
      margin:4px 0 14px;
    }
    .cap-kpi{
      position:relative;
      overflow:hidden;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      text-align:center;
      isolation:isolate;
    }
    .cap-kpi::after{
      content:"";
      position:absolute;
      inset:-30% -20% auto auto;
      width:180%;
      height:180%;
      background:radial-gradient(circle at 25% 25%, rgba(255,255,255,.25), transparent 45%);
      opacity:.75;
      transform:rotate(6deg);
      pointer-events:none;
      z-index:0;
    }
    .cap-kpi .label,
    .cap-kpi .value{
      text-align:center;
    }
    .cap-kpi.due{
      background:linear-gradient(135deg,#f59e0b,#f97316);
      border-color:rgba(249,115,22,.45);
      color:#fff;
    }
    .cap-kpi.received{
      background:linear-gradient(135deg,#22c55e,#15803d);
      border-color:rgba(21,128,61,.5);
      color:#ecfdf3;
    }
    .cap-kpi.total{
      background:linear-gradient(135deg,#312e81,#2563eb);
      border-color:rgba(37,99,235,.45);
      color:#e0e7ff;
      grid-column:1 / -1;
    }
    .cap-kpi .label{
      font-size:10px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:rgba(255,255,255,.85);
      z-index:1;
    }
    .cap-kpi .value{
      font-size:16px;
      font-weight:800;
      margin-top:4px;
      z-index:1;
    }
    .cap-item{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      margin-bottom:10px;
    }
    .cap-client{
      font-weight:700;
      font-size:14px;
      margin-bottom:2px;
    }
    .cap-subtitle{
      font-size:12px;
      color:var(--text2);
      margin-bottom:6px;
    }
    .cap-row{
      display:flex;
      justify-content:space-between;
      font-size:12px;
      margin-bottom:2px;
      gap:6px;
    }
    .cap-row span:first-child{
      color:var(--text2);
    }
    .cap-row .status-pill{
      font-size:10px;
      padding:2px 6px;
    }

    /* NOUVEAU: Styles pour la barre de progression dans la capture mobile */
    .cap-progress-wrap {
      padding: 8px 0;
    }
    .cap-row-progress-label {
      display: flex;
      justify-content: space-between; /* Correction d'alignement */
      align-items: center;
      margin-bottom: 4px;
      font-size: 0.875rem; 
      color: var(--muted);
    }
.cap-row-progress-label span:last-child {
  font-weight: 600;
  color: var(--text);
}
.cap-message{
  margin-top:8px;
  padding:10px 12px;
  border-radius:12px;
  background:rgba(15,23,42,.55);
  border:1px dashed var(--border);
  font-size:12px;
  color:var(--text);
  line-height:1.5;
  white-space:pre-line;
}
[data-theme="light"] .cap-message{
  background:rgba(248,250,252,.92);
  color:#0f172a;
}

    /* Bloc recherche plus premium */
    .filter-panel{
      background:linear-gradient(145deg, rgba(37,99,235,.12), rgba(34,197,94,.08)), var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      gap:10px;
      position:relative;
    }
    [data-theme="light"] .filter-panel{
      background:linear-gradient(145deg, rgba(37,99,235,.08), rgba(34,197,94,.05)), var(--card);
    }
    .filter-row{
      display:grid;
      grid-template-columns:1.2fr 1fr 1fr;
      gap:12px;
      align-items:end;
    }
    .filter-actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      padding-top:8px;
      border-top:1px dashed var(--border);
    }
    .filter-actions .row{ gap:12px; }
    @media(max-width:780px){
      .filter-row{ grid-template-columns:1fr; }
      .filter-actions{ flex-direction:column; align-items:flex-start; }
    }

    .artist-chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:2px;
    }
    .artist-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      font-size:12px;
      font-weight:700;
      letter-spacing:.01em;
      transition:.15s transform,.15s box-shadow,.15s border-color,.15s background;
    }
    .artist-chip:hover{
      transform:translateY(-1px);
      border-color:var(--accent);
      box-shadow:0 8px 18px rgba(0,0,0,.25);
    }
    .artist-chip::before{
      content:"";
      width:10px;
      height:10px;
      border-radius:50%;
      background:var(--artist-color, var(--accent));
      box-shadow:0 0 0 4px color-mix(in srgb, var(--artist-color, var(--accent)) 18%, transparent);
    }
    .artist-chip.is-active{
      background:color-mix(in srgb, var(--artist-color, var(--accent)) 16%, transparent);
      border-color:color-mix(in srgb, var(--artist-color, var(--accent)) 70%, transparent);
      box-shadow:0 10px 22px color-mix(in srgb, var(--artist-color, var(--accent)) 35%, rgba(0,0,0,.25));
    }
    [data-theme="light"] .artist-chip{
      background:rgba(255,255,255,.9);
    }

    /* BeatsEngine Premium */
    .beats-shell{
      position:relative;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:18px;
      padding:18px;
      box-shadow:0 18px 32px rgba(0,0,0,.34);
    }
    #beatsengine{
      --suno-orange:#FF7A18;
    }
    .beats-hero{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
    }
    .beats-hero h2{
      margin:0;
      font-size:1.55rem;
      letter-spacing:0.01em;
    }
    .beats-hero p{
      color:var(--text2);
      max-width:760px;
      margin:6px 0 0;
      line-height:1.5;
    }
    .beats-tagline{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .beats-chip{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text2);
      font-size:12px;
      letter-spacing:0.01em;
    }
    .beats-accent{ color:var(--accent); font-weight:700; }
    .beats-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    #beatsengine .beats-actions{
      gap:10px;
    }
    #beatsengine .beats-pill-btn{
      border-color:rgba(255,122,24,.35);
      background:rgba(255,122,24,.06);
    }
    #beatsengine .beats-pill-btn:hover{
      border-color:var(--suno-orange);
      background:rgba(255,122,24,.14);
      color:#fff;
    }
    .beats-pill-btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      font-weight:700;
    }
    .beats-pill-btn:hover{
      border-color:var(--accent);
      color:#fff;
      background:#111827;
      transition:140ms ease;
    }
    .beats-columns{
      display:grid;
      grid-template-columns:0.95fr 1.05fr;
      gap:14px;
      margin-top:14px;
      align-items:start;
    }
    @media(max-width:1024px){
      .beats-columns{ grid-template-columns:1fr; }
    }
    .beats-stack{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .beats-card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      box-shadow:none;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .beats-card h3{
      margin:0;
      letter-spacing:0.02em;
      font-size:18px;
    }
    .beats-card h4{
      margin:10px 0 8px;
      letter-spacing:0.02em;
      font-size:14px;
    }
    .beats-description{
      color:var(--text2);
      font-size:13px;
      margin:0 0 12px;
      line-height:1.6;
    }
    .beats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:12px;
    }
    .beats-label{
      font-size:12px;
      color:var(--text2);
      letter-spacing:0.02em;
      margin-bottom:6px;
      display:block;
    }
    .beats-input,
    .beats-select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      font-weight:600;
      letter-spacing:0.01em;
    }
    #beatsengine .beats-input:focus,
    #beatsengine .beats-select:focus,
    #beatsengine input[type="number"]:focus,
    #beatsengine select:focus{
      border-color:var(--suno-orange);
      box-shadow:0 0 0 1px rgba(255,122,24,.35);
      background:var(--panel);
    }
    .beats-select{ appearance:none; }
    .beats-meta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .beats-meta-pill{
      padding:8px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      color:var(--text2);
      background:var(--panel);
      font-size:12px;
    }
    .usage-meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .usage-pill{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      font-size:12px;
      letter-spacing:0.01em;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .usage-pill strong{ color:#fff; }
    .energy-toggle{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .energy-chip{
      position:relative;
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel);
      cursor:pointer;
      min-width:160px;
      transition:140ms ease;
    }
    .energy-chip input{ display:none; }
    .energy-chip span{
      font-weight:700;
      color:var(--text);
      letter-spacing:0.01em;
    }
    .energy-chip small{
      color:var(--text2);
      display:block;
      font-weight:500;
    }
    .energy-chip.active{
      border-color:var(--accent);
      background:#0f1a2d;
    }
    .progression-chip,
    .vocal-chip,
    .dance-chip,
    .usage-chip{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      background:var(--panel);
      color:var(--text);
      display:flex;
      gap:8px;
      align-items:flex-start;
      cursor:pointer;
      transition:140ms ease;
      box-shadow:none;
    }
    .progression-chip.active,
    .vocal-chip.active,
    .dance-chip.active,
    .usage-chip.active{
      border-color:var(--accent);
      background:#0f1a2d;
    }
    .progression-chip small,
    .vocal-chip small,
    .dance-chip small{
      display:block;
      color:var(--text2);
      line-height:1.4;
    }
    .progression-row,
    .vocal-row,
    .dance-row,
    .usage-row{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:10px;
    }
    .usage-row{ grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); }
    .usage-chip input{ display:none; }
    .beats-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:10px;
      background:var(--panel);
      border:1px solid var(--border);
      color:var(--text2);
      font-size:12px;
    }
    .progression-meta{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:10px;
      padding:10px;
      border:1px dashed var(--border);
      border-radius:12px;
      background:var(--panel);
      color:var(--text);
      font-family:"JetBrains Mono","Fira Code",ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
    }
    .beats-warning{
      margin-top:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #b91c1c;
      background:rgba(185,28,28,0.16);
      color:#fecdd3;
      font-weight:700;
      display:none;
    }
    .beats-warning.visible{ display:block; }
    .dual-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:12px;
    }
    .beats-slider{
      width:100%;
    }
    .duration-row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .duration-row input[type="text"]{
      max-width:120px;
      text-align:center;
    }
    .instrument-accordion{
      border-radius:12px;
      overflow:hidden;
      border:1px solid var(--border);
      background:var(--panel);
    }
    .instrument-accordion summary{
      list-style:none;
      padding:12px 14px;
      cursor:pointer;
      font-weight:700;
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .instrument-accordion summary::-webkit-details-marker{ display:none; }
    .instrument-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:10px;
      padding:10px 14px 14px;
      background:var(--card);
    }
    .instrument-checkbox{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--panel);
      font-size:13px;
      color:var(--text);
    }
    .instrument-checkbox input{ accent-color:var(--accent); }
    #beatsengine .instrument-checkbox input{ accent-color:var(--suno-orange); }
    .instrument-checkbox.over-limit{
      border-color:#ef4444;
      box-shadow:0 0 0 1px rgba(239,68,68,0.35);
    }
    .instrument-group-title{
      color:var(--text2);
      font-weight:800;
      margin:6px 0 2px;
      letter-spacing:0.01em;
    }
    .structure-list{
      list-style:none;
      margin:0;
      padding:0;
      display:grid;
      gap:10px;
    }
    .structure-item{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel);
      cursor:default;
    }
    .structure-item.dragging{
      opacity:0.7;
      border-style:dashed;
    }
    .structure-label{
      font-weight:700;
      color:var(--text);
      letter-spacing:0.01em;
    }
    .structure-controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .structure-controls input{
      flex:1;
      min-width:160px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      padding:10px 12px;
    }
    #beatsengine .structure-controls input:focus{
      border-color:var(--suno-orange);
      box-shadow:0 0 0 1px rgba(255,122,24,.35);
      background:var(--panel);
    }
    .structure-btn{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      font-weight:700;
      cursor:pointer;
    }
    .structure-btn.secondary:hover{ border-color:var(--accent); color:#fff; }
    #beatsengine .structure-btn.secondary:hover{
      border-color:var(--suno-orange);
      background:rgba(255,122,24,.12);
      color:#fff;
    }
    .beats-prompt{
      position:sticky;
      top:10px;
      align-self:start;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .beats-output{
      width:100%;
      min-height:320px;
      font-family:"JetBrains Mono","Fira Code",ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
      font-size:13px;
      line-height:1.55;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      color:var(--text);
      padding:14px;
      box-shadow:none;
      resize:vertical;
    }
    #beatsengine .beats-output:focus{
      border-color:var(--suno-orange);
      box-shadow:0 0 0 1px rgba(255,122,24,.35);
    }
    .beats-toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:2px;
      justify-content:flex-start;
    }
    .beats-btn{
      padding:11px 13px;
      border-radius:10px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      font-weight:700;
      letter-spacing:0.01em;
      cursor:pointer;
      min-width:130px;
      transition:140ms ease;
      box-shadow:none;
    }
    #beatsengine .beats-btn{
      border-color:rgba(255,122,24,.35);
    }
    .beats-btn.secondary{
      background:transparent;
      border-color:var(--border);
      color:var(--text);
    }
    #beatsengine .beats-btn.secondary{
      border-color:rgba(255,122,24,.35);
    }
    .beats-btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
      border-radius:8px;
    }
    #beatsengine .beats-btn.primary{
      background:var(--suno-orange);
      border-color:var(--suno-orange);
    }
    .beats-btn:hover{
      background:#111827;
      border-color:var(--accent);
      color:#fff;
    }
    #beatsengine .beats-btn:hover{
      border-color:var(--suno-orange);
      background:rgba(255,122,24,.12);
      color:#fff;
    }
    .beats-btn.primary:hover{
      background:#4f8ff8;
      border-color:#4f8ff8;
    }
    #beatsengine .beats-btn.primary:hover{
      background:#ff8c3a;
      border-color:#ff8c3a;
    }
    .beats-status{
      font-size:12px;
      color:var(--text2);
      margin-top:2px;
    }
    .beats-output-meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-start;
      margin-top:4px;
      color:var(--text2);
      font-size:12px;
    }
    .beats-length{
      font-weight:800;
      color:#fff;
    }
    .prompt-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .char-counter{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:2px;
      color:var(--text2);
      font-size:12px;
    }
    .char-counter .beats-length{
      font-size:14px;
      letter-spacing:0.01em;
    }
    #beatsengine .char-counter .beats-length{
      color:var(--suno-orange);
    }

    /* Track Name Generator */
    .track-inline-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      margin-top:8px;
    }
    .prompt-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .track-inline{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel);
      flex:1 1 360px;
      min-width:320px;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.02);
    }
    [data-theme="light"] .track-inline{
      background:#f8fafc;
    }
    .track-name-wrap{
      display:flex;
      flex-direction:column;
      gap:6px;
      flex:1;
      min-width:0;
    }
    .track-meta{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      color:var(--text2);
      font-size:12px;
    }
    .track-chip{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 8px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(0,0,0,0.08);
      color:inherit;
    }
    [data-theme="light"] .track-chip{
      background:rgba(15,23,42,.04);
    }
    .track-name-display{
      border-radius:10px;
      border:1px dashed var(--border);
      padding:10px 12px;
      font-size:15px;
      font-weight:800;
      letter-spacing:0.01em;
      color:var(--text);
      min-height:38px;
      display:flex;
      align-items:center;
      background:rgba(15,23,42,.6);
    }
    #beatsengine .track-name-display{
      border-color:rgba(255,122,24,.35);
      background:rgba(255,122,24,.06);
    }
    [data-theme="light"] .track-name-display{
      background:rgba(255,255,255,.85);
    }
    .track-name-actions{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
    }
    .beats-btn.sm{
      padding:9px 11px;
      min-width:120px;
      font-size:12px;
      border-radius:9px;
    }
    .track-copy-feedback{
      font-size:12px;
      color:#22c55e;
      opacity:0;
      transition:opacity .16s ease;
    }
    .track-copy-feedback.visible{ opacity:1; }
    .privacy-mode .amount-mask{
      position:relative;
      color:transparent !important;
      text-shadow:none !important;
    }
    .privacy-mode .amount-mask::after{
      content:"•••• €";
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      color:var(--text);
      pointer-events:none;
      text-shadow:none;
    }
    .privacy-mode .amount-input{
      -webkit-text-security: disc;
    }

    .mobile-only{ display:none; }
.mobile-cards{ display:none; }
.collapse-toggle{ display:none; }
.mobile-smart-btn{
  display:none;
}

    @media(max-width:768px){
      .container{ margin-top:20px; padding:0 12px; }
      header.app{ gap:12px; }
      .card{ padding:14px; margin-top:12px !important; }
      .filter-panel{ gap:8px; }
      .filter-row{ gap:10px; }
      .filter-actions{ gap:8px; }
      .toolbar{ width:100%; justify-content:flex-start; }

      .section-header,
      .section-subheader{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        margin-bottom:8px;
      }
      .section-subheader h3{
        margin:0;
        font-size:16px;
      }
      .collapse-toggle{
        display:inline-flex;
        align-items:center;
        gap:6px;
        padding:8px 10px;
        background:var(--panel);
        color:var(--text);
        border:1px solid var(--border);
        border-radius:10px;
        cursor:pointer;
        font-weight:700;
      }
      .collapse-toggle .collapse-icon{
        transition:transform .2s ease;
        display:inline-block;
      }
      .collapse-toggle[aria-expanded="true"] .collapse-icon{
        transform:rotate(180deg);
      }
      .collapsible-content{
        display:none;
      }
  .collapsible-content.is-open{
    display:block;
  }
  .mobile-only{ display:flex; }
  .mobile-smart-btn{
    display:inline-flex;
    width:100%;
    justify-content:center;
  }
  .followup-mobile-actions{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .followup-capture-btn,
  .followup-copy-btn{
    display:inline-flex;
  }

      table,
      thead{
        display:none;
      }
      tbody,
      tr,
      td{
        display:block;
      }
      .mobile-cards{
        display:flex;
        flex-direction:column;
        gap:12px;
        margin-top:10px;
      }
      .mobile-card{
        background:var(--card);
        border:1px solid var(--border);
        border-radius:14px;
        padding:12px;
        box-shadow:var(--shadow);
        display:flex;
        flex-direction:column;
        gap:8px;
      }
      .mobile-card header{
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        gap:10px;
      }
      .mobile-card .client{
        font-weight:700;
        font-size:15px;
      }
      .mobile-meta{
        display:flex;
        flex-direction:column;
        gap:6px;
        color:var(--text2);
        font-size:12px;
      }
      .mobile-amounts{
        display:grid;
        grid-template-columns:repeat(3,minmax(0,1fr));
        gap:8px;
      }
      .mobile-amounts .label{
        color:var(--muted);
        font-size:11px;
        letter-spacing:.02em;
      }
      .mobile-amounts .value{
        font-weight:700;
        font-size:14px;
      }
      .mobile-progress{
        display:flex;
        flex-direction:column;
        gap:6px;
        font-size:12px;
      }
      .mobile-status{
        align-self:flex-start;
      }
      .mobile-card-actions{
        display:flex;
        flex-direction:column;
        gap:8px;
      }
      .mobile-full-btn{
        width:100%;
        justify-content:center;
      }
      .mobile-secondary-actions{
        display:flex;
        gap:8px;
      }
      .mobile-secondary-actions .btn{
        flex:1;
        justify-content:center;
        padding:8px 10px;
      }
      .mobile-empty{
        text-align:center;
        color:var(--text2);
        font-size:13px;
      }
    }
  </style>
  <link rel="stylesheet" href="assets/szd-cards.css">
</head>
<body>
  <div class="container">
    <nav class="top-nav" aria-label="Navigation principale">
      <div class="nav-left">
        <a class="logo-wrap logo-compact" href="index.html" aria-label="Revenir aux prestations">
          <img
            src="szd_logo_white.png"
            data-dark-src="szd_logo_white.png"
            data-light-src="szd_logo_black.png"
            alt="Logo">
        </a>
      </div>
      <div class="nav-center">
        <div class="nav-links" id="nav-links">
          <a class="nav-link active" data-priority="main" href="#prestations" data-tab-target="prestations">Prestations</a>
          <a class="nav-link" data-priority="main" href="#beatsengine" data-tab-target="beatsengine">BeatsEngine</a>
          <a class="nav-link" data-priority="main" href="#facturation" data-tab-target="facturation">Facturation</a>
          <a class="nav-link" data-priority="main" href="#rdv" data-tab-target="rdv">RDV</a>
          <a class="nav-link" data-priority="secondary" href="#licence" data-tab-target="licence">Licence</a>
          <a class="nav-link" data-priority="secondary" href="#famille" data-tab-target="famille">Famille</a>
        </div>
      </div>
      <div class="nav-actions">
        <button class="nav-toggle" id="navToggle" aria-label="Ouvrir le menu" aria-controls="nav-links" aria-expanded="false" type="button">
          <span class="bar"></span>
          <span class="bar"></span>
          <span class="bar"></span>
        </button>
        <button type="button" class="privacy-toggle icon-only" id="togglePrivacyMode" aria-pressed="false" aria-label="Mode présentation" title="Mode présentation">
          <span class="privacy-toggle-icon" aria-hidden="true">👁️</span>
          <span class="privacy-toggle-text sr-only">Mode présentation</span>
        </button>
        <div class="theme-toggle">
          <span class="theme-icon" aria-hidden="true">🌙</span>
          <label class="switch" aria-label="Basculer le thème nuit/jour">
            <input type="checkbox" id="themeToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </nav>

    <main class="page-content">
    <section class="tab-section active" id="prestations">
      <div class="tab-header">
        <div>
          <h2>Prestations — Clips & Musique</h2>
          <p class="tab-subtitle">
            Ajoute tes prestations, saisis les montants et enregistre les paiements partiels. Données stockées en localStorage ; si le stockage est bloqué, un mode secours JSON est disponible.
          </p>
        </div>
        <div class="tab-actions">
          <span class="pill">Version 1.4</span>
          <span class="pill">LocalStorage</span>
        </div>
      </div>
      <div id="status" class="alert" style="display:none;"></div>

      <div class="grid grid-2">
        <div class="card">
          <h2>Nouvelle prestation</h2>
          <form id="prestations-form" novalidate>
            <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px;">
              <div>
                <label for="client">Client</label>
                <input type="text" id="client" placeholder="Nom de l'artiste / client">
              </div>
              <div>
                <label for="type">Type</label>
                <select id="type">
                  <option value="Clip">Clip</option>
                  <option value="Musique">Musique</option>
                  <option value="Tournage">Tournage</option>
                  <option value="Montage">Montage</option>
                  <option value="Autre">Autre</option>
                </select>
              </div>
              <div style="grid-column:1 / -1;">
                <label for="description">Description (optionnel)</label>
                <input type="text" id="description" placeholder="Détails de la prestation (ex : Clip Mayanna)">
              </div>
              <div>
                <label for="date">Date</label>
                <input type="date" id="date">
              </div>
              <div>
                <label for="montant">Montant (€)</label>
                <input type="text" inputmode="decimal" id="montant" class="amount-input" placeholder="ex : 800 ou 800,00">
              </div>
              <div class="checkbox-toggle" style="align-self:end;">
                <input type="checkbox" id="paye">
                <label for="paye" style="margin:0;">Déjà payé (total)</label>
              </div>
            </div>
            <div class="toolbar" style="margin-top:12px;">
              <button class="btn btn-primary" id="save" type="submit">Ajouter</button>
              <button type="button" class="btn btn-outline" id="reset">Réinitialiser</button>
              <button type="button" class="btn btn-outline" id="addDemo">+ Démo</button>
              <button type="button" class="btn btn-outline" id="exportJson">Export JSON</button>
              <button type="button" class="btn btn-outline" id="exportCsv">Export CSV</button>
              <label class="btn btn-outline">
                Import JSON
                <input type="file" id="importJson" accept="application/json" style="display:none;">
              </label>
            </div>
          </form>
        </div>

        <div class="card filter-card">
      <div class="section-header">
        <h2>Recherche & filtre</h2>
        <button type="button" class="collapse-toggle" data-collapse-target="search-filter-content" aria-expanded="true">
          <span class="collapse-label">Masquer</span>
          <span class="collapse-icon">▾</span>
        </button>
      </div>
      <div id="search-filter-content" class="collapsible-content is-open">
        <div class="filter-panel">
          <div class="filter-row">
            <div>
              <label for="search">Filtre texte</label>
              <input type="text" id="search" placeholder="Client, type, description…">
            </div>
                <div>
                  <label for="filterStatus">Statut</label>
                  <select id="filterStatus">
                    <option value="all">Tous</option>
                    <option value="unpayed">Non payé</option>
                    <option value="partial">Partiel</option>
                    <option value="paid">Payé / soldé</option>
                  </select>
                </div>
                <div>
                  <label for="filterType">Type</label>
                  <select id="filterType">
                    <option value="all">Tous</option>
                    <option value="Clip">Clip</option>
                    <option value="Musique">Musique</option>
                    <option value="Tournage">Tournage</option>
                    <option value="Montage">Montage</option>
                    <option value="Autre">Autre</option>
                  </select>
                </div>
              </div>

              <div class="filter-actions">
                <div class="row">
                  <div class="checkbox-toggle">
                    <input type="checkbox" id="debug">
                    <label for="debug" style="margin:0;">Debug mode</label>
                  </div>
                  <div class="checkbox-toggle">
                    <input type="checkbox" id="autoFile">
                    <label for="autoFile" style="margin:0;">Fichier auto (expérimental)</label>
                  </div>
                </div>
                <div class="row" style="gap:8px; color:var(--muted); font-size:12px;">
                  <span>Affinez vos résultats :</span>
                  <span class="pill">Texte</span>
                  <span class="pill">Statut</span>
              <span class="pill">Type</span>
            </div>
          </div>
        </div>
          <div class="artist-chips" id="artistChips" aria-label="Filtrer par artiste"></div>
      </div>

      <div class="section-subheader mobile-only">
            <h3>Totaux</h3>
            <button type="button" class="collapse-toggle" data-collapse-target="totals-content" aria-expanded="true">
              <span class="collapse-label">Masquer</span>
              <span class="collapse-icon">▾</span>
            </button>
          </div>
          <div id="totals-content" class="collapsible-content is-open">
            <div class="totals" style="margin-top:14px;">
              <div class="kpi">
                <div class="label">Total facturé</div>
                <div class="value amount-mask" id="totalMontant">0 €</div>
                <div class="sub">Somme des prestations</div>
              </div>
              <div class="kpi">
                <div class="label">Total reçu</div>
                <div class="value amount-mask" id="totalRecu">0 €</div>
                <div class="sub">Somme des paiements</div>
              </div>
              <div class="kpi">
                <div class="label">Total restant</div>
                <div class="value amount-mask" id="totalRestant">0 €</div>
                <div class="sub">À encaisser</div>
              </div>
            </div>

            <div class="small" id="lsStatus" style="margin-top:6px;"></div>

            <div class="debug-zone" id="debug-zone" style="display:none;">
              <div>Console locale :</div>
              <pre id="debugOut"></pre>
            </div>
          </div>
        </div>
    </div>

    <div class="card" style="margin-top:20px;">
      <h2>Prestations enregistrées</h2>
      <div class="small">Clique sur "Encaisser" pour enregistrer un paiement partiel ou total.</div>
      <div class="toolbar" style="margin-top:10px;">
        <button type="button" class="btn btn-outline" id="captureRecap">📸 Capture </button>
        <button type="button" class="btn btn-primary mobile-smart-btn" id="smartCapture">📱 Capture mobile intelligente</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Client / Type</th>
              <th>Montant</th>
              <th>Reçu</th>
              <th>Restant</th>
              <th>Avancement</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
        <tbody id="tbody">
          <tr><td colspan="10" class="small">Aucune prestation ne correspond.</td></tr>
        </tbody>
      </table>
      <div id="mobileCards" class="mobile-cards" aria-live="polite"></div>
    </div>

    <div class="card whatsapp-card" style="margin-top:20px;">
      <h2><span class="wa-icon">💚</span>Relances automatiques</h2>
      <div class="row" style="justify-content:space-between; align-items:center; gap:10px;">
        <p class="small" style="margin:0; max-width:620px;">Clients à relancer après 15 jours sans paiement ; à 30 jours la relance devient prioritaire, et à 45 jours elle passe en mode critique. Prépare tout pour WhatsApp en un coup d'œil.</p>
        <span class="wa-chip">💬 Mode WhatsApp prêt</span>
      </div>
      <div class="row wa-legend" style="align-items:center; margin:10px 0 6px; flex-wrap:wrap;">
        <span class="pill">15 jours : relance douce</span>
        <span class="pill">30 jours : relance urgente</span>
        <span class="pill">45 jours : relance critique</span>
        <span class="pill" id="followupCounts">0 relance en attente</span>
      </div>
      <div class="followup-mobile-actions mobile-only" aria-label="Actions mobiles pour les relances automatiques">
        <button type="button" class="btn btn-primary followup-capture-btn" id="followupCaptureBtn">
          📸 Capture relances
        </button>
        <button type="button" class="btn btn-outline followup-copy-btn" id="followupCopyBtn">
          💬 Copier le message
        </button>
      </div>
      <div id="followupList" class="grid followup-grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:10px;"></div>
    </div>
    </section>

    <section class="tab-section" id="beatsengine" hidden>
      <div class="tab-header">
        <div>
          <h2>BeatsEngine Pro — IA Studio</h2>
          <p class="tab-subtitle">Générateur de prompts IA premium &lt; 900 caractères, culturellement verrouillé, prêt pour Suno et co. Vocal-first par défaut.</p>
        </div>
        <div class="tab-actions">
          <span class="pill">Studio-grade</span>
          <span class="pill">Cultural lock</span>
          <span class="pill">Auto BPM</span>
        </div>
      </div>
      <div class="beats-shell">
        <div class="beats-hero">
          <div>
            <h2>🎛️ BeatsEngine Pro — Module Studio</h2>
            <p>
              Génère des prompts IA studio-grade en moins de 900 caractères : tonalité verrouillée, progression transposée, cultural lock, usage → durée, vocal-first par défaut. Sobre, lisible et prêt pour Suno.
            </p>
            <div class="beats-tagline">
              <span class="beats-chip">Key + BPM lock</span>
              <span class="beats-chip">Cultural lock</span>
              <span class="beats-chip">Usage → durée</span>
              <span class="beats-chip">Vocal-first</span>
            </div>
          </div>
          <div class="beats-actions">
            <button type="button" class="beats-pill-btn" id="beats-shuffle">Shuffle 🎲</button>
            <span class="beats-pill-btn">⚡ Studio-grade prompt</span>
          </div>
        </div>

        <div class="beats-columns">
          <div class="beats-stack">
            <div class="beats-card">
              <h3>🎼 Core Settings</h3>
              <p class="beats-description">Style, tonalité et BPM cohérents en deux clics.</p>
              <div class="beats-grid">
                <div>
                  <label class="beats-label" for="beats-style">Style musical</label>
                  <select id="beats-style" class="beats-select">
                    <option>Afro-Trap</option>
                    <option>Afro-Trap Club</option>
                    <option>Drill</option>
                    <option>R&B</option>
                    <option>Dancehall</option>
                    <option>Afrobeat</option>
                    <option>Afropop</option>
                    <option>Bongo Flava</option>
                    <option>Amapiano</option>
                    <option>Zouk</option>
                    <option>Reggae</option>
                    <option>Reggaeton</option>
                    <option>Moombahton Latin Club</option>
                    <option>Shatta</option>
                  </select>
                </div>
                <div>
                  <label class="beats-label" for="beats-bpm">BPM</label>
                  <input type="number" id="beats-bpm" class="beats-input" min="70" max="180" step="1" value="110" inputmode="numeric">
                </div>
              </div>
              <details class="instrument-accordion" open style="margin-top:10px;">
                <summary>Tonalité</summary>
                <div class="instrument-grid">
                  <div>
                    <label class="beats-label" for="beats-note">Note</label>
                    <select id="beats-note" class="beats-select">
                      <option>C</option>
                      <option>C#</option>
                      <option>D</option>
                      <option>D#</option>
                      <option>E</option>
                      <option>F</option>
                      <option>F#</option>
                      <option>G</option>
                      <option>G#</option>
                      <option>A</option>
                      <option>A#</option>
                      <option>B</option>
                    </select>
                  </div>
                  <div>
                    <span class="beats-label">Mode</span>
                    <div class="vocal-row" id="beats-mode">
                      <label class="vocal-chip active">
                        <input type="radio" name="beats-mode" value="minor" checked>
                        <div>
                          <span style="font-weight:800;">Minor</span>
                          <small>Natural minor scale</small>
                        </div>
                      </label>
                      <label class="vocal-chip">
                        <input type="radio" name="beats-mode" value="major">
                        <div>
                          <span style="font-weight:800;">Major</span>
                          <small>Bright, open harmonies</small>
                        </div>
                      </label>
                    </div>
                  </div>
                </div>
              </details>
              <div class="beats-meta">
                <span class="beats-meta-pill">Accords clés : <strong id="beats-chords">-</strong></span>
                <span class="beats-meta-pill">Plage BPM : <strong id="beats-bpm-range">-</strong></span>
                <span class="beats-meta-pill">Groove : <strong id="beats-energy-desc">-</strong></span>
              </div>
            </div>

            <div class="beats-card">
              <h3>🎼 Winning Chords</h3>
              <p class="beats-description">Auto (recommended) — ajusté au style et transposé dans ta tonalité.</p>
              <details class="instrument-accordion" style="margin-bottom:8px;">
                <summary>Manuel (optionnel)</summary>
                <div class="progression-row" id="progression-options" style="padding:10px 14px 14px; background:rgba(0,0,0,0.25);"></div>
              </details>
              <div class="progression-meta">
                <div><strong>Degrés :</strong> <span id="beats-progression">i – VI – III – VII</span></div>
                <div><strong>Accords réels :</strong> <span id="beats-progression-chords">Am – F – C – G</span></div>
                <div class="beats-badge">Auto-transposé selon la clé et le style.</div>
              </div>
            </div>

            <div class="beats-card">
              <h3>🎚️ Groove & Vocals</h3>
              <p class="beats-description">Mode vocal-first par défaut, Groove fusionnant énergie et dance.</p>
              <div class="vocal-row" id="vocal-modes">
                <label class="vocal-chip active">
                  <input type="radio" name="vocal-mode" value="vocal-first" checked>
                  <div>
                    <span style="font-weight:800;">Vocal-First</span>
                    <small>vocal-first arrangement, no competing lead melody, instrumental supportive, clear space for human vocals.</small>
                  </div>
                </label>
                <label class="vocal-chip">
                  <input type="radio" name="vocal-mode" value="balanced">
                  <div>
                    <span style="font-weight:800;">Balanced</span>
                    <small>vocal-instrument balance, gentle counter-melodies, controlled layers.</small>
                  </div>
                </label>
                <label class="vocal-chip">
                  <input type="radio" name="vocal-mode" value="instrumental-lead">
                  <div>
                    <span style="font-weight:800;">Instrumental-Lead</span>
                    <small>instrumental hooks in front, vocals woven around the lead.</small>
                  </div>
                </label>
              </div>

              <div class="dual-grid" style="margin-top:12px;">
                <div>
                  <h4>⚡ Energy</h4>
                  <div class="energy-toggle" id="beats-energy">
                    <label class="energy-chip">
                      <input type="radio" name="beats-energy" value="low">
                      <div>
                        <span>Low</span>
                        <small>Minimal, smooth, spacious</small>
                      </div>
                    </label>
                    <label class="energy-chip active">
                      <input type="radio" name="beats-energy" value="medium" checked>
                      <div>
                        <span>Medium</span>
                        <small>Balanced, groove-focused</small>
                      </div>
                    </label>
                    <label class="energy-chip">
                      <input type="radio" name="beats-energy" value="high">
                      <div>
                        <span>High</span>
                        <small>Aggressive, club-ready</small>
                      </div>
                    </label>
                  </div>
                  <div class="beats-status" id="beats-energy-note">Low → minimal, smooth, spacious.</div>
                </div>

                <div>
                  <h4>🕺 Dance</h4>
                  <div class="dance-row" id="beats-danceability">
                    <label class="dance-chip">
                      <input type="radio" name="beats-dance" value="chill">
                      <div>
                        <span>Chill</span>
                        <small>Laid-back groove</small>
                      </div>
                    </label>
                    <label class="dance-chip active">
                      <input type="radio" name="beats-dance" value="bounce" checked>
                      <div>
                        <span>Bounce</span>
                        <small>Smooth bounce</small>
                      </div>
                    </label>
                    <label class="dance-chip">
                      <input type="radio" name="beats-dance" value="club">
                      <div>
                        <span>Club</span>
                        <small>Club-focused rhythmic drive</small>
                      </div>
                    </label>
                  </div>
                  <div class="beats-status" id="beats-dance-note">Danceable sans agressivité obligatoire.</div>
                </div>
              </div>
            </div>

            <div class="beats-card">
              <h3>⏱️ Usage & Durée</h3>
              <p class="beats-description">Usage cible = durée et formulation automatique. Toujours en mode full-length, jamais en boucle.</p>
              <div class="usage-row" id="beats-usage">
                <label class="usage-chip active">
                  <input type="radio" name="beats-usage" value="streaming" data-usage="streaming" checked>
                  <div>
                    <span>Streaming</span>
                    <small>Hook rapide, 3.1–3.3 min</small>
                  </div>
                </label>
                <label class="usage-chip">
                  <input type="radio" name="beats-usage" value="radio" data-usage="radio">
                  <div>
                    <span>Radio</span>
                    <small>Clair, mix concis</small>
                  </div>
                </label>
                <label class="usage-chip">
                  <input type="radio" name="beats-usage" value="club" data-usage="club">
                  <div>
                    <span>Club</span>
                    <small>Drop étendu</small>
                  </div>
                </label>
                <label class="usage-chip">
                  <input type="radio" name="beats-usage" value="dj" data-usage="dj">
                  <div>
                    <span>DJ</span>
                    <small>Intro/outro mixables</small>
                  </div>
                </label>
                <label class="usage-chip">
                  <input type="radio" name="beats-usage" value="emotion" data-usage="emotion">
                  <div>
                    <span>Emotion</span>
                    <small>Storytelling</small>
                  </div>
                </label>
              </div>
              <div class="beats-meta">
                <span class="beats-meta-pill">Durée cible : <strong id="beats-duration">3.2 min</strong></span>
                <span class="beats-meta-pill">Contexte : <strong id="beats-usage-note">Streaming ready</strong></span>
              </div>
            </div>

            <div class="beats-card">
              <h3>🎹 Instruments & Structure</h3>
              <p class="beats-description">Catégories compactes, structure via presets, durée implicite. Le moteur gère les détails et exclusions automatiquement.</p>
              <details class="instrument-accordion" open>
                <summary>Instruments (auto)</summary>
                <div class="instrument-grid" id="beats-instruments">
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="drums" data-role="rhythm" checked> Drums</label>
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="bass" data-role="bass" checked> Bass</label>
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="melody" data-role="melody"> Melody</label>
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="guitar" data-role="melody"> Guitar</label>
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="piano" data-role="melody"> Piano</label>
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="pads" data-role="melody"> Pads / Atmos</label>
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="plucks" data-role="melody"> Plucks / Stabs</label>
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="strings" data-role="melody"> Strings (light)</label>
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="brass" data-role="melody"> Horns / Brass</label>
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="voxfx" data-role="melody"> Vocal chops</label>
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="fx" data-role="texture"> FX textures</label>
                </div>
              </details>
              <div class="beats-warning" id="melody-warning">Mode Vocal-First : limite de 1 instrument mélodique dépassée.</div>

              <div style="margin-top:12px;">
                <div class="structure-controls" id="structure-presets">
                  <button type="button" class="structure-btn secondary" data-structure-preset="singer">Singer</button>
                  <button type="button" class="structure-btn secondary" data-structure-preset="rapper">Rapper</button>
                  <button type="button" class="structure-btn secondary" data-structure-preset="club">Club</button>
                </div>
                <ul class="structure-list" id="structure-list" aria-label="Structure du morceau"></ul>
              </div>
              <div class="beats-status" id="beats-structure-note">Structure preset + durée auto.</div>
            </div>
          </div>

          <div class="beats-prompt">
            <div class="beats-card">
              <div class="prompt-header">
                <div>
                  <h3>🧠 Prompt Engine</h3>
                  <p class="beats-description">Prompt premium ligne par ligne, lisible, prêt à être collé dans ton IA audio.</p>
                </div>
                <div class="char-counter">
                  <span class="beats-length" id="beats-length">0 / 900</span>
                  <span>caractères</span>
                </div>
              </div>
              <textarea id="beats-output" class="beats-output" rows="14" readonly aria-live="polite"></textarea>
              <div class="beats-output-meta">
                <span class="beats-meta-pill" id="beats-keyline">Key &amp; BPM verrouillés</span>
              </div>
              <div class="track-inline-row">
                <div class="prompt-actions">
                  <button type="button" class="beats-btn primary" id="beats-generate">Generate</button>
                  <button type="button" class="beats-btn secondary" id="beats-shuffle-cta">Shuffle</button>
                  <button type="button" class="beats-btn" id="beats-copy">Copy Prompt</button>
                </div>
                <div class="track-inline" id="track-generator" aria-live="polite">
                  <div class="track-name-wrap">
                    <div class="track-meta">
                      <span class="track-chip">Style <strong id="track-style-meta">Afro-Trap</strong></span>
                      <span class="track-chip">Énergie <strong id="track-energy-meta">Medium</strong></span>
                      <span class="track-chip">Dance <strong id="track-dance-meta">Bounce</strong></span>
                    </div>
                    <div class="track-name-display" id="track-name-display">Prêt à générer</div>
                  </div>
                  <div class="track-name-actions">
                    <button type="button" class="beats-btn sm primary" id="track-generate">Generate Name</button>
                    <button type="button" class="beats-btn sm" id="track-copy">Copy Name</button>
                    <span class="track-copy-feedback" id="track-copy-feedback" role="status" aria-live="assertive">Copié ✔</span>
                  </div>
                </div>
              </div>
              <div class="beats-status" id="beats-status">Prêt à générer un prompt studio.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="tab-section" id="facturation" hidden>
      <div class="tab-header">
        <div>
          <h2>Facturation</h2>
          <p class="tab-subtitle">La vue facturation est chargée dans la même interface pour garder le header et la navigation identiques.</p>
        </div>
        <div class="tab-actions">
          <span class="pill">PDF prêt</span>
          <span class="pill">Prestations soldées</span>
        </div>
      </div>
      <div class="embed-shell">
        <p class="embed-note">Chargement de Facturation avec le header commun…</p>
        <iframe class="embed-frame" title="Facturation" loading="lazy" data-src="facturation.html"></iframe>
      </div>
    </section>

    <section class="tab-section" id="rdv" hidden>
      <div class="tab-header">
        <div>
          <h2>RDV</h2>
          <p class="tab-subtitle">Raccourcis planification et Google Calendar dans une vue embarquée qui conserve le même header.</p>
        </div>
        <div class="tab-actions">
          <span class="pill">Agenda</span>
          <span class="pill">Google Calendar</span>
        </div>
      </div>
      <div class="embed-shell">
        <p class="embed-note">Chargement de la page RDV dans la navigation unique…</p>
        <iframe class="embed-frame" title="RDV" loading="lazy" data-src="rdv.html"></iframe>
      </div>
    </section>

    <section class="tab-section" id="licence" hidden>
      <div class="tab-header">
        <div>
          <h2>Licence</h2>
          <p class="tab-subtitle">Contrat instrumentale / Licence affiché ici pour préserver la cohérence du header.</p>
        </div>
        <div class="tab-actions">
          <span class="pill">Contrat</span>
          <span class="pill">Instrumentale</span>
        </div>
      </div>
      <div class="embed-shell">
        <p class="embed-note">Chargement de l’onglet Licence sans changer de header…</p>
        <iframe class="embed-frame" title="Licence" loading="lazy" data-src="licence.html"></iframe>
      </div>
    </section>

    <section class="tab-section" id="famille" hidden>
      <div class="tab-header">
        <div>
          <h2>Famille</h2>
          <p class="tab-subtitle">Les ressources Famille restent accessibles sous le même header.</p>
        </div>
        <div class="tab-actions">
          <span class="pill">Vue partagée</span>
          <span class="pill">Navigation unifiée</span>
        </div>
      </div>
      <div class="embed-shell">
        <p class="embed-note">Chargement de l’espace Famille…</p>
        <iframe class="embed-frame" title="Famille" loading="lazy" data-src="famille.html"></iframe>
      </div>
    </section>

  </main>

  <!-- Zone de capture mobile cachée -->
  <div id="capture-mobile"></div>
  <div id="followup-capture"></div>

  </div>

  <footer>Local — clé: <code>prestations_v1</code>. Si ça casse, tu peux exporter en JSON et garder une sauvegarde manuelle.</footer>

  <!-- html2canvas pour la capture -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="assets/szd-card-glow.js" defer></script>

  <script>
    function updateThemeLogos(theme){
      const mode = theme === "light" ? "light" : "dark";

      document.querySelectorAll('[data-light-src][data-dark-src]').forEach((img) => {
        const target = mode === "light" ? img.dataset.lightSrc : img.dataset.darkSrc;
        if (target) {
          img.setAttribute("src", target);
        }
      });
    }

    function currentLogoForTheme(theme){
      const mode = theme === "light" ? "light" : "dark";
      const img = document.querySelector('[data-light-src][data-dark-src]');
      if (!img) return "";

      return mode === "light"
        ? (img.dataset.lightSrc || img.getAttribute("src") || "")
        : (img.dataset.darkSrc || img.getAttribute("src") || "");
    }

    function captureLogoForTheme(theme){
      const preferredCaptureLogo = "szd_logo_blanc.png";
      const mode = theme === "light" ? "light" : "dark";
      const candidates = [
        preferredCaptureLogo,
        "szd_logo_white.png",
        currentLogoForTheme(mode),
        mode === "light" ? "szd_logo_black.png" : "szd_logo_white.png",
        "szd_logo.png"
      ].filter(Boolean);

      const candidate = candidates[0] || "";

      try {
        return new URL(candidate, window.location.href).href;
      } catch (e) {
        return candidate;
      }
    }
  </script>

  <!-- SCRIPT MODE PRÉSENTATION -->
  <script>
    (function(){
      const PRIVACY_KEY = "szd_privacy_mode";
      const CLASSNAME = "privacy-mode";
      const body = document.body;
      const toggleBtn = document.getElementById("togglePrivacyMode");
      const icon = toggleBtn ? toggleBtn.querySelector(".privacy-toggle-icon") : null;
      const label = toggleBtn ? toggleBtn.querySelector(".privacy-toggle-text") : null;

      function readSaved(){
        try {
          return localStorage.getItem(PRIVACY_KEY) === "1";
        } catch(e) {
          return false;
        }
      }

      function syncFramePrivacy(frame, enabled){
        try{
          frame?.contentDocument?.body?.classList.toggle(CLASSNAME, enabled);
        }catch(err){}
      }

      function bindFrame(frame){
        if(!frame || frame.dataset.privacyBound === "1") return;
        frame.addEventListener("load", () => {
          syncFramePrivacy(frame, body?.classList.contains(CLASSNAME));
        });
        frame.dataset.privacyBound = "1";
      }

      function applyToFrames(enabled){
        document.querySelectorAll(".embed-frame").forEach((frame) => {
          bindFrame(frame);
          syncFramePrivacy(frame, enabled);
        });
      }

      function setPrivacy(enabled, persist=true){
        if(body){
          body.classList.toggle(CLASSNAME, enabled);
        }
        if(toggleBtn){
          toggleBtn.classList.toggle("is-active", enabled);
          toggleBtn.setAttribute("aria-pressed", enabled ? "true" : "false");
        }
        if(icon){
          icon.textContent = enabled ? "🙈" : "👁️";
        }
        if(label){
          label.textContent = enabled ? "Mode présentation activé" : "Mode présentation";
        }
        applyToFrames(enabled);
        if(persist){
          try {
            localStorage.setItem(PRIVACY_KEY, enabled ? "1" : "0");
          } catch(e) {}
        }
      }

      const initial = readSaved();
      setPrivacy(initial, false);

      document.addEventListener("DOMContentLoaded", () => {
        if(toggleBtn){
          toggleBtn.addEventListener("click", () => {
            const next = !body.classList.contains(CLASSNAME);
            setPrivacy(next);
          });
        }
      });

      window.addEventListener("storage", (event) => {
        if(event.key === PRIVACY_KEY){
          setPrivacy(event.newValue === "1", false);
        }
      });
    })();
  </script>

  <!-- SCRIPT TABS -->
  <script>
    (function(){
      const tabLinks = document.querySelectorAll("[data-tab-target]");
      const tabSections = document.querySelectorAll(".tab-section");
      const nav = document.querySelector(".top-nav");
      const navToggle = document.getElementById("navToggle");
      const navLinksContainer = document.getElementById("nav-links");
      const embedTabs = new Set(["facturation","rdv","licence","famille"]);
      if(!tabLinks.length || !tabSections.length) return;

      // Navigation principale : état du menu responsive (desktop intact, mobile contrôlé par .is-open).
      function syncToggleState(isOpen){
        if(nav){
          nav.classList.toggle("is-open", Boolean(isOpen));
        }
        if(navToggle){
          navToggle.setAttribute("aria-expanded", isOpen ? "true" : "false");
          navToggle.setAttribute("aria-label", isOpen ? "Fermer le menu" : "Ouvrir le menu");
        }
      }

      function closeMobileMenu(){
        syncToggleState(false);
      }

      if(navToggle && navLinksContainer){
        navToggle.addEventListener("click", () => {
          const isOpen = nav ? !nav.classList.contains("is-open") : !(navToggle.getAttribute("aria-expanded") === "true");
          syncToggleState(isOpen);
        });

        window.addEventListener("resize", () => {
          if(window.innerWidth > 768){
            closeMobileMenu();
          }
        });

        navLinksContainer.addEventListener("click", (event) => {
          const target = event.target;
          if(target && target.closest("a")){
            closeMobileMenu();
          }
        });

        syncToggleState(nav?.classList.contains("is-open"));
      }

      function getActiveTheme(){
        return document.documentElement.getAttribute("data-theme") === "light" ? "light" : "dark";
      }

      function syncFrameTheme(frame, theme){
        const doc = frame?.contentDocument;
        if(!doc) return;
        if(theme === "light"){
          doc.documentElement.setAttribute("data-theme","light");
        } else {
          doc.documentElement.removeAttribute("data-theme");
        }
      }

      function harmonizeFrame(frame){
        try{
          const doc = frame?.contentDocument;
          if(!doc) return;
          const nav = doc.querySelector(".top-nav");
          if(nav){
            nav.remove();
          }
          syncFrameTheme(frame, getActiveTheme());
          requestAnimationFrame(() => {
            const height = Math.max(doc.body?.scrollHeight || 0, doc.documentElement?.scrollHeight || 0, 900);
            frame.style.height = height + "px";
          });
        } catch(err){
          console.warn("Impossible d'harmoniser l'embed", err);
        }
      }

      function lazyLoadEmbed(targetId){
        if(!embedTabs.has(targetId)) return;
        const section = document.getElementById(targetId);
        const frame = section?.querySelector(".embed-frame");
        if(frame && !frame.src){
          frame.src = frame.dataset.src || "";
        }
      }

      function initEmbedFrames(){
        embedTabs.forEach(id => {
          const section = document.getElementById(id);
          const frame = section?.querySelector(".embed-frame");
          if(!frame) return;
          frame.addEventListener("load", () => {
            harmonizeFrame(frame);
            const note = section.querySelector(".embed-note");
            if(note){
              note.setAttribute("data-loaded","true");
            }
          });
        });
      }

      window.szdEmbed = {
        syncTheme(theme){
          document.querySelectorAll(".embed-frame").forEach((frame) => syncFrameTheme(frame, theme));
        },
        refresh(){
          document.querySelectorAll(".embed-frame").forEach((frame) => harmonizeFrame(frame));
        }
      };

      function activateTab(targetId, skipHash){
        tabSections.forEach(section => {
          const active = section.id === targetId;
          section.classList.toggle("active", active);
          section.hidden = !active;
        });

        lazyLoadEmbed(targetId);

        tabLinks.forEach(link => {
          const active = link.dataset.tabTarget === targetId;
          link.classList.toggle("active", active);
          if(active) link.blur();
        });

        if(!skipHash){
          const hash = targetId === "prestations" ? "" : `#${targetId}`;
          const newUrl = hash ? `${location.pathname}${hash}` : location.pathname;
          history.replaceState(null, "", newUrl);
        }
      }

      function initFromHash(){
        const hash = (location.hash || "").replace("#","");
        const target = document.getElementById(hash) ? hash : "prestations";
        lazyLoadEmbed(target);
        activateTab(target, true);
      }

      tabLinks.forEach(link => {
        link.addEventListener("click", (e) => {
          const target = link.dataset.tabTarget;
          if(!target) return;
          e.preventDefault();
          activateTab(target);
          closeMobileMenu();
        });
      });

      initFromHash();
      window.addEventListener("hashchange", initFromHash);
      initEmbedFrames();
    })();
  </script>

  <!-- SCRIPT PRESTATIONS -->
  <script>
    (() => {
      const $ = (id) => document.getElementById(id);
      const formEl = $("prestations-form");
      const eur = (n) => new Intl.NumberFormat("fr-FR", {style:"currency", currency:"EUR"}).format(n || 0);
      const storageKey = "prestations_v1";
      const VERSION = "1.4";

      const status = $("status");
      const debugChk = $("debug");
      const autoFile = $("autoFile");
      const debugOut = $("debugOut");
      const lsStatus = $("lsStatus");

      const tbody = $("tbody");
      const totalMontantEl = $("totalMontant");
      const totalRecuEl = $("totalRecu");
      const totalRestantEl = $("totalRestant");
      const search = $("search");
      const filterStatus = $("filterStatus");
      const filterType = $("filterType");
      const artistChipsWrap = $("artistChips");

      const client = $("client");
      const type = $("type");
      const description = $("description");
      const date = $("date");
      const montant = $("montant");
      const paye = $("paye");

      const exportJsonBtn = $("exportJson");
      const exportCsvBtn = $("exportCsv");
      const importJsonInput = $("importJson");
      const clearAllBtn = $("clearAll"); // (pas présent dans le HTML, ok si null)
      const resetBtn = $("reset");
      const addDemoBtn = $("addDemo");
      const captureBtn = $("captureRecap");
      const smartCaptureBtn = $("smartCapture");
      const followupList = $("followupList");
      const followupCounts = $("followupCounts");
      const followupCaptureBtn = $("followupCaptureBtn");
      const followupCopyBtn = $("followupCopyBtn");
      const mobileCards = $("mobileCards");
      const collapseButtons = Array.from(document.querySelectorAll(".collapse-toggle"));
      const mobileQuery = window.matchMedia("(max-width: 768px)");

      const WHATSAPP_LEVELS = [
        {
          threshold: 15,
          label: "Relance 15j",
          template: `Salut [Prénom],\nPetit rappel concernant ta prestation : il te reste encore 15 jours pour finaliser le règlement du solde.\nN’hésite pas à me contacter si tu as la moindre question.\nÀ bientôt.`,
          tone: "soft"
        },
        {
          threshold: 30,
          label: "Relance 30j",
          template: `Bonjour [Prénom],\nLa date limite des 30 jours pour le règlement du solde est atteinte.\nMerci de régulariser la situation rapidement afin de conserver la réservation de la prestation.\nJe reste disponible si besoin.`,
          tone: "firm"
        },
        {
          threshold: 45,
          label: "Relance 45j (critique)",
          template: `Bonjour [Prénom],\nCela fait désormais 45 jours que le solde est en attente malgré mes précédentes relances.\nMerci de régulariser la situation immédiatement afin d'éviter toute interruption de la prestation.\nJe reste disponible en cas de besoin.`,
          tone: "critical"
        }
      ];

      let data = [];
      let editingId = null;
      let activeArtistFilter = "";

      const log = (...args) => {
        if (debugChk && debugChk.checked) {
          console.log("[DEBUG]", ...args);
          if (debugOut) {
            debugOut.textContent = String(args.join(" "));
          }
        }
      };

      const isMobile = () => mobileQuery.matches;
      const artistColorCache = new Map();

      function colorForArtist(name = ""){
        if(!name) return "var(--accent)";
        if(artistColorCache.has(name)) return artistColorCache.get(name);
        let hash = 0;
        for (let i = 0; i < name.length; i++) {
          hash = name.charCodeAt(i) + ((hash << 5) - hash);
          hash |= 0;
        }
        const hue = Math.abs(hash) % 360;
        const color = `hsl(${hue}, 70%, 60%)`;
        artistColorCache.set(name, color);
        return color;
      }

      function formatAmountForText(value){
        return document.body.classList.contains("privacy-mode") ? "•••• €" : eur(value);
      }

      function syncCollapseTarget(targetId, open){
        const content = document.getElementById(targetId);
        const toggle = collapseButtons.find(btn => btn.dataset.collapseTarget === targetId);
        if(!content || !toggle) return;
        const shouldOpen = Boolean(open);
        content.classList.toggle("is-open", shouldOpen);
        toggle.setAttribute("aria-expanded", shouldOpen ? "true" : "false");
        const label = toggle.querySelector(".collapse-label");
        if(label){
          label.textContent = shouldOpen ? "Masquer" : "Afficher";
        }
      }

      function toggleCollapse(targetId){
        const content = document.getElementById(targetId);
        if(!content) return;
        const shouldOpen = !content.classList.contains("is-open");
        syncCollapseTarget(targetId, shouldOpen);
      }

      function ts(){
        const d=new Date();
        const p=n=>String(n).padStart(2,"0");
        return d.getFullYear()+"-"+p(d.getMonth()+1)+p(d.getDate())+"_"+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds());
      }

      const supportsLocalStorage = (() => {
        try {
          const k = "__test_ls__";
          localStorage.setItem(k,"1");
          localStorage.removeItem(k);
          return true;
        } catch(e) {
          return false;
        }
      })();

      function showStatus(msg, ok=true){
        if(!status) return;
        status.className = "alert " + (ok ? "alert-ok" : "alert-err");
        status.textContent = msg;
        status.style.display = "block";
        clearTimeout(showStatus._t);
        showStatus._t = setTimeout(() => { status.style.display = "none"; }, 4000);
      }

      function persist(){
        if(!supportsLocalStorage) return;
        try {
          localStorage.setItem(storageKey, JSON.stringify(data));
          log("persist ok", data.length);
        } catch(e) {
          console.error(e);
          showStatus("Erreur de sauvegarde locale : " + e.message, false);
        }
      }

      function load(){
        if(!supportsLocalStorage){
          if(lsStatus){
            lsStatus.textContent = "LocalStorage indisponible (mode secours).";
          }
          return;
        }
        if(lsStatus){
          lsStatus.textContent = "LocalStorage actif.";
        }
        try {
          const raw = localStorage.getItem(storageKey);
          if(!raw) return;
          data = JSON.parse(raw) || [];
        } catch(e) {
          console.error(e);
          showStatus("Impossible de lire les données locales.", false);
        }
      }

      function sanitizeAmount(v) {
        if (typeof v === "number") return v;
        let s = (v||"").toString().trim();
        s = s.replace(/\s/g,"").replace(",", "."); // french decimal
        const num = parseFloat(s);
        return isFinite(num) ? num : NaN;
      }

      function getPaid(r){ return Number(r.paidAmount || 0); }
      function getRemaining(r){ return Math.max(0, Number((r.montant||0) - getPaid(r))); }
      function isSettled(r){ return getRemaining(r) <= 0.00001; }

      function daysSince(datestr){
        if(!datestr) return null;
        const d = new Date(datestr);
        if(Number.isNaN(d.getTime())) return null;
        const now = new Date();
        const diff = now - d;
        if(diff < 0) return 0;
        return Math.floor(diff / (1000*60*60*24));
      }

      function extractFirstName(full){
        if(!full) return "client";
        const parts = full.trim().split(/\s+/);
        return parts[0] || "client";
      }

      function renderArtistChips(records){
        if(!artistChipsWrap) return;
        const source = Array.isArray(records) ? records : data;
        const artists = Array.from(new Set((source || []).map(r => r.client).filter(Boolean))).sort((a,b) => a.localeCompare(b, "fr"));
        if(activeArtistFilter && !artists.includes(activeArtistFilter)){
          activeArtistFilter = "";
        }
        artistChipsWrap.innerHTML = "";
        if(!artists.length){
          artistChipsWrap.style.display = "none";
          return;
        }
        artistChipsWrap.style.display = "flex";
        const frag = document.createDocumentFragment();
        artists.forEach(name => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "artist-chip";
          btn.textContent = name;
          btn.style.setProperty("--artist-color", colorForArtist(name));
          const isActive = activeArtistFilter === name;
          btn.classList.toggle("is-active", isActive);
          btn.setAttribute("aria-pressed", isActive ? "true" : "false");
          btn.addEventListener("click", () => {
            activeArtistFilter = isActive ? "" : name;
            render();
          });
          frag.appendChild(btn);
        });
        artistChipsWrap.appendChild(frag);
      }

      function buildWhatsAppUrl(name, level){
        const targetName = name || "client";
        const message = (level?.template || "").replace("[Prénom]", targetName);
        return "https://wa.me/?text=" + encodeURIComponent(message);
      }

      function filterRecords(list){
        const q = (search?.value || "").toLowerCase();
        const fStatus = filterStatus?.value || "all";
        const fType = filterType?.value || "all";
        const artist = (activeArtistFilter || "").toLowerCase();

        return list.filter(r => {
          if(q){
            const blob = [r.client,r.type,r.description].join(" ").toLowerCase();
            if(!blob.includes(q)) return false;
          }
          if(artist && (r.client || "").toLowerCase() !== artist) return false;
          if(fType !== "all" && r.type !== fType) return false;
          if(fStatus !== "all"){
            const settled = isSettled(r);
            const paid = getPaid(r) > 0;
            if(fStatus === "paid" && !settled) return false;
            if(fStatus === "unpayed" && (paid || settled)) return false;
            if(fStatus === "partial" && (!paid || settled)) return false;
          }
          return true;
        });
      }

      function updateTotals(records){
        const list = Array.isArray(records) ? records : [];
        const totals = list.reduce((acc, r = {}) => {
          const m = Number(r.montant || 0);
          const p = getPaid(r);
          acc.totalMontant += m;
          acc.totalRecu += p;
          acc.totalRestant += Math.max(0, m - p);
          return acc;
        }, {totalMontant:0, totalRecu:0, totalRestant:0});

        if(totalMontantEl) totalMontantEl.textContent = eur(totals.totalMontant);
        if(totalRecuEl) totalRecuEl.textContent = eur(totals.totalRecu);
        if(totalRestantEl) totalRestantEl.textContent = eur(totals.totalRestant);

        return totals;
      }

      function buildMobileRecap(records, target){
        const zone = target || document.getElementById("capture-mobile");
        if(!zone){
          throw new Error("Zone de capture introuvable pour le récapitulatif mobile.");
        }

        if(!Array.isArray(records)){
          throw new Error("getFilteredRecords() n'a pas renvoyé un tableau.");
        }
        if(typeof records.length !== "number" || records.length < 0){
          throw new Error("records.length est invalide pour la capture mobile.");
        }

        const list = Array.isArray(records) ? records : [];
        const totalRestant = list.reduce((acc, r = {}) => acc + Math.max(0, getRemaining(r)), 0);
        const summary = { totalRestant };

        const now = new Date();
        const dateStr = now.toLocaleString("fr-FR", {
          day:"2-digit", month:"2-digit", year:"numeric",
          hour:"2-digit", minute:"2-digit"
        });

        zone.innerHTML = "";
        zone.classList.remove("smart-capture");

        const header = document.createElement("div");
        header.className = "cap-header";

        const headerLogo = document.querySelector(".nav-left .logo-wrap");
        if(!headerLogo){
          throw new Error("Logo source introuvable pour la capture mobile.");
        }
        const clonedLogo = headerLogo.cloneNode(true);
        clonedLogo.classList.add("cap-logo-clone");
        clonedLogo.removeAttribute("href");
        const clonedImg = clonedLogo.querySelector("img");
        if(!clonedImg){
          throw new Error("Image du logo introuvable pour la capture mobile.");
        }
        clonedImg.style.opacity = "1";
        clonedImg.style.visibility = "visible";
        clonedImg.style.display = "block";
        header.appendChild(clonedLogo);

        const title = document.createElement("div");
        title.className = "cap-title";
        title.textContent = "Récapitulatif des prestations";
        const sub = document.createElement("div");
        sub.className = "cap-sub";
        sub.textContent = "Généré le " + dateStr;
        header.appendChild(title);
        header.appendChild(sub);
        if(activeArtistFilter){
          const highlight = document.createElement("div");
          highlight.className = "cap-highlight";
          const dot = document.createElement("span");
          dot.className = "dot";
          const name = document.createElement("span");
          name.textContent = activeArtistFilter;
          highlight.appendChild(dot);
          highlight.appendChild(name);
          header.appendChild(highlight);
        }
        zone.appendChild(header);

        const summaryWrap = document.createElement("div");
        summaryWrap.className = "cap-summary";
        const kpi = document.createElement("div");
        kpi.className = "cap-kpi due";
        const l = document.createElement("div");
        l.className = "label";
        l.textContent = "Restant dû total";
        const v = document.createElement("div");
        v.className = "value amount-mask";
        v.textContent = eur(summary.totalRestant || 0);
        kpi.appendChild(l);
        kpi.appendChild(v);
        summaryWrap.appendChild(kpi);
        zone.appendChild(summaryWrap);

        if(!list.length){
          const empty = document.createElement("div");
          empty.className = "cap-item";
          empty.textContent = "Aucune prestation ne correspond aux filtres.";
          zone.appendChild(empty);
          return summary;
        }

        const frag = document.createDocumentFragment();
        list.forEach(r => {
          const remaining = getRemaining(r);
          const paid = getPaid(r);
          const percent = (r.montant && r.montant > 0) ? Math.min(100, Math.round(paid/r.montant*100)) : 0;

          let cls, label;
          if(isSettled(r)){
            cls = "paid"; label = "Payé";
          }else if(paid > 0){
            cls = "partial"; label = "Partiel";
          }else{
            cls = "muted"; label = "Non payé";
          }

          const item = document.createElement("div");
          item.className = "cap-item";
          item.innerHTML = `
            <div class="cap-client">${r.client || ""}</div>
            <div class="cap-subtitle">${(r.type || "")}${r.description ? " — " + r.description : ""}</div>
            <div class="cap-row"><span>Date</span><span>${r.date || ""}</span></div>
            <div class="cap-row"><span>Facturé</span><span class="amount-mask">${eur(r.montant || 0)}</span></div>
            <div class="cap-row"><span>Reçu</span><span class="amount-mask">${eur(paid)}</span></div>
            <div class="cap-row"><span>Restant</span><span class="amount-mask">${eur(remaining)}</span></div>
            <div class="cap-progress-wrap">
              <div class="cap-row-progress-label">
                <span>Avancement</span>
                <span>${percent} %</span>
              </div>
              <div class="progress">
                <div class="progress-inner" style="width:${percent}%;"></div>
              </div>
            </div>
            <div class="cap-row">
              <span>Statut</span>
              <span class="status-pill ${cls}">
                <span class="dot"></span>
                <span>${label}</span>
              </span>
            </div>
          `;
          frag.appendChild(item);
        });
        zone.appendChild(frag);

        return summary;
      }

      function buildSmartCapture(records, target){
        const zone = target || document.getElementById("capture-mobile");
        if(!zone){
          throw new Error("Zone de capture introuvable pour le récapitulatif mobile.");
        }
        const list = Array.isArray(records) ? records : [];
        zone.innerHTML = "";
        zone.classList.add("smart-capture");

        const now = new Date();
        const dateStr = now.toLocaleString("fr-FR", {
          day:"2-digit", month:"2-digit", year:"numeric",
          hour:"2-digit", minute:"2-digit"
        });

        const header = document.createElement("div");
        header.className = "cap-header";

        const headerLogo = document.querySelector(".nav-left .logo-wrap");
        if(!headerLogo){
          throw new Error("Logo source introuvable pour la capture mobile.");
        }
        const clonedLogo = headerLogo.cloneNode(true);
        clonedLogo.classList.add("cap-logo-clone");
        clonedLogo.removeAttribute("href");
        const clonedImg = clonedLogo.querySelector("img");
        if(!clonedImg){
          throw new Error("Image du logo introuvable pour la capture mobile.");
        }
        clonedImg.style.opacity = "1";
        clonedImg.style.visibility = "visible";
        clonedImg.style.display = "block";
        header.appendChild(clonedLogo);

        const title = document.createElement("div");
        title.className = "cap-title";
        title.textContent = "Capture mobile intelligente";
        const sub = document.createElement("div");
        sub.className = "cap-sub";
        sub.textContent = "Prêt à partager — " + dateStr;
        header.appendChild(title);
        header.appendChild(sub);
        if(activeArtistFilter){
          const highlight = document.createElement("div");
          highlight.className = "cap-highlight";
          const dot = document.createElement("span");
          dot.className = "dot";
          const name = document.createElement("span");
          name.textContent = activeArtistFilter;
          highlight.appendChild(dot);
          highlight.appendChild(name);
          header.appendChild(highlight);
        }
        zone.appendChild(header);

        if(!list.length){
          const empty = document.createElement("div");
          empty.className = "cap-item";
          empty.textContent = "Aucune prestation ne correspond aux filtres.";
          zone.appendChild(empty);
          return { totalRestant: 0 };
        }

        const frag = document.createDocumentFragment();
        let totalRestant = 0;
        const messageLines = [];

        list.forEach(r => {
          const remaining = getRemaining(r);
          const paid = getPaid(r);
          const percent = (r.montant && r.montant > 0) ? Math.min(100, Math.round(paid/r.montant*100)) : 0;
          const days = daysSince(r.date);
          const late = Math.max(0, (days || 0) - 15);

          let cls = "muted";
          let label = "Non payé";
          if(isSettled(r)){
            cls = "paid"; label = "Payé";
          }else if(paid > 0){
            cls = "partial"; label = "Partiel";
          }

          totalRestant += remaining;
          messageLines.push({
            client: r.client || "Client",
            label,
            days: days !== null ? days + "j" : "date ?",
            remaining
          });

          const item = document.createElement("div");
          item.className = "cap-item";
          item.innerHTML = `
            <div class="cap-client">${r.client || ""}</div>
            <div class="cap-subtitle">${(r.type || "")}${r.description ? " — " + r.description : ""}</div>
            <div class="cap-row"><span>Date</span><span>${r.date || ""}</span></div>
            <div class="cap-row"><span>Jours depuis la prestation</span><span>${days !== null ? days + " j" : "N/A"}</span></div>
            <div class="cap-row"><span>Jours de retard</span><span>${late} j</span></div>
            <div class="cap-row"><span>Statut</span><span class="status-pill ${cls}"><span class="dot"></span><span>${label}</span></span></div>
            <div class="cap-row"><span>Restant dû</span><span class="amount-mask">${eur(remaining)}</span></div>
            <div class="cap-progress-wrap">
              <div class="cap-row-progress-label">
                <span>Avancement</span>
                <span>${percent} %</span>
              </div>
              <div class="progress">
                <div class="progress-inner" style="width:${percent}%;"></div>
              </div>
            </div>
          `;
          frag.appendChild(item);
        });

        const summaryWrap = document.createElement("div");
        summaryWrap.className = "cap-summary";
        const kpi = document.createElement("div");
        kpi.className = "cap-kpi due";
        const l = document.createElement("div");
        l.className = "label";
        l.textContent = "Restant dû total";
        const v = document.createElement("div");
        v.className = "value amount-mask";
        v.textContent = eur(totalRestant);
        kpi.appendChild(l);
        kpi.appendChild(v);
        summaryWrap.appendChild(kpi);
        zone.appendChild(summaryWrap);

        zone.appendChild(frag);

        const message = document.createElement("div");
        message.className = "cap-message";
        const artistLabel = activeArtistFilter ? activeArtistFilter : "Sélection courante";
        const msgTitle = document.createElement("div");
        msgTitle.textContent = `💬 WhatsApp — ${artistLabel}`;
        message.appendChild(msgTitle);
        messageLines.forEach(line => {
          const row = document.createElement("div");
          row.innerHTML = `• ${line.client} — ${line.label} — ${line.days} — Restant <span class="amount-mask">${eur(line.remaining)}</span>`;
          message.appendChild(row);
        });
        const totalRow = document.createElement("div");
        totalRow.innerHTML = `Total restant : <span class="amount-mask">${eur(totalRestant)}</span>`;
        message.appendChild(totalRow);
        zone.appendChild(message);

        return { totalRestant };
      }

      function getFollowupItems(list){
        const source = Array.isArray(list) ? list : filterRecords(data);
        return (source || [])
          .map(r => ({
            ...r,
            days: daysSince(r.date),
            remaining: getRemaining(r)
          }))
          .filter(r => r.remaining > 0 && r.days !== null && r.days >= 15)
          .sort((a,b) => (b.days || 0) - (a.days || 0))
          .map(r => {
            const urgency = (r.days || 0) >= 45 ? "critical" : (r.days || 0) >= 30 ? "firm" : "soft";
            const urgencyLabel = urgency === "critical" ? "Relance critique" : urgency === "firm" ? "Relance urgente" : "Relance douce";
            const paceLabel = urgency === "critical" ? "Critique" : urgency === "firm" ? "Prioritaire" : "Douce";
            const whatsappLevel = [...WHATSAPP_LEVELS].reverse().find(level => (r.days || 0) >= level.threshold) || WHATSAPP_LEVELS[0];
            return {
              ...r,
              urgency,
              urgencyLabel,
              paceLabel,
              whatsappLevel,
              late: Math.max(0, (r.days || 0) - 15)
            };
          });
      }

      function formatFollowupShareMessage(items){
        const list = Array.isArray(items) ? items : [];
        const artistLabel = activeArtistFilter || "Tous artistes";
        if(!list.length){
          return `Relances ${artistLabel} : aucune relance à traiter.`;
        }
        const lines = list.map(item => {
          const level = item.urgency === "critical" ? "Critique" : item.urgency === "firm" ? "Urgente" : "Douce";
          return `• ${item.client} — ${level} — ${item.days}j (${item.late}j retard) — Restant ${formatAmountForText(item.remaining)}`;
        });
        return [`Relances ${artistLabel} (${list.length})`, ...lines].join("\\n");
      }

      function buildFollowupCapture(records, target){
        const zone = target || document.getElementById("followup-capture");
        if(!zone){
          throw new Error("Conteneur de capture relances introuvable.");
        }
        const items = getFollowupItems(records);
        zone.innerHTML = "";

        const header = document.createElement("div");
        header.className = "cap-header";
        const headerLogo = document.querySelector(".nav-left .logo-wrap");
        if(!headerLogo){
          throw new Error("Logo source introuvable pour la capture relances.");
        }
        const clonedLogo = headerLogo.cloneNode(true);
        clonedLogo.classList.add("cap-logo-clone");
        clonedLogo.removeAttribute("href");
        const clonedImg = clonedLogo.querySelector("img");
        if(!clonedImg){
          throw new Error("Image du logo introuvable pour la capture relances.");
        }
        clonedImg.style.opacity = "1";
        clonedImg.style.visibility = "visible";
        clonedImg.style.display = "block";
        header.appendChild(clonedLogo);

        const title = document.createElement("div");
        title.className = "cap-title";
        title.textContent = "Relances automatiques — Mobile";
        const sub = document.createElement("div");
        sub.className = "cap-sub";
        const now = new Date();
        sub.textContent = "Prêt pour WhatsApp — " + now.toLocaleDateString("fr-FR");
        header.appendChild(title);
        header.appendChild(sub);
        if(activeArtistFilter){
          const highlight = document.createElement("div");
          highlight.className = "cap-highlight";
          const dot = document.createElement("span");
          dot.className = "dot";
          dot.style.background = colorForArtist(activeArtistFilter);
          const name = document.createElement("span");
          name.textContent = activeArtistFilter;
          highlight.appendChild(dot);
          highlight.appendChild(name);
          header.appendChild(highlight);
        }
        zone.appendChild(header);

        const summary = document.createElement("div");
        summary.className = "relance-summary";
        const totalRemaining = items.reduce((acc, r) => acc + (r.remaining || 0), 0);
        const relancesKpi = document.createElement("div");
        relancesKpi.className = "relance-kpi";
        relancesKpi.innerHTML = `<div class="label">Relances à effectuer</div><div class="value">${items.length}</div>`;
        const remainingKpi = document.createElement("div");
        remainingKpi.className = "relance-kpi";
        remainingKpi.innerHTML = `<div class="label">Restant dû</div><div class="value amount-mask">${eur(totalRemaining)}</div>`;
        summary.appendChild(relancesKpi);
        summary.appendChild(remainingKpi);
        zone.appendChild(summary);

        if(!items.length){
          const empty = document.createElement("div");
          empty.className = "cap-item";
          empty.textContent = "Aucune relance pour les filtres actifs.";
          zone.appendChild(empty);
          return { totalRestant: totalRemaining, relances: 0 };
        }

        const frag = document.createDocumentFragment();
        items.forEach(item => {
          const wrap = document.createElement("div");
          wrap.className = "relance-item";

          const top = document.createElement("div");
          top.className = "relance-top";
          const info = document.createElement("div");
          const clientLabel = document.createElement("div");
          clientLabel.className = "cap-client";
          clientLabel.textContent = item.client || "Client";
          const subtitle = document.createElement("div");
          subtitle.className = "cap-subtitle";
          subtitle.textContent = (item.type || "") + (item.description ? " — " + item.description : "");
          info.appendChild(clientLabel);
          info.appendChild(subtitle);
          top.appendChild(info);

          const urgency = document.createElement("span");
          urgency.className = "relance-urgency";
          const icon = item.urgency === "critical" ? "🚨" : item.urgency === "firm" ? "🚀" : "🌱";
          urgency.textContent = `${icon} ${item.urgencyLabel}`;
          top.appendChild(urgency);
          wrap.appendChild(top);

          const grid = document.createElement("div");
          grid.className = "relance-grid";
          [
            ["Jours depuis prestation", (item.days || 0) + " j"],
            ["Jours de retard", (item.late || 0) + " j"],
            ["Niveau WhatsApp", item.paceLabel],
            ["Restant dû", `<span class="amount-mask">${eur(item.remaining || 0)}</span>`]
          ].forEach(([label, value]) => {
            const row = document.createElement("div");
            row.className = "relance-row";
            const l = document.createElement("span");
            l.textContent = label;
            const v = document.createElement("span");
            v.innerHTML = value;
            row.appendChild(l);
            row.appendChild(v);
            grid.appendChild(row);
          });
          wrap.appendChild(grid);

          const message = document.createElement("div");
          message.className = "relance-message";
          const template = (item.whatsappLevel?.template || "").replace("[Prénom]", extractFirstName(item.client));
          message.textContent = `${template}\nRestant : ${formatAmountForText(item.remaining)}\nRetard : ${item.late} jours`;
          wrap.appendChild(message);

          frag.appendChild(wrap);
        });

        zone.appendChild(frag);

        const recapMessage = document.createElement("div");
        recapMessage.className = "cap-message";
        recapMessage.innerHTML = `💬 Message à partager<br>${formatFollowupShareMessage(items).replace(/\\n/g,"<br>")}`;
        zone.appendChild(recapMessage);

        return { totalRestant: totalRemaining, relances: items.length };
      }

      function updateFollowUps(list){
        if(!followupList) return;

        followupList.innerHTML = "";
        let soft = 0, firm = 0, critical = 0;

        const items = getFollowupItems(list);

        if(!items.length){
          const empty = document.createElement("div");
          empty.className = "small";
          empty.textContent = "Aucune relance nécessaire pour le moment.";
          followupList.appendChild(empty);
          if(followupCounts) followupCounts.textContent = "0 relance en attente";
          return;
        }

        items.forEach(r => {
          const urgency = r.urgency;
          if(urgency === "critical") critical++; else if(urgency === "firm") firm++; else soft++;

          const item = document.createElement("div");
          item.className = "cap-item followup-card";

          const actionLabel = r.urgencyLabel;
          const pillClass = urgency === "critical" ? "critical" : (urgency === "firm" ? "muted" : "partial");
          const actionIcon = urgency === "critical" ? "🚨" : urgency === "firm" ? "🚀" : "🌱";
          const paceLabel = r.paceLabel;
          const availableLevels = WHATSAPP_LEVELS.filter(level => (r.days || 0) >= level.threshold);

          item.innerHTML = `
            <div class="followup-head">
              <div>
                <div class="cap-client">${r.client || "Client"}</div>
                <div class="cap-subtitle">${r.type || ""}${r.description ? " — " + r.description : ""}</div>
              </div>
              <span class="status-pill ${pillClass} followup-pill">
                <span class="dot"></span>
                <span>${actionIcon} ${actionLabel}</span>
              </span>
            </div>
            <div class="followup-meta">
              <div class="followup-stat">
                <span class="label">💶 Restant dû</span>
                <span class="value amount-mask">${eur(r.remaining)}</span>
              </div>
              <div class="followup-stat">
                <span class="label">⏳ Ancienneté</span>
                <span class="value">${r.days} jours</span>
              </div>
              <div class="followup-stat">
                <span class="label">💬 Niveau WhatsApp</span>
                <span class="value">${paceLabel}</span>
              </div>
            </div>
          `;

          const actions = document.createElement("div");
          actions.className = "followup-actions";

          const hint = document.createElement("div");
          hint.className = "small";
          hint.textContent = "Messages prêts :";
          actions.appendChild(hint);

          const btnRow = document.createElement("div");
          btnRow.className = "followup-btn-row";

          availableLevels.forEach(level => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = `btn relance-btn relance-${level.tone}`;
            btn.textContent = level.label;
            btn.addEventListener("click", () => {
              const url = buildWhatsAppUrl(extractFirstName(r.client), level);
              window.open(url, "_blank", "noopener");
            });
            btnRow.appendChild(btn);
          });

          actions.appendChild(btnRow);
          item.appendChild(actions);

          followupList.appendChild(item);
        });

        if(followupCounts){
          const parts = [];
          if(soft) parts.push(`${soft} à relancer`);
          if(firm) parts.push(`${firm} urgentes`);
          if(critical) parts.push(`${critical} critiques`);
          followupCounts.textContent = parts.join(" • ");
        }
      }

      function handleEncaisser(r){
        let max = getRemaining(r);
        if(max <= 0){
          showStatus("Tout est déjà payé pour cette prestation.", false);
          return;
        }
        const s = prompt("Montant à encaisser (max " + eur(max) + "):", "");
        if(s===null) return;
        const val = sanitizeAmount(s);
        if(!isFinite(val) || val<=0){
          showStatus("Montant invalide.", false);
          return;
        }
        if(val > max + 0.00001){
          showStatus("Montant supérieur au restant dû.", false);
          return;
        }
        r.paidAmount = (r.paidAmount || 0) + val;
        persist();
        updateTotals(filterRecords(data));
        render();
        showStatus("Paiement enregistré.");
      }

      function handleEdit(r){
        editingId = r.id;
        client.value = r.client || "";
        type.value = r.type || "Clip";
        description.value = r.description || "";
        date.value = r.date || "";
        montant.value = r.montant != null ? String(r.montant) : "";
        paye.checked = isSettled(r);
        window.scrollTo({top:0, behavior:"smooth"});
      }

      function handleDelete(r){
        if (!confirm("Supprimer cette prestation ?")) return;
        data = data.filter(x => x.id !== r.id);
        persist();
        updateTotals(filterRecords(data));
        render();
        if (editingId === r.id) editingId = null;
        showStatus("Prestation supprimée.");
      }

      function renderMobileCards(records){
        if(!mobileCards) return;
        if(!isMobile()){
          mobileCards.innerHTML = "";
          mobileCards.setAttribute("aria-hidden","true");
          return;
        }

        mobileCards.setAttribute("aria-hidden","false");
        mobileCards.innerHTML = "";

        if(!records.length){
          const empty = document.createElement("div");
          empty.className = "mobile-card mobile-empty";
          empty.textContent = "Aucune prestation ne correspond.";
          mobileCards.appendChild(empty);
          return;
        }

        records.forEach(r => {
          const paid = getPaid(r);
          const remaining = getRemaining(r);
          const percent = (r.montant && r.montant > 0) ? Math.min(100, Math.round(paid/r.montant*100)) : 0;

          let cls = "muted";
          let label = "Non payé";
          if(isSettled(r)){
            cls = "paid"; label = "Payé";
          }else if(paid > 0){
            cls = "partial"; label = "Partiel";
          }

          const card = document.createElement("div");
          card.className = "mobile-card";

          const header = document.createElement("header");
          const left = document.createElement("div");
          const clientEl = document.createElement("div");
          clientEl.className = "client";
          clientEl.textContent = r.client || "";
          const meta = document.createElement("div");
          meta.className = "mobile-meta";
          meta.textContent = (r.type || "") + (r.description ? " — " + r.description : "");
          left.appendChild(clientEl);
          left.appendChild(meta);
          header.appendChild(left);

          const pill = document.createElement("span");
          pill.className = "status-pill " + cls + " mobile-status";
          const dot = document.createElement("span");
          dot.className = "dot";
          const text = document.createElement("span");
          text.textContent = label;
          pill.appendChild(dot);
          pill.appendChild(text);
          header.appendChild(pill);
          card.appendChild(header);

          const dateRow = document.createElement("div");
          dateRow.className = "mobile-meta";
          dateRow.textContent = r.date ? `Date : ${r.date}` : "Date non renseignée";
          card.appendChild(dateRow);

          const amounts = document.createElement("div");
          amounts.className = "mobile-amounts";
          [
            {label:"Facturé", value: eur(r.montant || 0)},
            {label:"Reçu", value: eur(paid)},
            {label:"Restant", value: eur(remaining)}
          ].forEach(item => {
            const wrap = document.createElement("div");
            const l = document.createElement("div");
            l.className = "label";
            l.textContent = item.label;
            const v = document.createElement("div");
            v.className = "value amount-mask";
            v.textContent = item.value;
            wrap.appendChild(l);
            wrap.appendChild(v);
            amounts.appendChild(wrap);
          });
          card.appendChild(amounts);

          const progress = document.createElement("div");
          progress.className = "mobile-progress";
          const progressHead = document.createElement("div");
          progressHead.className = "cap-row-progress-label";
          progressHead.innerHTML = `<span>Avancement</span><span>${percent} %</span>`;
          const bar = document.createElement("div");
          bar.className = "progress";
          const inner = document.createElement("div");
          inner.className = "progress-inner";
          inner.style.width = percent + "%";
          bar.appendChild(inner);
          progress.appendChild(progressHead);
          progress.appendChild(bar);
          card.appendChild(progress);

          const actions = document.createElement("div");
          actions.className = "mobile-card-actions";
          const encBtn = document.createElement("button");
          encBtn.type = "button";
          encBtn.className = "btn btn-primary mobile-full-btn";
          encBtn.textContent = "Encaisser";
          encBtn.addEventListener("click", () => handleEncaisser(r));
          const secondary = document.createElement("div");
          secondary.className = "mobile-secondary-actions";
          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.className = "btn btn-outline";
          editBtn.textContent = "Modifier";
          editBtn.addEventListener("click", () => handleEdit(r));
          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "btn btn-outline";
          delBtn.textContent = "Supprimer";
          delBtn.addEventListener("click", () => handleDelete(r));
          secondary.appendChild(editBtn);
          secondary.appendChild(delBtn);
          actions.appendChild(encBtn);
          actions.appendChild(secondary);
          card.appendChild(actions);

          mobileCards.appendChild(card);
        });
      }

      function render(){
        if(!tbody) return;
        tbody.innerHTML = "";

        renderArtistChips(data);
        const records = filterRecords(data);
        if(!records.length){
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 10;
          td.className = "small";
          td.textContent = "Aucune prestation ne correspond.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          const totals = updateTotals(records);
          renderMobileCards(records);
          buildMobileRecap(records);
          updateFollowUps(records);
          return;
        }

        records.sort((a,b) => {
          const da = a.date || "";
          const db = b.date || "";
          return da.localeCompare(db);
        });

        records.forEach(r => {
          const tr = document.createElement("tr");

          const tdDate = document.createElement("td");
          tdDate.textContent = r.date || "";
          tr.appendChild(tdDate);

          const tdClient = document.createElement("td");
          const c1 = document.createElement("div");
          c1.textContent = r.client || "";
          c1.style.fontWeight = "600";
          const c2 = document.createElement("div");
          c2.className = "small";
          c2.textContent = (r.type || "") + (r.description ? " — " + r.description : "");
          tdClient.appendChild(c1);
          tdClient.appendChild(c2);
          tr.appendChild(tdClient);

          const tdMontant = document.createElement("td");
          tdMontant.classList.add("amount-mask");
          tdMontant.textContent = eur(r.montant || 0);
          tr.appendChild(tdMontant);

          const tdRecu = document.createElement("td");
          tdRecu.classList.add("amount-mask");
          tdRecu.textContent = eur(getPaid(r));
          tr.appendChild(tdRecu);

          const remaining = getRemaining(r);
          const tdRestant = document.createElement("td");
          tdRestant.classList.add("amount-mask");
          tdRestant.textContent = eur(remaining);
          tr.appendChild(tdRestant);

          const tdProgress = document.createElement("td");
          const wrapper = document.createElement("div");
          wrapper.className = "small";
          const percent = (r.montant && r.montant > 0) ? Math.min(100, Math.round(getPaid(r)/r.montant*100)) : 0;
          wrapper.textContent = percent + " %";
          const bar = document.createElement("div");
          bar.className = "progress";
          const inner = document.createElement("div");
          inner.className = "progress-inner";
          inner.style.width = percent + "%";
          bar.appendChild(inner);
          tdProgress.appendChild(wrapper);
          tdProgress.appendChild(bar);
          tr.appendChild(tdProgress);

          const tdStatus = document.createElement("td");
          const pill = document.createElement("span");
          pill.className = "status-pill";
          const dot = document.createElement("span");
          dot.className = "dot";
          pill.appendChild(dot);
          const label = document.createElement("span");
          let cls = "";
          if(isSettled(r)){
            cls = "paid";
            label.textContent = "Payé";
          }else if(getPaid(r) > 0){
            cls = "partial";
            label.textContent = "Partiel";
          }else{
            cls = "muted";
            label.textContent = "Non payé";
          }
          pill.classList.add(cls);
          pill.appendChild(label);
          tdStatus.appendChild(pill);
          tr.appendChild(tdStatus);

          const tdActions = document.createElement("td");
          const encBtn = document.createElement("button");
          encBtn.type = "button";
          encBtn.className = "btn btn-primary";
          encBtn.textContent = "Encaisser";
          encBtn.addEventListener("click", () => handleEncaisser(r));

          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.className = "btn btn-outline";
          editBtn.textContent = "Modifier";
          editBtn.addEventListener("click", () => handleEdit(r));

          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "btn btn-outline";
          delBtn.textContent = "Supprimer";
          delBtn.addEventListener("click", () => handleDelete(r));

          tdActions.appendChild(encBtn);
          tdActions.appendChild(editBtn);
          tdActions.appendChild(delBtn);
          tr.appendChild(tdActions);

          tbody.appendChild(tr);
        });

        const totals = updateTotals(records);
        renderMobileCards(records);
        buildMobileRecap(records);
        updateFollowUps(records);
      }

      collapseButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          if(!isMobile()) return;
          const targetId = btn.dataset.collapseTarget;
          if(targetId){
            toggleCollapse(targetId);
          }
        });
      });

      let lastIsMobile = isMobile();
      collapseButtons.forEach(btn => {
        if(!btn.dataset.collapseTarget) return;
        syncCollapseTarget(btn.dataset.collapseTarget, lastIsMobile ? false : true);
      });

      function handleViewportChange(){
        const nowMobile = isMobile();
        if(nowMobile !== lastIsMobile){
          collapseButtons.forEach(btn => {
            if(!btn.dataset.collapseTarget) return;
            syncCollapseTarget(btn.dataset.collapseTarget, nowMobile ? false : true);
          });
        }
        renderMobileCards(filterRecords(data));
        lastIsMobile = nowMobile;
      }

      if(typeof mobileQuery?.addEventListener === "function"){
        mobileQuery.addEventListener("change", handleViewportChange);
      }

      function captureRecap(records, options = {}){
        console.log("CAPTURE 0: démarrage captureRecap");
        try{
          console.log("CAPTURE 1: récupération records");
          const base = Array.isArray(records) ? records : (data || []);
          if(!Array.isArray(base)){
            throw new Error("getFilteredRecords() n'a pas renvoyé un tableau.");
          }
          console.log("CAPTURE 2: application des filtres");
          const list = filterRecords(base);
          if(!Array.isArray(list)){
            throw new Error("getFilteredRecords() n'a pas renvoyé un tableau.");
          }
          if(typeof list.length !== "number" || list.length < 0){
            throw new Error("records.length est invalide pour la capture.");
          }
          if(!list.length){
            showStatus("Aucune prestation à capturer (vérifie les filtres).", false);
            return;
          }

          console.log("CAPTURE 3: récupération du conteneur de capture");
          const targetId = options.targetId || "capture-mobile";
          const zone = document.getElementById(targetId);
          if(!zone){
            throw new Error("Conteneur de capture introuvable.");
          }
          if(!(zone instanceof HTMLElement)){
            throw new Error("Élément de capture invalide.");
          }

          console.log("CAPTURE 4: buildMobileRecap en cours");
          const builder = typeof options.builder === "function" ? options.builder : buildMobileRecap;
          const totals = builder(list, zone);
          if(!totals){
            throw new Error("buildMobileRecap n'a pas renvoyé de totaux.");
          }
          console.log("CAPTURE 5: buildMobileRecap OK, préparation html2canvas");

          if(typeof html2canvas !== "function"){
            throw new Error("html2canvas indisponible pour la capture.");
          }

          const bg = document.documentElement.getAttribute("data-theme") === "light"
            ? "#f3f4f6"
            : "#020617";

          const prevDisplay = zone.style.display;
          const prevVisibility = zone.style.visibility;
          zone.style.display = "block";
          zone.style.visibility = "visible";

          const launchCapture = () => {
            console.log("CAPTURE 6: html2canvas lancé");
            html2canvas(zone, {
              backgroundColor: bg,
              scale: 2,
              useCORS: true,
              allowTaint: true
            }).then(canvas => {
              console.log("CAPTURE 7: html2canvas OK, création du lien de téléchargement");
              const link = document.createElement("a");
              const prefix = options.prefix || (targetId === "capture-mobile" ? "recap_prestations_mobile_" : `${targetId}_`);
              link.download = prefix + ts() + ".png";
              link.href = canvas.toDataURL("image/png");
              link.click();
              showStatus("Récapitulatif capturé (format mobile) !");
            }).catch(err => {
              console.error("CAPTURE ERREUR html2canvas", err);
              if(err && err.stack) console.error(err.stack);
              alert(err?.message || "Erreur lors de l'exécution de html2canvas.");
            }).finally(() => {
              zone.style.display = prevDisplay;
              zone.style.visibility = prevVisibility;
            });
          };

          if(typeof requestAnimationFrame === "function"){
            requestAnimationFrame(() => requestAnimationFrame(launchCapture));
          }else{
            setTimeout(launchCapture, 0);
          }
        }catch(err){
          console.error("CAPTURE ERREUR inattendue", err);
          if(err && err.stack) console.error(err.stack);
          alert(err && err.message ? err.message : "Erreur lors de la capture du récapitulatif.");
        }
      }

      function resetForm(){
        if(!formEl) return;
        client.value = "";
        type.value = "Clip";
        description.value = "";
        date.value = "";
        montant.value = "";
        paye.checked = false;
        editingId = null;
      }

      function validateForm(){
        const c = client.value.trim();
        if(!c){
          showStatus("Le nom du client est obligatoire.", false);
          client.focus();
          return null;
        }
        const m = sanitizeAmount(montant.value);
        if(!isFinite(m) || m<=0){
          showStatus("Montant invalide.", false);
          montant.focus();
          return null;
        }
        const d = date.value || new Date().toISOString().slice(0,10);
        return {client:c, type:type.value, description:description.value.trim(), date:d, montant:m};
      }

      function addRecord(rec){
        rec.id = rec.id || Date.now() + Math.random();
        rec.paidAmount = rec.paidAmount || 0;
        data.push(rec);
      }

      if(formEl){
        formEl.addEventListener("submit", (e) => {
          e.preventDefault();
          const rec = validateForm();
          if(!rec) return;

          if(editingId){
            const idx = data.findIndex(r => r.id === editingId);
            if(idx !== -1){
              data[idx] = {
                ...data[idx],
                ...rec
              };
              showStatus("Prestation modifiée.");
            }
            editingId = null;
          } else {
            if(paye.checked){
              rec.paidAmount = rec.montant;
            }
            addRecord(rec);
            showStatus("Prestation ajoutée.");
          }

          persist();
          render();
          resetForm();
        });
      }

      if(resetBtn){
        resetBtn.addEventListener("click", () => {
          resetForm();
        });
      }

      if(addDemoBtn){
        addDemoBtn.addEventListener("click", () => {
          const demo = {
            client:"Artiste démo",
            type:"Clip",
            description:"Clip test démo",
            date:new Date().toISOString().slice(0,10),
            montant:800,
            paidAmount:200
          };
          addRecord(demo);
          persist();
          render();
          showStatus("Démo ajoutée.");
        });
      }

      if(exportJsonBtn){
        exportJsonBtn.addEventListener("click", () => {
          try{
            const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "prestations_"+ts()+".json";
            a.click();
            URL.revokeObjectURL(a.href);
            showStatus("Export JSON téléchargé.");
          }catch(e){
            console.error(e);
            showStatus("Erreur export JSON : " + e.message, false);
          }
        });
      }

      if(exportCsvBtn){
        exportCsvBtn.addEventListener("click", () => {
          try{
            let csv = "date;client;type;description;montant;recu;restant\n";
            data.forEach(r => {
              csv += [
                r.date || "",
                r.client || "",
                r.type || "",
                (r.description||"").replace(/\n/g," "),
                r.montant || 0,
                getPaid(r),
                getRemaining(r)
              ].map(v => String(v).replace(/;/g,",")).join(";") + "\n";
            });
            const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "prestations_"+ts()+".csv";
            a.click();
            URL.revokeObjectURL(a.href);
            showStatus("Export CSV téléchargé.");
          }catch(e){
            console.error(e);
            showStatus("Erreur export CSV : " + e.message, false);
          }
        });
      }

      if(importJsonInput){
        importJsonInput.addEventListener("change", async (e) => {
          const file = e.target.files && e.target.files[0];
          if(!file) return;
          try{
            const txt = await file.text();
            const arr = JSON.parse(txt);
            if(!Array.isArray(arr)) throw new Error("Format JSON invalide");
            data = arr.map(r => ({
              id: r.id || Date.now()+Math.random(),
              client: r.client || "",
              type: r.type || "Clip",
              description: r.description || "",
              date: r.date || "",
              montant: Number(r.montant||0),
              paidAmount: Number(r.paidAmount||0)
            }));
            persist();
            render();
            showStatus("Import JSON réussi.");
          }catch(err){
            console.error(err);
            showStatus("Erreur import JSON : " + err.message, false);
          }finally{
            importJsonInput.value = "";
          }
        });
      }

      if(clearAllBtn){
        clearAllBtn.addEventListener("click", () => {
          if(confirm("Effacer TOUTES les prestations ?")){
            data = [];
            persist();
            render();
            showStatus("Tous les enregistrements ont été supprimés.");
          }
        });
      }

      if(debugChk){
        debugChk.addEventListener("change", () => {
          const zone = document.getElementById("debug-zone");
          if(zone) zone.style.display = debugChk.checked ? "block" : "none";
        });
      }

      if (search) {
        search.addEventListener("input", () => {
          render();
        });
      }
      if (filterStatus) {
        filterStatus.addEventListener("change", render);
      }
      if (filterType) {
        filterType.addEventListener("change", render);
      }

      /* ==== Capture pour "Prestations enregistrées" ==== */
if (captureBtn && typeof html2canvas !== "undefined") {
  captureBtn.addEventListener("click", () => {
    captureRecap(filterRecords(data));
  });
}
if (smartCaptureBtn && typeof html2canvas !== "undefined") {
  smartCaptureBtn.addEventListener("click", () => {
    captureRecap(filterRecords(data), { builder: buildSmartCapture, prefix: "recap_prestations_smart_" });
  });
}
if (followupCaptureBtn && typeof html2canvas !== "undefined") {
  followupCaptureBtn.addEventListener("click", () => {
    captureRecap(filterRecords(data), { builder: buildFollowupCapture, prefix: "relances_mobile_", targetId: "followup-capture" });
  });
}
if (followupCopyBtn) {
  followupCopyBtn.addEventListener("click", async () => {
    const items = getFollowupItems(filterRecords(data));
    if(!items.length){
      showStatus("Aucune relance à copier avec les filtres actuels.", false);
      return;
    }
    const message = formatFollowupShareMessage(items);
    try{
      if(navigator?.clipboard?.writeText){
        await navigator.clipboard.writeText(message);
      }else{
        const area = document.createElement("textarea");
        area.value = message;
        document.body.appendChild(area);
        area.select();
        document.execCommand("copy");
        document.body.removeChild(area);
      }
      showStatus("Message de relance copié !");
    }catch(err){
      console.error(err);
      showStatus("Impossible de copier le message.", false);
    }
  });
}

      load();
      render();
      showStatus(
        supportsLocalStorage ? "Sauvegarde locale active." : "Mode secours actif (stockage bloqué).",
        supportsLocalStorage
      );
      log("init ok, version", VERSION);

    })();
  </script>

  <!-- SCRIPT BEATSENGINE -->
  <script>
    (function(){
      const styleSel = document.getElementById("beats-style");
      const noteSel = document.getElementById("beats-note");
      const modeRadios = Array.from(document.querySelectorAll('input[name="beats-mode"]'));
      const bpmInput = document.getElementById("beats-bpm");
      const outputEl = document.getElementById("beats-output");
      const statusEl = document.getElementById("beats-status");
      const copyBtn = document.getElementById("beats-copy");
      const shuffleBtn = document.getElementById("beats-shuffle");
      const shuffleCTABtn = document.getElementById("beats-shuffle-cta");
      const generateBtn = document.getElementById("beats-generate");
      const instrumentInputs = Array.from(document.querySelectorAll(".beats-instrument"));
      const chordsEl = document.getElementById("beats-chords");
      const bpmRangeEl = document.getElementById("beats-bpm-range");
      const energyDescEl = document.getElementById("beats-energy-desc");
      const energyNoteEl = document.getElementById("beats-energy-note");
      const energyChips = Array.from(document.querySelectorAll("#beats-energy .energy-chip"));
      const energyRadios = Array.from(document.querySelectorAll('input[name="beats-energy"]'));
      const structureListEl = document.getElementById("structure-list");
      const progressionOptionsEl = document.getElementById("progression-options");
      const beatsProgressionEl = document.getElementById("beats-progression");
      const beatsProgressionChordsEl = document.getElementById("beats-progression-chords");
      const danceChips = Array.from(document.querySelectorAll("#beats-danceability .dance-chip"));
      const danceRadios = Array.from(document.querySelectorAll('input[name="beats-dance"]'));
      const danceNoteEl = document.getElementById("beats-dance-note");
      const vocalChips = Array.from(document.querySelectorAll("#vocal-modes .vocal-chip"));
      const vocalRadios = Array.from(document.querySelectorAll('input[name="vocal-mode"]'));
      const melodyWarning = document.getElementById("melody-warning");
      const structureNoteEl = document.getElementById("beats-structure-note");
      const usageChips = Array.from(document.querySelectorAll("#beats-usage .usage-chip"));
      const usageRadios = Array.from(document.querySelectorAll('input[name="beats-usage"]'));
      const beatsDurationEl = document.getElementById("beats-duration");
      const beatsUsageNoteEl = document.getElementById("beats-usage-note");
      const beatsLengthEl = document.getElementById("beats-length");
      const beatsKeylineEl = document.getElementById("beats-keyline");
      const trackNameDisplay = document.getElementById("track-name-display");
      const trackGenerateBtn = document.getElementById("track-generate");
      const trackCopyBtn = document.getElementById("track-copy");
      const trackCopyFeedback = document.getElementById("track-copy-feedback");
      const trackStyleMeta = document.getElementById("track-style-meta");
      const trackEnergyMeta = document.getElementById("track-energy-meta");
      const trackDanceMeta = document.getElementById("track-dance-meta");

      if(!styleSel || !noteSel || !bpmInput || !outputEl || !structureListEl) return;

      const chordsMap = {};

      const progressionMap = {
        "Afro-Trap":["i – VI – III – VII","i – v – i – VII","i – III – VI – VII"],
        "Afro-Trap Club":["i – VI – III – VII","i – v – i – VII","i – III – VI – VII"],
        "Afrobeat":["I – V – vi – IV","i – VI – III – VII","i – VII – VI – VII"],
        "Afropop":["I – V – vi – IV","i – VI – III – VII","i – VII – VI – VII"],
        "Bongo Flava":["I – V – vi – IV","i – VI – III – VII","i – VII – VI – VII"],
        "Reggae":["I – IV – V","I – V – IV","vi – IV – I – V"],
        "Zouk":["I – IV – V","I – V – IV","vi – IV – I – V"],
        "Reggaeton":["i – VI – VII","vi – IV – I – V","i – VII – VI"],
        "Moombahton Latin Club":["i – VI – VII","vi – IV – I – V","i – VII – VI"],
        "Dancehall":["i – VII – VI – VII","i – VI – VII","i – III – VI – VII"],
        "Shatta":["i – VII – VI – VII","i – VI – VII","i – III – VI – VII"],
        "Amapiano":["i – v – i – VII","i – VI – III – VII","i – VII – VI – VII"],
        "R&B":["i – VI – III – VII","vi – IV – I – V","i – VII – VI – VII"],
        "Drill":["i – VI – III – VII","i – VII – VI – VII","i – III – VI – VII"]
      };

      const bpmMap = {
        "Afro-Trap":[95,115],
        "Afro-Trap Club":[100,118],
        "R&B":[72,92],
        "Drill":[135,150],
        "Dancehall":[90,105],
        "Afrobeat":[100,120],
        "Afropop":[102,118],
        "Bongo Flava":[95,112],
        "Amapiano":[103,115],
        "Zouk":[85,100],
        "Reggae":[78,92],
        "Reggaeton":[86,98],
        "Moombahton Latin Club":[108,112],
        "Shatta":[96,112]
      };

      const vibeMap = {
        "Afro-Trap":"afro swing bounce, syncopated percussions, trap gloss and modern club sheen.",
        "Afro-Trap Club":"dancefloor afro-trap, neon synths, tight drums and crowd-ready drops.",
        "R&B":"silky R&B textures, lush chords, intimate drums and smooth ambience.",
        "Drill":"cinematic drill tension, sliding 808s, moody pads and syncopated hats.",
        "Dancehall":"island groove with percussive skank rhythms, playful percs, warm low-end and hooks.",
        "Afrobeat":"polyrhythmic afrobeat pulse, brass stabs, guitar licks and steady groove.",
        "Afropop":"sunny afro-pop sheen, catchy toplines, bouncy drums and bright textures.",
        "Bongo Flava":"east-afro fusion, polished percussions, airy keys and melodic hooks.",
        "Amapiano":"log drum rolls, shaker-driven groove, dreamy keys and late-night atmosphere.",
        "Zouk":"smooth zouk sway, silky guitars, romantic pads and mid-tempo bounce.",
        "Reggae":"roots groove, off-beat skank, warm bass and relaxed pocket.",
        "Reggaeton":"latin club swing, perreo drums, crisp claps and sensual bounce.",
        "Moombahton Latin Club":"latin club dembow, mid-tempo heat, syncopated percussion and vocal-friendly bounce.",
        "Shatta":"dancehall-inspired shatta grit, percussive chops and assertive groove."
      };

      const culturalLockMap = {
        "Shatta":"Martinican Shatta instrumental, French Caribbean origin, urban Caribbean style from Martinique",
        "Bongo Flava":"Tanzanian Bongo Flava instrumental, East African origin, Swahili pop and East African afro-pop influence",
        "Zouk":"Zouk instrumental from the French Caribbean, romantic Caribbean groove",
        "Reggae":"Reggae instrumental from Jamaica, roots and modern reggae influence",
        "Reggaeton":"Reggaeton instrumental from Puerto Rico, Latin urban club influence",
        "Moombahton Latin Club":"Latin Moombahton instrumental, Latin American club origin, modern moombahton style inspired by Latin urban club music",
        "Afrobeat":"Afrobeat instrumental rooted in Nigeria/Ghana, West African groove heritage",
        "Afropop":"Afropop instrumental, West African pop lineage (Nigeria/Ghana) with modern polish",
        "Afro-Trap":"French Afro-Trap instrumental, African diasporic roots blended with trap",
        "Afro-Trap Club":"Club-ready French Afro-Trap instrumental, African diasporic roots and club aesthetics",
        "Dancehall":"Dancehall instrumental from Jamaica, Caribbean club DNA, Jamaican island groove",
        "Amapiano":"South African Amapiano instrumental, township roots and log-drum heritage",
        "R&B":"R&B instrumental with US/UK neo-soul influence",
        "Drill":"Drill instrumental with UK/US roots, urban street influence"
      };

      const energyMap = {
        low: {
          label: "low",
          note: "Low → minimal, smooth, spacious",
          texture: "minimal dynamics, airy ambience, plenty of space between elements"
        },
        medium: {
          label: "medium",
          note: "Medium → balanced, groove-focused",
          texture: "balanced groove, clean transients, pocketed swing and tasteful layers"
        },
        high: {
          label: "high",
          note: "High → aggressive, powerful, club-ready",
          texture: "aggressive drums, forward low-end, club-ready punch and bold synth leads"
        }
      };

      const danceabilityMap = {
        chill: {
          label:"chill",
          note:"Chill → laid-back groove",
          texture:"laid-back groove, relaxed syncopation, room for storytelling"
        },
        bounce: {
          label:"bounce",
          note:"Bounce → smooth bounce",
          texture:"smooth bounce, pocketed swing, body-friendly groove"
        },
        club: {
          label:"club",
          note:"Club → club-focused rhythmic drive",
          texture:"strong rhythmic drive, club-focused cadence, infectious movement"
        }
      };

      const vocalModeMap = {
        "vocal-first":{
          label:"vocal-first",
          arrangement:"vocal-first arrangement, no competing lead melody, instrumental supportive, not dominant, clear space for human vocals",
          summary:"vocal-first arrangement, no lead melody, instrumental supportive, not dominant, clear space for human vocals",
          mix:"strong rhythmic groove with clean vocal pocket, instrumental supportive not dominant"
        },
        "balanced":{
          label:"balanced",
          arrangement:"balanced vocal/instrument layout, controlled counter-melodies, supportive pads",
          summary:"balanced vocals and instruments with controlled counter-lines",
          mix:"vocals and instruments share space with controlled dynamics"
        },
        "instrumental-lead":{
          label:"instrumental-lead",
          arrangement:"instrumental hooks upfront, vocals weaving around the lead motif",
          summary:"lead motif forward, vocals weave around the hook if present",
          mix:"lead melody forward, vocals ride the groove without clashing"
        }
      };

      const styles = Array.from(styleSel.options).map(o => o.value);
      const notes = Array.from(noteSel.options).map(o => o.value);
      const modes = modeRadios.map(r => r.value);
      const keys = notes.flatMap(note => modes.map(mode => `${note} ${mode}`));
      const usagePresets = {
        streaming:{ label:"Streaming", note:"streaming-first hook and compact pacing", duration:192 },
        radio:{ label:"Radio", note:"radio-ready energy, vocal clarity first", duration:185 },
        club:{ label:"Club", note:"club audience, extended drops and transitions", duration:210 },
        dj:{ label:"DJ", note:"DJ-friendly intro/outro for beatmatching", duration:230 },
        emotion:{ label:"Emotion", note:"cinematic/emotional arc, slow-burn build", duration:175 }
      };
      const structurePresets = {
        singer:{ label:"Singer", parts:["Intro","Couplet","Pre-Chorus","Refrain","Couplet","Refrain","Outro"], duration:200 },
        rapper:{ label:"Rapper", parts:["Intro","Couplet","Couplet","Refrain","Bridge","Refrain","Outro"], duration:190 },
        club:{ label:"Club", parts:["Intro","Drop","Couplet","Refrain","Drop","Couplet","Drop","Outro"], duration:210 }
      };
      const defaultStructure = structurePresets.singer.parts;
      let selectedStructurePreset = "singer";
      let selectedDurationSeconds = structurePresets[selectedStructurePreset].duration;
      let selectedUsage = "streaming";
      const STRUCTURE_TRANSLATIONS = {
        "couplet":"Verse",
        "refrain":"Chorus",
        "pont":"Bridge",
        "intro":"Intro",
        "outro":"Outro",
        "drop":"Drop",
        "pre-chorus":"Pre-Chorus",
        "prechorus":"Pre-Chorus",
        "verse":"Verse",
        "chorus":"Chorus",
        "bridge":"Bridge"
      };
      let structure = [...defaultStructure];
      let selectedProgression = progressionMap[styleSel.value]?.[0] || "i – VI – III – VII";

      const chromatic = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      const flatToSharp = {"Db":"C#","Eb":"D#","Gb":"F#","Ab":"G#","Bb":"A#"};
      const trackNameBanks = {
        "Dancehall":{ primary:["island","heat","bass","riddim","night","fire","motion"], mood:["skies","after dark","breeze","ember","wave","sundown"] },
        "Bongo Flava":{ primary:["moyo","safari","pulse","coast","rhythm","love","vibe"], mood:["sunrise","tanzanite","coastal night","kin","heartline","amber"] },
        "Afro-Trap":{ primary:["drip","vision","flow","pressure","code","street"], mood:["midnight","bounce","mirror","flare","steez","signal"] },
        "Afro-Trap Club":{ primary:["club","neon","vision","flow","pressure","wave"], mood:["midnight","bounce","spark","after dark","electric","uptown"] },
        "Amapiano":{ primary:["midnight","echo","groove","soul","horizon","dust"], mood:["log drum","shaker line","night drive","embers","loft","afterglow"] },
        "Reggae":{ primary:["roots","breeze","vibration","light","river","shore"], mood:["irie","sunbeam","groundation","coastline","isle","dawn"] },
        "Shatta":{ primary:["raw","force","voltage","block","zone","charge"], mood:["steelo","red zone","uptempo","pressure","wildlight","ignite"] },
        "Afrobeat":{ primary:["pulse","roots","lagos","groove","brass","motion"], mood:["sunrise","storyline","coast road","ember","festival","ray"] },
        "Afropop":{ primary:["spark","chorus","wave","summer","bloom","glow"], mood:["skyline","colorfield","late call","highlight","rose night","vista"] },
        "R&B":{ primary:["velvet","midnight","silk","echo","amber","haze"], mood:["slow burn","afterglow","neon hush","soft rain","reverie","cascade"] },
        "Drill":{ primary:["shadow","grit","echo","nightfall","pressure","lane"], mood:["steel pulse","northern sky","ashen","cold wave","outline","silent run"] },
        "Zouk":{ primary:["lagoon","isle","velours","breeze","palm","caresse"], mood:["lueur","parfum","satin night","azur","slow wine","tropique"] },
        "Reggaeton":{ primary:["calor","ritmo","calle","noche","fuego","marea"], mood:["neon tide","brillo","vertigo","madrugada","sombra","respiro"] },
        "Moombahton Latin Club":{ primary:["dembow","ritual","rumba","fuego","club","glow"], mood:["afterhours","ambar","neon drive","red room","haze","pulse line"] },
        "Default":{ primary:["pulse","signal","echo","horizon","motion","silk"], mood:["after dark","dawnline","glow","bloom","low tide","resonance"] }
      };
      const trackEnergyWords = {
        low:["calm","velvet","haze","breeze","float","mellow"],
        medium:["motion","glow","steady","balance","pulse","sway"],
        high:["ignite","voltage","rush","impact","fever","charge"]
      };
      const trackDanceWords = {
        chill:["drift","sofa","slow step","soft sway","warm up","coast"],
        bounce:["bounce","two-step","bodyline","groove","smooth drive","roll"],
        club:["club","floor","after midnight","prime time","peak hour","dancefloor"]
      };
      const trackPhraseHooks = ["After Dark","In Motion","At Dawn","For Tonight","Beyond Night","Forever Move","Late Glow","Echo Line"];
      let lastTrackName = "";

      function normalizeRoot(note){
        if(!note) return "A";
        return flatToSharp[note] || note;
      }

      function parseKey(keyStr){
        const parts = (keyStr || "A minor").split(" ");
        const root = normalizeRoot(parts[0]);
        const scale = (parts[1] || "minor").toLowerCase().includes("major") ? "major" : "minor";
        return {root, scale};
      }

      function generateScaleChords(keyStr){
        const {root, scale} = parseKey(keyStr);
        const intervals = scale === "major" ? [0,2,4,5,7,9,11] : [0,2,3,5,7,8,10];
        const qualities = scale === "major"
          ? ["maj","min","min","maj","maj","min","dim"]
          : ["min","dim","maj","min","min","maj","maj"];
        const mapping = {};
        const rootIndex = chromatic.indexOf(root);
        if(rootIndex === -1) return mapping;

        ["I","II","III","IV","V","VI","VII"].forEach((deg, idx) => {
          const note = chromatic[(rootIndex + intervals[idx]) % chromatic.length];
          const qual = qualities[idx];
          const chord = qual === "maj" ? note : qual === "min" ? `${note}m` : `${note}°`;
          mapping[deg] = chord;
          mapping[deg.toLowerCase()] = chord;
        });
        return mapping;
      }

      function buildChordLibrary(){
        keys.forEach(k => {
          chordsMap[k] = generateScaleChords(k);
        });
      }

      function romanToDegree(r){
        const base = r.toUpperCase();
        const map = { "I":1,"II":2,"III":3,"IV":4,"V":5,"VI":6,"VII":7 };
        return map[base] || 1;
      }

      function chordFromRoman(roman, keyStr){
        const degree = romanToDegree(roman);
        const dict = chordsMap[keyStr] || {};
        const entry = dict[roman] || dict[roman.toUpperCase()] || dict[roman.toLowerCase()];
        if(entry){
          const root = entry.replace(/m|°/g,"");
          const isMinor = roman === roman.toLowerCase();
          const isDim = roman.includes("°");
          if(isDim) return `${root}°`;
          if(isMinor) return `${root}m`;
          return entry.includes("m") && roman === roman.toUpperCase() ? entry.replace("m","") : entry;
        }
        const {root, scale} = parseKey(keyStr);
        const intervals = scale === "major" ? [0,2,4,5,7,9,11] : [0,2,3,5,7,8,10];
        const rootIndex = chromatic.indexOf(root);
        const note = chromatic[(rootIndex + intervals[degree-1]) % chromatic.length];
        const minor = roman === roman.toLowerCase();
        return minor ? `${note}m` : note;
      }

      function splitProgression(progress){
        return (progress || "").split("–").map(p => p.trim()).filter(Boolean);
      }

      function transposeProgression(progress, keyStr){
        const degrees = splitProgression(progress);
        const chords = degrees.map(r => chordFromRoman(r, keyStr));
        return {
          romanLine: progress,
          chordLine: chords.join(" – ")
        };
      }

      function sanitizeBpm(value, range){
        const [min,max] = range || [80,160];
        const n = parseInt(value, 10);
        if(Number.isFinite(n)){
          return Math.max(min, Math.min(max, n));
        }
        return Math.round((min + max) / 2);
      }

      function describeStyle(style){
        return vibeMap[style] || "clean modern mix, energetic groove and tight arrangement.";
      }

      function translateStructureLabel(part){
        const label = (part || "").trim();
        const lower = label.toLowerCase();
        const matchKey = Object.keys(STRUCTURE_TRANSLATIONS).find(k => lower.startsWith(k));
        if(matchKey){
          const translated = STRUCTURE_TRANSLATIONS[matchKey];
          const suffix = label.slice(matchKey.length);
          return `${translated}${suffix ? suffix : ""}`.trim();
        }
        return label;
      }

      function translateStructureToEnglish(parts){
        return (parts || []).map(translateStructureLabel);
      }

      function currentEnergy(){
        const selected = energyRadios.find(r => r.checked);
        return selected ? selected.value : "medium";
      }

      function updateEnergyUI(){
        const value = currentEnergy();
        energyChips.forEach(chip => {
          const radio = chip.querySelector('input[name="beats-energy"]');
          chip.classList.toggle("active", radio && radio.value === value);
        });
        const meta = energyMap[value] || energyMap.medium;
        if(energyDescEl) energyDescEl.textContent = meta.note;
        if(energyNoteEl) energyNoteEl.textContent = meta.note;
        updateTrackMeta();
      }

      function currentDanceability(){
        const selected = danceRadios.find(r => r.checked);
        return selected ? selected.value : "bounce";
      }

      function updateDanceUI(){
        const value = currentDanceability();
        danceChips.forEach(chip => {
          const radio = chip.querySelector('input[name="beats-dance"]');
          chip.classList.toggle("active", radio && radio.value === value);
        });
        const meta = danceabilityMap[value] || danceabilityMap.bounce;
        if(danceNoteEl) danceNoteEl.textContent = meta.note;
        updateTrackMeta();
      }

      function currentVocalMode(){
        const selected = vocalRadios.find(r => r.checked);
        return selected ? selected.value : "vocal-first";
      }

      function updateVocalUI(){
        const value = currentVocalMode();
        vocalChips.forEach(chip => {
          const radio = chip.querySelector('input[name="vocal-mode"]');
          chip.classList.toggle("active", radio && radio.value === value);
        });
        enforceMelodyLimit();
      }

      function updateTrackMeta(){
        const style = styleSel.value;
        const energy = currentEnergy();
        const dance = currentDanceability();
        if(trackStyleMeta) trackStyleMeta.textContent = style;
        if(trackEnergyMeta) trackEnergyMeta.textContent = energy.charAt(0).toUpperCase() + energy.slice(1);
        if(trackDanceMeta){
          const label = dance === "club" ? "Club" : dance === "bounce" ? "Bounce" : "Chill";
          trackDanceMeta.textContent = label;
        }
      }

      function formatTrackPart(part){
        return (part || "")
          .split(/\s+/)
          .filter(Boolean)
          .map(word => word.charAt(0).toUpperCase() + word.slice(1))
          .join(" ");
      }

      function pickRandom(list){
        const pool = (list || []).filter(Boolean);
        if(!pool.length) return "";
        return pool[Math.floor(Math.random() * pool.length)];
      }

      function pickDistinct(list, avoid){
        const pool = (list || []).filter(Boolean);
        const filtered = pool.filter(item => !avoid.includes(item));
        if(filtered.length) return pickRandom(filtered);
        return pickRandom(pool);
      }

      function resolveTrackBank(style){
        return trackNameBanks[style] || trackNameBanks.Default;
      }

      function composeTrackName(){
        const style = styleSel.value;
        const energy = currentEnergy();
        const dance = currentDanceability();
        const bank = resolveTrackBank(style);
        const energyWords = trackEnergyWords[energy] || trackEnergyWords.medium;
        const danceWords = trackDanceWords[dance] || trackDanceWords.bounce;
        const primaries = (bank.primary || []).filter(Boolean);
        const moods = (bank.mood || []).filter(Boolean);
        const basePool = [...primaries, ...moods];
        const wordA = pickRandom(basePool) || pickRandom(trackNameBanks.Default.primary);
        const templates = ["single","double","phrase","abstract"];
        const template = pickRandom(templates) || "double";

        const energyWord = pickRandom(energyWords);
        const danceWord = pickRandom(danceWords);
        const hook = pickRandom(trackPhraseHooks);

        if(template === "single"){
          return formatTrackPart(wordA || energyWord || "Pulse");
        }

        if(template === "double"){
          const second = pickDistinct([...moods, ...energyWords, ...danceWords], [wordA]);
          return `${formatTrackPart(wordA)} ${formatTrackPart(second || "Motion")}`.trim();
        }

        if(template === "phrase"){
          const second = pickDistinct([...trackPhraseHooks, ...moods, energyWord, danceWord].flat().filter(Boolean), [wordA]);
          return `${formatTrackPart(wordA)} ${formatTrackPart(second || "After Dark")}`.trim();
        }

        const abstractA = pickDistinct([...moods, wordA, energyWord].flat().filter(Boolean), []);
        const abstractB = pickDistinct([...danceWords, ...energyWords, hook ? [hook] : []].flat().filter(Boolean), [abstractA]);
        const joiner = pickRandom(["in","of","beyond","into"]) || "in";
        return `${formatTrackPart(abstractA || "Echo")} ${joiner} ${formatTrackPart(abstractB || "Motion")}`.trim();
      }

      function refreshTrackName(){
        updateTrackMeta();
        if(!trackNameDisplay) return;
        const next = composeTrackName();
        lastTrackName = next;
        trackNameDisplay.textContent = next;
        if(trackCopyFeedback){
          trackCopyFeedback.classList.remove("visible");
        }
      }

      function copyTrackName(){
        if(!lastTrackName){
          if(trackCopyFeedback){
            trackCopyFeedback.textContent = "Rien à copier";
            trackCopyFeedback.classList.add("visible");
          }
          return;
        }
        const text = lastTrackName;
        const onSuccess = () => {
          if(trackCopyFeedback){
            trackCopyFeedback.textContent = "Copié ✔";
            trackCopyFeedback.classList.add("visible");
            setTimeout(() => trackCopyFeedback.classList.remove("visible"), 1200);
          }
        };
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(text).then(onSuccess).catch(() => {
            fallbackCopy(text);
            onSuccess();
          });
        }else{
          fallbackCopy(text);
          onSuccess();
        }
      }

      const INSTRUMENT_CATEGORY_DETAILS = {
        drums:{ include:"drums: kick, snare/clap, hi-hats, tasteful percussions", role:"core" },
        bass:{ include:"808/bass with controlled sidechain", role:"bass" },
        melody:{ include:"simple synth/pad hook", role:"melody" },
        guitar:{ include:"clean guitar licks", role:"melody" },
        piano:{ include:"piano/keys chords", role:"melody" },
        pads:{ include:"warm pads / atmospheres", role:"melody" },
        plucks:{ include:"plucks or synth stabs", role:"melody" },
        strings:{ include:"light strings section", role:"melody" },
        brass:{ include:"brass / horn stabs", role:"melody" },
        voxfx:{ include:"vocal chops / textures", role:"melody" },
        fx:{ include:"fx texture beds, risers (subtle)", role:"texture" }
      };
      const STRICT_EXCLUSION = "strict exclusion: no guitar, no guitar textures, no guitar-like timbres";

      const MOOMBAHTON_STYLE = "Moombahton Latin Club";
      const MOOMBAHTON_STRUCTURE = ["Intro","Drop","Couplet","Drop","Couplet","Drop","Outro"];
      const MOOMBAHTON_INCLUDED = "whitelist: drums, bass, latin percussions, short synth stabs";
      const MOOMBAHTON_STRICT = "exclusions: no guitar, no piano, no big EDM risers";
      const MOOMBAHTON_GROOVE = "groove: dembow-based moombahton rhythm; heavy kick on 1 and 3; syncopated percussion; club bounce.";

      function currentMode(){
        const selected = modeRadios.find(r => r.checked);
        return selected ? selected.value : "minor";
      }

      function currentKey(){
        const note = noteSel.value || "A";
        return `${note} ${currentMode()}`;
      }

      function normalizeInstrumentName(name){
        return (name || "").toLowerCase().trim();
      }

      function isMoombahtonLatinClub(style){
        return (style || "").trim() === MOOMBAHTON_STYLE;
      }

      function getInstrumentSelection(){
        const included = [];
        const excluded = [];
        let melodicCount = 0;

        instrumentInputs.forEach(input => {
          const id = input.value;
          const meta = INSTRUMENT_CATEGORY_DETAILS[id];
          if(!meta) return;
          if(input.checked){
            included.push(meta.include);
            if(meta.role === "melody") melodicCount++;
          } else {
            excluded.push(meta.include);
          }
        });

        if(!included.length){
          included.push("minimal drums only");
        }

        return {included, excluded, melodicCount};
      }

      function buildInstrumentLines(){
        const {included, excluded, melodicCount} = getInstrumentSelection();
        const includedLine = `whitelist: ${included.join(", ")}`;
        const excludedList = excluded.join(", ");
        const excludedLine = excludedList
          ? `exclusions: ${excludedList}`
          : "exclusions: ban anything outside the whitelist";
        const barrierLine = "do not add any instrument not listed above";
        const compactExclusion = STRICT_EXCLUSION;
        const strictBlock = (melodicCount > 1 && currentVocalMode() === "vocal-first")
          ? "keep only one melodic hook to protect vocal space"
          : "";
        return {includedLine, excludedLine, compactExclusion, strictBlock, barrierLine};
      }

      function buildPromptText(sections, limit = 900){
        let active = sections.filter(section => section && section.text && section.text.trim());
        let prompt = active.map(s => s.text).join("\n");

        const optionalIndexes = active
          .map((section, idx) => section.optional ? idx : null)
          .filter(idx => idx !== null);

        while(prompt.length > limit && optionalIndexes.length){
          const idxToRemove = optionalIndexes.pop();
          active.splice(idxToRemove, 1);
          for(let i = 0; i < optionalIndexes.length; i++){
            if(optionalIndexes[i] > idxToRemove){
              optionalIndexes[i] -= 1;
            }
          }
          prompt = active.map(s => s.text).join("\n");
        }

        if(prompt.length > limit){
          active = active.map(section => {
            if(typeof section.compact === "function"){
              return {...section, text: section.compact(section.text)};
            }
            return section;
          });
          prompt = active.map(s => s.text).join("\n");
        }

        if(prompt.length > limit){
          prompt = `${prompt.slice(0, limit - 3)}...`;
        }

        return {prompt, length: prompt.length};
      }

      function enforceMelodyLimit(){
        const isVocalFirst = currentVocalMode() === "vocal-first";
        const {melodicCount} = getInstrumentSelection();
        const overLimit = isVocalFirst && melodicCount > 1;
        instrumentInputs.forEach(input => {
          const wrapper = input.closest(".instrument-checkbox");
          if(wrapper){
            const isMelodic = (input.dataset.role || "") === "melody";
            wrapper.classList.toggle("over-limit", overLimit && isMelodic && input.checked);
          }
        });
        if(melodyWarning){
          melodyWarning.classList.toggle("visible", overLimit);
        }
      }

      function ensureStructure(){
        const preset = structurePresets[selectedStructurePreset];
        if(!preset){
          selectedStructurePreset = "singer";
        }
        const currentPreset = structurePresets[selectedStructurePreset] || structurePresets.singer;
        structure = Array.isArray(currentPreset.parts) ? [...currentPreset.parts] : [...defaultStructure];
        selectedDurationSeconds = currentPreset.duration || 180;
      }

      function currentDurationSeconds(){
        const usageDur = usagePresets[selectedUsage]?.duration;
        const presetDur = structurePresets[selectedStructurePreset]?.duration;
        return usageDur || presetDur || selectedDurationSeconds || 180;
      }

      function formatMinutesValue(seconds){
        if(!Number.isFinite(seconds) || seconds <= 0) return "3.0";
        return (seconds / 60).toFixed(1);
      }

      function renderStructure(){
        ensureStructure();
        structureListEl.innerHTML = "";
        structure.forEach(part => {
          const li = document.createElement("li");
          li.className = "structure-item";
          const label = document.createElement("span");
          label.className = "structure-label";
          label.textContent = part;
          li.appendChild(label);
          structureListEl.appendChild(li);
        });
        const preset = structurePresets[selectedStructurePreset];
        if(structureNoteEl && preset){
          const minutes = formatMinutesValue(currentDurationSeconds());
          const usageLabel = usagePresets[selectedUsage]?.label || "Streaming";
          structureNoteEl.textContent = `${preset.label} preset — ${minutes} min target (${usageLabel}), FR labels auto → EN in prompt.`;
        }
      }

      function selectStructurePreset(name){
        if(!structurePresets[name]) return;
        selectedStructurePreset = name;
        ensureStructure();
        renderStructure();
        generatePrompt();
      }

      function updateMeta(){
        const style = styleSel.value;
        const key = currentKey();
        const transposed = transposeProgression(selectedProgression, key);
        const range = bpmMap[style] || [90,120];
        if(chordsEl) chordsEl.textContent = transposed.chordLine;
        if(bpmRangeEl) bpmRangeEl.textContent = `${range[0]}-${range[1]} BPM`;
        if(beatsKeylineEl){
          beatsKeylineEl.textContent = `Key ${key} • ${bpmInput.value || range[0]} BPM • ${usagePresets[selectedUsage]?.label || "Streaming"} • ${structurePresets[selectedStructurePreset]?.label || "Singer"}`;
        }
        updateEnergyUI();
        updateDanceUI();
        updateVocalUI();
        updateUsageUI();
        updateTrackMeta();
      }

      function pickProgression(){
        const options = progressionMap[styleSel.value] || ["i – VI – III – VII"];
        if(!selectedProgression || !options.includes(selectedProgression)){
          selectedProgression = options[0];
        }
        return selectedProgression;
      }

      function renderProgressions(){
        const list = progressionMap[styleSel.value] || [];
        progressionOptionsEl.innerHTML = "";
        list.forEach(prog => {
          const label = document.createElement("label");
          label.className = "progression-chip" + (prog === selectedProgression ? " active" : "");
          label.innerHTML = `<div><strong>${prog}</strong><small>Progression gagnante ${styleSel.value}</small></div>`;
          label.addEventListener("click", () => {
            selectedProgression = prog;
            renderProgressions();
            generatePrompt();
          });
          progressionOptionsEl.appendChild(label);
        });
        if(!selectedProgression && list.length){
          selectedProgression = list[0];
        }
        const transposed = transposeProgression(selectedProgression, currentKey());
        beatsProgressionEl.textContent = transposed.romanLine;
        beatsProgressionChordsEl.textContent = transposed.chordLine;
      }

      function updateUsageUI(){
        const current = currentUsage();
        usageChips.forEach(chip => {
          const radio = chip.querySelector('input[name="beats-usage"]');
          chip.classList.toggle("active", radio && radio.value === current);
        });
        const preset = usagePresets[current] || usagePresets.streaming;
        if(beatsDurationEl) beatsDurationEl.textContent = `${formatMinutesValue(currentDurationSeconds())} min`;
        if(beatsUsageNoteEl) beatsUsageNoteEl.textContent = `${preset.label} ready — ${preset.note}`;
      }

      function syncBpmWithStyle(){
        const range = bpmMap[styleSel.value] || [90,120];
        const mid = Math.round((range[0]+range[1])/2);
        bpmInput.min = range[0];
        bpmInput.max = range[1];
        bpmInput.value = sanitizeBpm(bpmInput.value, range) || mid;
        if(!bpmInput.value) bpmInput.value = mid;
      }

      function buildCulturalLock(style){
        return culturalLockMap[style] || `${style} instrumental, authentic to its cultural roots`;
      }

      function currentUsage(){
        const selected = usageRadios.find(r => r.checked);
        return selected ? selected.value : selectedUsage;
      }

      function generatePrompt(source="manual"){
        ensureStructure();
        selectedUsage = currentUsage();
        const style = styleSel.value || "Afro-Trap";
        const key = currentKey();
        const range = bpmMap[style] || [90,120];
        const bpm = sanitizeBpm(bpmInput.value, range);
        bpmInput.value = bpm;
        const progression = pickProgression();
        const transposed = transposeProgression(progression, key);
        beatsProgressionEl.textContent = transposed.romanLine;
        beatsProgressionChordsEl.textContent = transposed.chordLine;
        if(chordsEl) chordsEl.textContent = transposed.chordLine;
        let {includedLine, excludedLine, compactExclusion, strictBlock, barrierLine} = buildInstrumentLines();
        const energy = energyMap[currentEnergy()] || energyMap.medium;
        const dance = danceabilityMap[currentDanceability()] || danceabilityMap.bounce;
        const vocal = vocalModeMap[currentVocalMode()] || vocalModeMap["vocal-first"];
        const preset = structurePresets[selectedStructurePreset] || structurePresets.singer;
        let structureParts = (structure && structure.length) ? structure : preset.parts;
        let structureLine = `structure (EN): ${translateStructureToEnglish(structureParts).join(" → ")}`;
        const usage = usagePresets[selectedUsage] || usagePresets.streaming;
        let durationMinutes = formatMinutesValue(currentDurationSeconds());
        const culturalLock = buildCulturalLock(style);
        const styleLine = style === "Dancehall"
          ? `Dancehall instrumental from Jamaica, Caribbean club DNA, Jamaican island groove — ${describeStyle(style)}`
          : `${style} instrumental — ${describeStyle(style)}`;
        const culturalLine = `origin & cultural lock: ${culturalLock}`;
        let bpmLine = `${bpm} BPM locked in ${key}; winning chords ${transposed.romanLine} (${transposed.chordLine}).`;
        let durationLine = `full-length instrumental track, approx ${durationMinutes} minutes (${usage.label.toLowerCase()} ready), continuous arrangement, not a loop.`;
        const vocalLine = `vocal focus: ${vocal.summary || vocal.arrangement}`;
        let grooveDetails = `${vocal.mix}`;

        if(isMoombahtonLatinClub(style)){
          includedLine = MOOMBAHTON_INCLUDED;
          excludedLine = "";
          strictBlock = MOOMBAHTON_STRICT;
          barrierLine = "do not add any instrument not listed above";
          bpmLine = `${bpm} BPM locked (108-112 range) with key ${key}; winning chords ${transposed.romanLine} (${transposed.chordLine}).`;
          durationLine = `full-length instrumental track, approx 3.0 minutes (club ready), continuous arrangement, not a loop.`;
          grooveDetails = MOOMBAHTON_GROOVE;
          structureParts = [...MOOMBAHTON_STRUCTURE];
          structureLine = `structure (EN): ${translateStructureToEnglish(structureParts).join(" → ")}`;
        }

        const energyDanceLineBase = `energy ${energy.label} — ${energy.texture}; danceability ${dance.label} — ${dance.texture}`;
        const grooveText = grooveDetails ? `; groove: ${grooveDetails}` : "";
        const energyDanceLine = `${energyDanceLineBase}${grooveText}.`;

        const exclusionLine = [compactExclusion, excludedLine, strictBlock, barrierLine].filter(Boolean).join("; ");

        const sections = [
          {text: styleLine},
          {text: culturalLine},
          {text: bpmLine},
          {text: durationLine},
          {text: vocalLine},
          {text: includedLine},
          {text: exclusionLine},
          {text: structureLine},
          {text: energyDanceLine}
        ];

        const {prompt, length} = buildPromptText(sections);
        outputEl.value = prompt;
        if(beatsLengthEl){
          beatsLengthEl.textContent = `${length} / 900`;
        }
        if(statusEl){
          const baseStatus = source === "shuffle"
            ? "Shuffle premium généré automatiquement"
            : "Prompt généré et prêt à être copié";
          statusEl.textContent = `${baseStatus} (${length}/900 caractères).`;
        }
        updateMeta();
        enforceMelodyLimit();
      }

      function randomizeInstruments(){
        let checkedCount = 0;
        instrumentInputs.forEach(input => {
          const mustKeep = ["drums","bass"].includes(input.value);
          const decision = mustKeep ? true : Math.random() > 0.5;
          input.checked = decision;
          if(decision) checkedCount++;
        });
        if(checkedCount === 0 && instrumentInputs[0]){
          instrumentInputs[0].checked = true;
        }
        enforceMelodyLimit();
      }

      function shuffleStructure(){
        const presetKeys = Object.keys(structurePresets);
        const pick = presetKeys[Math.floor(Math.random()*presetKeys.length)] || "singer";
        selectStructurePreset(pick);
      }

      function shufflePrompt(){
        const style = styles[Math.floor(Math.random()*styles.length)] || "Afro-Trap";
        const key = keys[Math.floor(Math.random()*keys.length)] || "A minor";
        const [note, mode] = key.split(" ");
        styleSel.value = style;
        if(noteSel) noteSel.value = note;
        modeRadios.forEach(r => { r.checked = r.value === (mode || "minor"); });

        syncBpmWithStyle();
        const range = bpmMap[style] || [90,120];
        const bpm = Math.floor(Math.random() * (range[1] - range[0] + 1)) + range[0];
        bpmInput.value = bpm;

        const energyKeys = Object.keys(energyMap);
        const pickedEnergy = energyKeys[Math.floor(Math.random()*energyKeys.length)] || "medium";
        energyRadios.forEach(r => { r.checked = r.value === pickedEnergy; });
        updateEnergyUI();

        const danceKeys = Object.keys(danceabilityMap);
        const pickedDance = danceKeys[Math.floor(Math.random()*danceKeys.length)] || "bounce";
        danceRadios.forEach(r => { r.checked = r.value === pickedDance; });
        updateDanceUI();

        const vocalKeys = Object.keys(vocalModeMap);
        const pickedVocal = vocalKeys[Math.floor(Math.random()*vocalKeys.length)] || "vocal-first";
        vocalRadios.forEach(r => { r.checked = r.value === pickedVocal; });
        updateVocalUI();

        const progs = progressionMap[style] || [];
        selectedProgression = progs[Math.floor(Math.random()*progs.length)] || selectedProgression;

        const usageKeys = Object.keys(usagePresets);
        selectedUsage = usageKeys[Math.floor(Math.random()*usageKeys.length)] || selectedUsage;
        usageRadios.forEach(r => { r.checked = r.value === selectedUsage; });
        updateUsageUI();
        renderStructure();

        randomizeInstruments();
        shuffleStructure();
        renderProgressions();
        generatePrompt("shuffle");
      }

      function copyPrompt(){
        const txt = outputEl.value || "";
        if(!txt.trim()){
          statusEl && (statusEl.textContent = "Rien à copier : génère un prompt d'abord.");
          return;
        }
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(txt).then(() => {
            statusEl && (statusEl.textContent = "Prompt copié dans le presse-papiers.");
          }).catch(() => {
            fallbackCopy(txt);
          });
        } else {
          fallbackCopy(txt);
        }
      }

      function fallbackCopy(text){
        const area = document.createElement("textarea");
        area.value = text;
        area.style.position = "fixed";
        area.style.opacity = "0";
        document.body.appendChild(area);
        area.select();
        try { document.execCommand("copy"); } catch(e){}
        document.body.removeChild(area);
        statusEl && (statusEl.textContent = "Prompt copié (mode rétro).");
      }

      styleSel.addEventListener("change", () => {
        selectedProgression = (progressionMap[styleSel.value] || [])[0] || selectedProgression;
        syncBpmWithStyle();
        renderProgressions();
        updateMeta();
        refreshTrackName();
        generatePrompt();
      });
      noteSel.addEventListener("change", () => {
        renderProgressions();
        updateMeta();
        generatePrompt();
      });
      modeRadios.forEach(radio => {
        radio.addEventListener("change", () => {
          renderProgressions();
          updateMeta();
          generatePrompt();
        });
      });
      bpmInput.addEventListener("input", () => generatePrompt());
      energyChips.forEach(chip => {
        const radio = chip.querySelector('input[name="beats-energy"]');
        chip.addEventListener("click", () => {
          if(radio){
            radio.checked = true;
            updateEnergyUI();
            refreshTrackName();
            generatePrompt();
          }
        });
      });
      danceChips.forEach(chip => {
        const radio = chip.querySelector('input[name="beats-dance"]');
        chip.addEventListener("click", () => {
          if(radio){
            radio.checked = true;
            updateDanceUI();
            refreshTrackName();
            generatePrompt();
          }
        });
      });
      vocalChips.forEach(chip => {
        const radio = chip.querySelector('input[name="vocal-mode"]');
        chip.addEventListener("click", () => {
          if(radio){
            radio.checked = true;
            updateVocalUI();
            generatePrompt();
          }
        });
      });
      usageChips.forEach(chip => {
        const radio = chip.querySelector('input[name="beats-usage"]');
        chip.addEventListener("click", () => {
          if(radio){
            radio.checked = true;
            selectedUsage = radio.value || "streaming";
            updateUsageUI();
            renderStructure();
            generatePrompt();
          }
        });
      });
      if(trackGenerateBtn){
        trackGenerateBtn.addEventListener("click", () => {
          refreshTrackName();
        });
      }
      if(trackCopyBtn){
        trackCopyBtn.addEventListener("click", () => {
          copyTrackName();
        });
      }
      instrumentInputs.forEach(input => {
        input.addEventListener("change", () => {
          enforceMelodyLimit();
          generatePrompt();
        });
      });
      document.querySelectorAll("[data-structure-preset]").forEach(btn => {
        btn.addEventListener("click", () => {
          const name = btn.getAttribute("data-structure-preset");
          selectStructurePreset(name);
        });
      });
      copyBtn && copyBtn.addEventListener("click", copyPrompt);
      generateBtn && generateBtn.addEventListener("click", () => generatePrompt());
      shuffleBtn && shuffleBtn.addEventListener("click", shufflePrompt);
      shuffleCTABtn && shuffleCTABtn.addEventListener("click", shufflePrompt);

      buildChordLibrary();
      syncBpmWithStyle();
      renderProgressions();
      renderStructure();
      updateMeta();
      refreshTrackName();
      generatePrompt("init");
    })();
  </script>

  <!-- SCRIPT THEME NUIT/JOUR -->
  <script>
    (function(){
      const THEME_KEY = "szd_theme";
      const root = document.documentElement;
      const themeIcon = document.querySelector(".theme-icon");

      function applyTheme(theme){
        if(theme === "light"){
          root.setAttribute("data-theme","light");
        }else{
          root.removeAttribute("data-theme"); // dark par défaut
        }

        if (themeIcon) {
          themeIcon.textContent = theme === "light" ? "☀️" : "🌙";
        }

        if (typeof updateThemeLogos === "function") {
          updateThemeLogos(theme);
        }

        if(window.szdEmbed && typeof window.szdEmbed.syncTheme === "function"){
          window.szdEmbed.syncTheme(theme);
        }
      }

      document.addEventListener("DOMContentLoaded", function(){
        var toggle = document.getElementById("themeToggle");
        if(!toggle) return;

        var saved = null;
        try {
          saved = localStorage.getItem(THEME_KEY);
        } catch(e) {}

        var initialTheme = saved === "light" ? "light" : "dark";
        applyTheme(initialTheme);
        toggle.checked = initialTheme !== "light";

        function persistTheme(theme){
          applyTheme(theme);
          toggle.checked = theme !== "light";
          try { localStorage.setItem(THEME_KEY, theme); } catch(e) {}
        }

        toggle.addEventListener("change", function(){
          var theme = toggle.checked ? "dark" : "light";
          persistTheme(theme);
        });

        if(themeIcon){
          themeIcon.setAttribute("role","button");
          themeIcon.setAttribute("tabindex","0");
          themeIcon.setAttribute("aria-label","Basculer le thème");
          themeIcon.setAttribute("title","Basculer le thème");
          themeIcon.addEventListener("click", function(){
            var nextTheme = toggle.checked ? "light" : "dark";
            persistTheme(nextTheme);
          });
          themeIcon.addEventListener("keydown", function(event){
            if(event.key === "Enter" || event.key === " "){
              event.preventDefault();
              var nextTheme = toggle.checked ? "light" : "dark";
              persistTheme(nextTheme);
            }
          });
        }
      });
    })();
  </script>

</body>
</html>
