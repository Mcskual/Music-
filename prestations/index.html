<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Prestations ‚Äî Clips & Musique (v1.4)</title>
  <style>
    :root {
      --bg:#0b0e14;
      --card:#111827;
      --panel:#0f172a;
      --muted:#9ca3af;
      --accent:#3b82f6;
      --accent2:#22d3ee;
      --border:#1f2937;
      --text:#e5e7eb;
      --text2:#9ca3af;
      --shadow:0 8px 28px rgba(0,0,0,.32);
      --nav-bg:#0f172a;
      --nav-sheen:linear-gradient(90deg,rgba(255,255,255,.05),transparent 50%);
      --bg-gradient:var(--bg);
    }

    /* Th√®me clair premium */
    [data-theme="light"] {
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#0f172a;
      --text2:#4b5563;
      --border:#e5e7eb;
      --muted:#6b7280;
      --shadow:0 16px 40px rgba(15,23,42,.12);
      --nav-bg:linear-gradient(125deg,rgba(59,130,246,.12),rgba(34,197,94,.08)),linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.9));
      --nav-sheen:linear-gradient(90deg,rgba(15,23,42,.06),transparent 45%,rgba(15,23,42,.08));
      --bg-gradient:
        radial-gradient(circle at 0% 0%, rgba(59,130,246,.12), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(120deg,#f9fafb,#f3f4f6 40%,#e5e7eb 60%,#f9fafb);
    }

    *, *::before, *::after { box-sizing:border-box; }
    * { scroll-behavior:auto; }

    body {
      font-family: "Inter", system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: var(--bg);
      color:var(--text);
      margin:0;
    }

    .container { max-width:1200px; margin:36px auto 0 auto; padding:0 16px; }
    .tab-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px 16px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .tab-header h2{ margin:0; font-size:clamp(22px,2.8vw,26px); }
    .tab-subtitle{
      color:var(--text2);
      margin:6px 0 0;
      font-size:14px;
      max-width:820px;
      line-height:1.5;
    }
    .tab-actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      align-self:center;
    }

    .top-nav{
      position:relative;
      display:flex;
      align-items:center;
      flex-wrap:nowrap;
      gap:12px;
      padding:10px 14px;
      min-height:70px;
      background:var(--nav-bg);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
      margin-bottom:16px;
      overflow:hidden;
      isolation:isolate;
    }
    .top-nav::after{
      content:"";
      position:absolute;
      inset:0;
      background:var(--nav-sheen);
      pointer-events:none;
      z-index:0;
    }
    .nav-left,
    .nav-center,
    .nav-actions{
      display:flex;
      align-items:center;
      min-width:0;
      z-index:1;
      height:100%;
      flex-shrink:0;
    }
    .nav-left{ flex:0 0 auto; }
    .nav-center{
      flex:1 1 auto;
      gap:8px;
      justify-content:flex-start;
      position:relative;
      min-width:0;
      overflow:hidden;
    }
    .nav-actions{
      flex:0 0 auto;
      justify-content:flex-end;
      gap:8px;
      padding-left:4px;
    }
    .nav-links{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-start;
      flex:1 1 auto;
      min-width:0;
      padding:6px 10px;
      background:#0d121d;
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:none;
      position:relative;
      z-index:1;
      flex-wrap:nowrap;
      overflow-x:auto;
      overflow-y:hidden;
      white-space:nowrap;
      scrollbar-width:thin;
      scrollbar-color:rgba(59,130,246,.35) transparent;
      -webkit-overflow-scrolling:touch;
    }
    [data-theme="light"] .nav-links{ background:rgba(15,23,42,.02); }
    .nav-link{
      position:relative;
      color:var(--text2);
      text-decoration:none;
      min-width:108px;
      height:40px;
      display:inline-flex;
      justify-content:center;
      align-items:center;
      line-height:1;
      padding:0 12px;
      box-sizing:border-box;
      border-radius:12px;
      border:1px solid transparent;
      background:#0f172a;
      font-size:13px;
      font-weight:700;
      letter-spacing:.01em;
      transition:.18s background,.18s border-color,.18s color;
      white-space:nowrap;
      flex:0 0 auto;
    }
    [data-theme="light"] .nav-link{ background:#f8fafc; }
    .nav-link:hover{
      border-color:var(--accent);
      color:#e2e8f0;
      background:#111827;
    }
    [data-theme="light"] .nav-link:hover{ color:var(--accent); }
    .nav-link::after{
      content:"";
      position:absolute;
      left:12px;
      right:12px;
      bottom:6px;
      height:3px;
      border-radius:999px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      opacity:0;
      transform:translateY(6px);
      transition:.2s ease;
    }
    .nav-link:hover::after{ opacity:1; transform:translateY(0); }
    .nav-link.active{
      background:#111827;
      color:#f8fafc;
      border-color:rgba(59,130,246,.45);
      box-shadow:none;
    }
    [data-theme="light"] .nav-link.active{
      background:linear-gradient(135deg,rgba(59,130,246,.14),rgba(16,185,129,.16));
      color:var(--accent);
      box-shadow:0 8px 18px rgba(59,130,246,.22);
    }
    .nav-link.active::after{ opacity:1; transform:translateY(0); background:linear-gradient(135deg,rgba(255,255,255,.8),rgba(255,255,255,.4)); }
    .theme-toggle{
      display:flex;
      align-items:center;
      gap:8px;
      height:100%;
    }
    @media(max-width:820px){
      .top-nav{ gap:10px; }
      .nav-link{ min-width:100px; padding:0 10px; font-size:12px; }
      .nav-links{ gap:8px; padding:6px 8px; }
      .theme-toggle{ padding:6px 8px; }
    }
    @media(max-width:640px){
      .nav-link{ min-width:96px; padding:0 8px; }
      .top-nav{ padding:8px 10px; }
    }

    header.app {
      display:flex;
      gap:16px;
      align-items:center;
      margin-bottom:8px;
      flex-wrap:wrap;
    }

    .logo-wrap{
      background:var(--card);
      border-radius:18px;
      padding:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      text-decoration:none;
      color:inherit;
    }
    .logo-wrap img{
      width:220px;
      height:auto;
      display:block;
      border-radius:14px;
      transition:transform .2s ease, opacity .2s ease;
    }
    .logo-compact{
      padding:6px 10px;
      border-radius:14px;
    }
    .logo-compact img{ width:160px; }

    h1 {
      font-size:clamp(26px,4vw,40px);
      margin:0;
      padding:0;
      line-height:1.15;
    }
    h2 { margin:0 0 10px; font-size:clamp(18px,2.4vw,22px); }
    .sub{ color:var(--text2); margin-bottom:16px; font-size:14px;}

    header.app, header.hero { margin-bottom:16px; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:16px;
      margin-top:16px !important;
    }

    .page-content{
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .whatsapp-card{
      position:relative;
      overflow:hidden;
      border:1px solid rgba(34,197,94,.35);
      background:linear-gradient(135deg,rgba(16,185,129,.12),rgba(16,185,129,.04)),var(--card);
    }
    .whatsapp-card::after{
      content:"";
      position:absolute;
      inset:-40% auto auto 40%;
      width:360px;
      height:360px;
      background:radial-gradient(circle at center, rgba(16,185,129,.18), transparent 55%);
      opacity:.8;
      pointer-events:none;
      filter:blur(8px);
    }
    .whatsapp-card h2{ display:flex; align-items:center; gap:8px; margin-bottom:6px; }
    .wa-icon{ width:22px; height:22px; display:inline-flex; align-items:center; justify-content:center; }
    .wa-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(34,197,94,.18);
      color:#bbf7d0;
      border:1px solid rgba(34,197,94,.45);
      font-size:12px;
      font-weight:700;
      letter-spacing:.01em;
    }
    [data-theme="light"] .wa-chip{ color:#0f5132; background:rgba(16,185,129,.16); }
    .wa-legend{ gap:8px; }

    .followup-grid{ position:relative; z-index:1; }
    .followup-card{
      position:relative;
      border:1px solid rgba(34,197,94,.32);
      background:linear-gradient(120deg,rgba(16,185,129,.09),rgba(16,185,129,.02));
      box-shadow:0 12px 30px rgba(16,185,129,.12);
      isolation:isolate;
    }
    .followup-card::before{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(135deg,rgba(16,185,129,.18),transparent 55%);
      opacity:.4;
      pointer-events:none;
      border-radius:inherit;
      z-index:0;
    }
    .followup-card > *{ position:relative; z-index:1; }
    .followup-head{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .followup-meta{ display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:8px; margin-top:10px; }
    .followup-stat{
      display:flex;
      flex-direction:column;
      gap:4px;
      padding:8px 10px;
      border-radius:10px;
      background:rgba(15,23,42,.4);
      border:1px solid rgba(34,197,94,.25);
    }
    [data-theme="light"] .followup-stat{ background:rgba(240,253,244,.9); }
    .followup-stat .label{ font-size:12px; color:var(--muted); display:inline-flex; gap:6px; align-items:center; }
    .followup-stat .value{ font-weight:700; font-size:14px; }
    .followup-pill{ box-shadow:0 4px 16px rgba(16,185,129,.16); }
    .followup-actions{ display:flex; flex-direction:column; gap:6px; margin-top:12px; }
    .followup-btn-row{ display:flex; flex-wrap:wrap; gap:8px; }
    .relance-btn{ color:#fff; border-color:transparent; }
    .relance-soft{ background:linear-gradient(135deg,#22c55e,#15803d); box-shadow:0 10px 20px rgba(16,185,129,.28); }
    .relance-soft:hover{ background:linear-gradient(135deg,#34d399,#16a34a); }
    .relance-firm{ background:linear-gradient(135deg,#f59e0b,#d97706); box-shadow:0 10px 20px rgba(245,158,11,.28); }
    .relance-firm:hover{ background:linear-gradient(135deg,#fbbf24,#f59e0b); }
    .relance-critical{ background:linear-gradient(135deg,#ef4444,#b91c1c); box-shadow:0 12px 22px rgba(239,68,68,.3); }
    .relance-critical:hover{ background:linear-gradient(135deg,#f87171,#ef4444); }

    @media(max-width:640px){
      .followup-head{ flex-direction:column; }
      .followup-pill{ align-self:flex-start; }
    }

    .grid{ display:grid; gap:16px; }
    .grid-2{ grid-template-columns:1.15fr .85fr; }
    @media(max-width:960px){
      .grid-2{ grid-template-columns:1fr; }
      header.app{ justify-content:flex-start; }
    }

    label{
      display:block;
      font-size:13px;
      margin-bottom:6px;
      color:var(--text2);
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    input[type="time"],
    select,
    textarea{
      width:100%;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      font-size:14px;
      outline:none;
      transition:.16s border-color,.16s box-shadow,.16s background,.16s transform;
    }
    input::placeholder,
    textarea::placeholder{ color:#6b7280; font-size:13px;}
    input:focus,
    select:focus,
    textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(59,130,246,.35);
      background:var(--card);
    }

    .btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:9px 14px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
      letter-spacing:.01em;
      background:transparent;
      color:var(--text);
      border:1px solid var(--border);
      transition:.12s background,.12s border-color,.12s color;
    }
    .btn-primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
      border-radius:8px;
      box-shadow:none;
    }
    .btn-primary:hover{
      background:#4f8ff8;
      border-color:#4f8ff8;
    }
    .btn-outline{
      background:transparent;
      color:var(--text);
      border-color:var(--border);
    }
    [data-theme="light"] .btn-outline{
      border-color:#d1d5db;
      background:#f9fafb;
    }
    .btn-outline:hover{
      background:#111827;
      border-color:#1f2937;
    }
    [data-theme="light"] .btn-outline:hover{
      background:#edf2ff;
      border-color:#3b82f6;
    }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
      align-items:center;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      font-size:13px;
      border-radius:12px;
      overflow:hidden;
    }
    th,td{
      padding:7px 8px;
      border-bottom:1px solid #111827;
      text-align:left;
      vertical-align:top;
    }
    [data-theme="light"] th,
    [data-theme="light"] td{
      border-bottom:1px solid #e5e7eb;
    }
    th{
      font-weight:500;
      font-size:12px;
      color:#9ca3af;
      white-space:nowrap;
      background:rgba(15,23,42,.85);
    }
    [data-theme="light"] th{
      background:#f3f4f6;
      color:#6b7280;
    }
    tr:nth-child(even) td{
      background:rgba(15,23,42,.35);
    }
    [data-theme="light"] tr:nth-child(even) td{
      background:#f9fafb;
    }
    tr:hover td{
      background:rgba(59,130,246,.18);
    }
    [data-theme="light"] tr:hover td{
      background:rgba(59,130,246,.09);
    }

    .small{ font-size:12px; color:#8aa0b5;}
    .muted{ color:#94a3b8; font-size:12px; }

    .totals{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:8px;
      margin-top:10px;
    }
    @media(max-width:780px){ .totals{ grid-template-columns:1fr; } }

    .kpi{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .kpi .label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .kpi .value{
      font-size:20px;
      font-weight:800;
      margin-top:6px;
    }
    .kpi .sub{
      font-size:11px;
      color:#64748b;
      margin-top:2px;
    }

    .progress{
      height:6px;
      border-radius:999px;
      background:rgba(15,23,42,.8);
      overflow:hidden;
      border:1px solid #111827;
    }
    [data-theme="light"] .progress{
      background:#e5e7eb;
      border-color:#d1d5db;
    }
    .progress-inner{
      height:100%;
      width:0;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      transition:width .2s ease-out;
    }

    .searchbar{
      display:grid;
      grid-template-columns:1fr 160px 150px;
      gap:10px;
      margin:10px 0 0;
    }
    @media(max-width:780px){
      .searchbar{ grid-template-columns:1fr; }
    }

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:5px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:var(--card);
      font-size:11px;
      color:var(--text);
    }
    [data-theme="light"] .status-pill{
      border-color:#e5e7eb;
    }
    .status-pill span.dot{
      width:8px;
      height:8px;
      border-radius:999px;
      display:inline-block;
    }

    /* √âtats de pastilles (nuit) */
    .status-pill.paid{
      background:rgba(22,163,74,.14);
      border-color:#16a34a;
      color:#bbf7d0;
    }
    .status-pill.paid .dot{
      background:#22c55e;
    }

    .status-pill.partial{
      background:rgba(234,179,8,.16);
      border-color:#facc15;
      color:#fef9c3;
    }
    .status-pill.partial .dot{
      background:#eab308;
    }

    .status-pill.muted{
      background:rgba(239,68,68,.16);
      border-color:#ef4444;
      color:#fecaca;
    }
    .status-pill.muted .dot{
      background:#ef4444;
    }
    .status-pill.critical{
      background:rgba(248,113,113,.22);
      border-color:#ef4444;
      color:#ffe4e6;
    }
    .status-pill.critical .dot{
      background:#f87171;
    }

    /* √âtats de pastilles (jour) */
    [data-theme="light"] .status-pill.paid{
      background:rgba(22,163,74,.14);
      border-color:#16a34a;
      color:#166534;
    }
    [data-theme="light"] .status-pill.partial{
      background:rgba(250,204,21,.16);
      border-color:#eab308;
      color:#854d0e;
    }
    [data-theme="light"] .status-pill.muted{
      background:rgba(248,113,113,.18);
      border-color:#ef4444;
      color:#991b1b;
    }
    [data-theme="light"] .status-pill.critical{
      background:rgba(254,226,226,.9);
      border-color:#ef4444;
      color:#991b1b;
    }

    .checkbox-toggle{ display:flex; align-items:center; gap:8px; }

    .alert{
      padding:10px 12px;
      border-radius:12px;
      margin:10px 0;
    }
    .alert-ok{
      background:rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.5);
      color:#bbf7d0;
    }
    .alert-err{
      background:rgba(239,68,68,.08);
      border:1px solid rgba(239,68,68,.5);
      color:#fecaca;
    }

    footer{
      margin:20px 0;
      color:#94a3b8;
      font-size:12px;
      text-align:center;
    }
    footer code{
      background:var(--card);
      border-radius:8px;
      padding:2px 6px;
      border:1px solid #1f2937;
    }
    [data-theme="light"] footer code{
      border-color:#e5e7eb;
    }

    .hint{ font-size:12px; color:#9fb1c2; }
    .tab-section{ display:none; }
    .tab-section.active{ display:block; }
    .row{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px;
    }
    .pill{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:var(--card);
      color:#9ca3af;
    }
    [data-theme="light"] .pill{
      border-color:#e5e7eb;
      color:#6b7280;
    }

    /* Switch th√®me */
    .switch{
      position:relative;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      color:#9ca3af;
      cursor:pointer;
      user-select:none;
    }
    .switch input{ display:none; }
    .switch span.slider{
      width:34px;
      height:18px;
      border-radius:999px;
      background:#020617;
      border:1px solid #1f2937;
      position:relative;
      transition:.16s background,.16s border-color;
    }
    [data-theme="light"] .switch span.slider{
      background:#e5e7eb;
      border-color:#d1d5db;
    }
    .switch span.slider::before{
      content:"";
      position:absolute;
      top:1px;
      left:1px;
      width:14px;
      height:14px;
      border-radius:999px;
      background:#e5e7eb;
      transition:.16s transform,.16s background;
      box-shadow:0 1px 3px rgba(15,23,42,.5);
    }
    [data-theme="light"] .switch span.slider::before{
      background:#ffffff;
    }
    .switch input:checked + .slider{
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      border-color:transparent;
    }
    .switch input:checked + .slider::before{
      transform:translateX(14px);
    }
    .theme-toggle{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      background:rgba(15,23,42,.6);
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow:var(--shadow);
      flex-shrink:0;
    }
    [data-theme="light"] .theme-toggle{ background:#f8fafc; }
    .theme-icon{
      font-size:14px;
      line-height:1;
      filter:drop-shadow(0 2px 6px rgba(0,0,0,.25));
    }

    .debug-zone{
      margin-top:10px;
      font-size:11px;
      background:var(--card);
      border-radius:12px;
      padding:8px 10px;
      border:1px dashed #1f2937;
      color:#9ca3af;
    }
    .debug-zone pre{
      margin:4px 0 0;
      white-space:pre-wrap;
      word-break:break-word;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }

    .actions button{ margin-right:6px; }

    .small { font-size:12px; color:#8aa0b5;}
    .checkbox-toggle { display:flex; align-items:center; gap:8px;}
    .alert-ok { background: rgba(34,197,94,.1); border:1px solid rgba(34,197,94,.4); color:#86efac; }
    .alert-err{ background: rgba(239,68,68,.1); border:1px solid rgba(239,68,68,.4); color:#fecaca; }
    .hint { font-size:12px; color:#9fb1c2; }
    .debug { font-size:12px; color:#9ca3af; margin-top:6px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .totals { display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px; margin-top:10px; }
    .kpi{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; }
    .kpi .label{ font-size:12px; color:var(--muted); }
    .kpi .value{ font-size:20px; font-weight:800; margin-top:6px;}
    .actions button{ margin-right:6px;}
    .searchbar{ display:grid; grid-template-columns: 1fr 150px 160px; gap:10px; }
    @media(max-width:780px){ .searchbar{ grid-template-columns:1fr;} .totals{ grid-template-columns:1fr; } }

    /* calendar centered narrow */
    #bloc-calendar{max-width:900px;margin:24px auto;}

    /* ====== CAPTURE MOBILE R√âCAP ====== */
    #capture-mobile{
      display:none;
      width:380px;
      max-width:100%;
      margin:0 auto;
      padding:16px;
      background:var(--bg);
      color:var(--text);
      border-radius:16px;
    }
    .cap-header{
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      margin-bottom:12px;
      gap:6px;
    }
    .cap-header img{
      width:180px;
      height:auto;
      border-radius:12px;
      margin-top: -6px;
    }
    .cap-header .recap-logo{
      filter:brightness(10);
    }
    .cap-logo-clone{
      display:block;
      margin:0 auto 6px;
      opacity:1 !important;
      visibility:visible !important;
    }
    .cap-logo-clone img{
      width:180px;
      height:auto;
      display:block;
      opacity:1 !important;
      visibility:visible !important;
    }
    .cap-title{
      font-size:16px;
      font-weight:700;
    }
    .cap-sub{
      font-size:11px;
      color:var(--text2);
    }
    .cap-summary{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:8px;
      width:100%;
      margin:4px 0 14px;
    }
    .cap-kpi{
      position:relative;
      overflow:hidden;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      text-align:center;
      isolation:isolate;
    }
    .cap-kpi::after{
      content:"";
      position:absolute;
      inset:-30% -20% auto auto;
      width:180%;
      height:180%;
      background:radial-gradient(circle at 25% 25%, rgba(255,255,255,.25), transparent 45%);
      opacity:.75;
      transform:rotate(6deg);
      pointer-events:none;
      z-index:0;
    }
    .cap-kpi .label,
    .cap-kpi .value{
      text-align:center;
    }
    .cap-kpi.due{
      background:linear-gradient(135deg,#f59e0b,#f97316);
      border-color:rgba(249,115,22,.45);
      color:#fff;
    }
    .cap-kpi.received{
      background:linear-gradient(135deg,#22c55e,#15803d);
      border-color:rgba(21,128,61,.5);
      color:#ecfdf3;
    }
    .cap-kpi.total{
      background:linear-gradient(135deg,#312e81,#2563eb);
      border-color:rgba(37,99,235,.45);
      color:#e0e7ff;
      grid-column:1 / -1;
    }
    .cap-kpi .label{
      font-size:10px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:rgba(255,255,255,.85);
      z-index:1;
    }
    .cap-kpi .value{
      font-size:16px;
      font-weight:800;
      margin-top:4px;
      z-index:1;
    }
    .cap-item{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      margin-bottom:10px;
    }
    .cap-client{
      font-weight:700;
      font-size:14px;
      margin-bottom:2px;
    }
    .cap-subtitle{
      font-size:12px;
      color:var(--text2);
      margin-bottom:6px;
    }
    .cap-row{
      display:flex;
      justify-content:space-between;
      font-size:12px;
      margin-bottom:2px;
      gap:6px;
    }
    .cap-row span:first-child{
      color:var(--text2);
    }
    .cap-row .status-pill{
      font-size:10px;
      padding:2px 6px;
    }

    /* NOUVEAU: Styles pour la barre de progression dans la capture mobile */
    .cap-progress-wrap {
      padding: 8px 0;
    }
    .cap-row-progress-label {
      display: flex;
      justify-content: space-between; /* Correction d'alignement */
      align-items: center;
      margin-bottom: 4px;
      font-size: 0.875rem; 
      color: var(--muted);
    }
    .cap-row-progress-label span:last-child {
      font-weight: 600;
      color: var(--text);
    }

    /* Bloc recherche plus premium */
    .filter-panel{
      background:linear-gradient(145deg, rgba(37,99,235,.12), rgba(34,197,94,.08)), var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    [data-theme="light"] .filter-panel{
      background:linear-gradient(145deg, rgba(37,99,235,.08), rgba(34,197,94,.05)), var(--card);
    }
    .filter-row{
      display:grid;
      grid-template-columns:1.2fr 1fr 1fr;
      gap:12px;
      align-items:end;
    }
    .filter-actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      padding-top:8px;
      border-top:1px dashed var(--border);
    }
    .filter-actions .row{ gap:12px; }
    @media(max-width:780px){
      .filter-row{ grid-template-columns:1fr; }
      .filter-actions{ flex-direction:column; align-items:flex-start; }
    }

    /* BeatsEngine Premium */
    .beats-shell{
      position:relative;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:18px;
      padding:18px;
      box-shadow:0 18px 32px rgba(0,0,0,.34);
    }
    .beats-hero{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
    }
    .beats-hero h2{
      margin:0;
      font-size:1.55rem;
      letter-spacing:0.01em;
    }
    .beats-hero p{
      color:var(--text2);
      max-width:760px;
      margin:6px 0 0;
      line-height:1.5;
    }
    .beats-tagline{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .beats-chip{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text2);
      font-size:12px;
      letter-spacing:0.01em;
    }
    .beats-accent{ color:var(--accent); font-weight:700; }
    .beats-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .beats-pill-btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      font-weight:700;
    }
    .beats-pill-btn:hover{
      border-color:var(--accent);
      color:#fff;
      background:#111827;
      transition:140ms ease;
    }
    .beats-columns{
      display:grid;
      grid-template-columns:0.95fr 1.05fr;
      gap:14px;
      margin-top:14px;
      align-items:start;
    }
    @media(max-width:1024px){
      .beats-columns{ grid-template-columns:1fr; }
    }
    .beats-stack{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .beats-card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      box-shadow:none;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .beats-card h3{
      margin:0;
      letter-spacing:0.02em;
      font-size:18px;
    }
    .beats-card h4{
      margin:10px 0 8px;
      letter-spacing:0.02em;
      font-size:14px;
    }
    .beats-description{
      color:var(--text2);
      font-size:13px;
      margin:0 0 12px;
      line-height:1.6;
    }
    .beats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:12px;
    }
    .beats-label{
      font-size:12px;
      color:var(--text2);
      letter-spacing:0.02em;
      margin-bottom:6px;
      display:block;
    }
    .beats-input,
    .beats-select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      font-weight:600;
      letter-spacing:0.01em;
    }
    .beats-select{ appearance:none; }
    .beats-meta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .beats-meta-pill{
      padding:8px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      color:var(--text2);
      background:var(--panel);
      font-size:12px;
    }
    .usage-meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .usage-pill{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      font-size:12px;
      letter-spacing:0.01em;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .usage-pill strong{ color:#fff; }
    .energy-toggle{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .energy-chip{
      position:relative;
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel);
      cursor:pointer;
      min-width:160px;
      transition:140ms ease;
    }
    .energy-chip input{ display:none; }
    .energy-chip span{
      font-weight:700;
      color:var(--text);
      letter-spacing:0.01em;
    }
    .energy-chip small{
      color:var(--text2);
      display:block;
      font-weight:500;
    }
    .energy-chip.active{
      border-color:var(--accent);
      background:#0f1a2d;
    }
    .progression-chip,
    .vocal-chip,
    .dance-chip,
    .usage-chip{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      background:var(--panel);
      color:var(--text);
      display:flex;
      gap:8px;
      align-items:flex-start;
      cursor:pointer;
      transition:140ms ease;
      box-shadow:none;
    }
    .progression-chip.active,
    .vocal-chip.active,
    .dance-chip.active,
    .usage-chip.active{
      border-color:var(--accent);
      background:#0f1a2d;
    }
    .progression-chip small,
    .vocal-chip small,
    .dance-chip small{
      display:block;
      color:var(--text2);
      line-height:1.4;
    }
    .progression-row,
    .vocal-row,
    .dance-row,
    .usage-row{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:10px;
    }
    .usage-row{ grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); }
    .usage-chip input{ display:none; }
    .beats-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:10px;
      background:var(--panel);
      border:1px solid var(--border);
      color:var(--text2);
      font-size:12px;
    }
    .progression-meta{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:10px;
      padding:10px;
      border:1px dashed var(--border);
      border-radius:12px;
      background:var(--panel);
      color:var(--text);
      font-family:"JetBrains Mono","Fira Code",ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
    }
    .beats-warning{
      margin-top:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #b91c1c;
      background:rgba(185,28,28,0.16);
      color:#fecdd3;
      font-weight:700;
      display:none;
    }
    .beats-warning.visible{ display:block; }
    .dual-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:12px;
    }
    .beats-slider{
      width:100%;
    }
    .duration-row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .duration-row input[type="text"]{
      max-width:120px;
      text-align:center;
    }
    .instrument-accordion{
      border-radius:12px;
      overflow:hidden;
      border:1px solid var(--border);
      background:var(--panel);
    }
    .instrument-accordion summary{
      list-style:none;
      padding:12px 14px;
      cursor:pointer;
      font-weight:700;
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .instrument-accordion summary::-webkit-details-marker{ display:none; }
    .instrument-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:10px;
      padding:10px 14px 14px;
      background:var(--card);
    }
    .instrument-checkbox{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--panel);
      font-size:13px;
      color:var(--text);
    }
    .instrument-checkbox input{ accent-color:var(--accent); }
    .instrument-checkbox.over-limit{
      border-color:#ef4444;
      box-shadow:0 0 0 1px rgba(239,68,68,0.35);
    }
    .instrument-group-title{
      color:var(--text2);
      font-weight:800;
      margin:6px 0 2px;
      letter-spacing:0.01em;
    }
    .structure-list{
      list-style:none;
      margin:0;
      padding:0;
      display:grid;
      gap:10px;
    }
    .structure-item{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel);
      cursor:default;
    }
    .structure-item.dragging{
      opacity:0.7;
      border-style:dashed;
    }
    .structure-label{
      font-weight:700;
      color:var(--text);
      letter-spacing:0.01em;
    }
    .structure-controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .structure-controls input{
      flex:1;
      min-width:160px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      padding:10px 12px;
    }
    .structure-btn{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      font-weight:700;
      cursor:pointer;
    }
    .structure-btn.secondary:hover{ border-color:var(--accent); color:#fff; }
    .beats-prompt{
      position:sticky;
      top:10px;
      align-self:start;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .beats-output{
      width:100%;
      min-height:320px;
      font-family:"JetBrains Mono","Fira Code",ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
      font-size:13px;
      line-height:1.55;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      color:var(--text);
      padding:14px;
      box-shadow:none;
      resize:vertical;
    }
    .beats-toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:2px;
      justify-content:flex-start;
    }
    .beats-btn{
      padding:11px 13px;
      border-radius:10px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      font-weight:700;
      letter-spacing:0.01em;
      cursor:pointer;
      min-width:130px;
      transition:140ms ease;
      box-shadow:none;
    }
    .beats-btn.secondary{
      background:transparent;
      border-color:var(--border);
      color:var(--text);
    }
    .beats-btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
      border-radius:8px;
    }
    .beats-btn:hover{
      background:#111827;
      border-color:var(--accent);
      color:#fff;
    }
    .beats-btn.primary:hover{
      background:#4f8ff8;
      border-color:#4f8ff8;
    }
    .beats-status{
      font-size:12px;
      color:var(--text2);
      margin-top:2px;
    }
    .beats-output-meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-start;
      margin-top:4px;
      color:var(--text2);
      font-size:12px;
    }
    .beats-length{
      font-weight:800;
      color:#fff;
    }
    .prompt-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .char-counter{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:2px;
      color:var(--text2);
      font-size:12px;
    }
    .char-counter .beats-length{
      font-size:14px;
      letter-spacing:0.01em;
    }

    /* Track Name Generator */
    .track-card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:10px;
      box-shadow:none;
    }
    .track-name-panel{
      background:var(--panel);
      border:1px dashed var(--border);
      border-radius:12px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .track-name-display{
      min-height:48px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.6);
      padding:12px 14px;
      font-size:18px;
      font-weight:800;
      letter-spacing:0.01em;
      display:flex;
      align-items:center;
      color:var(--text);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.02);
    }
    [data-theme="light"] .track-name-display{
      background:#f8fafc;
    }
    .track-name-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .track-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text2);
      font-size:12px;
    }
    .track-meta{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .track-copy-feedback{
      font-size:12px;
      color:#22c55e;
      opacity:0;
      transition:opacity .16s ease;
    }
    .track-copy-feedback.visible{ opacity:1; }
  </style>
  <link rel="stylesheet" href="assets/szd-cards.css">
</head>
<body>
  <div class="container">
    <nav class="top-nav" aria-label="Navigation principale">
      <div class="nav-left">
        <a class="logo-wrap logo-compact" href="index.html" aria-label="Revenir aux prestations">
          <img
            src="szd_logo_white.png"
            data-dark-src="szd_logo_white.png"
            data-light-src="szd_logo_black.png"
            alt="Logo">
        </a>
      </div>
      <div class="nav-center">
        <div class="nav-links" id="nav-links">
          <a class="nav-link active" data-priority="main" href="#prestations" data-tab-target="prestations">Prestations</a>
          <a class="nav-link" data-priority="main" href="#beatsengine" data-tab-target="beatsengine">BeatsEngine</a>
          <a class="nav-link" data-priority="main" href="facturation.html">Facturation</a>
          <a class="nav-link" data-priority="main" href="rdv.html">RDV</a>
          <a class="nav-link" data-priority="secondary" href="licence.html">Licence</a>
          <a class="nav-link" data-priority="secondary" href="famille.html">Famille</a>
        </div>
      </div>
      <div class="nav-actions">
        <div class="theme-toggle">
          <span class="theme-icon" aria-hidden="true">üåô</span>
          <label class="switch" aria-label="Basculer le th√®me nuit/jour">
            <input type="checkbox" id="themeToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </nav>

    <main class="page-content">
    <section class="tab-section active" id="prestations">
      <div class="tab-header">
        <div>
          <h2>Prestations ‚Äî Clips & Musique</h2>
          <p class="tab-subtitle">
            Ajoute tes prestations, saisis les montants et enregistre les paiements partiels. Donn√©es stock√©es en localStorage ; si le stockage est bloqu√©, un mode secours JSON est disponible.
          </p>
        </div>
        <div class="tab-actions">
          <span class="pill">Version 1.4</span>
          <span class="pill">LocalStorage</span>
        </div>
      </div>
      <div id="status" class="alert" style="display:none;"></div>

      <div class="grid grid-2">
        <div class="card">
          <h2>Nouvelle prestation</h2>
          <form id="prestations-form" novalidate>
            <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px;">
              <div>
                <label for="client">Client</label>
                <input type="text" id="client" placeholder="Nom de l'artiste / client">
              </div>
              <div>
                <label for="type">Type</label>
                <select id="type">
                  <option value="Clip">Clip</option>
                  <option value="Musique">Musique</option>
                  <option value="Tournage">Tournage</option>
                  <option value="Montage">Montage</option>
                  <option value="Autre">Autre</option>
                </select>
              </div>
              <div style="grid-column:1 / -1;">
                <label for="description">Description (optionnel)</label>
                <input type="text" id="description" placeholder="D√©tails de la prestation (ex : Clip Mayanna)">
              </div>
              <div>
                <label for="date">Date</label>
                <input type="date" id="date">
              </div>
              <div>
                <label for="montant">Montant (‚Ç¨)</label>
                <input type="text" inputmode="decimal" id="montant" placeholder="ex : 800 ou 800,00">
              </div>
              <div class="checkbox-toggle" style="align-self:end;">
                <input type="checkbox" id="paye">
                <label for="paye" style="margin:0;">D√©j√† pay√© (total)</label>
              </div>
            </div>
            <div class="toolbar" style="margin-top:12px;">
              <button class="btn btn-primary" id="save" type="submit">Ajouter</button>
              <button type="button" class="btn btn-outline" id="reset">R√©initialiser</button>
              <button type="button" class="btn btn-outline" id="addDemo">+ D√©mo</button>
              <button type="button" class="btn btn-outline" id="exportJson">Export JSON</button>
              <button type="button" class="btn btn-outline" id="exportCsv">Export CSV</button>
              <label class="btn btn-outline">
                Import JSON
                <input type="file" id="importJson" accept="application/json" style="display:none;">
              </label>
            </div>
          </form>
        </div>

        <div class="card">
          <h2>Recherche & filtre</h2>
          <div class="filter-panel">
            <div class="filter-row">
              <div>
                <label for="search">Filtre texte</label>
                <input type="text" id="search" placeholder="Client, type, description‚Ä¶">
              </div>
              <div>
                <label for="filterStatus">Statut</label>
                <select id="filterStatus">
                  <option value="all">Tous</option>
                  <option value="unpayed">Non pay√©</option>
                  <option value="partial">Partiel</option>
                  <option value="paid">Pay√© / sold√©</option>
                </select>
              </div>
              <div>
                <label for="filterType">Type</label>
                <select id="filterType">
                  <option value="all">Tous</option>
                  <option value="Clip">Clip</option>
                  <option value="Musique">Musique</option>
                  <option value="Tournage">Tournage</option>
                  <option value="Montage">Montage</option>
                  <option value="Autre">Autre</option>
                </select>
              </div>
            </div>

            <div class="filter-actions">
              <div class="row">
                <div class="checkbox-toggle">
                  <input type="checkbox" id="debug">
                  <label for="debug" style="margin:0;">Debug mode</label>
                </div>
                <div class="checkbox-toggle">
                  <input type="checkbox" id="autoFile">
                  <label for="autoFile" style="margin:0;">Fichier auto (exp√©rimental)</label>
                </div>
              </div>
              <div class="row" style="gap:8px; color:var(--muted); font-size:12px;">
                <span>Affinez vos r√©sultats :</span>
                <span class="pill">Texte</span>
                <span class="pill">Statut</span>
                <span class="pill">Type</span>
              </div>
            </div>
          </div>

          <div class="totals" style="margin-top:14px;">
            <div class="kpi">
              <div class="label">Total factur√©</div>
              <div class="value" id="totalMontant">0 ‚Ç¨</div>
              <div class="sub">Somme des prestations</div>
            </div>
            <div class="kpi">
              <div class="label">Total re√ßu</div>
              <div class="value" id="totalRecu">0 ‚Ç¨</div>
              <div class="sub">Somme des paiements</div>
            </div>
            <div class="kpi">
              <div class="label">Total restant</div>
              <div class="value" id="totalRestant">0 ‚Ç¨</div>
              <div class="sub">√Ä encaisser</div>
            </div>
          </div>

          <div class="small" id="lsStatus" style="margin-top:6px;"></div>

        <div class="debug-zone" id="debug-zone" style="display:none;">
          <div>Console locale :</div>
          <pre id="debugOut"></pre>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:20px;">
      <h2>Prestations enregistr√©es</h2>
      <div class="small">Clique sur "Encaisser" pour enregistrer un paiement partiel ou total.</div>
      <div class="toolbar" style="margin-top:10px;">
        <button type="button" class="btn btn-outline" id="captureRecap">üì∏ Capture </button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Client / Type</th>
              <th>Montant</th>
              <th>Re√ßu</th>
              <th>Restant</th>
              <th>Avancement</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
        <tbody id="tbody">
          <tr><td colspan="10" class="small">Aucune prestation ne correspond.</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card whatsapp-card" style="margin-top:20px;">
      <h2><span class="wa-icon">üíö</span>Relances automatiques</h2>
      <div class="row" style="justify-content:space-between; align-items:center; gap:10px;">
        <p class="small" style="margin:0; max-width:620px;">Clients √† relancer apr√®s 15 jours sans paiement ; √† 30 jours la relance devient prioritaire, et √† 45 jours elle passe en mode critique. Pr√©pare tout pour WhatsApp en un coup d'≈ìil.</p>
        <span class="wa-chip">üí¨ Mode WhatsApp pr√™t</span>
      </div>
      <div class="row wa-legend" style="align-items:center; margin:10px 0 6px; flex-wrap:wrap;">
        <span class="pill">15 jours : relance douce</span>
        <span class="pill">30 jours : relance urgente</span>
        <span class="pill">45 jours : relance critique</span>
        <span class="pill" id="followupCounts">0 relance en attente</span>
      </div>
      <div id="followupList" class="grid followup-grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:10px;"></div>
    </div>
    </section>

    <section class="tab-section" id="beatsengine" hidden>
      <div class="tab-header">
        <div>
          <h2>BeatsEngine Pro ‚Äî IA Studio</h2>
          <p class="tab-subtitle">G√©n√©rateur de prompts IA premium &lt; 900 caract√®res, culturellement verrouill√©, pr√™t pour Suno et co. Vocal-first par d√©faut.</p>
        </div>
        <div class="tab-actions">
          <span class="pill">Studio-grade</span>
          <span class="pill">Cultural lock</span>
          <span class="pill">Auto BPM</span>
        </div>
      </div>
      <div class="beats-shell">
        <div class="beats-hero">
          <div>
            <h2>üéõÔ∏è BeatsEngine Pro ‚Äî Module Studio</h2>
            <p>
              G√©n√®re des prompts IA studio-grade en moins de 900 caract√®res : tonalit√© verrouill√©e, progression transpos√©e, cultural lock, usage ‚Üí dur√©e, vocal-first par d√©faut. Sobre, lisible et pr√™t pour Suno.
            </p>
            <div class="beats-tagline">
              <span class="beats-chip">Key + BPM lock</span>
              <span class="beats-chip">Cultural lock</span>
              <span class="beats-chip">Usage ‚Üí dur√©e</span>
              <span class="beats-chip">Vocal-first</span>
            </div>
          </div>
          <div class="beats-actions">
            <button type="button" class="beats-pill-btn" id="beats-shuffle">Shuffle üé≤</button>
            <span class="beats-pill-btn">‚ö° Studio-grade prompt</span>
          </div>
        </div>

        <div class="beats-columns">
          <div class="beats-stack">
            <div class="beats-card">
              <h3>üéº Core Settings</h3>
              <p class="beats-description">Style, tonalit√© et BPM coh√©rents en deux clics.</p>
              <div class="beats-grid">
                <div>
                  <label class="beats-label" for="beats-style">Style musical</label>
                  <select id="beats-style" class="beats-select">
                    <option>Afro-Trap</option>
                    <option>Afro-Trap Club</option>
                    <option>Drill</option>
                    <option>R&B</option>
                    <option>Dancehall</option>
                    <option>Afrobeat</option>
                    <option>Afropop</option>
                    <option>Bongo Flava</option>
                    <option>Amapiano</option>
                    <option>Zouk</option>
                    <option>Reggae</option>
                    <option>Reggaeton</option>
                    <option>Moombahton Latin Club</option>
                    <option>Shatta</option>
                  </select>
                </div>
                <div>
                  <label class="beats-label" for="beats-bpm">BPM</label>
                  <input type="number" id="beats-bpm" class="beats-input" min="70" max="180" step="1" value="110" inputmode="numeric">
                </div>
              </div>
              <details class="instrument-accordion" open style="margin-top:10px;">
                <summary>Tonalit√©</summary>
                <div class="instrument-grid">
                  <div>
                    <label class="beats-label" for="beats-note">Note</label>
                    <select id="beats-note" class="beats-select">
                      <option>C</option>
                      <option>C#</option>
                      <option>D</option>
                      <option>D#</option>
                      <option>E</option>
                      <option>F</option>
                      <option>F#</option>
                      <option>G</option>
                      <option>G#</option>
                      <option>A</option>
                      <option>A#</option>
                      <option>B</option>
                    </select>
                  </div>
                  <div>
                    <span class="beats-label">Mode</span>
                    <div class="vocal-row" id="beats-mode">
                      <label class="vocal-chip active">
                        <input type="radio" name="beats-mode" value="minor" checked>
                        <div>
                          <span style="font-weight:800;">Minor</span>
                          <small>Natural minor scale</small>
                        </div>
                      </label>
                      <label class="vocal-chip">
                        <input type="radio" name="beats-mode" value="major">
                        <div>
                          <span style="font-weight:800;">Major</span>
                          <small>Bright, open harmonies</small>
                        </div>
                      </label>
                    </div>
                  </div>
                </div>
              </details>
              <div class="beats-meta">
                <span class="beats-meta-pill">Accords cl√©s : <strong id="beats-chords">-</strong></span>
                <span class="beats-meta-pill">Plage BPM : <strong id="beats-bpm-range">-</strong></span>
                <span class="beats-meta-pill">Groove : <strong id="beats-energy-desc">-</strong></span>
              </div>
            </div>

            <div class="beats-card">
              <h3>üéº Winning Chords</h3>
              <p class="beats-description">Auto (recommended) ‚Äî ajust√© au style et transpos√© dans ta tonalit√©.</p>
              <details class="instrument-accordion" style="margin-bottom:8px;">
                <summary>Manuel (optionnel)</summary>
                <div class="progression-row" id="progression-options" style="padding:10px 14px 14px; background:rgba(0,0,0,0.25);"></div>
              </details>
              <div class="progression-meta">
                <div><strong>Degr√©s :</strong> <span id="beats-progression">i ‚Äì VI ‚Äì III ‚Äì VII</span></div>
                <div><strong>Accords r√©els :</strong> <span id="beats-progression-chords">Am ‚Äì F ‚Äì C ‚Äì G</span></div>
                <div class="beats-badge">Auto-transpos√© selon la cl√© et le style.</div>
              </div>
            </div>

            <div class="beats-card">
              <h3>üéöÔ∏è Groove & Vocals</h3>
              <p class="beats-description">Mode vocal-first par d√©faut, Groove fusionnant √©nergie et dance.</p>
              <div class="vocal-row" id="vocal-modes">
                <label class="vocal-chip active">
                  <input type="radio" name="vocal-mode" value="vocal-first" checked>
                  <div>
                    <span style="font-weight:800;">Vocal-First</span>
                    <small>vocal-first arrangement, no competing lead melody, instrumental supportive, clear space for human vocals.</small>
                  </div>
                </label>
                <label class="vocal-chip">
                  <input type="radio" name="vocal-mode" value="balanced">
                  <div>
                    <span style="font-weight:800;">Balanced</span>
                    <small>vocal-instrument balance, gentle counter-melodies, controlled layers.</small>
                  </div>
                </label>
                <label class="vocal-chip">
                  <input type="radio" name="vocal-mode" value="instrumental-lead">
                  <div>
                    <span style="font-weight:800;">Instrumental-Lead</span>
                    <small>instrumental hooks in front, vocals woven around the lead.</small>
                  </div>
                </label>
              </div>

              <div class="dual-grid" style="margin-top:12px;">
                <div>
                  <h4>‚ö° Energy</h4>
                  <div class="energy-toggle" id="beats-energy">
                    <label class="energy-chip">
                      <input type="radio" name="beats-energy" value="low">
                      <div>
                        <span>Low</span>
                        <small>Minimal, smooth, spacious</small>
                      </div>
                    </label>
                    <label class="energy-chip active">
                      <input type="radio" name="beats-energy" value="medium" checked>
                      <div>
                        <span>Medium</span>
                        <small>Balanced, groove-focused</small>
                      </div>
                    </label>
                    <label class="energy-chip">
                      <input type="radio" name="beats-energy" value="high">
                      <div>
                        <span>High</span>
                        <small>Aggressive, club-ready</small>
                      </div>
                    </label>
                  </div>
                  <div class="beats-status" id="beats-energy-note">Low ‚Üí minimal, smooth, spacious.</div>
                </div>

                <div>
                  <h4>üï∫ Dance</h4>
                  <div class="dance-row" id="beats-danceability">
                    <label class="dance-chip">
                      <input type="radio" name="beats-dance" value="chill">
                      <div>
                        <span>Chill</span>
                        <small>Laid-back groove</small>
                      </div>
                    </label>
                    <label class="dance-chip active">
                      <input type="radio" name="beats-dance" value="bounce" checked>
                      <div>
                        <span>Bounce</span>
                        <small>Smooth bounce</small>
                      </div>
                    </label>
                    <label class="dance-chip">
                      <input type="radio" name="beats-dance" value="club">
                      <div>
                        <span>Club</span>
                        <small>Club-focused rhythmic drive</small>
                      </div>
                    </label>
                  </div>
                  <div class="beats-status" id="beats-dance-note">Danceable sans agressivit√© obligatoire.</div>
                </div>
              </div>
            </div>

            <div class="track-card" id="track-generator">
              <h3>üéµ Track Name Generator</h3>
              <p class="beats-description">Titres illimit√©s li√©s au style, √† l'√©nergie et √† la danceability. Ind√©pendant du prompt.</p>
              <div class="track-name-panel" aria-live="polite">
                <div class="track-meta">
                  <span class="track-chip">Style : <strong id="track-style-meta">Afro-Trap</strong></span>
                  <span class="track-chip">√ânergie : <strong id="track-energy-meta">Medium</strong></span>
                  <span class="track-chip">Dance : <strong id="track-dance-meta">Bounce</strong></span>
                </div>
                <div class="track-name-display" id="track-name-display">Pr√™t √† g√©n√©rer</div>
                <div class="track-name-actions">
                  <button type="button" class="beats-btn primary" id="track-generate">Generate Name</button>
                  <button type="button" class="beats-btn" id="track-copy">Copy Name</button>
                  <span class="track-copy-feedback" id="track-copy-feedback" role="status" aria-live="assertive">Copi√© ‚úî</span>
                </div>
              </div>
            </div>

            <div class="beats-card">
              <h3>‚è±Ô∏è Usage & Dur√©e</h3>
              <p class="beats-description">Usage cible = dur√©e et formulation automatique. Toujours en mode full-length, jamais en boucle.</p>
              <div class="usage-row" id="beats-usage">
                <label class="usage-chip active">
                  <input type="radio" name="beats-usage" value="streaming" data-usage="streaming" checked>
                  <div>
                    <span>Streaming</span>
                    <small>Hook rapide, 3.1‚Äì3.3 min</small>
                  </div>
                </label>
                <label class="usage-chip">
                  <input type="radio" name="beats-usage" value="radio" data-usage="radio">
                  <div>
                    <span>Radio</span>
                    <small>Clair, mix concis</small>
                  </div>
                </label>
                <label class="usage-chip">
                  <input type="radio" name="beats-usage" value="club" data-usage="club">
                  <div>
                    <span>Club</span>
                    <small>Drop √©tendu</small>
                  </div>
                </label>
                <label class="usage-chip">
                  <input type="radio" name="beats-usage" value="dj" data-usage="dj">
                  <div>
                    <span>DJ</span>
                    <small>Intro/outro mixables</small>
                  </div>
                </label>
                <label class="usage-chip">
                  <input type="radio" name="beats-usage" value="emotion" data-usage="emotion">
                  <div>
                    <span>Emotion</span>
                    <small>Storytelling</small>
                  </div>
                </label>
              </div>
              <div class="beats-meta">
                <span class="beats-meta-pill">Dur√©e cible : <strong id="beats-duration">3.2 min</strong></span>
                <span class="beats-meta-pill">Contexte : <strong id="beats-usage-note">Streaming ready</strong></span>
              </div>
            </div>

            <div class="beats-card">
              <h3>üéπ Instruments & Structure</h3>
              <p class="beats-description">Cat√©gories compactes, structure via presets, dur√©e implicite. Le moteur g√®re les d√©tails et exclusions automatiquement.</p>
              <details class="instrument-accordion" open>
                <summary>Instruments (auto)</summary>
                <div class="instrument-grid" id="beats-instruments">
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="drums" data-role="rhythm" checked> Drums</label>
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="bass" data-role="bass" checked> Bass</label>
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="melody" data-role="melody"> Melody</label>
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="guitar" data-role="melody"> Guitar</label>
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="piano" data-role="melody"> Piano</label>
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="pads" data-role="melody"> Pads / Atmos</label>
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="plucks" data-role="melody"> Plucks / Stabs</label>
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="strings" data-role="melody"> Strings (light)</label>
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="brass" data-role="melody"> Horns / Brass</label>
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="voxfx" data-role="melody"> Vocal chops</label>
                  <label class="instrument-checkbox"><input type="checkbox" class="beats-instrument" value="fx" data-role="texture"> FX textures</label>
                </div>
              </details>
              <div class="beats-warning" id="melody-warning">Mode Vocal-First : limite de 1 instrument m√©lodique d√©pass√©e.</div>

              <div style="margin-top:12px;">
                <div class="structure-controls" id="structure-presets">
                  <button type="button" class="structure-btn secondary" data-structure-preset="singer">Singer</button>
                  <button type="button" class="structure-btn secondary" data-structure-preset="rapper">Rapper</button>
                  <button type="button" class="structure-btn secondary" data-structure-preset="club">Club</button>
                </div>
                <ul class="structure-list" id="structure-list" aria-label="Structure du morceau"></ul>
              </div>
              <div class="beats-status" id="beats-structure-note">Structure preset + dur√©e auto.</div>
            </div>
          </div>

          <div class="beats-prompt">
            <div class="beats-card">
              <div class="prompt-header">
                <div>
                  <h3>üß† Prompt Engine</h3>
                  <p class="beats-description">Prompt premium ligne par ligne, lisible, pr√™t √† √™tre coll√© dans ton IA audio.</p>
                </div>
                <div class="char-counter">
                  <span class="beats-length" id="beats-length">0 / 900</span>
                  <span>caract√®res</span>
                </div>
              </div>
              <textarea id="beats-output" class="beats-output" rows="14" readonly aria-live="polite"></textarea>
              <div class="beats-output-meta">
                <span class="beats-meta-pill" id="beats-keyline">Key &amp; BPM verrouill√©s</span>
              </div>
              <div class="beats-toolbar">
                <button type="button" class="beats-btn primary" id="beats-generate">Generate</button>
                <button type="button" class="beats-btn secondary" id="beats-shuffle-cta">Shuffle</button>
                <button type="button" class="beats-btn" id="beats-copy">Copy Prompt</button>
              </div>
              <div class="beats-status" id="beats-status">Pr√™t √† g√©n√©rer un prompt studio.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Zone de capture mobile cach√©e -->
  <div id="capture-mobile"></div>

  </div>

  <footer>Local ‚Äî cl√©: <code>prestations_v1</code>. Si √ßa casse, tu peux exporter en JSON et garder une sauvegarde manuelle.</footer>

  <!-- html2canvas pour la capture -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="assets/szd-card-glow.js" defer></script>

  <script>
    function updateThemeLogos(theme){
      const mode = theme === "light" ? "light" : "dark";

      document.querySelectorAll('[data-light-src][data-dark-src]').forEach((img) => {
        const target = mode === "light" ? img.dataset.lightSrc : img.dataset.darkSrc;
        if (target) {
          img.setAttribute("src", target);
        }
      });
    }

    function currentLogoForTheme(theme){
      const mode = theme === "light" ? "light" : "dark";
      const img = document.querySelector('[data-light-src][data-dark-src]');
      if (!img) return "";

      return mode === "light"
        ? (img.dataset.lightSrc || img.getAttribute("src") || "")
        : (img.dataset.darkSrc || img.getAttribute("src") || "");
    }

    function captureLogoForTheme(theme){
      const preferredCaptureLogo = "szd_logo_blanc.png";
      const mode = theme === "light" ? "light" : "dark";
      const candidates = [
        preferredCaptureLogo,
        "szd_logo_white.png",
        currentLogoForTheme(mode),
        mode === "light" ? "szd_logo_black.png" : "szd_logo_white.png",
        "szd_logo.png"
      ].filter(Boolean);

      const candidate = candidates[0] || "";

      try {
        return new URL(candidate, window.location.href).href;
      } catch (e) {
        return candidate;
      }
    }
  </script>

  <!-- SCRIPT TABS -->
  <script>
    (function(){
      const tabLinks = document.querySelectorAll("[data-tab-target]");
      const tabSections = document.querySelectorAll(".tab-section");
      if(!tabLinks.length || !tabSections.length) return;

      function activateTab(targetId, skipHash){
        tabSections.forEach(section => {
          const active = section.id === targetId;
          section.classList.toggle("active", active);
          section.hidden = !active;
        });

        tabLinks.forEach(link => {
          const active = link.dataset.tabTarget === targetId;
          link.classList.toggle("active", active);
          if(active) link.blur();
        });

        if(!skipHash){
          const hash = targetId === "prestations" ? "" : `#${targetId}`;
          const newUrl = hash ? `${location.pathname}${hash}` : location.pathname;
          history.replaceState(null, "", newUrl);
        }
      }

      function initFromHash(){
        const hash = (location.hash || "").replace("#","");
        const target = document.getElementById(hash) ? hash : "prestations";
        activateTab(target, true);
      }

      tabLinks.forEach(link => {
        link.addEventListener("click", (e) => {
          const target = link.dataset.tabTarget;
          if(!target) return;
          e.preventDefault();
          activateTab(target);
        });
      });

      initFromHash();
      window.addEventListener("hashchange", initFromHash);
    })();
  </script>

  <!-- SCRIPT PRESTATIONS -->
  <script>
    (() => {
      const $ = (id) => document.getElementById(id);
      const formEl = $("prestations-form");
      const eur = (n) => new Intl.NumberFormat("fr-FR", {style:"currency", currency:"EUR"}).format(n || 0);
      const storageKey = "prestations_v1";
      const VERSION = "1.4";

      const status = $("status");
      const debugChk = $("debug");
      const autoFile = $("autoFile");
      const debugOut = $("debugOut");
      const lsStatus = $("lsStatus");

      const tbody = $("tbody");
      const totalMontantEl = $("totalMontant");
      const totalRecuEl = $("totalRecu");
      const totalRestantEl = $("totalRestant");
      const search = $("search");
      const filterStatus = $("filterStatus");
      const filterType = $("filterType");

      const client = $("client");
      const type = $("type");
      const description = $("description");
      const date = $("date");
      const montant = $("montant");
      const paye = $("paye");

      const exportJsonBtn = $("exportJson");
      const exportCsvBtn = $("exportCsv");
      const importJsonInput = $("importJson");
      const clearAllBtn = $("clearAll"); // (pas pr√©sent dans le HTML, ok si null)
      const resetBtn = $("reset");
      const addDemoBtn = $("addDemo");
      const captureBtn = $("captureRecap");
      const followupList = $("followupList");
      const followupCounts = $("followupCounts");

      const WHATSAPP_LEVELS = [
        {
          threshold: 15,
          label: "Relance 15j",
          template: `Salut [Pr√©nom],\nPetit rappel concernant ta prestation : il te reste encore 15 jours pour finaliser le r√®glement du solde.\nN‚Äôh√©site pas √† me contacter si tu as la moindre question.\n√Ä bient√¥t.`,
          tone: "soft"
        },
        {
          threshold: 30,
          label: "Relance 30j",
          template: `Bonjour [Pr√©nom],\nLa date limite des 30 jours pour le r√®glement du solde est atteinte.\nMerci de r√©gulariser la situation rapidement afin de conserver la r√©servation de la prestation.\nJe reste disponible si besoin.`,
          tone: "firm"
        },
        {
          threshold: 45,
          label: "Relance 45j (critique)",
          template: `Bonjour [Pr√©nom],\nCela fait d√©sormais 45 jours que le solde est en attente malgr√© mes pr√©c√©dentes relances.\nMerci de r√©gulariser la situation imm√©diatement afin d'√©viter toute interruption de la prestation.\nJe reste disponible en cas de besoin.`,
          tone: "critical"
        }
      ];

      let data = [];
      let editingId = null;

      const log = (...args) => {
        if (debugChk && debugChk.checked) {
          console.log("[DEBUG]", ...args);
          if (debugOut) {
            debugOut.textContent = String(args.join(" "));
          }
        }
      };

      function ts(){
        const d=new Date();
        const p=n=>String(n).padStart(2,"0");
        return d.getFullYear()+"-"+p(d.getMonth()+1)+p(d.getDate())+"_"+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds());
      }

      const supportsLocalStorage = (() => {
        try {
          const k = "__test_ls__";
          localStorage.setItem(k,"1");
          localStorage.removeItem(k);
          return true;
        } catch(e) {
          return false;
        }
      })();

      function showStatus(msg, ok=true){
        if(!status) return;
        status.className = "alert " + (ok ? "alert-ok" : "alert-err");
        status.textContent = msg;
        status.style.display = "block";
        clearTimeout(showStatus._t);
        showStatus._t = setTimeout(() => { status.style.display = "none"; }, 4000);
      }

      function persist(){
        if(!supportsLocalStorage) return;
        try {
          localStorage.setItem(storageKey, JSON.stringify(data));
          log("persist ok", data.length);
        } catch(e) {
          console.error(e);
          showStatus("Erreur de sauvegarde locale : " + e.message, false);
        }
      }

      function load(){
        if(!supportsLocalStorage){
          if(lsStatus){
            lsStatus.textContent = "LocalStorage indisponible (mode secours).";
          }
          return;
        }
        if(lsStatus){
          lsStatus.textContent = "LocalStorage actif.";
        }
        try {
          const raw = localStorage.getItem(storageKey);
          if(!raw) return;
          data = JSON.parse(raw) || [];
        } catch(e) {
          console.error(e);
          showStatus("Impossible de lire les donn√©es locales.", false);
        }
      }

      function sanitizeAmount(v) {
        if (typeof v === "number") return v;
        let s = (v||"").toString().trim();
        s = s.replace(/\s/g,"").replace(",", "."); // french decimal
        const num = parseFloat(s);
        return isFinite(num) ? num : NaN;
      }

      function getPaid(r){ return Number(r.paidAmount || 0); }
      function getRemaining(r){ return Math.max(0, Number((r.montant||0) - getPaid(r))); }
      function isSettled(r){ return getRemaining(r) <= 0.00001; }

      function daysSince(datestr){
        if(!datestr) return null;
        const d = new Date(datestr);
        if(Number.isNaN(d.getTime())) return null;
        const now = new Date();
        const diff = now - d;
        if(diff < 0) return 0;
        return Math.floor(diff / (1000*60*60*24));
      }

      function extractFirstName(full){
        if(!full) return "client";
        const parts = full.trim().split(/\s+/);
        return parts[0] || "client";
      }

      function buildWhatsAppUrl(name, level){
        const targetName = name || "client";
        const message = (level?.template || "").replace("[Pr√©nom]", targetName);
        return "https://wa.me/?text=" + encodeURIComponent(message);
      }

      function filterRecords(list){
        const q = (search?.value || "").toLowerCase();
        const fStatus = filterStatus?.value || "all";
        const fType = filterType?.value || "all";

        return list.filter(r => {
          if(q){
            const blob = [r.client,r.type,r.description].join(" ").toLowerCase();
            if(!blob.includes(q)) return false;
          }
          if(fType !== "all" && r.type !== fType) return false;
          if(fStatus !== "all"){
            const settled = isSettled(r);
            const paid = getPaid(r) > 0;
            if(fStatus === "paid" && !settled) return false;
            if(fStatus === "unpayed" && (paid || settled)) return false;
            if(fStatus === "partial" && (!paid || settled)) return false;
          }
          return true;
        });
      }

      function updateTotals(records){
        const list = Array.isArray(records) ? records : [];
        const totals = list.reduce((acc, r = {}) => {
          const m = Number(r.montant || 0);
          const p = getPaid(r);
          acc.totalMontant += m;
          acc.totalRecu += p;
          acc.totalRestant += Math.max(0, m - p);
          return acc;
        }, {totalMontant:0, totalRecu:0, totalRestant:0});

        if(totalMontantEl) totalMontantEl.textContent = eur(totals.totalMontant);
        if(totalRecuEl) totalRecuEl.textContent = eur(totals.totalRecu);
        if(totalRestantEl) totalRestantEl.textContent = eur(totals.totalRestant);

        return totals;
      }

      function buildMobileRecap(records, totals){
        const zone = document.getElementById("capture-mobile");
        if(!zone){
          throw new Error("Zone de capture introuvable pour le r√©capitulatif mobile.");
        }

        if(!Array.isArray(records)){
          throw new Error("getFilteredRecords() n'a pas renvoy√© un tableau.");
        }
        if(typeof records.length !== "number" || records.length < 0){
          throw new Error("records.length est invalide pour la capture mobile.");
        }

        const list = Array.isArray(records) ? records : [];
        const totalRestant = list.reduce((acc, r = {}) => acc + Math.max(0, getRemaining(r)), 0);
        const summary = { totalRestant };

        const now = new Date();
        const dateStr = now.toLocaleString("fr-FR", {
          day:"2-digit", month:"2-digit", year:"numeric",
          hour:"2-digit", minute:"2-digit"
        });

        zone.innerHTML = "";

        const header = document.createElement("div");
        header.className = "cap-header";

        const headerLogo = document.querySelector(".nav-left .logo-wrap");
        if(!headerLogo){
          throw new Error("Logo source introuvable pour la capture mobile.");
        }
        const clonedLogo = headerLogo.cloneNode(true);
        clonedLogo.classList.add("cap-logo-clone");
        clonedLogo.removeAttribute("href");
        const clonedImg = clonedLogo.querySelector("img");
        if(!clonedImg){
          throw new Error("Image du logo introuvable pour la capture mobile.");
        }
        clonedImg.style.opacity = "1";
        clonedImg.style.visibility = "visible";
        clonedImg.style.display = "block";
        header.appendChild(clonedLogo);

        const title = document.createElement("div");
        title.className = "cap-title";
        title.textContent = "R√©capitulatif des prestations";
        const sub = document.createElement("div");
        sub.className = "cap-sub";
        sub.textContent = "G√©n√©r√© le " + dateStr;
        header.appendChild(title);
        header.appendChild(sub);
        zone.appendChild(header);

        const summaryWrap = document.createElement("div");
        summaryWrap.className = "cap-summary";
        const kpi = document.createElement("div");
        kpi.className = "cap-kpi due";
        const l = document.createElement("div");
        l.className = "label";
        l.textContent = "Restant d√ª total";
        const v = document.createElement("div");
        v.className = "value";
        v.textContent = eur(summary.totalRestant || 0);
        kpi.appendChild(l);
        kpi.appendChild(v);
        summaryWrap.appendChild(kpi);
        zone.appendChild(summaryWrap);

        if(!list.length){
          const empty = document.createElement("div");
          empty.className = "cap-item";
          empty.textContent = "Aucune prestation ne correspond aux filtres.";
          zone.appendChild(empty);
          return summary;
        }

        const frag = document.createDocumentFragment();
        list.forEach(r => {
          const remaining = getRemaining(r);
          const paid = getPaid(r);
          const percent = (r.montant && r.montant > 0) ? Math.min(100, Math.round(paid/r.montant*100)) : 0;

          let cls, label;
          if(isSettled(r)){
            cls = "paid"; label = "Pay√©";
          }else if(paid > 0){
            cls = "partial"; label = "Partiel";
          }else{
            cls = "muted"; label = "Non pay√©";
          }

          const item = document.createElement("div");
          item.className = "cap-item";
          item.innerHTML = `
            <div class="cap-client">${r.client || ""}</div>
            <div class="cap-subtitle">${(r.type || "")}${r.description ? " ‚Äî " + r.description : ""}</div>
            <div class="cap-row"><span>Date</span><span>${r.date || ""}</span></div>
            <div class="cap-row"><span>Factur√©</span><span>${eur(r.montant || 0)}</span></div>
            <div class="cap-row"><span>Re√ßu</span><span>${eur(paid)}</span></div>
            <div class="cap-row"><span>Restant</span><span>${eur(remaining)}</span></div>
            <div class="cap-progress-wrap">
              <div class="cap-row-progress-label">
                <span>Avancement</span>
                <span>${percent} %</span>
              </div>
              <div class="progress">
                <div class="progress-inner" style="width:${percent}%;"></div>
              </div>
            </div>
            <div class="cap-row">
              <span>Statut</span>
              <span class="status-pill ${cls}">
                <span class="dot"></span>
                <span>${label}</span>
              </span>
            </div>
          `;
          frag.appendChild(item);
        });
        zone.appendChild(frag);

        return summary;
      }

      function updateFollowUps(){
        if(!followupList) return;

        followupList.innerHTML = "";
        let soft = 0, firm = 0, critical = 0;

        const items = data
          .map(r => ({...r, days: daysSince(r.date), remaining: getRemaining(r)}))
          .filter(r => r.remaining > 0 && r.days !== null && r.days >= 15)
          .sort((a,b) => (b.days||0) - (a.days||0));

        if(!items.length){
          const empty = document.createElement("div");
          empty.className = "small";
          empty.textContent = "Aucune relance n√©cessaire pour le moment.";
          followupList.appendChild(empty);
          if(followupCounts) followupCounts.textContent = "0 relance en attente";
          return;
        }

        items.forEach(r => {
          const urgency = (r.days || 0) >= 45 ? "critical" : (r.days || 0) >= 30 ? "firm" : "soft";
          if(urgency === "critical") critical++; else if(urgency === "firm") firm++; else soft++;

          const item = document.createElement("div");
          item.className = "cap-item followup-card";

          const actionLabel = urgency === "critical" ? "Relance critique" : urgency === "firm" ? "Relance urgente" : "Relance √† pr√©voir";
          const pillClass = urgency === "critical" ? "critical" : (urgency === "firm" ? "muted" : "partial");
          const actionIcon = urgency === "critical" ? "üö®" : urgency === "firm" ? "üöÄ" : "üå±";
          const paceLabel = urgency === "critical" ? "Critique" : urgency === "firm" ? "Prioritaire" : "Douce";
          const availableLevels = WHATSAPP_LEVELS.filter(level => (r.days || 0) >= level.threshold);

          item.innerHTML = `
            <div class="followup-head">
              <div>
                <div class="cap-client">${r.client || "Client"}</div>
                <div class="cap-subtitle">${r.type || ""}${r.description ? " ‚Äî " + r.description : ""}</div>
              </div>
              <span class="status-pill ${pillClass} followup-pill">
                <span class="dot"></span>
                <span>${actionIcon} ${actionLabel}</span>
              </span>
            </div>
            <div class="followup-meta">
              <div class="followup-stat">
                <span class="label">üí∂ Restant d√ª</span>
                <span class="value">${eur(r.remaining)}</span>
              </div>
              <div class="followup-stat">
                <span class="label">‚è≥ Anciennet√©</span>
                <span class="value">${r.days} jours</span>
              </div>
              <div class="followup-stat">
                <span class="label">üí¨ Niveau WhatsApp</span>
                <span class="value">${paceLabel}</span>
              </div>
            </div>
          `;

          const actions = document.createElement("div");
          actions.className = "followup-actions";

          const hint = document.createElement("div");
          hint.className = "small";
          hint.textContent = "Messages pr√™ts :";
          actions.appendChild(hint);

          const btnRow = document.createElement("div");
          btnRow.className = "followup-btn-row";

          availableLevels.forEach(level => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = `btn relance-btn relance-${level.tone}`;
            btn.textContent = level.label;
            btn.addEventListener("click", () => {
              const url = buildWhatsAppUrl(extractFirstName(r.client), level);
              window.open(url, "_blank", "noopener");
            });
            btnRow.appendChild(btn);
          });

          actions.appendChild(btnRow);
          item.appendChild(actions);

          followupList.appendChild(item);
        });

        if(followupCounts){
          const parts = [];
          if(soft) parts.push(`${soft} √† relancer`);
          if(firm) parts.push(`${firm} urgentes`);
          if(critical) parts.push(`${critical} critiques`);
          followupCounts.textContent = parts.join(" ‚Ä¢ ");
        }
      }

      function render(){
        if(!tbody) return;
        tbody.innerHTML = "";

        const records = filterRecords(data);
        if(!records.length){
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 10;
          td.className = "small";
          td.textContent = "Aucune prestation ne correspond.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          const totals = updateTotals(records);
          buildMobileRecap(records, totals);
          updateFollowUps();
          return;
        }

        records.sort((a,b) => {
          const da = a.date || "";
          const db = b.date || "";
          return da.localeCompare(db);
        });

        records.forEach(r => {
          const tr = document.createElement("tr");

          const tdDate = document.createElement("td");
          tdDate.textContent = r.date || "";
          tr.appendChild(tdDate);

          const tdClient = document.createElement("td");
          const c1 = document.createElement("div");
          c1.textContent = r.client || "";
          c1.style.fontWeight = "600";
          const c2 = document.createElement("div");
          c2.className = "small";
          c2.textContent = (r.type || "") + (r.description ? " ‚Äî " + r.description : "");
          tdClient.appendChild(c1);
          tdClient.appendChild(c2);
          tr.appendChild(tdClient);

          const tdMontant = document.createElement("td");
          tdMontant.textContent = eur(r.montant || 0);
          tr.appendChild(tdMontant);

          const tdRecu = document.createElement("td");
          tdRecu.textContent = eur(getPaid(r));
          tr.appendChild(tdRecu);

          const remaining = getRemaining(r);
          const tdRestant = document.createElement("td");
          tdRestant.textContent = eur(remaining);
          tr.appendChild(tdRestant);

          const tdProgress = document.createElement("td");
          const wrapper = document.createElement("div");
          wrapper.className = "small";
          const percent = (r.montant && r.montant > 0) ? Math.min(100, Math.round(getPaid(r)/r.montant*100)) : 0;
          wrapper.textContent = percent + " %";
          const bar = document.createElement("div");
          bar.className = "progress";
          const inner = document.createElement("div");
          inner.className = "progress-inner";
          inner.style.width = percent + "%";
          bar.appendChild(inner);
          tdProgress.appendChild(wrapper);
          tdProgress.appendChild(bar);
          tr.appendChild(tdProgress);

          const tdStatus = document.createElement("td");
          const pill = document.createElement("span");
          pill.className = "status-pill";
          const dot = document.createElement("span");
          dot.className = "dot";
          pill.appendChild(dot);
          const label = document.createElement("span");
          let cls = "";
          if(isSettled(r)){
            cls = "paid";
            label.textContent = "Pay√©";
          }else if(getPaid(r) > 0){
            cls = "partial";
            label.textContent = "Partiel";
          }else{
            cls = "muted";
            label.textContent = "Non pay√©";
          }
          pill.classList.add(cls);
          pill.appendChild(label);
          tdStatus.appendChild(pill);
          tr.appendChild(tdStatus);

          const tdActions = document.createElement("td");
          const encBtn = document.createElement("button");
          encBtn.type = "button";
          encBtn.className = "btn btn-primary";
          encBtn.textContent = "Encaisser";
          encBtn.addEventListener("click", () => {
            let max = getRemaining(r);
            if(max <= 0){
              showStatus("Tout est d√©j√† pay√© pour cette prestation.", false);
              return;
            }
            const s = prompt("Montant √† encaisser (max " + eur(max) + "):", "");
            if(s===null) return;
            const val = sanitizeAmount(s);
            if(!isFinite(val) || val<=0){
              showStatus("Montant invalide.", false);
              return;
            }
            if(val > max + 0.00001){
              showStatus("Montant sup√©rieur au restant d√ª.", false);
              return;
            }
            r.paidAmount = (r.paidAmount || 0) + val;
            persist();
            updateTotals(filterRecords(data));
            render();
            showStatus("Paiement enregistr√©.");
          });

          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.className = "btn btn-outline";
          editBtn.textContent = "Modifier";
          editBtn.addEventListener("click", () => {
            editingId = r.id;
            client.value = r.client || "";
            type.value = r.type || "Clip";
            description.value = r.description || "";
            date.value = r.date || "";
            montant.value = r.montant != null ? String(r.montant) : "";
            paye.checked = isSettled(r);
            window.scrollTo({top:0, behavior:"smooth"});
          });

          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "btn btn-outline";
          delBtn.textContent = "Supprimer";
          delBtn.addEventListener("click", () => {
            if (confirm("Supprimer cette prestation ?")) {
              data = data.filter(x => x.id !== r.id);
              persist();
              updateTotals(filterRecords(data));
              render();
              if (editingId === r.id) editingId = null;
              showStatus("Prestation supprim√©e.");
            }
          });

          tdActions.appendChild(encBtn);
          tdActions.appendChild(editBtn);
          tdActions.appendChild(delBtn);
          tr.appendChild(tdActions);

          tbody.appendChild(tr);
        });

        const totals = updateTotals(records);
        buildMobileRecap(records, totals);
        updateFollowUps();
      }

      function captureRecap(records){
        console.log("CAPTURE 0: d√©marrage captureRecap");
        try{
          console.log("CAPTURE 1: r√©cup√©ration records");
          const base = Array.isArray(records) ? records : (data || []);
          if(!Array.isArray(base)){
            throw new Error("getFilteredRecords() n'a pas renvoy√© un tableau.");
          }
          console.log("CAPTURE 2: application des filtres");
          const list = filterRecords(base);
          if(!Array.isArray(list)){
            throw new Error("getFilteredRecords() n'a pas renvoy√© un tableau.");
          }
          if(typeof list.length !== "number" || list.length < 0){
            throw new Error("records.length est invalide pour la capture.");
          }
          if(!list.length){
            showStatus("Aucune prestation √† capturer (v√©rifie les filtres).", false);
            return;
          }

          console.log("CAPTURE 3: r√©cup√©ration du conteneur de capture");
          const zone = document.getElementById("capture-mobile");
          if(!zone){
            throw new Error("Conteneur #capture-mobile introuvable.");
          }
          if(!(zone instanceof HTMLElement)){
            throw new Error("√âl√©ment de capture invalide.");
          }

          console.log("CAPTURE 4: buildMobileRecap en cours");
          const totals = buildMobileRecap(list);
          if(!totals){
            throw new Error("buildMobileRecap n'a pas renvoy√© de totaux.");
          }
          console.log("CAPTURE 5: buildMobileRecap OK, pr√©paration html2canvas");

          if(typeof html2canvas !== "function"){
            throw new Error("html2canvas indisponible pour la capture.");
          }

          const bg = document.documentElement.getAttribute("data-theme") === "light"
            ? "#f3f4f6"
            : "#020617";

          const prevDisplay = zone.style.display;
          const prevVisibility = zone.style.visibility;
          zone.style.display = "block";
          zone.style.visibility = "visible";

          const launchCapture = () => {
            console.log("CAPTURE 6: html2canvas lanc√©");
            html2canvas(zone, {
              backgroundColor: bg,
              scale: 2,
              useCORS: true,
              allowTaint: true
            }).then(canvas => {
              console.log("CAPTURE 7: html2canvas OK, cr√©ation du lien de t√©l√©chargement");
              const link = document.createElement("a");
              link.download = "recap_prestations_mobile_"+ts()+".png";
              link.href = canvas.toDataURL("image/png");
              link.click();
              showStatus("R√©capitulatif captur√© (format mobile) !");
            }).catch(err => {
              console.error("CAPTURE ERREUR html2canvas", err);
              if(err && err.stack) console.error(err.stack);
              alert(err?.message || "Erreur lors de l'ex√©cution de html2canvas.");
            }).finally(() => {
              zone.style.display = prevDisplay;
              zone.style.visibility = prevVisibility;
            });
          };

          if(typeof requestAnimationFrame === "function"){
            requestAnimationFrame(() => requestAnimationFrame(launchCapture));
          }else{
            setTimeout(launchCapture, 0);
          }
        }catch(err){
          console.error("CAPTURE ERREUR inattendue", err);
          if(err && err.stack) console.error(err.stack);
          alert(err && err.message ? err.message : "Erreur lors de la capture du r√©capitulatif.");
        }
      }

      function resetForm(){
        if(!formEl) return;
        client.value = "";
        type.value = "Clip";
        description.value = "";
        date.value = "";
        montant.value = "";
        paye.checked = false;
        editingId = null;
      }

      function validateForm(){
        const c = client.value.trim();
        if(!c){
          showStatus("Le nom du client est obligatoire.", false);
          client.focus();
          return null;
        }
        const m = sanitizeAmount(montant.value);
        if(!isFinite(m) || m<=0){
          showStatus("Montant invalide.", false);
          montant.focus();
          return null;
        }
        const d = date.value || new Date().toISOString().slice(0,10);
        return {client:c, type:type.value, description:description.value.trim(), date:d, montant:m};
      }

      function addRecord(rec){
        rec.id = rec.id || Date.now() + Math.random();
        rec.paidAmount = rec.paidAmount || 0;
        data.push(rec);
      }

      if(formEl){
        formEl.addEventListener("submit", (e) => {
          e.preventDefault();
          const rec = validateForm();
          if(!rec) return;

          if(editingId){
            const idx = data.findIndex(r => r.id === editingId);
            if(idx !== -1){
              data[idx] = {
                ...data[idx],
                ...rec
              };
              showStatus("Prestation modifi√©e.");
            }
            editingId = null;
          } else {
            if(paye.checked){
              rec.paidAmount = rec.montant;
            }
            addRecord(rec);
            showStatus("Prestation ajout√©e.");
          }

          persist();
          render();
          resetForm();
        });
      }

      if(resetBtn){
        resetBtn.addEventListener("click", () => {
          resetForm();
        });
      }

      if(addDemoBtn){
        addDemoBtn.addEventListener("click", () => {
          const demo = {
            client:"Artiste d√©mo",
            type:"Clip",
            description:"Clip test d√©mo",
            date:new Date().toISOString().slice(0,10),
            montant:800,
            paidAmount:200
          };
          addRecord(demo);
          persist();
          render();
          showStatus("D√©mo ajout√©e.");
        });
      }

      if(exportJsonBtn){
        exportJsonBtn.addEventListener("click", () => {
          try{
            const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "prestations_"+ts()+".json";
            a.click();
            URL.revokeObjectURL(a.href);
            showStatus("Export JSON t√©l√©charg√©.");
          }catch(e){
            console.error(e);
            showStatus("Erreur export JSON : " + e.message, false);
          }
        });
      }

      if(exportCsvBtn){
        exportCsvBtn.addEventListener("click", () => {
          try{
            let csv = "date;client;type;description;montant;recu;restant\n";
            data.forEach(r => {
              csv += [
                r.date || "",
                r.client || "",
                r.type || "",
                (r.description||"").replace(/\n/g," "),
                r.montant || 0,
                getPaid(r),
                getRemaining(r)
              ].map(v => String(v).replace(/;/g,",")).join(";") + "\n";
            });
            const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "prestations_"+ts()+".csv";
            a.click();
            URL.revokeObjectURL(a.href);
            showStatus("Export CSV t√©l√©charg√©.");
          }catch(e){
            console.error(e);
            showStatus("Erreur export CSV : " + e.message, false);
          }
        });
      }

      if(importJsonInput){
        importJsonInput.addEventListener("change", async (e) => {
          const file = e.target.files && e.target.files[0];
          if(!file) return;
          try{
            const txt = await file.text();
            const arr = JSON.parse(txt);
            if(!Array.isArray(arr)) throw new Error("Format JSON invalide");
            data = arr.map(r => ({
              id: r.id || Date.now()+Math.random(),
              client: r.client || "",
              type: r.type || "Clip",
              description: r.description || "",
              date: r.date || "",
              montant: Number(r.montant||0),
              paidAmount: Number(r.paidAmount||0)
            }));
            persist();
            render();
            showStatus("Import JSON r√©ussi.");
          }catch(err){
            console.error(err);
            showStatus("Erreur import JSON : " + err.message, false);
          }finally{
            importJsonInput.value = "";
          }
        });
      }

      if(clearAllBtn){
        clearAllBtn.addEventListener("click", () => {
          if(confirm("Effacer TOUTES les prestations ?")){
            data = [];
            persist();
            render();
            showStatus("Tous les enregistrements ont √©t√© supprim√©s.");
          }
        });
      }

      if(debugChk){
        debugChk.addEventListener("change", () => {
          const zone = document.getElementById("debug-zone");
          if(zone) zone.style.display = debugChk.checked ? "block" : "none";
        });
      }

      if (search) {
        search.addEventListener("input", () => {
          render();
        });
      }
      if (filterStatus) {
        filterStatus.addEventListener("change", render);
      }
      if (filterType) {
        filterType.addEventListener("change", render);
      }

      /* ==== Capture pour "Prestations enregistr√©es" ==== */
if (captureBtn && typeof html2canvas !== "undefined") {
  captureBtn.addEventListener("click", () => {
    captureRecap(filterRecords(data));
  });
}

      load();
      render();
      showStatus(
        supportsLocalStorage ? "Sauvegarde locale active." : "Mode secours actif (stockage bloqu√©).",
        supportsLocalStorage
      );
      log("init ok, version", VERSION);

    })();
  </script>

  <!-- SCRIPT BEATSENGINE -->
  <script>
    (function(){
      const styleSel = document.getElementById("beats-style");
      const noteSel = document.getElementById("beats-note");
      const modeRadios = Array.from(document.querySelectorAll('input[name="beats-mode"]'));
      const bpmInput = document.getElementById("beats-bpm");
      const outputEl = document.getElementById("beats-output");
      const statusEl = document.getElementById("beats-status");
      const copyBtn = document.getElementById("beats-copy");
      const shuffleBtn = document.getElementById("beats-shuffle");
      const shuffleCTABtn = document.getElementById("beats-shuffle-cta");
      const generateBtn = document.getElementById("beats-generate");
      const instrumentInputs = Array.from(document.querySelectorAll(".beats-instrument"));
      const chordsEl = document.getElementById("beats-chords");
      const bpmRangeEl = document.getElementById("beats-bpm-range");
      const energyDescEl = document.getElementById("beats-energy-desc");
      const energyNoteEl = document.getElementById("beats-energy-note");
      const energyChips = Array.from(document.querySelectorAll("#beats-energy .energy-chip"));
      const energyRadios = Array.from(document.querySelectorAll('input[name="beats-energy"]'));
      const structureListEl = document.getElementById("structure-list");
      const progressionOptionsEl = document.getElementById("progression-options");
      const beatsProgressionEl = document.getElementById("beats-progression");
      const beatsProgressionChordsEl = document.getElementById("beats-progression-chords");
      const danceChips = Array.from(document.querySelectorAll("#beats-danceability .dance-chip"));
      const danceRadios = Array.from(document.querySelectorAll('input[name="beats-dance"]'));
      const danceNoteEl = document.getElementById("beats-dance-note");
      const vocalChips = Array.from(document.querySelectorAll("#vocal-modes .vocal-chip"));
      const vocalRadios = Array.from(document.querySelectorAll('input[name="vocal-mode"]'));
      const melodyWarning = document.getElementById("melody-warning");
      const structureNoteEl = document.getElementById("beats-structure-note");
      const usageChips = Array.from(document.querySelectorAll("#beats-usage .usage-chip"));
      const usageRadios = Array.from(document.querySelectorAll('input[name="beats-usage"]'));
      const beatsDurationEl = document.getElementById("beats-duration");
      const beatsUsageNoteEl = document.getElementById("beats-usage-note");
      const beatsLengthEl = document.getElementById("beats-length");
      const beatsKeylineEl = document.getElementById("beats-keyline");
      const trackNameDisplay = document.getElementById("track-name-display");
      const trackGenerateBtn = document.getElementById("track-generate");
      const trackCopyBtn = document.getElementById("track-copy");
      const trackCopyFeedback = document.getElementById("track-copy-feedback");
      const trackStyleMeta = document.getElementById("track-style-meta");
      const trackEnergyMeta = document.getElementById("track-energy-meta");
      const trackDanceMeta = document.getElementById("track-dance-meta");

      if(!styleSel || !noteSel || !bpmInput || !outputEl || !structureListEl) return;

      const chordsMap = {};

      const progressionMap = {
        "Afro-Trap":["i ‚Äì VI ‚Äì III ‚Äì VII","i ‚Äì v ‚Äì i ‚Äì VII","i ‚Äì III ‚Äì VI ‚Äì VII"],
        "Afro-Trap Club":["i ‚Äì VI ‚Äì III ‚Äì VII","i ‚Äì v ‚Äì i ‚Äì VII","i ‚Äì III ‚Äì VI ‚Äì VII"],
        "Afrobeat":["I ‚Äì V ‚Äì vi ‚Äì IV","i ‚Äì VI ‚Äì III ‚Äì VII","i ‚Äì VII ‚Äì VI ‚Äì VII"],
        "Afropop":["I ‚Äì V ‚Äì vi ‚Äì IV","i ‚Äì VI ‚Äì III ‚Äì VII","i ‚Äì VII ‚Äì VI ‚Äì VII"],
        "Bongo Flava":["I ‚Äì V ‚Äì vi ‚Äì IV","i ‚Äì VI ‚Äì III ‚Äì VII","i ‚Äì VII ‚Äì VI ‚Äì VII"],
        "Reggae":["I ‚Äì IV ‚Äì V","I ‚Äì V ‚Äì IV","vi ‚Äì IV ‚Äì I ‚Äì V"],
        "Zouk":["I ‚Äì IV ‚Äì V","I ‚Äì V ‚Äì IV","vi ‚Äì IV ‚Äì I ‚Äì V"],
        "Reggaeton":["i ‚Äì VI ‚Äì VII","vi ‚Äì IV ‚Äì I ‚Äì V","i ‚Äì VII ‚Äì VI"],
        "Moombahton Latin Club":["i ‚Äì VI ‚Äì VII","vi ‚Äì IV ‚Äì I ‚Äì V","i ‚Äì VII ‚Äì VI"],
        "Dancehall":["i ‚Äì VII ‚Äì VI ‚Äì VII","i ‚Äì VI ‚Äì VII","i ‚Äì III ‚Äì VI ‚Äì VII"],
        "Shatta":["i ‚Äì VII ‚Äì VI ‚Äì VII","i ‚Äì VI ‚Äì VII","i ‚Äì III ‚Äì VI ‚Äì VII"],
        "Amapiano":["i ‚Äì v ‚Äì i ‚Äì VII","i ‚Äì VI ‚Äì III ‚Äì VII","i ‚Äì VII ‚Äì VI ‚Äì VII"],
        "R&B":["i ‚Äì VI ‚Äì III ‚Äì VII","vi ‚Äì IV ‚Äì I ‚Äì V","i ‚Äì VII ‚Äì VI ‚Äì VII"],
        "Drill":["i ‚Äì VI ‚Äì III ‚Äì VII","i ‚Äì VII ‚Äì VI ‚Äì VII","i ‚Äì III ‚Äì VI ‚Äì VII"]
      };

      const bpmMap = {
        "Afro-Trap":[95,115],
        "Afro-Trap Club":[100,118],
        "R&B":[72,92],
        "Drill":[135,150],
        "Dancehall":[90,105],
        "Afrobeat":[100,120],
        "Afropop":[102,118],
        "Bongo Flava":[95,112],
        "Amapiano":[103,115],
        "Zouk":[85,100],
        "Reggae":[78,92],
        "Reggaeton":[86,98],
        "Moombahton Latin Club":[108,112],
        "Shatta":[96,112]
      };

      const vibeMap = {
        "Afro-Trap":"afro swing bounce, syncopated percussions, trap gloss and modern club sheen.",
        "Afro-Trap Club":"dancefloor afro-trap, neon synths, tight drums and crowd-ready drops.",
        "R&B":"silky R&B textures, lush chords, intimate drums and smooth ambience.",
        "Drill":"cinematic drill tension, sliding 808s, moody pads and syncopated hats.",
        "Dancehall":"island groove with percussive skank rhythms, playful percs, warm low-end and hooks.",
        "Afrobeat":"polyrhythmic afrobeat pulse, brass stabs, guitar licks and steady groove.",
        "Afropop":"sunny afro-pop sheen, catchy toplines, bouncy drums and bright textures.",
        "Bongo Flava":"east-afro fusion, polished percussions, airy keys and melodic hooks.",
        "Amapiano":"log drum rolls, shaker-driven groove, dreamy keys and late-night atmosphere.",
        "Zouk":"smooth zouk sway, silky guitars, romantic pads and mid-tempo bounce.",
        "Reggae":"roots groove, off-beat skank, warm bass and relaxed pocket.",
        "Reggaeton":"latin club swing, perreo drums, crisp claps and sensual bounce.",
        "Moombahton Latin Club":"latin club dembow, mid-tempo heat, syncopated percussion and vocal-friendly bounce.",
        "Shatta":"dancehall-inspired shatta grit, percussive chops and assertive groove."
      };

      const culturalLockMap = {
        "Shatta":"Martinican Shatta instrumental, French Caribbean origin, urban Caribbean style from Martinique",
        "Bongo Flava":"Tanzanian Bongo Flava instrumental, East African origin, Swahili pop and East African afro-pop influence",
        "Zouk":"Zouk instrumental from the French Caribbean, romantic Caribbean groove",
        "Reggae":"Reggae instrumental from Jamaica, roots and modern reggae influence",
        "Reggaeton":"Reggaeton instrumental from Puerto Rico, Latin urban club influence",
        "Moombahton Latin Club":"Latin Moombahton instrumental, Latin American club origin, modern moombahton style inspired by Latin urban club music",
        "Afrobeat":"Afrobeat instrumental rooted in Nigeria/Ghana, West African groove heritage",
        "Afropop":"Afropop instrumental, West African pop lineage (Nigeria/Ghana) with modern polish",
        "Afro-Trap":"French Afro-Trap instrumental, African diasporic roots blended with trap",
        "Afro-Trap Club":"Club-ready French Afro-Trap instrumental, African diasporic roots and club aesthetics",
        "Dancehall":"Dancehall instrumental from Jamaica, Caribbean club DNA, Jamaican island groove",
        "Amapiano":"South African Amapiano instrumental, township roots and log-drum heritage",
        "R&B":"R&B instrumental with US/UK neo-soul influence",
        "Drill":"Drill instrumental with UK/US roots, urban street influence"
      };

      const energyMap = {
        low: {
          label: "low",
          note: "Low ‚Üí minimal, smooth, spacious",
          texture: "minimal dynamics, airy ambience, plenty of space between elements"
        },
        medium: {
          label: "medium",
          note: "Medium ‚Üí balanced, groove-focused",
          texture: "balanced groove, clean transients, pocketed swing and tasteful layers"
        },
        high: {
          label: "high",
          note: "High ‚Üí aggressive, powerful, club-ready",
          texture: "aggressive drums, forward low-end, club-ready punch and bold synth leads"
        }
      };

      const danceabilityMap = {
        chill: {
          label:"chill",
          note:"Chill ‚Üí laid-back groove",
          texture:"laid-back groove, relaxed syncopation, room for storytelling"
        },
        bounce: {
          label:"bounce",
          note:"Bounce ‚Üí smooth bounce",
          texture:"smooth bounce, pocketed swing, body-friendly groove"
        },
        club: {
          label:"club",
          note:"Club ‚Üí club-focused rhythmic drive",
          texture:"strong rhythmic drive, club-focused cadence, infectious movement"
        }
      };

      const vocalModeMap = {
        "vocal-first":{
          label:"vocal-first",
          arrangement:"vocal-first arrangement, no competing lead melody, instrumental supportive, not dominant, clear space for human vocals",
          summary:"vocal-first arrangement, no lead melody, instrumental supportive, not dominant, clear space for human vocals",
          mix:"strong rhythmic groove with clean vocal pocket, instrumental supportive not dominant"
        },
        "balanced":{
          label:"balanced",
          arrangement:"balanced vocal/instrument layout, controlled counter-melodies, supportive pads",
          summary:"balanced vocals and instruments with controlled counter-lines",
          mix:"vocals and instruments share space with controlled dynamics"
        },
        "instrumental-lead":{
          label:"instrumental-lead",
          arrangement:"instrumental hooks upfront, vocals weaving around the lead motif",
          summary:"lead motif forward, vocals weave around the hook if present",
          mix:"lead melody forward, vocals ride the groove without clashing"
        }
      };

      const styles = Array.from(styleSel.options).map(o => o.value);
      const notes = Array.from(noteSel.options).map(o => o.value);
      const modes = modeRadios.map(r => r.value);
      const keys = notes.flatMap(note => modes.map(mode => `${note} ${mode}`));
      const usagePresets = {
        streaming:{ label:"Streaming", note:"streaming-first hook and compact pacing", duration:192 },
        radio:{ label:"Radio", note:"radio-ready energy, vocal clarity first", duration:185 },
        club:{ label:"Club", note:"club audience, extended drops and transitions", duration:210 },
        dj:{ label:"DJ", note:"DJ-friendly intro/outro for beatmatching", duration:230 },
        emotion:{ label:"Emotion", note:"cinematic/emotional arc, slow-burn build", duration:175 }
      };
      const structurePresets = {
        singer:{ label:"Singer", parts:["Intro","Couplet","Pre-Chorus","Refrain","Couplet","Refrain","Outro"], duration:200 },
        rapper:{ label:"Rapper", parts:["Intro","Couplet","Couplet","Refrain","Bridge","Refrain","Outro"], duration:190 },
        club:{ label:"Club", parts:["Intro","Drop","Couplet","Refrain","Drop","Couplet","Drop","Outro"], duration:210 }
      };
      const defaultStructure = structurePresets.singer.parts;
      let selectedStructurePreset = "singer";
      let selectedDurationSeconds = structurePresets[selectedStructurePreset].duration;
      let selectedUsage = "streaming";
      const STRUCTURE_TRANSLATIONS = {
        "couplet":"Verse",
        "refrain":"Chorus",
        "pont":"Bridge",
        "intro":"Intro",
        "outro":"Outro",
        "drop":"Drop",
        "pre-chorus":"Pre-Chorus",
        "prechorus":"Pre-Chorus",
        "verse":"Verse",
        "chorus":"Chorus",
        "bridge":"Bridge"
      };
      let structure = [...defaultStructure];
      let selectedProgression = progressionMap[styleSel.value]?.[0] || "i ‚Äì VI ‚Äì III ‚Äì VII";

      const chromatic = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      const flatToSharp = {"Db":"C#","Eb":"D#","Gb":"F#","Ab":"G#","Bb":"A#"};
      const trackNameBanks = {
        "Dancehall":{ primary:["island","heat","bass","riddim","night","fire","motion"], mood:["skies","after dark","breeze","ember","wave","sundown"] },
        "Bongo Flava":{ primary:["moyo","safari","pulse","coast","rhythm","love","vibe"], mood:["sunrise","tanzanite","coastal night","kin","heartline","amber"] },
        "Afro-Trap":{ primary:["drip","vision","flow","pressure","code","street"], mood:["midnight","bounce","mirror","flare","steez","signal"] },
        "Afro-Trap Club":{ primary:["club","neon","vision","flow","pressure","wave"], mood:["midnight","bounce","spark","after dark","electric","uptown"] },
        "Amapiano":{ primary:["midnight","echo","groove","soul","horizon","dust"], mood:["log drum","shaker line","night drive","embers","loft","afterglow"] },
        "Reggae":{ primary:["roots","breeze","vibration","light","river","shore"], mood:["irie","sunbeam","groundation","coastline","isle","dawn"] },
        "Shatta":{ primary:["raw","force","voltage","block","zone","charge"], mood:["steelo","red zone","uptempo","pressure","wildlight","ignite"] },
        "Afrobeat":{ primary:["pulse","roots","lagos","groove","brass","motion"], mood:["sunrise","storyline","coast road","ember","festival","ray"] },
        "Afropop":{ primary:["spark","chorus","wave","summer","bloom","glow"], mood:["skyline","colorfield","late call","highlight","rose night","vista"] },
        "R&B":{ primary:["velvet","midnight","silk","echo","amber","haze"], mood:["slow burn","afterglow","neon hush","soft rain","reverie","cascade"] },
        "Drill":{ primary:["shadow","grit","echo","nightfall","pressure","lane"], mood:["steel pulse","northern sky","ashen","cold wave","outline","silent run"] },
        "Zouk":{ primary:["lagoon","isle","velours","breeze","palm","caresse"], mood:["lueur","parfum","satin night","azur","slow wine","tropique"] },
        "Reggaeton":{ primary:["calor","ritmo","calle","noche","fuego","marea"], mood:["neon tide","brillo","vertigo","madrugada","sombra","respiro"] },
        "Moombahton Latin Club":{ primary:["dembow","ritual","rumba","fuego","club","glow"], mood:["afterhours","ambar","neon drive","red room","haze","pulse line"] },
        "Default":{ primary:["pulse","signal","echo","horizon","motion","silk"], mood:["after dark","dawnline","glow","bloom","low tide","resonance"] }
      };
      const trackEnergyWords = {
        low:["calm","velvet","haze","breeze","float","mellow"],
        medium:["motion","glow","steady","balance","pulse","sway"],
        high:["ignite","voltage","rush","impact","fever","charge"]
      };
      const trackDanceWords = {
        chill:["drift","sofa","slow step","soft sway","warm up","coast"],
        bounce:["bounce","two-step","bodyline","groove","smooth drive","roll"],
        club:["club","floor","after midnight","prime time","peak hour","dancefloor"]
      };
      const trackPhraseHooks = ["After Dark","In Motion","At Dawn","For Tonight","Beyond Night","Forever Move","Late Glow","Echo Line"];
      let lastTrackName = "";

      function normalizeRoot(note){
        if(!note) return "A";
        return flatToSharp[note] || note;
      }

      function parseKey(keyStr){
        const parts = (keyStr || "A minor").split(" ");
        const root = normalizeRoot(parts[0]);
        const scale = (parts[1] || "minor").toLowerCase().includes("major") ? "major" : "minor";
        return {root, scale};
      }

      function generateScaleChords(keyStr){
        const {root, scale} = parseKey(keyStr);
        const intervals = scale === "major" ? [0,2,4,5,7,9,11] : [0,2,3,5,7,8,10];
        const qualities = scale === "major"
          ? ["maj","min","min","maj","maj","min","dim"]
          : ["min","dim","maj","min","min","maj","maj"];
        const mapping = {};
        const rootIndex = chromatic.indexOf(root);
        if(rootIndex === -1) return mapping;

        ["I","II","III","IV","V","VI","VII"].forEach((deg, idx) => {
          const note = chromatic[(rootIndex + intervals[idx]) % chromatic.length];
          const qual = qualities[idx];
          const chord = qual === "maj" ? note : qual === "min" ? `${note}m` : `${note}¬∞`;
          mapping[deg] = chord;
          mapping[deg.toLowerCase()] = chord;
        });
        return mapping;
      }

      function buildChordLibrary(){
        keys.forEach(k => {
          chordsMap[k] = generateScaleChords(k);
        });
      }

      function romanToDegree(r){
        const base = r.toUpperCase();
        const map = { "I":1,"II":2,"III":3,"IV":4,"V":5,"VI":6,"VII":7 };
        return map[base] || 1;
      }

      function chordFromRoman(roman, keyStr){
        const degree = romanToDegree(roman);
        const dict = chordsMap[keyStr] || {};
        const entry = dict[roman] || dict[roman.toUpperCase()] || dict[roman.toLowerCase()];
        if(entry){
          const root = entry.replace(/m|¬∞/g,"");
          const isMinor = roman === roman.toLowerCase();
          const isDim = roman.includes("¬∞");
          if(isDim) return `${root}¬∞`;
          if(isMinor) return `${root}m`;
          return entry.includes("m") && roman === roman.toUpperCase() ? entry.replace("m","") : entry;
        }
        const {root, scale} = parseKey(keyStr);
        const intervals = scale === "major" ? [0,2,4,5,7,9,11] : [0,2,3,5,7,8,10];
        const rootIndex = chromatic.indexOf(root);
        const note = chromatic[(rootIndex + intervals[degree-1]) % chromatic.length];
        const minor = roman === roman.toLowerCase();
        return minor ? `${note}m` : note;
      }

      function splitProgression(progress){
        return (progress || "").split("‚Äì").map(p => p.trim()).filter(Boolean);
      }

      function transposeProgression(progress, keyStr){
        const degrees = splitProgression(progress);
        const chords = degrees.map(r => chordFromRoman(r, keyStr));
        return {
          romanLine: progress,
          chordLine: chords.join(" ‚Äì ")
        };
      }

      function sanitizeBpm(value, range){
        const [min,max] = range || [80,160];
        const n = parseInt(value, 10);
        if(Number.isFinite(n)){
          return Math.max(min, Math.min(max, n));
        }
        return Math.round((min + max) / 2);
      }

      function describeStyle(style){
        return vibeMap[style] || "clean modern mix, energetic groove and tight arrangement.";
      }

      function translateStructureLabel(part){
        const label = (part || "").trim();
        const lower = label.toLowerCase();
        const matchKey = Object.keys(STRUCTURE_TRANSLATIONS).find(k => lower.startsWith(k));
        if(matchKey){
          const translated = STRUCTURE_TRANSLATIONS[matchKey];
          const suffix = label.slice(matchKey.length);
          return `${translated}${suffix ? suffix : ""}`.trim();
        }
        return label;
      }

      function translateStructureToEnglish(parts){
        return (parts || []).map(translateStructureLabel);
      }

      function currentEnergy(){
        const selected = energyRadios.find(r => r.checked);
        return selected ? selected.value : "medium";
      }

      function updateEnergyUI(){
        const value = currentEnergy();
        energyChips.forEach(chip => {
          const radio = chip.querySelector('input[name="beats-energy"]');
          chip.classList.toggle("active", radio && radio.value === value);
        });
        const meta = energyMap[value] || energyMap.medium;
        if(energyDescEl) energyDescEl.textContent = meta.note;
        if(energyNoteEl) energyNoteEl.textContent = meta.note;
        updateTrackMeta();
      }

      function currentDanceability(){
        const selected = danceRadios.find(r => r.checked);
        return selected ? selected.value : "bounce";
      }

      function updateDanceUI(){
        const value = currentDanceability();
        danceChips.forEach(chip => {
          const radio = chip.querySelector('input[name="beats-dance"]');
          chip.classList.toggle("active", radio && radio.value === value);
        });
        const meta = danceabilityMap[value] || danceabilityMap.bounce;
        if(danceNoteEl) danceNoteEl.textContent = meta.note;
        updateTrackMeta();
      }

      function currentVocalMode(){
        const selected = vocalRadios.find(r => r.checked);
        return selected ? selected.value : "vocal-first";
      }

      function updateVocalUI(){
        const value = currentVocalMode();
        vocalChips.forEach(chip => {
          const radio = chip.querySelector('input[name="vocal-mode"]');
          chip.classList.toggle("active", radio && radio.value === value);
        });
        enforceMelodyLimit();
      }

      function updateTrackMeta(){
        const style = styleSel.value;
        const energy = currentEnergy();
        const dance = currentDanceability();
        if(trackStyleMeta) trackStyleMeta.textContent = style;
        if(trackEnergyMeta) trackEnergyMeta.textContent = energy.charAt(0).toUpperCase() + energy.slice(1);
        if(trackDanceMeta){
          const label = dance === "club" ? "Club" : dance === "bounce" ? "Bounce" : "Chill";
          trackDanceMeta.textContent = label;
        }
      }

      function formatTrackPart(part){
        return (part || "")
          .split(/\s+/)
          .filter(Boolean)
          .map(word => word.charAt(0).toUpperCase() + word.slice(1))
          .join(" ");
      }

      function pickRandom(list){
        const pool = (list || []).filter(Boolean);
        if(!pool.length) return "";
        return pool[Math.floor(Math.random() * pool.length)];
      }

      function pickDistinct(list, avoid){
        const pool = (list || []).filter(Boolean);
        const filtered = pool.filter(item => !avoid.includes(item));
        if(filtered.length) return pickRandom(filtered);
        return pickRandom(pool);
      }

      function resolveTrackBank(style){
        return trackNameBanks[style] || trackNameBanks.Default;
      }

      function composeTrackName(){
        const style = styleSel.value;
        const energy = currentEnergy();
        const dance = currentDanceability();
        const bank = resolveTrackBank(style);
        const energyWords = trackEnergyWords[energy] || trackEnergyWords.medium;
        const danceWords = trackDanceWords[dance] || trackDanceWords.bounce;
        const primaries = (bank.primary || []).filter(Boolean);
        const moods = (bank.mood || []).filter(Boolean);
        const basePool = [...primaries, ...moods];
        const wordA = pickRandom(basePool) || pickRandom(trackNameBanks.Default.primary);
        const templates = ["single","double","phrase","abstract"];
        const template = pickRandom(templates) || "double";

        const energyWord = pickRandom(energyWords);
        const danceWord = pickRandom(danceWords);
        const hook = pickRandom(trackPhraseHooks);

        if(template === "single"){
          return formatTrackPart(wordA || energyWord || "Pulse");
        }

        if(template === "double"){
          const second = pickDistinct([...moods, ...energyWords, ...danceWords], [wordA]);
          return `${formatTrackPart(wordA)} ${formatTrackPart(second || "Motion")}`.trim();
        }

        if(template === "phrase"){
          const second = pickDistinct([...trackPhraseHooks, ...moods, energyWord, danceWord].flat().filter(Boolean), [wordA]);
          return `${formatTrackPart(wordA)} ${formatTrackPart(second || "After Dark")}`.trim();
        }

        const abstractA = pickDistinct([...moods, wordA, energyWord].flat().filter(Boolean), []);
        const abstractB = pickDistinct([...danceWords, ...energyWords, hook ? [hook] : []].flat().filter(Boolean), [abstractA]);
        const joiner = pickRandom(["in","of","beyond","into"]) || "in";
        return `${formatTrackPart(abstractA || "Echo")} ${joiner} ${formatTrackPart(abstractB || "Motion")}`.trim();
      }

      function refreshTrackName(){
        updateTrackMeta();
        if(!trackNameDisplay) return;
        const next = composeTrackName();
        lastTrackName = next;
        trackNameDisplay.textContent = next;
        if(trackCopyFeedback){
          trackCopyFeedback.classList.remove("visible");
        }
      }

      function copyTrackName(){
        if(!lastTrackName){
          if(trackCopyFeedback){
            trackCopyFeedback.textContent = "Rien √† copier";
            trackCopyFeedback.classList.add("visible");
          }
          return;
        }
        const text = lastTrackName;
        const onSuccess = () => {
          if(trackCopyFeedback){
            trackCopyFeedback.textContent = "Copi√© ‚úî";
            trackCopyFeedback.classList.add("visible");
            setTimeout(() => trackCopyFeedback.classList.remove("visible"), 1200);
          }
        };
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(text).then(onSuccess).catch(() => {
            fallbackCopy(text);
            onSuccess();
          });
        }else{
          fallbackCopy(text);
          onSuccess();
        }
      }

      const INSTRUMENT_CATEGORY_DETAILS = {
        drums:{ include:"drums: kick, snare/clap, hi-hats, tasteful percussions", role:"core" },
        bass:{ include:"808/bass with controlled sidechain", role:"bass" },
        melody:{ include:"simple synth/pad hook", role:"melody" },
        guitar:{ include:"clean guitar licks", role:"melody" },
        piano:{ include:"piano/keys chords", role:"melody" },
        pads:{ include:"warm pads / atmospheres", role:"melody" },
        plucks:{ include:"plucks or synth stabs", role:"melody" },
        strings:{ include:"light strings section", role:"melody" },
        brass:{ include:"brass / horn stabs", role:"melody" },
        voxfx:{ include:"vocal chops / textures", role:"melody" },
        fx:{ include:"fx texture beds, risers (subtle)", role:"texture" }
      };
      const STRICT_EXCLUSION = "strict exclusion: no guitar, no guitar textures, no guitar-like timbres";

      const MOOMBAHTON_STYLE = "Moombahton Latin Club";
      const MOOMBAHTON_STRUCTURE = ["Intro","Drop","Couplet","Drop","Couplet","Drop","Outro"];
      const MOOMBAHTON_INCLUDED = "whitelist: drums, bass, latin percussions, short synth stabs";
      const MOOMBAHTON_STRICT = "exclusions: no guitar, no piano, no big EDM risers";
      const MOOMBAHTON_GROOVE = "groove: dembow-based moombahton rhythm; heavy kick on 1 and 3; syncopated percussion; club bounce.";

      function currentMode(){
        const selected = modeRadios.find(r => r.checked);
        return selected ? selected.value : "minor";
      }

      function currentKey(){
        const note = noteSel.value || "A";
        return `${note} ${currentMode()}`;
      }

      function normalizeInstrumentName(name){
        return (name || "").toLowerCase().trim();
      }

      function isMoombahtonLatinClub(style){
        return (style || "").trim() === MOOMBAHTON_STYLE;
      }

      function getInstrumentSelection(){
        const included = [];
        const excluded = [];
        let melodicCount = 0;

        instrumentInputs.forEach(input => {
          const id = input.value;
          const meta = INSTRUMENT_CATEGORY_DETAILS[id];
          if(!meta) return;
          if(input.checked){
            included.push(meta.include);
            if(meta.role === "melody") melodicCount++;
          } else {
            excluded.push(meta.include);
          }
        });

        if(!included.length){
          included.push("minimal drums only");
        }

        return {included, excluded, melodicCount};
      }

      function buildInstrumentLines(){
        const {included, excluded, melodicCount} = getInstrumentSelection();
        const includedLine = `whitelist: ${included.join(", ")}`;
        const excludedList = excluded.join(", ");
        const excludedLine = excludedList
          ? `exclusions: ${excludedList}`
          : "exclusions: ban anything outside the whitelist";
        const barrierLine = "do not add any instrument not listed above";
        const compactExclusion = STRICT_EXCLUSION;
        const strictBlock = (melodicCount > 1 && currentVocalMode() === "vocal-first")
          ? "keep only one melodic hook to protect vocal space"
          : "";
        return {includedLine, excludedLine, compactExclusion, strictBlock, barrierLine};
      }

      function buildPromptText(sections, limit = 900){
        let active = sections.filter(section => section && section.text && section.text.trim());
        let prompt = active.map(s => s.text).join("\n");

        const optionalIndexes = active
          .map((section, idx) => section.optional ? idx : null)
          .filter(idx => idx !== null);

        while(prompt.length > limit && optionalIndexes.length){
          const idxToRemove = optionalIndexes.pop();
          active.splice(idxToRemove, 1);
          for(let i = 0; i < optionalIndexes.length; i++){
            if(optionalIndexes[i] > idxToRemove){
              optionalIndexes[i] -= 1;
            }
          }
          prompt = active.map(s => s.text).join("\n");
        }

        if(prompt.length > limit){
          active = active.map(section => {
            if(typeof section.compact === "function"){
              return {...section, text: section.compact(section.text)};
            }
            return section;
          });
          prompt = active.map(s => s.text).join("\n");
        }

        if(prompt.length > limit){
          prompt = `${prompt.slice(0, limit - 3)}...`;
        }

        return {prompt, length: prompt.length};
      }

      function enforceMelodyLimit(){
        const isVocalFirst = currentVocalMode() === "vocal-first";
        const {melodicCount} = getInstrumentSelection();
        const overLimit = isVocalFirst && melodicCount > 1;
        instrumentInputs.forEach(input => {
          const wrapper = input.closest(".instrument-checkbox");
          if(wrapper){
            const isMelodic = (input.dataset.role || "") === "melody";
            wrapper.classList.toggle("over-limit", overLimit && isMelodic && input.checked);
          }
        });
        if(melodyWarning){
          melodyWarning.classList.toggle("visible", overLimit);
        }
      }

      function ensureStructure(){
        const preset = structurePresets[selectedStructurePreset];
        if(!preset){
          selectedStructurePreset = "singer";
        }
        const currentPreset = structurePresets[selectedStructurePreset] || structurePresets.singer;
        structure = Array.isArray(currentPreset.parts) ? [...currentPreset.parts] : [...defaultStructure];
        selectedDurationSeconds = currentPreset.duration || 180;
      }

      function currentDurationSeconds(){
        const usageDur = usagePresets[selectedUsage]?.duration;
        const presetDur = structurePresets[selectedStructurePreset]?.duration;
        return usageDur || presetDur || selectedDurationSeconds || 180;
      }

      function formatMinutesValue(seconds){
        if(!Number.isFinite(seconds) || seconds <= 0) return "3.0";
        return (seconds / 60).toFixed(1);
      }

      function renderStructure(){
        ensureStructure();
        structureListEl.innerHTML = "";
        structure.forEach(part => {
          const li = document.createElement("li");
          li.className = "structure-item";
          const label = document.createElement("span");
          label.className = "structure-label";
          label.textContent = part;
          li.appendChild(label);
          structureListEl.appendChild(li);
        });
        const preset = structurePresets[selectedStructurePreset];
        if(structureNoteEl && preset){
          const minutes = formatMinutesValue(currentDurationSeconds());
          const usageLabel = usagePresets[selectedUsage]?.label || "Streaming";
          structureNoteEl.textContent = `${preset.label} preset ‚Äî ${minutes} min target (${usageLabel}), FR labels auto ‚Üí EN in prompt.`;
        }
      }

      function selectStructurePreset(name){
        if(!structurePresets[name]) return;
        selectedStructurePreset = name;
        ensureStructure();
        renderStructure();
        generatePrompt();
      }

      function updateMeta(){
        const style = styleSel.value;
        const key = currentKey();
        const transposed = transposeProgression(selectedProgression, key);
        const range = bpmMap[style] || [90,120];
        if(chordsEl) chordsEl.textContent = transposed.chordLine;
        if(bpmRangeEl) bpmRangeEl.textContent = `${range[0]}-${range[1]} BPM`;
        if(beatsKeylineEl){
          beatsKeylineEl.textContent = `Key ${key} ‚Ä¢ ${bpmInput.value || range[0]} BPM ‚Ä¢ ${usagePresets[selectedUsage]?.label || "Streaming"} ‚Ä¢ ${structurePresets[selectedStructurePreset]?.label || "Singer"}`;
        }
        updateEnergyUI();
        updateDanceUI();
        updateVocalUI();
        updateUsageUI();
        updateTrackMeta();
      }

      function pickProgression(){
        const options = progressionMap[styleSel.value] || ["i ‚Äì VI ‚Äì III ‚Äì VII"];
        if(!selectedProgression || !options.includes(selectedProgression)){
          selectedProgression = options[0];
        }
        return selectedProgression;
      }

      function renderProgressions(){
        const list = progressionMap[styleSel.value] || [];
        progressionOptionsEl.innerHTML = "";
        list.forEach(prog => {
          const label = document.createElement("label");
          label.className = "progression-chip" + (prog === selectedProgression ? " active" : "");
          label.innerHTML = `<div><strong>${prog}</strong><small>Progression gagnante ${styleSel.value}</small></div>`;
          label.addEventListener("click", () => {
            selectedProgression = prog;
            renderProgressions();
            generatePrompt();
          });
          progressionOptionsEl.appendChild(label);
        });
        if(!selectedProgression && list.length){
          selectedProgression = list[0];
        }
        const transposed = transposeProgression(selectedProgression, currentKey());
        beatsProgressionEl.textContent = transposed.romanLine;
        beatsProgressionChordsEl.textContent = transposed.chordLine;
      }

      function updateUsageUI(){
        const current = currentUsage();
        usageChips.forEach(chip => {
          const radio = chip.querySelector('input[name="beats-usage"]');
          chip.classList.toggle("active", radio && radio.value === current);
        });
        const preset = usagePresets[current] || usagePresets.streaming;
        if(beatsDurationEl) beatsDurationEl.textContent = `${formatMinutesValue(currentDurationSeconds())} min`;
        if(beatsUsageNoteEl) beatsUsageNoteEl.textContent = `${preset.label} ready ‚Äî ${preset.note}`;
      }

      function syncBpmWithStyle(){
        const range = bpmMap[styleSel.value] || [90,120];
        const mid = Math.round((range[0]+range[1])/2);
        bpmInput.min = range[0];
        bpmInput.max = range[1];
        bpmInput.value = sanitizeBpm(bpmInput.value, range) || mid;
        if(!bpmInput.value) bpmInput.value = mid;
      }

      function buildCulturalLock(style){
        return culturalLockMap[style] || `${style} instrumental, authentic to its cultural roots`;
      }

      function currentUsage(){
        const selected = usageRadios.find(r => r.checked);
        return selected ? selected.value : selectedUsage;
      }

      function generatePrompt(source="manual"){
        ensureStructure();
        selectedUsage = currentUsage();
        const style = styleSel.value || "Afro-Trap";
        const key = currentKey();
        const range = bpmMap[style] || [90,120];
        const bpm = sanitizeBpm(bpmInput.value, range);
        bpmInput.value = bpm;
        const progression = pickProgression();
        const transposed = transposeProgression(progression, key);
        beatsProgressionEl.textContent = transposed.romanLine;
        beatsProgressionChordsEl.textContent = transposed.chordLine;
        if(chordsEl) chordsEl.textContent = transposed.chordLine;
        let {includedLine, excludedLine, compactExclusion, strictBlock, barrierLine} = buildInstrumentLines();
        const energy = energyMap[currentEnergy()] || energyMap.medium;
        const dance = danceabilityMap[currentDanceability()] || danceabilityMap.bounce;
        const vocal = vocalModeMap[currentVocalMode()] || vocalModeMap["vocal-first"];
        const preset = structurePresets[selectedStructurePreset] || structurePresets.singer;
        let structureParts = (structure && structure.length) ? structure : preset.parts;
        let structureLine = `structure (EN): ${translateStructureToEnglish(structureParts).join(" ‚Üí ")}`;
        const usage = usagePresets[selectedUsage] || usagePresets.streaming;
        let durationMinutes = formatMinutesValue(currentDurationSeconds());
        const culturalLock = buildCulturalLock(style);
        const styleLine = style === "Dancehall"
          ? `Dancehall instrumental from Jamaica, Caribbean club DNA, Jamaican island groove ‚Äî ${describeStyle(style)}`
          : `${style} instrumental ‚Äî ${describeStyle(style)}`;
        const culturalLine = `origin & cultural lock: ${culturalLock}`;
        let bpmLine = `${bpm} BPM locked in ${key}; winning chords ${transposed.romanLine} (${transposed.chordLine}).`;
        let durationLine = `full-length instrumental track, approx ${durationMinutes} minutes (${usage.label.toLowerCase()} ready), continuous arrangement, not a loop.`;
        const vocalLine = `vocal focus: ${vocal.summary || vocal.arrangement}`;
        let grooveDetails = `${vocal.mix}`;

        if(isMoombahtonLatinClub(style)){
          includedLine = MOOMBAHTON_INCLUDED;
          excludedLine = "";
          strictBlock = MOOMBAHTON_STRICT;
          barrierLine = "do not add any instrument not listed above";
          bpmLine = `${bpm} BPM locked (108-112 range) with key ${key}; winning chords ${transposed.romanLine} (${transposed.chordLine}).`;
          durationLine = `full-length instrumental track, approx 3.0 minutes (club ready), continuous arrangement, not a loop.`;
          grooveDetails = MOOMBAHTON_GROOVE;
          structureParts = [...MOOMBAHTON_STRUCTURE];
          structureLine = `structure (EN): ${translateStructureToEnglish(structureParts).join(" ‚Üí ")}`;
        }

        const energyDanceLineBase = `energy ${energy.label} ‚Äî ${energy.texture}; danceability ${dance.label} ‚Äî ${dance.texture}`;
        const grooveText = grooveDetails ? `; groove: ${grooveDetails}` : "";
        const energyDanceLine = `${energyDanceLineBase}${grooveText}.`;

        const exclusionLine = [compactExclusion, excludedLine, strictBlock, barrierLine].filter(Boolean).join("; ");

        const sections = [
          {text: styleLine},
          {text: culturalLine},
          {text: bpmLine},
          {text: durationLine},
          {text: vocalLine},
          {text: includedLine},
          {text: exclusionLine},
          {text: structureLine},
          {text: energyDanceLine}
        ];

        const {prompt, length} = buildPromptText(sections);
        outputEl.value = prompt;
        if(beatsLengthEl){
          beatsLengthEl.textContent = `${length} / 900`;
        }
        if(statusEl){
          const baseStatus = source === "shuffle"
            ? "Shuffle premium g√©n√©r√© automatiquement"
            : "Prompt g√©n√©r√© et pr√™t √† √™tre copi√©";
          statusEl.textContent = `${baseStatus} (${length}/900 caract√®res).`;
        }
        updateMeta();
        enforceMelodyLimit();
      }

      function randomizeInstruments(){
        let checkedCount = 0;
        instrumentInputs.forEach(input => {
          const mustKeep = ["drums","bass"].includes(input.value);
          const decision = mustKeep ? true : Math.random() > 0.5;
          input.checked = decision;
          if(decision) checkedCount++;
        });
        if(checkedCount === 0 && instrumentInputs[0]){
          instrumentInputs[0].checked = true;
        }
        enforceMelodyLimit();
      }

      function shuffleStructure(){
        const presetKeys = Object.keys(structurePresets);
        const pick = presetKeys[Math.floor(Math.random()*presetKeys.length)] || "singer";
        selectStructurePreset(pick);
      }

      function shufflePrompt(){
        const style = styles[Math.floor(Math.random()*styles.length)] || "Afro-Trap";
        const key = keys[Math.floor(Math.random()*keys.length)] || "A minor";
        const [note, mode] = key.split(" ");
        styleSel.value = style;
        if(noteSel) noteSel.value = note;
        modeRadios.forEach(r => { r.checked = r.value === (mode || "minor"); });

        syncBpmWithStyle();
        const range = bpmMap[style] || [90,120];
        const bpm = Math.floor(Math.random() * (range[1] - range[0] + 1)) + range[0];
        bpmInput.value = bpm;

        const energyKeys = Object.keys(energyMap);
        const pickedEnergy = energyKeys[Math.floor(Math.random()*energyKeys.length)] || "medium";
        energyRadios.forEach(r => { r.checked = r.value === pickedEnergy; });
        updateEnergyUI();

        const danceKeys = Object.keys(danceabilityMap);
        const pickedDance = danceKeys[Math.floor(Math.random()*danceKeys.length)] || "bounce";
        danceRadios.forEach(r => { r.checked = r.value === pickedDance; });
        updateDanceUI();

        const vocalKeys = Object.keys(vocalModeMap);
        const pickedVocal = vocalKeys[Math.floor(Math.random()*vocalKeys.length)] || "vocal-first";
        vocalRadios.forEach(r => { r.checked = r.value === pickedVocal; });
        updateVocalUI();

        const progs = progressionMap[style] || [];
        selectedProgression = progs[Math.floor(Math.random()*progs.length)] || selectedProgression;

        const usageKeys = Object.keys(usagePresets);
        selectedUsage = usageKeys[Math.floor(Math.random()*usageKeys.length)] || selectedUsage;
        usageRadios.forEach(r => { r.checked = r.value === selectedUsage; });
        updateUsageUI();
        renderStructure();

        randomizeInstruments();
        shuffleStructure();
        renderProgressions();
        generatePrompt("shuffle");
      }

      function copyPrompt(){
        const txt = outputEl.value || "";
        if(!txt.trim()){
          statusEl && (statusEl.textContent = "Rien √† copier : g√©n√®re un prompt d'abord.");
          return;
        }
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(txt).then(() => {
            statusEl && (statusEl.textContent = "Prompt copi√© dans le presse-papiers.");
          }).catch(() => {
            fallbackCopy(txt);
          });
        } else {
          fallbackCopy(txt);
        }
      }

      function fallbackCopy(text){
        const area = document.createElement("textarea");
        area.value = text;
        area.style.position = "fixed";
        area.style.opacity = "0";
        document.body.appendChild(area);
        area.select();
        try { document.execCommand("copy"); } catch(e){}
        document.body.removeChild(area);
        statusEl && (statusEl.textContent = "Prompt copi√© (mode r√©tro).");
      }

      styleSel.addEventListener("change", () => {
        selectedProgression = (progressionMap[styleSel.value] || [])[0] || selectedProgression;
        syncBpmWithStyle();
        renderProgressions();
        updateMeta();
        refreshTrackName();
        generatePrompt();
      });
      noteSel.addEventListener("change", () => {
        renderProgressions();
        updateMeta();
        generatePrompt();
      });
      modeRadios.forEach(radio => {
        radio.addEventListener("change", () => {
          renderProgressions();
          updateMeta();
          generatePrompt();
        });
      });
      bpmInput.addEventListener("input", () => generatePrompt());
      energyChips.forEach(chip => {
        const radio = chip.querySelector('input[name="beats-energy"]');
        chip.addEventListener("click", () => {
          if(radio){
            radio.checked = true;
            updateEnergyUI();
            refreshTrackName();
            generatePrompt();
          }
        });
      });
      danceChips.forEach(chip => {
        const radio = chip.querySelector('input[name="beats-dance"]');
        chip.addEventListener("click", () => {
          if(radio){
            radio.checked = true;
            updateDanceUI();
            refreshTrackName();
            generatePrompt();
          }
        });
      });
      vocalChips.forEach(chip => {
        const radio = chip.querySelector('input[name="vocal-mode"]');
        chip.addEventListener("click", () => {
          if(radio){
            radio.checked = true;
            updateVocalUI();
            generatePrompt();
          }
        });
      });
      usageChips.forEach(chip => {
        const radio = chip.querySelector('input[name="beats-usage"]');
        chip.addEventListener("click", () => {
          if(radio){
            radio.checked = true;
            selectedUsage = radio.value || "streaming";
            updateUsageUI();
            renderStructure();
            generatePrompt();
          }
        });
      });
      if(trackGenerateBtn){
        trackGenerateBtn.addEventListener("click", () => {
          refreshTrackName();
        });
      }
      if(trackCopyBtn){
        trackCopyBtn.addEventListener("click", () => {
          copyTrackName();
        });
      }
      instrumentInputs.forEach(input => {
        input.addEventListener("change", () => {
          enforceMelodyLimit();
          generatePrompt();
        });
      });
      document.querySelectorAll("[data-structure-preset]").forEach(btn => {
        btn.addEventListener("click", () => {
          const name = btn.getAttribute("data-structure-preset");
          selectStructurePreset(name);
        });
      });
      copyBtn && copyBtn.addEventListener("click", copyPrompt);
      generateBtn && generateBtn.addEventListener("click", () => generatePrompt());
      shuffleBtn && shuffleBtn.addEventListener("click", shufflePrompt);
      shuffleCTABtn && shuffleCTABtn.addEventListener("click", shufflePrompt);

      buildChordLibrary();
      syncBpmWithStyle();
      renderProgressions();
      renderStructure();
      updateMeta();
      refreshTrackName();
      generatePrompt("init");
    })();
  </script>

  <!-- SCRIPT THEME NUIT/JOUR -->
  <script>
    (function(){
      const THEME_KEY = "szd_theme";
      const root = document.documentElement;
      const themeIcon = document.querySelector(".theme-icon");

      function applyTheme(theme){
        if(theme === "light"){
          root.setAttribute("data-theme","light");
        }else{
          root.removeAttribute("data-theme"); // dark par d√©faut
        }

        if (themeIcon) {
          themeIcon.textContent = theme === "light" ? "‚òÄÔ∏è" : "üåô";
        }

        if (typeof updateThemeLogos === "function") {
          updateThemeLogos(theme);
        }
      }

      document.addEventListener("DOMContentLoaded", function(){
        var toggle = document.getElementById("themeToggle");
        if(!toggle) return;

        var saved = null;
        try {
          saved = localStorage.getItem(THEME_KEY);
        } catch(e) {}

        if(saved === "light"){
          applyTheme("light");
          toggle.checked = false;
        } else {
          applyTheme("dark");
          toggle.checked = true;
        }

        toggle.addEventListener("change", function(){
          if(toggle.checked){
            applyTheme("dark");
            try { localStorage.setItem(THEME_KEY,"dark"); } catch(e) {}
          } else {
            applyTheme("light");
            try { localStorage.setItem(THEME_KEY,"light"); } catch(e) {}
          }
        });
      });
    })();
  </script>

</body>
</html>
